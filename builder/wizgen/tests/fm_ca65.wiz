//======================================================================================================================
// FAMISTUDIO SOUND ENGINE (4.3.0)
// Copyright (c) 2019-2024 Mathieu Gauthier
//
// Copying and distribution of this file, with or without
// modification, are permitted in any medium without royalty provided
// the copyright notice and this notice are preserved in all source
// code copies. This file is offered as-is, without any warranty.
//======================================================================================================================

//======================================================================================================================
// This is the FamiStudio sound engine. It is used by the NSF and ROM exporter of FamiStudio and can be used to make
// games. It supports every feature from FamiStudio, some of them are toggeable to save CPU/memory.
//
// This is essentially a heavily modified version of FamiTone2 by Shiru. A lot of his code and comments are still
// present here, so massive thanks to him!! I am not trying to steal his work or anything, i renamed a lot of functions
// and variables because at some point it was becoming a mess of coding standards and getting hard to maintain.
//
// Moderately advanced users can probably figure out how to use the sound engine simply by reading these comments.
// For more in-depth documentation, please go to:
//
//    https://famistudio.org/doc/soundengine/
//======================================================================================================================

//======================================================================================================================
// INTERFACE
//
// The interface is pretty much the same as FamiTone2, with a slightly different naming convention. The subroutines you
// can call from your game are:
//
//   - famistudio_init            : Initialize the engine with some music data.
//   - famistudio_music_play      : Start music playback with a specific song.
//   - famistudio_music_pause     : Pause/unpause music playback.
//   - famistudio_music_stop      : Stops music playback.
//   - famistudio_sfx_init        : Initialize SFX engine with SFX data.
//   - famistudio_sfx_play        : Play a SFX.
//   - famistudio_sfx_sample_play : Play a DPCM SFX.
//   - famistudio_update          : Updates the music/SFX engine, call once per frame, ideally from NMI.
//
// You can check the demo ROM to see how they are used or check out the online documentation for more info.
//======================================================================================================================

//======================================================================================================================
// CONFIGURATION
//
// There are 2 main ways of configuring the engine.
//
//   1) The simplest way is right here, in the section below. Simply comment/uncomment these defines, and move on
//      with your life.
//
//   2) The second way is "externally", using definitions coming from elsewhere in your app or the command line. If you
//      wish do so, simply define FAMISTUDIO_CFG_EXTERNAL=1 and this whole section will be ignored. You are then
//      responsible for providing all configuration. This is useful if you have multiple projects that needs
//      different configurations, while pointing to the same code file. This is how the provided demos and FamiStudio
//      uses it.
//
// Note that unless specified, the engine uses "if" and not "ifdef" for all boolean values so you need to define these
// to non-zero values. Undefined values will be assumed to be zero.
//
// There are 4 main things to configure, each of them will be detailed below.
//
//   1) Segments (ZP/RAM/PRG)
//   2) Audio expansion
//   3) Global engine parameters
//   4) Supported features
//======================================================================================================================

if (ndef FAMISTUDIO_CFG_EXTERNAL) {
/* FAMISTUDIO_CFG_EXTERNAL = 0 */
}

// Set this to configure the sound engine from outside (in your app, or from the command line)
if (!FAMISTUDIO_CFG_EXTERNAL) {

//======================================================================================================================
// 1) SEGMENT CONFIGURATION
//
// You need to tell where you want to allocate the zeropage, RAM and code. This section will be slightly different for
// each assembler.
//
// For CA65, you need to specify the name of your ZEROPAGE, RAM/BSS and CODE/PRG segments as c-style macros (.define)
// like the example below.
//======================================================================================================================

/* .define FAMISTUDIO_CA65_ZP_SEGMENT   ZP */
/* .define FAMISTUDIO_CA65_RAM_SEGMENT  RAM */
/* .define FAMISTUDIO_CA65_CODE_SEGMENT PRG */

//======================================================================================================================
// 2) AUDIO EXPANSION CONFIGURATION
//
// You can enable up to one audio expansion (FAMISTUDIO_EXP_XXX). Enabling more than one expansion will lead to
// undefined behavior. Memory usage goes up as more complex expansions are used. The audio expansion you choose
// **MUST MATCH** with the data you will load in the engine. Loading a FDS song while enabling VRC6 will lead to
// undefined behavior.
//======================================================================================================================

// Konami VRC6 (2 extra square + saw)
// FAMISTUDIO_EXP_VRC6          = 1

// Rainbow-Net (homebrew clone of VRC6)
// FAMISTUDIO_EXP_RAINBOW       = 1

// Konami VRC7 (6 FM channels)
// FAMISTUDIO_EXP_VRC7          = 1

// Nintendo MMC5 (2 extra squares, extra DPCM not supported)
// FAMISTUDIO_EXP_MMC5          = 1

// Sunsoft S5B (2 extra squares, advanced features not supported.)
// FAMISTUDIO_EXP_S5B           = 1

// Famicom Disk System (extra wavetable channel)
// FAMISTUDIO_EXP_FDS           = 1

// Namco 163 (between 1 and 8 extra wavetable channels) + number of channels.
// FAMISTUDIO_EXP_N163          = 1
// FAMISTUDIO_EXP_N163_CHN_CNT  = 4

// EPSM (Expansion Port Sound Module)
// FAMISTUDIO_EXP_EPSM          = 1
// Fine-tune control for enabling specific channels
// Default values for the channels are to enable all channels.
// FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT     = 3
// FAMISTUDIO_EXP_EPSM_FM_CHN_CNT      = 6
// FAMISTUDIO_EXP_EPSM_RHYTHM_CHN1_ENABLE = 1
// FAMISTUDIO_EXP_EPSM_RHYTHM_CHN2_ENABLE = 1
// FAMISTUDIO_EXP_EPSM_RHYTHM_CHN3_ENABLE = 1
// FAMISTUDIO_EXP_EPSM_RHYTHM_CHN4_ENABLE = 1
// FAMISTUDIO_EXP_EPSM_RHYTHM_CHN5_ENABLE = 1
// FAMISTUDIO_EXP_EPSM_RHYTHM_CHN6_ENABLE = 1

//======================================================================================================================
// 3) GLOBAL ENGINE CONFIGURATION
//
// These are parameters that configures the engine, but are independent of the data you will be importing, such as
// which platform (PAL/NTSC) you want to support playback for, whether SFX are enabled or not, etc. They all have the
// form FAMISTUDIO_CFG_XXX.
//======================================================================================================================

// One of these MUST be defined (PAL or NTSC playback). Note that only NTSC support is supported when using any of the audio expansions.
// FAMISTUDIO_CFG_PAL_SUPPORT   = 1
/* FAMISTUDIO_CFG_NTSC_SUPPORT  = 1 */

// Support for sound effects playback + number of SFX that can play at once.
// FAMISTUDIO_CFG_SFX_SUPPORT   = 1
// FAMISTUDIO_CFG_SFX_STREAMS   = 2

// Blaarg's smooth vibrato technique. Eliminates phase resets ("pops") on square channels.
// FAMISTUDIO_CFG_SMOOTH_VIBRATO = 1

// Enables DPCM playback support.
/* FAMISTUDIO_CFG_DPCM_SUPPORT   = 1 */

// Must be enabled if you are calling sound effects from a different thread than the sound engine update.
// FAMISTUDIO_CFG_THREAD         = 1

// Enable to use the CC65 compatible entrypoints via the provided header file
// FAMISTUDIO_CFG_C_BINDINGS   = 1

//======================================================================================================================
// 4) SUPPORTED FEATURES CONFIGURATION
//
// Every feature supported in FamiStudio is supported by this sound engine. If you know for sure that you are not using
// specific features in your music, you can disable them to save memory/processing time. Using a feature in your song
// and failing to enable it will likely lead to crashes (BRK), or undefined behavior. They all have the form
// FAMISTUDIO_USE_XXX.
//======================================================================================================================

// Must be enabled if the songs you will be importing have been created using FamiTracker tempo mode. If you are using
// FamiStudio tempo mode, this must be undefined. You cannot mix and match tempo modes, the engine can only run in one
// mode or the other.
// More information at: https://famistudio.org/doc/song/#tempo-modes
// FAMISTUDIO_USE_FAMITRACKER_TEMPO = 1

// Must be enabled if the songs uses delayed notes or delayed cuts. This is obviously only available when using
// FamiTracker tempo mode as FamiStudio tempo mode does not need this.
// FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS = 1

// Must be enabled if the songs uses release notes.
// More information at: https://famistudio.org/doc/pianoroll/#release-point
/* FAMISTUDIO_USE_RELEASE_NOTES = 1 */

// Must be enabled if any song uses the volume track. The volume track allows manipulating the volume at the track level
// independently from instruments.
// More information at: https://famistudio.org/doc/pianoroll/#editing-volume-tracks-effects
/* FAMISTUDIO_USE_VOLUME_TRACK      = 1 */

// Must be enabled if any song uses slides on the volume track. Volume track must be enabled too.
// More information at: https://famistudio.org/doc/pianoroll/#editing-volume-tracks-effects
// FAMISTUDIO_USE_VOLUME_SLIDES     = 1

// Must be enabled if any song uses the pitch track. The pitch track allows manipulating the pitch at the track level
// independently from instruments.
// More information at: https://famistudio.org/doc/pianoroll/#pitch
/* FAMISTUDIO_USE_PITCH_TRACK       = 1 */

// Must be enabled if any song uses slide notes. Slide notes allows portamento and slide effects.
// More information at: https://famistudio.org/doc/pianoroll/#slide-notes
/* FAMISTUDIO_USE_SLIDE_NOTES       = 1 */

// Must be enabled if any song uses slide notes on the noise channel too.
// More information at: https://famistudio.org/doc/pianoroll/#slide-notes
// FAMISTUDIO_USE_NOISE_SLIDE_NOTES = 1

// Must be enabled if any song uses the vibrato speed/depth effect track.
// More information at: https://famistudio.org/doc/pianoroll/#vibrato-depth-speed
/* FAMISTUDIO_USE_VIBRATO           = 1 */

// Must be enabled if any song uses arpeggios (not to be confused with instrument arpeggio envelopes, those are always
// supported).
// More information at: (TODO)
/* FAMISTUDIO_USE_ARPEGGIO          = 1 */

// Must be enabled if any song uses the "Duty Cycle" effect (equivalent of FamiTracker Vxx, also called "Timbre").
// FAMISTUDIO_USE_DUTYCYCLE_EFFECT  = 1

// Must be enabled if any song uses the DPCM delta counter. Only makes sense if DPCM samples
// are enabled (FAMISTUDIO_CFG_DPCM_SUPPORT).
// More information at: (TODO)
// FAMISTUDIO_USE_DELTA_COUNTER     = 1

// Must be enabled if your project uses more than 1 bank of DPCM samples.
// When using this, you must implement the "famistudio_dpcm_bank_callback" callback
// and switch to the correct bank every time a sample is played.
// FAMISTUDIO_USE_DPCM_BANKSWITCHING = 1

// Must be enabled if your project uses more than 63 unique DPCM mappings (a mapping is DPCM sample
// assigned to a note, with a specific pitch/loop, etc.). Implied when using FAMISTUDIO_USE_DPCM_BANKSWITCHING.
// FAMISTUDIO_USE_DPCM_EXTENDED_RANGE = 1

// Allows having up to 256 instrument at the cost of slightly higher CPU usage when switching instrument.
// When this is off, the limit is 64 for regular instruments and 32 for expansion instrumnets.
// FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE = 1

// Must be enabled if your project uses the "Phase Reset" effect.
// FAMISTUDIO_USE_PHASE_RESET = 1

// Must be enabled if your project uses the FDS expansion and at least one instrument with FDS Auto-Mod enabled.
// FAMISTUDIO_USE_FDS_AUTOMOD  = 1

}

// Memory location of the DPCM samples. Must be between $c000 and $ffc0, and a multiple of 64.
if (ndef FAMISTUDIO_DPCM_OFF) {
/* FAMISTUDIO_DPCM_OFF = $c000 */
}

//======================================================================================================================
// END OF CONFIGURATION
//
// Ideally, you should not have to change anything below this line.
//======================================================================================================================

//======================================================================================================================
// INTERNAL DEFINES (Do not touch)
//======================================================================================================================

if (ndef FAMISTUDIO_EXP_RAINBOW) {
/* FAMISTUDIO_EXP_RAINBOW = 0 */
}

if (FAMISTUDIO_EXP_RAINBOW) {
/* FAMISTUDIO_EXP_VRC6 = 1 */
}

if (ndef FAMISTUDIO_EXP_VRC6) {
/* FAMISTUDIO_EXP_VRC6 = 0 */
}

if (ndef FAMISTUDIO_EXP_VRC7) {
/* FAMISTUDIO_EXP_VRC7 = 0 */
}

if (ndef FAMISTUDIO_EXP_EPSM) {
/* FAMISTUDIO_EXP_EPSM = 0 */
/* FAMISTUDIO_EXP_EPSM_ENV_CNT = 0 */
/* FAMISTUDIO_EXP_EPSM_RHYTHM_CNT = 0 */
/* FAMISTUDIO_EXP_EPSM_FM_CHN_CNT = 0 */
/* FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT = 0 */
/* FAMISTUDIO_EXP_EPSM_TRIG_CHN = 0 */
} else {
    if (ndef FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT) {
/* FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT     = 3 */
    }
    if (ndef FAMISTUDIO_EXP_EPSM_FM_CHN_CNT) {
/* FAMISTUDIO_EXP_EPSM_FM_CHN_CNT      = 6 */
    }
    if (ndef FAMISTUDIO_EXP_EPSM_RHYTHM_CHN1_ENABLE) {
/* FAMISTUDIO_EXP_EPSM_RHYTHM_CHN1_ENABLE = 1 */
    }
    if (ndef FAMISTUDIO_EXP_EPSM_RHYTHM_CHN2_ENABLE) {
/* FAMISTUDIO_EXP_EPSM_RHYTHM_CHN2_ENABLE = 1 */
    }
    if (ndef FAMISTUDIO_EXP_EPSM_RHYTHM_CHN3_ENABLE) {
/* FAMISTUDIO_EXP_EPSM_RHYTHM_CHN3_ENABLE = 1 */
    }
    if (ndef FAMISTUDIO_EXP_EPSM_RHYTHM_CHN4_ENABLE) {
/* FAMISTUDIO_EXP_EPSM_RHYTHM_CHN4_ENABLE = 1 */
    }
    if (ndef FAMISTUDIO_EXP_EPSM_RHYTHM_CHN5_ENABLE) {
/* FAMISTUDIO_EXP_EPSM_RHYTHM_CHN5_ENABLE = 1 */
    }
    if (ndef FAMISTUDIO_EXP_EPSM_RHYTHM_CHN6_ENABLE) {
/* FAMISTUDIO_EXP_EPSM_RHYTHM_CHN6_ENABLE = 1 */
    }
}

if (ndef FAMISTUDIO_EXP_MMC5) {
/* FAMISTUDIO_EXP_MMC5 = 0 */
}

if (ndef FAMISTUDIO_EXP_S5B) {
/* FAMISTUDIO_EXP_S5B = 0 */
}

if (ndef FAMISTUDIO_EXP_FDS) {
/* FAMISTUDIO_EXP_FDS = 0 */
}

if (ndef FAMISTUDIO_EXP_N163) {
/* FAMISTUDIO_EXP_N163 = 0 */
}

if (ndef FAMISTUDIO_EXP_N163_CHN_CNT) {
/* FAMISTUDIO_EXP_N163_CHN_CNT = 1 */
}

if (ndef FAMISTUDIO_CFG_PAL_SUPPORT) {
/* FAMISTUDIO_CFG_PAL_SUPPORT = 0 */
}

if (ndef FAMISTUDIO_CFG_NTSC_SUPPORT) {
    if (FAMISTUDIO_CFG_PAL_SUPPORT) {
/* FAMISTUDIO_CFG_NTSC_SUPPORT = 0 */
    } else {
/* FAMISTUDIO_CFG_NTSC_SUPPORT = 1 */
    }
}

if (FAMISTUDIO_CFG_NTSC_SUPPORT && FAMISTUDIO_CFG_PAL_SUPPORT) {
/* FAMISTUDIO_DUAL_SUPPORT = 1 */
} else {
/* FAMISTUDIO_DUAL_SUPPORT = 0 */
}

if (ndef FAMISTUDIO_CFG_SFX_SUPPORT) {
/* FAMISTUDIO_CFG_SFX_SUPPORT = 0 */
/* FAMISTUDIO_CFG_SFX_STREAMS = 0 */
}

if (ndef FAMISTUDIO_CFG_SFX_STREAMS) {
/* FAMISTUDIO_CFG_SFX_STREAMS = 1 */
}

if (ndef FAMISTUDIO_CFG_C_BINDINGS) {
/* FAMISTUDIO_CFG_C_BINDINGS = 0 */
}

if (ndef FAMISTUDIO_CFG_SMOOTH_VIBRATO) {
/* FAMISTUDIO_CFG_SMOOTH_VIBRATO = 0 */
}

if (ndef FAMISTUDIO_CFG_DPCM_SUPPORT) {
/* FAMISTUDIO_CFG_DPCM_SUPPORT = 0 */
}

if (ndef FAMISTUDIO_CFG_EQUALIZER) {
/* FAMISTUDIO_CFG_EQUALIZER = 0 */
}

if (ndef FAMISTUDIO_USE_FAMITRACKER_TEMPO) {
/* FAMISTUDIO_USE_FAMITRACKER_TEMPO = 0 */
}

if (ndef FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS) {
/* FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS = 0 */
}

if (ndef FAMISTUDIO_USE_VOLUME_TRACK) {
/* FAMISTUDIO_USE_VOLUME_TRACK = 0 */
}

if (ndef FAMISTUDIO_USE_VOLUME_SLIDES) {
/* FAMISTUDIO_USE_VOLUME_SLIDES = 0 */
}

if (ndef FAMISTUDIO_USE_PITCH_TRACK) {
/* FAMISTUDIO_USE_PITCH_TRACK = 0 */
}

if (ndef FAMISTUDIO_USE_SLIDE_NOTES) {
/* FAMISTUDIO_USE_SLIDE_NOTES = 0 */
}

if (ndef FAMISTUDIO_USE_NOISE_SLIDE_NOTES) {
/* FAMISTUDIO_USE_NOISE_SLIDE_NOTES = 0 */
}

if (ndef FAMISTUDIO_USE_VIBRATO) {
/* FAMISTUDIO_USE_VIBRATO = 0 */
}

if (ndef FAMISTUDIO_USE_ARPEGGIO) {
/* FAMISTUDIO_USE_ARPEGGIO = 0 */
}

if (ndef FAMISTUDIO_USE_DUTYCYCLE_EFFECT) {
/* FAMISTUDIO_USE_DUTYCYCLE_EFFECT = 0 */
}

if (ndef FAMISTUDIO_USE_DELTA_COUNTER) {
/* FAMISTUDIO_USE_DELTA_COUNTER = 0 */
}

if (ndef FAMISTUDIO_USE_PHASE_RESET) {
/* FAMISTUDIO_USE_PHASE_RESET = 0 */
}

if (ndef FAMISTUDIO_USE_FDS_AUTOMOD) {
/* FAMISTUDIO_USE_FDS_AUTOMOD = 0 */
}

if (ndef FAMISTUDIO_USE_RELEASE_NOTES) {
/* FAMISTUDIO_USE_RELEASE_NOTES = 0 */
}

if (ndef FAMISTUDIO_USE_DPCM_EXTENDED_RANGE) {
/* FAMISTUDIO_USE_DPCM_EXTENDED_RANGE = 0 */
}

if (ndef FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE) {
/* FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE = 0 */
}

if (ndef FAMISTUDIO_USE_DPCM_BANKSWITCHING) {
/* FAMISTUDIO_USE_DPCM_BANKSWITCHING = 0 */
}

if (ndef FAMISTUDIO_CFG_THREAD) {
/* FAMISTUDIO_CFG_THREAD = 0 */
}

if ((FAMISTUDIO_EXP_VRC6 + FAMISTUDIO_EXP_VRC7 + FAMISTUDIO_EXP_EPSM + FAMISTUDIO_EXP_MMC5 + FAMISTUDIO_EXP_S5B + FAMISTUDIO_EXP_FDS + FAMISTUDIO_EXP_N163) = 0) {
/* FAMISTUDIO_EXP_NONE = 1 */
} else {
/* FAMISTUDIO_EXP_NONE = 0 */
}

if ((FAMISTUDIO_EXP_VRC7 + FAMISTUDIO_EXP_EPSM + FAMISTUDIO_EXP_N163 + FAMISTUDIO_EXP_FDS + FAMISTUDIO_EXP_S5B)) {
/* FAMISTUDIO_EXP_NOTE_START = 5 */
}
if (FAMISTUDIO_EXP_VRC6) {
/* FAMISTUDIO_EXP_NOTE_START = 7 */
}

if (FAMISTUDIO_USE_NOISE_SLIDE_NOTES && (FAMISTUDIO_USE_SLIDE_NOTES = 0)) {
/* .error "Noise slide notes can only be used when regular slide notes are enabled too." */
}

if (FAMISTUDIO_USE_VOLUME_SLIDES && (FAMISTUDIO_USE_VOLUME_TRACK = 0)) {
/* .error "Volume slides can only be used when the volume track is enabled too." */
}

if (FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS && (FAMISTUDIO_USE_FAMITRACKER_TEMPO = 0)) {
/* .error "Delayed notes or cuts only make sense when using FamiTracker tempo." */
}

if ((FAMISTUDIO_EXP_VRC6 + FAMISTUDIO_EXP_VRC7 + FAMISTUDIO_EXP_EPSM + FAMISTUDIO_EXP_MMC5 + FAMISTUDIO_EXP_S5B + FAMISTUDIO_EXP_FDS + FAMISTUDIO_EXP_N163) > 1) {
/* .error "Only one audio expansion can be enabled." */
}

if (FAMISTUDIO_EXP_N163 && ((FAMISTUDIO_EXP_N163_CHN_CNT < 1) || (FAMISTUDIO_EXP_N163_CHN_CNT > 8))) {
/* .error "N163 only supports between 1 and 8 channels." */
}

if (FAMISTUDIO_USE_DELTA_COUNTER && (FAMISTUDIO_CFG_DPCM_SUPPORT = 0)) {
/* .error "Delta counter only makes sense if DPCM samples are enabled." */
}

if (FAMISTUDIO_USE_DPCM_BANKSWITCHING && (FAMISTUDIO_CFG_DPCM_SUPPORT = 0)) {
/* .error "DPCM bankswitching only makes sense if DPCM samples are enabled." */
}

// This is the best way i found to test if a C-style macro is defined or not...
if (.xmatch(.string(FAMISTUDIO_CA65_ZP_SEGMENT), "FAMISTUDIO_CA65_ZP_SEGMENT")) {
/* .error "You must .define FAMISTUDIO_CA65_ZP_SEGMENT with the name of your zeropage segment." */
}

if (.xmatch(.string(FAMISTUDIO_CA65_RAM_SEGMENT), "FAMISTUDIO_CA65_RAM_SEGMENT")) {
/* .error "You must .define FAMISTUDIO_CA65_RAM_SEGMENT with the name of your RAM/BSS segment." */
}

if (.xmatch(.string(FAMISTUDIO_CA65_CODE_SEGMENT), "FAMISTUDIO_CA65_CODE_SEGMENT")) {
/* .error "You must .define FAMISTUDIO_CA65_CODE_SEGMENT with the name of your CODE/PRG segment." */
}

/* FAMISTUDIO_DPCM_PTR = (FAMISTUDIO_DPCM_OFF & $3fff) >> 6 */

if (FAMISTUDIO_EXP_NONE) {
/* FAMISTUDIO_NUM_ENVELOPES        = 3+3+2+3 */
/* FAMISTUDIO_NUM_PITCH_ENVELOPES  = 3 */
/* FAMISTUDIO_NUM_CHANNELS         = 5 */
/* FAMISTUDIO_NUM_DUTY_CYCLES      = 3 */
}
if (FAMISTUDIO_EXP_VRC6) {
/* FAMISTUDIO_NUM_ENVELOPES        = 3+3+2+3+3+3+3 */
/* FAMISTUDIO_NUM_PITCH_ENVELOPES  = 6 */
/* FAMISTUDIO_NUM_CHANNELS         = 8 */
/* FAMISTUDIO_NUM_DUTY_CYCLES      = 6 */
}
if (FAMISTUDIO_EXP_VRC7) {
/* FAMISTUDIO_NUM_ENVELOPES        = 3+3+2+3+2+2+2+2+2+2 */
/* FAMISTUDIO_NUM_PITCH_ENVELOPES  = 9 */
/* FAMISTUDIO_NUM_CHANNELS         = 11 */
/* FAMISTUDIO_NUM_DUTY_CYCLES      = 3 */
}
if (FAMISTUDIO_EXP_EPSM) {
/* FAMISTUDIO_EXP_EPSM_RHYTHM_CNT  = FAMISTUDIO_EXP_EPSM_RHYTHM_CHN1_ENABLE + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN2_ENABLE + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN3_ENABLE + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN4_ENABLE + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN5_ENABLE + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN6_ENABLE */
/* FAMISTUDIO_EXP_EPSM_ENV_CNT     = FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT + FAMISTUDIO_EXP_EPSM_FM_CHN_CNT */
/* FAMISTUDIO_EXP_EPSM_CHANNELS    = FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT + FAMISTUDIO_EXP_EPSM_FM_CHN_CNT + FAMISTUDIO_EXP_EPSM_RHYTHM_CNT */
/* FAMISTUDIO_EXP_EPSM_TRIG_CHN    = FAMISTUDIO_EXP_EPSM_FM_CHN_CNT + FAMISTUDIO_EXP_EPSM_RHYTHM_CNT */

/* FAMISTUDIO_NUM_ENVELOPES        = 3+3+2+3+(FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT * 4) + (FAMISTUDIO_EXP_EPSM_FM_CHN_CNT * 2) */
/* FAMISTUDIO_NUM_PITCH_ENVELOPES  = 3 + FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT + FAMISTUDIO_EXP_EPSM_FM_CHN_CNT */
/* FAMISTUDIO_NUM_CHANNELS         = 5 + FAMISTUDIO_EXP_EPSM_CHANNELS */
/* FAMISTUDIO_NUM_DUTY_CYCLES      = 3 */
}
if (FAMISTUDIO_EXP_FDS) {
/* FAMISTUDIO_NUM_ENVELOPES        = 3+3+2+3+2 */
/* FAMISTUDIO_NUM_PITCH_ENVELOPES  = 4 */
/* FAMISTUDIO_NUM_CHANNELS         = 6 */
/* FAMISTUDIO_NUM_DUTY_CYCLES      = 3 */
}
if (FAMISTUDIO_EXP_MMC5) {
/* FAMISTUDIO_NUM_ENVELOPES        = 3+3+2+3+3+3 */
/* FAMISTUDIO_NUM_PITCH_ENVELOPES  = 5 */
/* FAMISTUDIO_NUM_CHANNELS         = 7 */
/* FAMISTUDIO_NUM_DUTY_CYCLES      = 5 */
}
if (FAMISTUDIO_EXP_N163) {
/* FAMISTUDIO_NUM_ENVELOPES        = 3+3+2+3+(FAMISTUDIO_EXP_N163_CHN_CNT*3) */
/* FAMISTUDIO_NUM_PITCH_ENVELOPES  = 3+FAMISTUDIO_EXP_N163_CHN_CNT */
/* FAMISTUDIO_NUM_CHANNELS         = 5+FAMISTUDIO_EXP_N163_CHN_CNT */
/* FAMISTUDIO_NUM_DUTY_CYCLES      = 3 */
}
if (FAMISTUDIO_EXP_S5B) {
/* FAMISTUDIO_NUM_ENVELOPES        = 3+3+2+3+4+4+4 */
/* FAMISTUDIO_NUM_PITCH_ENVELOPES  = 6 */
/* FAMISTUDIO_NUM_CHANNELS         = 8 */
/* FAMISTUDIO_NUM_DUTY_CYCLES      = 3 */
}

if (FAMISTUDIO_EXP_NONE) {
/* FAMISTUDIO_NUM_VOLUME_SLIDES = 4 */
} else {
/* FAMISTUDIO_NUM_VOLUME_SLIDES = FAMISTUDIO_NUM_CHANNELS ; DPCM volume is unused. */
}

if (FAMISTUDIO_USE_NOISE_SLIDE_NOTES) {
/* FAMISTUDIO_NUM_SLIDES = FAMISTUDIO_NUM_PITCH_ENVELOPES + 1 */
} else {
/* FAMISTUDIO_NUM_SLIDES = FAMISTUDIO_NUM_PITCH_ENVELOPES */
}

// Keep the noise slide at the end so the pitch envelopes/slides are in sync.
/* FAMISTUDIO_NOISE_SLIDE_INDEX = FAMISTUDIO_NUM_SLIDES - 1 */

if (FAMISTUDIO_EXP_VRC6) {
/* FAMISTUDIO_VRC6_CH0_PITCH_ENV_IDX = 3 */
/* FAMISTUDIO_VRC6_CH1_PITCH_ENV_IDX = 4 */
/* FAMISTUDIO_VRC6_CH2_PITCH_ENV_IDX = 5 */
}
if (FAMISTUDIO_EXP_VRC7) {
/* FAMISTUDIO_VRC7_CH0_PITCH_ENV_IDX = 3 */
/* FAMISTUDIO_VRC7_CH1_PITCH_ENV_IDX = 4 */
/* FAMISTUDIO_VRC7_CH2_PITCH_ENV_IDX = 5 */
/* FAMISTUDIO_VRC7_CH3_PITCH_ENV_IDX = 6 */
/* FAMISTUDIO_VRC7_CH4_PITCH_ENV_IDX = 7 */
/* FAMISTUDIO_VRC7_CH5_PITCH_ENV_IDX = 8 */
}
if (FAMISTUDIO_EXP_FDS) {
/* FAMISTUDIO_FDS_CH0_PITCH_ENV_IDX  = 3 */
}
if (FAMISTUDIO_EXP_MMC5) {
/* FAMISTUDIO_MMC5_CH0_PITCH_ENV_IDX = 3 */
/* FAMISTUDIO_MMC5_CH1_PITCH_ENV_IDX = 4 */
}
if (FAMISTUDIO_EXP_N163) {
/* FAMISTUDIO_N163_CH0_PITCH_ENV_IDX = 3 */
/* FAMISTUDIO_N163_CH1_PITCH_ENV_IDX = 4 */
/* FAMISTUDIO_N163_CH2_PITCH_ENV_IDX = 5 */
/* FAMISTUDIO_N163_CH3_PITCH_ENV_IDX = 6 */
/* FAMISTUDIO_N163_CH4_PITCH_ENV_IDX = 7 */
/* FAMISTUDIO_N163_CH5_PITCH_ENV_IDX = 8 */
/* FAMISTUDIO_N163_CH6_PITCH_ENV_IDX = 9 */
/* FAMISTUDIO_N163_CH7_PITCH_ENV_IDX = 10 */
}
if (FAMISTUDIO_EXP_S5B) {
/* FAMISTUDIO_S5B_CH0_PITCH_ENV_IDX  = 3 */
/* FAMISTUDIO_S5B_CH1_PITCH_ENV_IDX  = 4 */
/* FAMISTUDIO_S5B_CH2_PITCH_ENV_IDX  = 5 */
}
if (FAMISTUDIO_EXP_EPSM) {
/* FAMISTUDIO_EPSM_CH0_PITCH_ENV_IDX = 3 */
/* FAMISTUDIO_EPSM_CH1_PITCH_ENV_IDX = 4 */
/* FAMISTUDIO_EPSM_CH2_PITCH_ENV_IDX = 5 */
/* FAMISTUDIO_EPSM_CH3_PITCH_ENV_IDX = 6 */
/* FAMISTUDIO_EPSM_CH4_PITCH_ENV_IDX = 7 */
/* FAMISTUDIO_EPSM_CH5_PITCH_ENV_IDX = 8 */
/* FAMISTUDIO_EPSM_CH6_PITCH_ENV_IDX = 9 */
/* FAMISTUDIO_EPSM_CH7_PITCH_ENV_IDX = 10 */
/* FAMISTUDIO_EPSM_CH8_PITCH_ENV_IDX = 11 */
}

// TODO: Investigate reshuffling the envelopes to keep them contiguously
// by type (all volumes envelopes, all arp envelopes, etc.) instead of
// by channel. This *may* simplify a lot of places where we need a lookup
// table (famistudio_channel_to_volume_env, etc.)
/* FAMISTUDIO_CH0_ENVS = 0 */
/* FAMISTUDIO_CH1_ENVS = 3 */
/* FAMISTUDIO_CH2_ENVS = 6 */
/* FAMISTUDIO_CH3_ENVS = 8 */

if (FAMISTUDIO_EXP_VRC6) {
/* FAMISTUDIO_VRC6_CH0_ENVS = 11 */
/* FAMISTUDIO_VRC6_CH1_ENVS = 14 */
/* FAMISTUDIO_VRC6_CH2_ENVS = 17 */
}
if (FAMISTUDIO_EXP_VRC7) {
/* FAMISTUDIO_VRC7_CH0_ENVS = 11 */
/* FAMISTUDIO_VRC7_CH1_ENVS = 13 */
/* FAMISTUDIO_VRC7_CH2_ENVS = 15 */
/* FAMISTUDIO_VRC7_CH3_ENVS = 17 */
/* FAMISTUDIO_VRC7_CH4_ENVS = 19 */
/* FAMISTUDIO_VRC7_CH5_ENVS = 21 */
}
if (FAMISTUDIO_EXP_FDS) {
/* FAMISTUDIO_FDS_CH0_ENVS = 11 */
}
if (FAMISTUDIO_EXP_MMC5) {
/* FAMISTUDIO_MMC5_CH0_ENVS = 11 */
/* FAMISTUDIO_MMC5_CH1_ENVS = 14 */
}
if (FAMISTUDIO_EXP_N163) {
/* FAMISTUDIO_N163_CH0_ENVS = 11 */
/* FAMISTUDIO_N163_CH1_ENVS = 14 */
/* FAMISTUDIO_N163_CH2_ENVS = 17 */
/* FAMISTUDIO_N163_CH3_ENVS = 20 */
/* FAMISTUDIO_N163_CH4_ENVS = 23 */
/* FAMISTUDIO_N163_CH5_ENVS = 26 */
/* FAMISTUDIO_N163_CH6_ENVS = 29 */
/* FAMISTUDIO_N163_CH7_ENVS = 32 */
}
if (FAMISTUDIO_EXP_S5B) {
/* FAMISTUDIO_S5B_CH0_ENVS = 11 */
/* FAMISTUDIO_S5B_CH1_ENVS = 15 */
/* FAMISTUDIO_S5B_CH2_ENVS = 19 */
}
if (FAMISTUDIO_EXP_EPSM) {
if (FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0) {
/* EPSM_ENV_CH1_INCREMENT = 4 */
} else {
/* EPSM_ENV_CH1_INCREMENT = 2 */
}
if (FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 1) {
/* EPSM_ENV_CH2_INCREMENT = 4 */
} else {
/* EPSM_ENV_CH2_INCREMENT = 2 */
}
if (FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 2) {
/* EPSM_ENV_CH3_INCREMENT = 4 */
} else {
/* EPSM_ENV_CH3_INCREMENT = 2 */
}
/* FAMISTUDIO_EPSM_CH0_ENVS = 11 */
/* FAMISTUDIO_EPSM_CH1_ENVS =  FAMISTUDIO_EPSM_CH0_ENVS + EPSM_ENV_CH1_INCREMENT */
/* FAMISTUDIO_EPSM_CH2_ENVS =  FAMISTUDIO_EPSM_CH1_ENVS + EPSM_ENV_CH2_INCREMENT */
/* FAMISTUDIO_EPSM_CH3_ENVS =  FAMISTUDIO_EPSM_CH2_ENVS + EPSM_ENV_CH3_INCREMENT */
/* FAMISTUDIO_EPSM_CH4_ENVS =  FAMISTUDIO_EPSM_CH3_ENVS + 2 */
/* FAMISTUDIO_EPSM_CH5_ENVS =  FAMISTUDIO_EPSM_CH4_ENVS + 2 */
/* FAMISTUDIO_EPSM_CH6_ENVS =  FAMISTUDIO_EPSM_CH5_ENVS + 2 */
/* FAMISTUDIO_EPSM_CH7_ENVS =  FAMISTUDIO_EPSM_CH6_ENVS + 2 */
/* FAMISTUDIO_EPSM_CH8_ENVS =  FAMISTUDIO_EPSM_CH7_ENVS + 2 */
}

/* FAMISTUDIO_ENV_VOLUME_OFF        = 0 */
/* FAMISTUDIO_ENV_NOTE_OFF          = 1 */
/* FAMISTUDIO_ENV_DUTY_OFF          = 2 */
/* FAMISTUDIO_ENV_N163_WAVE_IDX_OFF = 2 */
/* FAMISTUDIO_ENV_MIXER_IDX_OFF     = 2 */
/* FAMISTUDIO_ENV_NOISE_IDX_OFF     = 3 */

if (FAMISTUDIO_EXP_VRC6) {
/* FAMISTUDIO_VRC6_CH0_DUTY_IDX = 3 */
/* FAMISTUDIO_VRC6_CH1_DUTY_IDX = 4 */
/* FAMISTUDIO_VRC6_CH2_DUTY_IDX = 5 */
}
if (FAMISTUDIO_EXP_MMC5) {
/* FAMISTUDIO_MMC5_CH0_DUTY_IDX = 3 */
/* FAMISTUDIO_MMC5_CH1_DUTY_IDX = 4 */
}

if (FAMISTUDIO_EXP_VRC6) {
/* FAMISTUDIO_VRC6_CH0_IDX = 5 */
/* FAMISTUDIO_VRC6_CH1_IDX = 6 */
/* FAMISTUDIO_VRC6_CH2_IDX = 7 */
} else {
/* FAMISTUDIO_VRC6_CH0_IDX = -1 */
/* FAMISTUDIO_VRC6_CH1_IDX = -1 */
/* FAMISTUDIO_VRC6_CH2_IDX = -1 */
}
if (FAMISTUDIO_EXP_VRC7) {
/* FAMISTUDIO_VRC7_CH0_IDX = 5 */
/* FAMISTUDIO_VRC7_CH1_IDX = 6 */
/* FAMISTUDIO_VRC7_CH2_IDX = 7 */
/* FAMISTUDIO_VRC7_CH3_IDX = 8 */
/* FAMISTUDIO_VRC7_CH4_IDX = 9 */
/* FAMISTUDIO_VRC7_CH5_IDX = 10 */
}
if (FAMISTUDIO_EXP_FDS) {
/* FAMISTUDIO_FDS_CH0_IDX  = 5 */
}
if (FAMISTUDIO_EXP_MMC5) {
/* FAMISTUDIO_MMC5_CH0_IDX = 5 */
/* FAMISTUDIO_MMC5_CH1_IDX = 6 */
} else {
/* FAMISTUDIO_MMC5_CH0_IDX = -1 */
/* FAMISTUDIO_MMC5_CH1_IDX = -1 */
}
if (FAMISTUDIO_EXP_N163) {
/* FAMISTUDIO_N163_CH0_IDX = 5 */
/* FAMISTUDIO_N163_CH1_IDX = 6 */
/* FAMISTUDIO_N163_CH2_IDX = 7 */
/* FAMISTUDIO_N163_CH3_IDX = 8 */
/* FAMISTUDIO_N163_CH4_IDX = 9 */
/* FAMISTUDIO_N163_CH5_IDX = 10 */
/* FAMISTUDIO_N163_CH6_IDX = 11 */
/* FAMISTUDIO_N163_CH7_IDX = 12 */
}
if (FAMISTUDIO_EXP_S5B) {
/* FAMISTUDIO_S5B_CH0_IDX  = 5 */
/* FAMISTUDIO_S5B_CH1_IDX  = 6 */
/* FAMISTUDIO_S5B_CH2_IDX  = 7 */
}
if (FAMISTUDIO_EXP_EPSM) {
/* FAMISTUDIO_EPSM_CH0_IDX = 5 */
/* FAMISTUDIO_EPSM_CH1_IDX = 6 */
/* FAMISTUDIO_EPSM_CH2_IDX = 7 */
/* FAMISTUDIO_EPSM_CH3_IDX = 8 */
/* FAMISTUDIO_EPSM_CH4_IDX = 9 */
/* FAMISTUDIO_EPSM_CH5_IDX = 10 */
/* FAMISTUDIO_EPSM_CH6_IDX = 11 */
/* FAMISTUDIO_EPSM_CH7_IDX = 12 */
/* FAMISTUDIO_EPSM_CH8_IDX = 13 */
/* FAMISTUDIO_EPSM_CH9_IDX = 14 */
/* FAMISTUDIO_EPSM_CH10_IDX = 15 */
/* FAMISTUDIO_EPSM_CH11_IDX = 16 */
/* FAMISTUDIO_EPSM_CH12_IDX = 17 */
/* FAMISTUDIO_EPSM_CH13_IDX = 18 */
/* FAMISTUDIO_EPSM_CH14_IDX = 19 */
/* FAMISTUDIO_EPSM_CHAN_FM_START = FAMISTUDIO_EPSM_CH0_IDX + FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT */
/* FAMISTUDIO_EPSM_CHAN_RHYTHM_START = FAMISTUDIO_EPSM_CHAN_FM_START + FAMISTUDIO_EXP_EPSM_FM_CHN_CNT */
}

/* FAMISTUDIO_VRC7_PITCH_SHIFT = 3 */
/* FAMISTUDIO_EPSM_PITCH_SHIFT = 3 */

if ((FAMISTUDIO_EXP_N163_CHN_CNT > 4)) {
/* FAMISTUDIO_N163_PITCH_SHIFT = 5 */
}
if ((FAMISTUDIO_EXP_N163_CHN_CNT > 2) & (FAMISTUDIO_EXP_N163_CHN_CNT <= 4)) {
/* FAMISTUDIO_N163_PITCH_SHIFT = 4 */
}
if ((FAMISTUDIO_EXP_N163_CHN_CNT > 1) & (FAMISTUDIO_EXP_N163_CHN_CNT <= 2)) {
/* FAMISTUDIO_N163_PITCH_SHIFT = 3 */
}
if ((FAMISTUDIO_EXP_N163_CHN_CNT = 1)) {
/* FAMISTUDIO_N163_PITCH_SHIFT = 2 */
}

if (FAMISTUDIO_EXP_VRC7) {
/* FAMISTUDIO_PITCH_SHIFT = FAMISTUDIO_VRC7_PITCH_SHIFT */
} else {
    if (FAMISTUDIO_EXP_EPSM) {
/* FAMISTUDIO_PITCH_SHIFT = FAMISTUDIO_EPSM_PITCH_SHIFT */
    } else {
        if (FAMISTUDIO_EXP_N163) {
/* FAMISTUDIO_PITCH_SHIFT = FAMISTUDIO_N163_PITCH_SHIFT */
        } else {
/* FAMISTUDIO_PITCH_SHIFT = 0 */
        }
    }
}

if (FAMISTUDIO_EXP_N163) {
/* FAMISTUDIO_N163_CHN_MASK = (FAMISTUDIO_EXP_N163_CHN_CNT - 1) << 4 */
}

if (FAMISTUDIO_CFG_SFX_SUPPORT) {
/* FAMISTUDIO_SFX_STRUCT_SIZE = 15 */

/* FAMISTUDIO_SFX_CH0 = FAMISTUDIO_SFX_STRUCT_SIZE * 0 */
/* FAMISTUDIO_SFX_CH1 = FAMISTUDIO_SFX_STRUCT_SIZE * 1 */
/* FAMISTUDIO_SFX_CH2 = FAMISTUDIO_SFX_STRUCT_SIZE * 2 */
/* FAMISTUDIO_SFX_CH3 = FAMISTUDIO_SFX_STRUCT_SIZE * 3 */
}

/* FAMISTUDIO_FIRST_EXP_INST_CHANNEL = 5 */

if (FAMISTUDIO_EXP_EPSM) {
/* FAMISTUDIO_FIRST_POSITIVE_SLIDE_CHANNEL = 3 + FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT */
} else {
/* FAMISTUDIO_FIRST_POSITIVE_SLIDE_CHANNEL = 3 */
}

//======================================================================================================================
// RAM VARIABLES (You should not have to play with these)
//======================================================================================================================

/* .segment .string(FAMISTUDIO_CA65_RAM_SEGMENT) */

/* famistudio_env_value:             .res FAMISTUDIO_NUM_ENVELOPES */
/* famistudio_env_repeat:            .res FAMISTUDIO_NUM_ENVELOPES */
/* famistudio_env_addr_lo:           .res FAMISTUDIO_NUM_ENVELOPES */
/* famistudio_env_addr_hi:           .res FAMISTUDIO_NUM_ENVELOPES */
/* famistudio_env_ptr:               .res FAMISTUDIO_NUM_ENVELOPES */

/* famistudio_pitch_env_value_lo:    .res FAMISTUDIO_NUM_PITCH_ENVELOPES */
/* famistudio_pitch_env_value_hi:    .res FAMISTUDIO_NUM_PITCH_ENVELOPES */
/* famistudio_pitch_env_repeat:      .res FAMISTUDIO_NUM_PITCH_ENVELOPES */
/* famistudio_pitch_env_addr_lo:     .res FAMISTUDIO_NUM_PITCH_ENVELOPES */
/* famistudio_pitch_env_addr_hi:     .res FAMISTUDIO_NUM_PITCH_ENVELOPES */
/* famistudio_pitch_env_ptr:         .res FAMISTUDIO_NUM_PITCH_ENVELOPES */
if (FAMISTUDIO_USE_PITCH_TRACK) {
/* famistudio_pitch_env_fine_value:  .res FAMISTUDIO_NUM_PITCH_ENVELOPES */
}

if (FAMISTUDIO_USE_SLIDE_NOTES) {
/* famistudio_slide_step:            .res FAMISTUDIO_NUM_SLIDES */
/* famistudio_slide_pitch_lo:        .res FAMISTUDIO_NUM_SLIDES */
/* famistudio_slide_pitch_hi:        .res FAMISTUDIO_NUM_SLIDES */
}

/* famistudio_chn_ptr_lo:            .res FAMISTUDIO_NUM_CHANNELS */
/* famistudio_chn_ptr_hi:            .res FAMISTUDIO_NUM_CHANNELS */
/* famistudio_chn_note:              .res FAMISTUDIO_NUM_CHANNELS */
/* famistudio_chn_repeat:            .res FAMISTUDIO_NUM_CHANNELS */
/* famistudio_chn_return_lo:         .res FAMISTUDIO_NUM_CHANNELS */
/* famistudio_chn_return_hi:         .res FAMISTUDIO_NUM_CHANNELS */
/* famistudio_chn_ref_len:           .res FAMISTUDIO_NUM_CHANNELS */
if (FAMISTUDIO_USE_VOLUME_TRACK) {
/* famistudio_chn_volume_track:      .res FAMISTUDIO_NUM_CHANNELS */
if (FAMISTUDIO_USE_VOLUME_SLIDES) {
/* famistudio_chn_volume_slide_step:   .res FAMISTUDIO_NUM_VOLUME_SLIDES */
/* famistudio_chn_volume_slide_target: .res FAMISTUDIO_NUM_VOLUME_SLIDES */
}
}
if (FAMISTUDIO_USE_VIBRATO || FAMISTUDIO_USE_ARPEGGIO) {
/* famistudio_chn_env_override:      .res FAMISTUDIO_NUM_CHANNELS ; bit 7 = pitch, bit 0 = arpeggio. */
}
if (FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS) {
/* famistudio_chn_note_delay:        .res FAMISTUDIO_NUM_CHANNELS */
/* famistudio_chn_cut_delay:         .res FAMISTUDIO_NUM_CHANNELS */
}
if (FAMISTUDIO_CFG_EQUALIZER) {
/* famistudio_chn_note_counter:      .res FAMISTUDIO_NUM_CHANNELS */
}
if (FAMISTUDIO_USE_PHASE_RESET) {
/* famistudio_phase_reset:           .res 1 ; bit 0/1 = 2a03, bit 2/3/4 = vrc6, 5/6 = mmc5, bit 7 = fds */
if (FAMISTUDIO_EXP_N163) {
/* famistudio_phase_reset_n163:      .res 1 ; bit 0...7 = n163 */
}
}
if (FAMISTUDIO_USE_DELTA_COUNTER) {
/* famistudio_dmc_delta_counter:     .res 1 */
}
if (FAMISTUDIO_EXP_VRC6) {
/* famistudio_vrc6_saw_volume:       .res 1 ; -1 = 1/4, 0 = 1/2, 1 = Full */
if (FAMISTUDIO_USE_PHASE_RESET) {
/* famistudio_vrc6_pulse1_prev_hi:   .res 1 */
/* famistudio_vrc6_pulse2_prev_hi:   .res 1 */
/* famistudio_vrc6_saw_prev_hi:      .res 1 */
} else {
/* famistudio_vrc6_pulse1_prev_hi = famistudio_vrc6_saw_volume */
/* famistudio_vrc6_pulse2_prev_hi = famistudio_vrc6_saw_volume */
/* famistudio_vrc6_saw_prev_hi    = famistudio_vrc6_saw_volume */
}
}
if (FAMISTUDIO_EXP_VRC7) {
/* famistudio_chn_vrc7_prev_hi:      .res 6 */
/* famistudio_chn_vrc7_patch:        .res 6 */
/* famistudio_chn_vrc7_trigger:      .res 6 ; bit 0 = new note triggered, bit 7 = note released. */
}
if (FAMISTUDIO_EXP_EPSM) {
if (FAMISTUDIO_EXP_EPSM_RHYTHM_CNT > 0) {
/* famistudio_chn_epsm_rhythm_volume: .res FAMISTUDIO_EXP_EPSM_RHYTHM_CNT */
/* famistudio_chn_epsm_rhythm_stereo: .res FAMISTUDIO_EXP_EPSM_RHYTHM_CNT */
}
if (FAMISTUDIO_EXP_EPSM_FM_CHN_CNT+FAMISTUDIO_EXP_EPSM_RHYTHM_CNT > 0) {
/* famistudio_chn_epsm_trigger:       .res FAMISTUDIO_EXP_EPSM_FM_CHN_CNT + FAMISTUDIO_EXP_EPSM_RHYTHM_CNT ; bit 0 = new note triggered, bit 7 = note released. */
}
if (FAMISTUDIO_EXP_EPSM_FM_CHN_CNT > 0) {
/* famistudio_chn_epsm_fm_stereo:     .res FAMISTUDIO_EXP_EPSM_FM_CHN_CNT */
/* famistudio_chn_epsm_fm_instrument: .res FAMISTUDIO_EXP_EPSM_FM_CHN_CNT */
/* famistudio_chn_epsm_alg:           .res FAMISTUDIO_EXP_EPSM_FM_CHN_CNT */
/* famistudio_chn_epsm_vol_op1:       .res FAMISTUDIO_EXP_EPSM_FM_CHN_CNT */
/* famistudio_chn_epsm_vol_op2:       .res FAMISTUDIO_EXP_EPSM_FM_CHN_CNT */
/* famistudio_chn_epsm_vol_op3:       .res FAMISTUDIO_EXP_EPSM_FM_CHN_CNT */
/* famistudio_chn_epsm_vol_op4:       .res FAMISTUDIO_EXP_EPSM_FM_CHN_CNT */
}
if (FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0) {
/* famistudio_epsm_env_period_lo:     .res 1 */
/* famistudio_epsm_env_period_hi:     .res 1 */
/* famistudio_epsm_env_override:      .res 1 */
/* famistudio_epsm_chn_env_shape:     .res FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT ; bit 7 = note attack. */
/* famistudio_epsm_chn_env_octave:    .res FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT */
}
}
if (FAMISTUDIO_EXP_N163) {
/* famistudio_chn_n163_instrument:   .res FAMISTUDIO_EXP_N163_CHN_CNT */
/* famistudio_chn_n163_wave_index:   .res FAMISTUDIO_EXP_N163_CHN_CNT */
/* famistudio_chn_n163_wave_len:     .res FAMISTUDIO_EXP_N163_CHN_CNT */
}
if (FAMISTUDIO_EXP_S5B) {
/* famistudio_s5b_env_period_lo:     .res 1 */
/* famistudio_s5b_env_period_hi:     .res 1 */
/* famistudio_s5b_env_override:      .res 1 ; if non zero, it means we had an env period effect this frame. */
/* famistudio_s5b_chn_env_shape:     .res 3 ; bit 7 = note attack */
/* famistudio_s5b_chn_env_octave:    .res 3 */
}
if (FAMISTUDIO_USE_DUTYCYCLE_EFFECT) {
/* famistudio_duty_cycle:            .res FAMISTUDIO_NUM_DUTY_CYCLES */
}

if (FAMISTUDIO_USE_FAMITRACKER_TEMPO) {
/* famistudio_tempo_step_lo:         .res 1 */
/* famistudio_tempo_step_hi:         .res 1 */
/* famistudio_tempo_acc_lo:          .res 1 */
/* famistudio_tempo_acc_hi:          .res 1 */
if (FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS) {
/* famistudio_tempo_advance_row:     .res 1 */
}
} else {
/* famistudio_tempo_env_ptr_lo:      .res 1 */
/* famistudio_tempo_env_ptr_hi:      .res 1 */
/* famistudio_tempo_env_counter:     .res 1 */
/* famistudio_tempo_env_idx:         .res 1 */
/* famistudio_tempo_frame_num:       .res 1 */
/* famistudio_tempo_frame_cnt:       .res 1 */
}

/* famistudio_pal_adjust:            .res 1 */
/* famistudio_song_list_lo:          .res 1 */
/* famistudio_song_list_hi:          .res 1 */
/* famistudio_instrument_lo:         .res 1 */
/* famistudio_instrument_hi:         .res 1 */
/* famistudio_dpcm_list_lo:          .res 1 ; TODO: Not needed if DPCM support is disabled. */
/* famistudio_dpcm_list_hi:          .res 1 ; TODO: Not needed if DPCM support is disabled. */
/* famistudio_dpcm_effect:           .res 1 ; TODO: Not needed if DPCM support is disabled. */
/* famistudio_pulse1_prev:           .res 1 */
/* famistudio_pulse2_prev:           .res 1 */
/* famistudio_song_speed:            .res 1 */

if (FAMISTUDIO_EXP_MMC5) {
/* famistudio_mmc5_pulse1_prev:      .res 1 */
/* famistudio_mmc5_pulse2_prev:      .res 1 */
}

if (FAMISTUDIO_EXP_FDS) {
/* famistudio_fds_mod_speed:         .res 2 */
/* famistudio_fds_mod_depth:         .res 1 */
/* famistudio_fds_mod_delay:         .res 1 */
/* famistudio_fds_mod_delay_counter: .res 1 */
/* famistudio_fds_override_flags:    .res 1 ; Bit 7 = mod speed overriden, bit 6 mod depth overriden */
if (FAMISTUDIO_USE_FDS_AUTOMOD) {
/* famistudio_fds_automod_numer:     .res 1 ; 0 = auto-mod off. */
/* famistudio_fds_automod_denom:     .res 1 */
}
if (FAMISTUDIO_USE_PHASE_RESET) {
/* famistudio_fds_prev_hi:           .res 1 */
}
}

if (FAMISTUDIO_EXP_VRC7) {
/* famistudio_vrc7_dummy:            .res 1 ; TODO: Find a dummy address i can simply write to without side effects. */
}

// FDS, N163 and VRC7 have very different instrument layout and are 16-bytes, so we keep them seperate.
if (FAMISTUDIO_EXP_FDS || FAMISTUDIO_EXP_N163 || FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_EPSM || FAMISTUDIO_EXP_S5B) {
/* famistudio_exp_instrument_lo:     .res 1 */
/* famistudio_exp_instrument_hi:     .res 1 */
}

if (FAMISTUDIO_CFG_SFX_SUPPORT) {

/* famistudio_output_buf:     .res 11 */
/* famistudio_sfx_addr_lo:    .res 1 */
/* famistudio_sfx_addr_hi:    .res 1 */
/* famistudio_sfx_base_addr:  .res (FAMISTUDIO_CFG_SFX_STREAMS * FAMISTUDIO_SFX_STRUCT_SIZE) */

// TODO: Refactor SFX memory layout. These uses a AoS approach, not fan.
/* famistudio_sfx_repeat = famistudio_sfx_base_addr + 0 */
/* famistudio_sfx_ptr_lo = famistudio_sfx_base_addr + 1 */
/* famistudio_sfx_ptr_hi = famistudio_sfx_base_addr + 2 */
/* famistudio_sfx_offset = famistudio_sfx_base_addr + 3 */
/* famistudio_sfx_buffer = famistudio_sfx_base_addr + 4 */

}

//======================================================================================================================
// ZEROPAGE VARIABLES
//
// These are only used as temporary variable during the famistudio_xxx calls.
// Feel free to alias those with other ZP values in your programs to save a few bytes.
//======================================================================================================================

/* .segment .string(FAMISTUDIO_CA65_ZP_SEGMENT) : zeropage */

/* famistudio_r0:   .res 1 */
/* famistudio_r1:   .res 1 */
/* famistudio_r2:   .res 1 */
/* famistudio_r3:   .res 1 */

/* famistudio_ptr0: .res 2 */
/* famistudio_ptr1: .res 2 */
if (FAMISTUDIO_EXP_EPSM || FAMISTUDIO_EXP_FDS || FAMISTUDIO_EXP_S5B) {
/* famistudio_ptr2: .res 2 */
}

/* famistudio_ptr0_lo = famistudio_ptr0+0 */
/* famistudio_ptr0_hi = famistudio_ptr0+1 */
/* famistudio_ptr1_lo = famistudio_ptr1+0 */
/* famistudio_ptr1_hi = famistudio_ptr1+1 */

//======================================================================================================================
// CODE
//======================================================================================================================

/* .export famistudio_init */
/* .export famistudio_music_play */
/* .export famistudio_music_pause */
/* .export famistudio_music_stop */
/* .export famistudio_update */
if (FAMISTUDIO_CFG_SFX_SUPPORT) {
if (FAMISTUDIO_CFG_DPCM_SUPPORT) {
/* .export famistudio_sfx_sample_play */
}
/* .export famistudio_sfx_init */
/* .export famistudio_sfx_play */
/* .exportzp FAMISTUDIO_SFX_CH0 */
/* .exportzp FAMISTUDIO_SFX_CH1 */
/* .exportzp FAMISTUDIO_SFX_CH2 */
/* .exportzp FAMISTUDIO_SFX_CH3 */
}
if (FAMISTUDIO_USE_DPCM_BANKSWITCHING) {
/* .global famistudio_dpcm_bank_callback */
}

/* .segment .string(FAMISTUDIO_CA65_CODE_SEGMENT) */

/* FAMISTUDIO_APU_PL1_VOL    = $4000 */
/* FAMISTUDIO_APU_PL1_SWEEP  = $4001 */
/* FAMISTUDIO_APU_PL1_LO     = $4002 */
/* FAMISTUDIO_APU_PL1_HI     = $4003 */
/* FAMISTUDIO_APU_PL2_VOL    = $4004 */
/* FAMISTUDIO_APU_PL2_SWEEP  = $4005 */
/* FAMISTUDIO_APU_PL2_LO     = $4006 */
/* FAMISTUDIO_APU_PL2_HI     = $4007 */
/* FAMISTUDIO_APU_TRI_LINEAR = $4008 */
/* FAMISTUDIO_APU_TRI_LO     = $400a */
/* FAMISTUDIO_APU_TRI_HI     = $400b */
/* FAMISTUDIO_APU_NOISE_VOL  = $400c */
/* FAMISTUDIO_APU_NOISE_LO   = $400e */
/* FAMISTUDIO_APU_NOISE_HI   = $400f */
/* FAMISTUDIO_APU_DMC_FREQ   = $4010 */
/* FAMISTUDIO_APU_DMC_RAW    = $4011 */
/* FAMISTUDIO_APU_DMC_START  = $4012 */
/* FAMISTUDIO_APU_DMC_LEN    = $4013 */
/* FAMISTUDIO_APU_SND_CHN    = $4015 */
/* FAMISTUDIO_APU_FRAME_CNT  = $4017 */

if (FAMISTUDIO_EXP_RAINBOW) {
/* FAMISTUDIO_VRC6_PL1_VOL   = $41a0 */
/* FAMISTUDIO_VRC6_PL1_LO    = $41a1 */
/* FAMISTUDIO_VRC6_PL1_HI    = $41a2 */
/* FAMISTUDIO_VRC6_FREQ_CTRL = $41a0 ; Dummy */
/* FAMISTUDIO_VRC6_PL2_VOL   = $41a3 */
/* FAMISTUDIO_VRC6_PL2_LO    = $41a4 */
/* FAMISTUDIO_VRC6_PL2_HI    = $41a5 */
/* FAMISTUDIO_VRC6_SAW_VOL   = $41a6 */
/* FAMISTUDIO_VRC6_SAW_LO    = $41a7 */
/* FAMISTUDIO_VRC6_SAW_HI    = $41a8 */
} else {
/* FAMISTUDIO_VRC6_PL1_VOL   = $9000 */
/* FAMISTUDIO_VRC6_PL1_LO    = $9001 */
/* FAMISTUDIO_VRC6_PL1_HI    = $9002 */
/* FAMISTUDIO_VRC6_FREQ_CTRL = $9003 */
/* FAMISTUDIO_VRC6_PL2_VOL   = $a000 */
/* FAMISTUDIO_VRC6_PL2_LO    = $a001 */
/* FAMISTUDIO_VRC6_PL2_HI    = $a002 */
/* FAMISTUDIO_VRC6_SAW_VOL   = $b000 */
/* FAMISTUDIO_VRC6_SAW_LO    = $b001 */
/* FAMISTUDIO_VRC6_SAW_HI    = $b002 */
}

/* FAMISTUDIO_VRC7_SILENCE   = $e000 */
/* FAMISTUDIO_VRC7_REG_SEL   = $9010 */
/* FAMISTUDIO_VRC7_REG_WRITE = $9030 */
/* FAMISTUDIO_VRC7_REG_LO_1  = $10 */
/* FAMISTUDIO_VRC7_REG_LO_2  = $11 */
/* FAMISTUDIO_VRC7_REG_LO_3  = $12 */
/* FAMISTUDIO_VRC7_REG_LO_4  = $13 */
/* FAMISTUDIO_VRC7_REG_LO_5  = $14 */
/* FAMISTUDIO_VRC7_REG_LO_6  = $15 */
/* FAMISTUDIO_VRC7_REG_HI_1  = $20 */
/* FAMISTUDIO_VRC7_REG_HI_2  = $21 */
/* FAMISTUDIO_VRC7_REG_HI_3  = $22 */
/* FAMISTUDIO_VRC7_REG_HI_4  = $23 */
/* FAMISTUDIO_VRC7_REG_HI_5  = $24 */
/* FAMISTUDIO_VRC7_REG_HI_6  = $25 */
/* FAMISTUDIO_VRC7_REG_VOL_1 = $30 */
/* FAMISTUDIO_VRC7_REG_VOL_2 = $31 */
/* FAMISTUDIO_VRC7_REG_VOL_3 = $32 */
/* FAMISTUDIO_VRC7_REG_VOL_4 = $33 */
/* FAMISTUDIO_VRC7_REG_VOL_5 = $34 */
/* FAMISTUDIO_VRC7_REG_VOL_6 = $35 */

/* FAMISTUDIO_EPSM_REG_SEL0   = $401c */
/* FAMISTUDIO_EPSM_REG_WRITE0 = $401d */
/* FAMISTUDIO_EPSM_REG_SEL1   = $401e */
/* FAMISTUDIO_EPSM_REG_WRITE1 = $401f */
/* FAMISTUDIO_EPSM_REG_KEY    = $28 */
/* FAMISTUDIO_EPSM_REG_DT_MUL = $30 */
/* FAMISTUDIO_EPSM_REG_TL     = $40 */
/* FAMISTUDIO_EPSM_REG_KS_AR  = $50 */
/* FAMISTUDIO_EPSM_REG_AMO_DR = $60 */
/* FAMISTUDIO_EPSM_REG_SR     = $70 */
/* FAMISTUDIO_EPSM_REG_SL_RR  = $80 */
/* FAMISTUDIO_EPSM_REG_SSG    = $90 */
/* FAMISTUDIO_EPSM_REG_FN_LO  = $A0 */
/* FAMISTUDIO_EPSM_REG_FN_LO2 = $A1 */
/* FAMISTUDIO_EPSM_REG_FN_LO3 = $A2 */
/* FAMISTUDIO_EPSM_REG_FN_HI  = $A4 */
/* FAMISTUDIO_EPSM_REG_FN_HI2 = $A5 */
/* FAMISTUDIO_EPSM_REG_FN_HI3 = $A6 */
/* FAMISTUDIO_EPSM_REG_FB     = $B0 */
/* FAMISTUDIO_EPSM_REG_AM_PM  = $B4 */
/* FAMISTUDIO_EPSM_REG_LFO    = $22 */
/* FAMISTUDIO_EPSM_REG_RHY_KY = $10 */
/* FAMISTUDIO_EPSM_REG_RHY_BD = $18 */
/* FAMISTUDIO_EPSM_REG_RHY_SD = $19 */
/* FAMISTUDIO_EPSM_REG_RHY_TC = $1a */
/* FAMISTUDIO_EPSM_REG_RHY_HH = $1b */
/* FAMISTUDIO_EPSM_REG_RHY_TOM = $1c */
/* FAMISTUDIO_EPSM_REG_RHY_RIM = $1d */
/* FAMISTUDIO_EPSM_REG_LO_1  = $10 */
/* FAMISTUDIO_EPSM_REG_LO_2  = $11 */
/* FAMISTUDIO_EPSM_REG_LO_3  = $12 */
/* FAMISTUDIO_EPSM_REG_LO_4  = $13 */
/* FAMISTUDIO_EPSM_REG_LO_5  = $14 */
/* FAMISTUDIO_EPSM_REG_LO_6  = $15 */
/* FAMISTUDIO_EPSM_REG_HI_1  = $20 */
/* FAMISTUDIO_EPSM_REG_HI_2  = $21 */
/* FAMISTUDIO_EPSM_REG_HI_3  = $22 */
/* FAMISTUDIO_EPSM_REG_HI_4  = $23 */
/* FAMISTUDIO_EPSM_REG_HI_5  = $24 */
/* FAMISTUDIO_EPSM_REG_HI_6  = $25 */
/* FAMISTUDIO_EPSM_REG_VOL_1 = $30 */
/* FAMISTUDIO_EPSM_REG_VOL_2 = $31 */
/* FAMISTUDIO_EPSM_REG_VOL_3 = $32 */
/* FAMISTUDIO_EPSM_REG_VOL_4 = $33 */
/* FAMISTUDIO_EPSM_REG_VOL_5 = $34 */
/* FAMISTUDIO_EPSM_REG_VOL_6 = $35 */
/* FAMISTUDIO_EPSM_ADDR       = $401c */
/* FAMISTUDIO_EPSM_DATA       = $401d */
/* FAMISTUDIO_EPSM_REG_LO_A   = $00 */
/* FAMISTUDIO_EPSM_REG_HI_A   = $01 */
/* FAMISTUDIO_EPSM_REG_LO_B   = $02 */
/* FAMISTUDIO_EPSM_REG_HI_B   = $03 */
/* FAMISTUDIO_EPSM_REG_LO_C   = $04 */
/* FAMISTUDIO_EPSM_REG_HI_C   = $05 */
/* FAMISTUDIO_EPSM_REG_NOISE  = $06 */
/* FAMISTUDIO_EPSM_REG_TONE   = $07 */
/* FAMISTUDIO_EPSM_REG_VOL_A  = $08 */
/* FAMISTUDIO_EPSM_REG_VOL_B  = $09 */
/* FAMISTUDIO_EPSM_REG_VOL_C  = $0a */
/* FAMISTUDIO_EPSM_REG_ENV_LO = $0b */
/* FAMISTUDIO_EPSM_REG_ENV_HI = $0c */
/* FAMISTUDIO_EPSM_REG_SHAPE  = $0d */
/* FAMISTUDIO_EPSM_REG_IO_A   = $0e */
/* FAMISTUDIO_EPSM_REG_IO_B   = $0f */

/* FAMISTUDIO_MMC5_PL1_VOL    = $5000 */
/* FAMISTUDIO_MMC5_PL1_SWEEP  = $5001 */
/* FAMISTUDIO_MMC5_PL1_LO     = $5002 */
/* FAMISTUDIO_MMC5_PL1_HI     = $5003 */
/* FAMISTUDIO_MMC5_PL2_VOL    = $5004 */
/* FAMISTUDIO_MMC5_PL2_SWEEP  = $5005 */
/* FAMISTUDIO_MMC5_PL2_LO     = $5006 */
/* FAMISTUDIO_MMC5_PL2_HI     = $5007 */
/* FAMISTUDIO_MMC5_PCM_MODE   = $5010 */
/* FAMISTUDIO_MMC5_SND_CHN    = $5015 */
/* FAMISTUDIO_MMC5_EXRAM_MODE = $5104 */

/* FAMISTUDIO_N163_SILENCE       = $e000 */
/* FAMISTUDIO_N163_ADDR          = $f800 */
/* FAMISTUDIO_N163_DATA          = $4800 */
/* FAMISTUDIO_N163_REG_FREQ_LO   = $78 */
/* FAMISTUDIO_N163_REG_PHASE_LO  = $79 */
/* FAMISTUDIO_N163_REG_FREQ_MID  = $7a */
/* FAMISTUDIO_N163_REG_PHASE_MID = $7b */
/* FAMISTUDIO_N163_REG_FREQ_HI   = $7c */
/* FAMISTUDIO_N163_REG_PHASE_HI  = $7d */
/* FAMISTUDIO_N163_REG_WAVE      = $7e */
/* FAMISTUDIO_N163_REG_VOLUME    = $7f */

/* FAMISTUDIO_S5B_ADDR       = $c000 */
/* FAMISTUDIO_S5B_DATA       = $e001 ; To avoid VRC7 conflict. */
/* FAMISTUDIO_S5B_REG_LO_A   = $00 */
/* FAMISTUDIO_S5B_REG_HI_A   = $01 */
/* FAMISTUDIO_S5B_REG_LO_B   = $02 */
/* FAMISTUDIO_S5B_REG_HI_B   = $03 */
/* FAMISTUDIO_S5B_REG_LO_C   = $04 */
/* FAMISTUDIO_S5B_REG_HI_C   = $05 */
/* FAMISTUDIO_S5B_REG_NOISE  = $06 */
/* FAMISTUDIO_S5B_REG_TONE   = $07 */
/* FAMISTUDIO_S5B_REG_VOL_A  = $08 */
/* FAMISTUDIO_S5B_REG_VOL_B  = $09 */
/* FAMISTUDIO_S5B_REG_VOL_C  = $0a */
/* FAMISTUDIO_S5B_REG_ENV_LO = $0b */
/* FAMISTUDIO_S5B_REG_ENV_HI = $0c */
/* FAMISTUDIO_S5B_REG_SHAPE  = $0d */
/* FAMISTUDIO_S5B_REG_IO_A   = $0e */
/* FAMISTUDIO_S5B_REG_IO_B   = $0f */

/* FAMISTUDIO_FDS_WAV_START  = $4040 */
/* FAMISTUDIO_FDS_VOL_ENV    = $4080 */
/* FAMISTUDIO_FDS_FREQ_LO    = $4082 */
/* FAMISTUDIO_FDS_FREQ_HI    = $4083 */
/* FAMISTUDIO_FDS_SWEEP_ENV  = $4084 */
/* FAMISTUDIO_FDS_SWEEP_BIAS = $4085 */
/* FAMISTUDIO_FDS_MOD_LO     = $4086 */
/* FAMISTUDIO_FDS_MOD_HI     = $4087 */
/* FAMISTUDIO_FDS_MOD_TABLE  = $4088 */
/* FAMISTUDIO_FDS_VOL        = $4089 */
/* FAMISTUDIO_FDS_ENV_SPEED  = $408A */

if (!FAMISTUDIO_CFG_SFX_SUPPORT) {
    // Output directly to APU
/* FAMISTUDIO_ALIAS_PL1_VOL    = FAMISTUDIO_APU_PL1_VOL */
/* FAMISTUDIO_ALIAS_PL1_LO     = FAMISTUDIO_APU_PL1_LO */
/* FAMISTUDIO_ALIAS_PL1_HI     = FAMISTUDIO_APU_PL1_HI */
/* FAMISTUDIO_ALIAS_PL2_VOL    = FAMISTUDIO_APU_PL2_VOL */
/* FAMISTUDIO_ALIAS_PL2_LO     = FAMISTUDIO_APU_PL2_LO */
/* FAMISTUDIO_ALIAS_PL2_HI     = FAMISTUDIO_APU_PL2_HI */
/* FAMISTUDIO_ALIAS_TRI_LINEAR = FAMISTUDIO_APU_TRI_LINEAR */
/* FAMISTUDIO_ALIAS_TRI_LO     = FAMISTUDIO_APU_TRI_LO */
/* FAMISTUDIO_ALIAS_TRI_HI     = FAMISTUDIO_APU_TRI_HI */
/* FAMISTUDIO_ALIAS_NOISE_VOL  = FAMISTUDIO_APU_NOISE_VOL */
/* FAMISTUDIO_ALIAS_NOISE_LO   = FAMISTUDIO_APU_NOISE_LO */
} else {
    // Otherwise write to the output buffer
/* FAMISTUDIO_ALIAS_PL1_VOL    = famistudio_output_buf + 0 */
/* FAMISTUDIO_ALIAS_PL1_LO     = famistudio_output_buf + 1 */
/* FAMISTUDIO_ALIAS_PL1_HI     = famistudio_output_buf + 2 */
/* FAMISTUDIO_ALIAS_PL2_VOL    = famistudio_output_buf + 3 */
/* FAMISTUDIO_ALIAS_PL2_LO     = famistudio_output_buf + 4 */
/* FAMISTUDIO_ALIAS_PL2_HI     = famistudio_output_buf + 5 */
/* FAMISTUDIO_ALIAS_TRI_LINEAR = famistudio_output_buf + 6 */
/* FAMISTUDIO_ALIAS_TRI_LO     = famistudio_output_buf + 7 */
/* FAMISTUDIO_ALIAS_TRI_HI     = famistudio_output_buf + 8 */
/* FAMISTUDIO_ALIAS_NOISE_VOL  = famistudio_output_buf + 9 */
/* FAMISTUDIO_ALIAS_NOISE_LO   = famistudio_output_buf + 10 */
}

//======================================================================================================================
// FAMISTUDIO_INIT (public)
//
// Reset APU, initialize the sound engine with some music data.
//
// [in] a : Playback platform, zero for PAL, non-zero for NTSC.
// [in] x : Pointer to music data (lo)
// [in] y : Pointer to music data (hi)
//======================================================================================================================

/* famistudio_init: */

/* @music_data_ptr = famistudio_ptr0 */

    *((famistudio_song_list_lo) as *u8) = x;
    *((famistudio_song_list_hi) as *u8) = y;
    *((@music_data_ptr+0) as *u8) = x;
    *((@music_data_ptr+1) as *u8) = y;

if (FAMISTUDIO_DUAL_SUPPORT) {
    x = a;
    goto (@pal) if zero;
    a = 97;
/* @pal: */
} else {
    if (FAMISTUDIO_CFG_PAL_SUPPORT) {
        a = 0;
    }
    if (FAMISTUDIO_CFG_NTSC_SUPPORT) {
        a = 97;
    }
}
    *((famistudio_pal_adjust) as *u8) = a;

    famistudio_music_stop();

    // Instrument address
    y = 1;
    a = *(((@music_data_ptr),y) as *u8);
    *((famistudio_instrument_lo) as *u8) = a;
    ++y;
    a = *(((@music_data_ptr),y) as *u8);
    *((famistudio_instrument_hi) as *u8) = a;
    ++y;

    // Expansions instrument address
    if (FAMISTUDIO_EXP_FDS || FAMISTUDIO_EXP_N163 || FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_EPSM || FAMISTUDIO_EXP_S5B) {
        a = *(((@music_data_ptr),y) as *u8);
        *((famistudio_exp_instrument_lo) as *u8) = a;
        ++y;
        a = *(((@music_data_ptr),y) as *u8);
        *((famistudio_exp_instrument_hi) as *u8) = a;
        ++y;
    }

    // Sample list address
    a = *(((@music_data_ptr),y) as *u8);
    *((famistudio_dpcm_list_lo) as *u8) = a;
    ++y;
    a = *(((@music_data_ptr),y) as *u8);
    *((famistudio_dpcm_list_hi) as *u8) = a;

    a = 0x80; // Previous pulse period MSB, to not write it when not changed
    *((famistudio_pulse1_prev) as *u8) = a;
    *((famistudio_pulse2_prev) as *u8) = a;

    a = 0x0f; // Enable channels, stop DMC
    *((FAMISTUDIO_APU_SND_CHN) as *u8) = a;
    a = 0x80; // Disable triangle length counter
    *((FAMISTUDIO_APU_TRI_LINEAR) as *u8) = a;
    a = 0x00; // Load noise length
    *((FAMISTUDIO_APU_NOISE_HI) as *u8) = a;

    a = 0x30; // Volumes to 0
    *((FAMISTUDIO_APU_PL1_VOL) as *u8) = a;
    *((FAMISTUDIO_APU_PL2_VOL) as *u8) = a;
    *((FAMISTUDIO_APU_NOISE_VOL) as *u8) = a;
    a = 0x08; // No sweep
    *((FAMISTUDIO_APU_PL1_SWEEP) as *u8) = a;
    *((FAMISTUDIO_APU_PL2_SWEEP) as *u8) = a;

if (FAMISTUDIO_EXP_VRC6) {
/* @init_vrc6: */
    a = 0;
    *((FAMISTUDIO_VRC6_FREQ_CTRL) as *u8) = a; // NESDEV wiki says to write zero at startup.
}

if (FAMISTUDIO_EXP_VRC7) {
/* @init_vrc7: */
    a = 0;
    *((FAMISTUDIO_VRC7_SILENCE) as *u8) = a; // Enable VRC7 audio.
}

/* @init_epsm: */
if (FAMISTUDIO_EXP_EPSM) {
    a = FAMISTUDIO_EPSM_REG_TONE;
    *((FAMISTUDIO_EPSM_ADDR) as *u8) = a;
    a = 0x38; // No noise, just 3 tones for now.
    *((FAMISTUDIO_EPSM_DATA) as *u8) = a;
    a = 0x29;
    *((FAMISTUDIO_EPSM_ADDR) as *u8) = a;
    a = 0x80;
    *((FAMISTUDIO_EPSM_DATA) as *u8) = a;
    a = 0x27;
    *((FAMISTUDIO_EPSM_ADDR) as *u8) = a;
    a = 0x00;
    *((FAMISTUDIO_EPSM_DATA) as *u8) = a;
    a = 0x11;
    *((FAMISTUDIO_EPSM_ADDR) as *u8) = a;
    a = 0x37;
    *((FAMISTUDIO_EPSM_DATA) as *u8) = a;
}

if (FAMISTUDIO_EXP_MMC5) {
/* @init_mmc5: */
    a = 0x00;
    *((FAMISTUDIO_MMC5_PCM_MODE) as *u8) = a;
    a = 0x03;
    *((FAMISTUDIO_MMC5_SND_CHN) as *u8) = a;
    a = 0x80; // Previous pulse period MSB, to not write it when not changed
    *((famistudio_mmc5_pulse1_prev) as *u8) = a;
    *((famistudio_mmc5_pulse2_prev) as *u8) = a;
}

if (FAMISTUDIO_EXP_S5B) {
/* @init_s5b: */
    a = FAMISTUDIO_S5B_REG_TONE;
    *((FAMISTUDIO_S5B_ADDR) as *u8) = a;
    a = 0x38; // No noise, just 3 tones for now.
    *((FAMISTUDIO_S5B_DATA) as *u8) = a;
}

    goto (*((famistudio_music_stop) as *u8));

//======================================================================================================================
// FAMISTUDIO_MUSIC_STOP (public)
//
// Stops any music currently playing, if any. Note that this will not update the APU, so sound might linger. Calling
// famistudio_update after this will update the APU.
//
// [in] no input params.
//======================================================================================================================

/* famistudio_music_stop: */

    a = 0;
    *((famistudio_song_speed) as *u8) = a;
    *((famistudio_dpcm_effect) as *u8) = a;

    x = 0;

/* @set_channels: */

    *((famistudio_chn_repeat + x) as *u8) = a;
    *((famistudio_chn_note + x) as *u8) = a;
    *((famistudio_chn_ref_len + x) as *u8) = a;
    if (FAMISTUDIO_USE_VOLUME_TRACK) {
        *((famistudio_chn_volume_track + x) as *u8) = a;
    }
    if (FAMISTUDIO_USE_VIBRATO || FAMISTUDIO_USE_ARPEGGIO) {
        *((famistudio_chn_env_override + x) as *u8) = a;
    }
    if (FAMISTUDIO_CFG_EQUALIZER) {
        *((famistudio_chn_note_counter + x) as *u8) = a;
    }
    if (FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS) {
        a = 0xff;
        *((famistudio_chn_note_delay + x) as *u8) = a;
        *((famistudio_chn_cut_delay + x) as *u8) = a;
        a = 0;
    }
    ++x;
    cmp(x, FAMISTUDIO_NUM_CHANNELS);
    goto (@set_channels) if !zero;

if (FAMISTUDIO_USE_DUTYCYCLE_EFFECT) {
x = 0;
/* @set_duty_cycles: */
    *((famistudio_duty_cycle + x) as *u8) = a;
    ++x;
    cmp(x, FAMISTUDIO_NUM_DUTY_CYCLES);
    goto (@set_duty_cycles) if !zero;
}

if (FAMISTUDIO_USE_SLIDE_NOTES) {
    x = 0;
/* @set_slides: */
    *((famistudio_slide_step + x) as *u8) = a;
    ++x;
    cmp(x, FAMISTUDIO_NUM_SLIDES);
    goto (@set_slides) if !zero;
}

if (FAMISTUDIO_USE_VOLUME_SLIDES) {
    x = 0;
/* @set_volume_slides: */
    *((famistudio_chn_volume_slide_step + x) as *u8) = a;
    *((famistudio_chn_volume_slide_target + x) as *u8) = a;
    ++x;
    cmp(x, FAMISTUDIO_NUM_VOLUME_SLIDES);
    goto (@set_volume_slides) if !zero;
}

    x = 0;

/* @set_envelopes: */

    a = <:famistudio_dummy_envelope;
    *((famistudio_env_addr_lo + x) as *u8) = a;
    a = >:famistudio_dummy_envelope;
    *((famistudio_env_addr_hi + x) as *u8) = a;
    a = 0;
    *((famistudio_env_repeat + x) as *u8) = a;
    *((famistudio_env_value + x) as *u8) = a;
    *((famistudio_env_ptr + x) as *u8) = a;
    ++x;
    cmp(x, FAMISTUDIO_NUM_ENVELOPES);
    goto (@set_envelopes) if !zero;

    x = 0;
/* @set_pitch_envelopes: */

    a = <:famistudio_dummy_pitch_envelope;
    *((famistudio_pitch_env_addr_lo + x) as *u8) = a;
    a = >:famistudio_dummy_pitch_envelope;
    *((famistudio_pitch_env_addr_hi + x) as *u8) = a;
    a = 0;
    *((famistudio_pitch_env_repeat + x) as *u8) = a;
    *((famistudio_pitch_env_value_lo + x) as *u8) = a;
    *((famistudio_pitch_env_value_hi + x) as *u8) = a;
    if (FAMISTUDIO_USE_PITCH_TRACK) {
        *((famistudio_pitch_env_fine_value + x) as *u8) = a;
    }
    a = 1;
    *((famistudio_pitch_env_ptr + x) as *u8) = a;
    ++x;
    cmp(x, FAMISTUDIO_NUM_PITCH_ENVELOPES);
    goto (@set_pitch_envelopes) if !zero;

    goto (*((famistudio_sample_stop) as *u8));

//======================================================================================================================
// FAMISTUDIO_MUSIC_PLAY (public)
//
// Plays a song from the loaded music data (from a previous call to famistudio_init).
//
// [in] a : Song index.
//======================================================================================================================

/* famistudio_music_play: */

/* @tmp = famistudio_r0 */
/* @song_list_ptr = famistudio_ptr0 */
/* @temp_env_ptr  = famistudio_ptr1 */

    x = *((famistudio_song_list_lo) as *u8);
    *((@song_list_ptr+0) as *u8) = x;
    x = *((famistudio_song_list_hi) as *u8);
    *((@song_list_ptr+1) as *u8) = x;

    y = 0;
    cmp(a, *(((@song_list_ptr),y) as *u8));
    goto (@valid_song) if !carry;
    return; // Invalid song index.

/* @valid_song: */
if (FAMISTUDIO_NUM_CHANNELS = 5) {
    // Here we basically assume we have 17 songs or less (17 songs * 14 bytes per song + 5 bytes header < 256).
    *(() as *u8) <<= 1;
    *((@tmp) as *u8) = a;
    *(() as *u8) <<= 1;
    x = a;
    *(() as *u8) <<= 1;
    a +#= *((@tmp) as *u8);
    *((@tmp) as *u8) = x;
    a +#= *((@tmp) as *u8);
    a +#= 5; // Song count + instrument ptr + sample ptr
    y = a;
} else {
    // This supports a larger number of songs as it increments the pointer itself, not Y.
    // As the number of channel becomes huge, this become necessary to support a decent
    // number of songs.
    x = a;
    a = *((@song_list_ptr+0) as *u8);
/* @song_mult_loop: */
        --x;
        goto (@song_mult_loop_done) if negative;
        a +#= (FAMISTUDIO_NUM_CHANNELS * 2 + 4);
        goto (@song_mult_loop) if !carry;
        ++(*((@song_list_ptr+1) as *u8));
        carry = false;
        goto (@song_mult_loop) if !carry;

/* @song_mult_loop_done: */
        *((@song_list_ptr+0) as *u8) = a;

if (FAMISTUDIO_EXP_FDS || FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_EPSM || FAMISTUDIO_EXP_N163 || FAMISTUDIO_EXP_S5B) {
    y = 7; // Song count + instrument ptr + exp instrument ptr + sample ptr
} else {
    y = 5; // Song count + instrument ptr + sample ptr
}
}

    famistudio_music_stop();

    x = 0;

/* @set_channels: */

    // Channel data address
    a = *(((@song_list_ptr),y) as *u8);
    *((famistudio_chn_ptr_lo + x) as *u8) = a;
    ++y;
    a = *(((@song_list_ptr),y) as *u8);
    *((famistudio_chn_ptr_hi + x) as *u8) = a;
    ++y;

    a = 0;
    *((famistudio_chn_repeat + x) as *u8) = a;
    *((famistudio_chn_note + x) as *u8) = a;
    *((famistudio_chn_ref_len + x) as *u8) = a;
    if (FAMISTUDIO_USE_VOLUME_TRACK) {
        a = 0xf0;
        *((famistudio_chn_volume_track + x) as *u8) = a;
    }
    if (FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS) {
        a = 0xff;
        *((famistudio_chn_note_delay + x) as *u8) = a;
        *((famistudio_chn_cut_delay + x) as *u8) = a;
    }

/* @nextchannel: */
    ++x;
    cmp(x, FAMISTUDIO_NUM_CHANNELS);
    goto (@set_channels) if !zero;

if (FAMISTUDIO_USE_FAMITRACKER_TEMPO) {
    a = *((famistudio_pal_adjust) as *u8);
    goto (@pal) if zero;
    ++y;
    ++y;
/* @pal: */

    // Tempo increment.
    a = *(((@song_list_ptr),y) as *u8);
    *((famistudio_tempo_step_lo) as *u8) = a;
    ++y;
    a = *(((@song_list_ptr),y) as *u8);
    *((famistudio_tempo_step_hi) as *u8) = a;

    a = 0; // Reset tempo accumulator
    *((famistudio_tempo_acc_lo) as *u8) = a;
    a = 6; // Default speed
    *((famistudio_tempo_acc_hi) as *u8) = a;
    *((famistudio_song_speed) as *u8) = a; // Apply default speed, this also enables music
} else {
    a = *(((@song_list_ptr),y) as *u8);
    *((famistudio_tempo_env_ptr_lo) as *u8) = a;
    *((@temp_env_ptr+0) as *u8) = a;
    ++y;
    a = *(((@song_list_ptr),y) as *u8);
    *((famistudio_tempo_env_ptr_hi) as *u8) = a;
    *((@temp_env_ptr+1) as *u8) = a;
    ++y;
    a = *(((@song_list_ptr),y) as *u8);
if (FAMISTUDIO_DUAL_SUPPORT) { // Dual mode
    x = *((famistudio_pal_adjust) as *u8);
    goto (@ntsc_target) if !zero;
    a |= 1;
/* @ntsc_target: */
} else if (FAMISTUDIO_CFG_PAL_SUPPORT) { // PAL only
    a |= 1;
}
    x = a;
    a = *((famistudio_tempo_frame_lookup + x) as *u8); // Lookup contains the number of frames to run (0,1,2) to maintain tempo
    *((famistudio_tempo_frame_num) as *u8) = a;
    y = 0;
    *((famistudio_tempo_env_idx) as *u8) = y;
    a = *(((@temp_env_ptr),y) as *u8);
    carry = false;
    a +#= 1;
    *((famistudio_tempo_env_counter) as *u8) = a;
    a = 6;
    *((famistudio_song_speed) as *u8) = a; // Non-zero simply so the song isnt considered paused.
}

if (FAMISTUDIO_EXP_VRC7) {
    a = 0;
    x = 5;
/* @clear_vrc7_loop: */
        *((famistudio_chn_vrc7_prev_hi + x) as *u8) = a;
        *((famistudio_chn_vrc7_patch + x) as *u8) = a;
        *((famistudio_chn_vrc7_trigger + x) as *u8) = a;
        --x;
        goto (@clear_vrc7_loop) if !negative;
}

if (FAMISTUDIO_EXP_EPSM) {
if (FAMISTUDIO_EXP_EPSM_TRIG_CHN > 0) {
    a = 0;
    x = FAMISTUDIO_EXP_EPSM_FM_CHN_CNT + FAMISTUDIO_EXP_EPSM_RHYTHM_CNT - 1;
/* @clear_epsm_loop: */
        *((famistudio_chn_epsm_trigger + x) as *u8) = a;
        --x;
        goto (@clear_epsm_loop) if !negative;
}
if (FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0) {
    a = 0;
    *((famistudio_epsm_env_period_lo) as *u8) = a;
    *((famistudio_epsm_env_period_hi) as *u8) = a;
    *((famistudio_epsm_env_override) as *u8) = a;
    x = (FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT - 1);
/* @clear_epsm_sq_loop: */
        *((famistudio_epsm_chn_env_shape + x) as *u8) = a;
        *((famistudio_epsm_chn_env_octave + x) as *u8) = a;
        --x;
        goto (@clear_epsm_sq_loop) if !negative;
}
}

if (FAMISTUDIO_EXP_VRC6) {
    a = 0;
    *((famistudio_vrc6_saw_volume) as *u8) = a;
    if (FAMISTUDIO_USE_PHASE_RESET) {
        *((famistudio_vrc6_pulse1_prev_hi) as *u8) = a;
        *((famistudio_vrc6_pulse2_prev_hi) as *u8) = a;
        *((famistudio_vrc6_saw_prev_hi) as *u8) = a;
    }
}

if (FAMISTUDIO_USE_PHASE_RESET) {
    a = 0;
    *((famistudio_phase_reset) as *u8) = a;
    if (FAMISTUDIO_EXP_N163) {
        *((famistudio_phase_reset_n163) as *u8) = a;
    }
}

if (FAMISTUDIO_USE_DELTA_COUNTER) {
    a = 0xff;
    *((famistudio_dmc_delta_counter) as *u8) = a;
}

if (FAMISTUDIO_EXP_FDS) {
    a = 0;
    *((famistudio_fds_mod_speed+0) as *u8) = a;
    *((famistudio_fds_mod_speed+1) as *u8) = a;
    *((famistudio_fds_mod_depth) as *u8) = a;
    *((famistudio_fds_mod_delay) as *u8) = a;
    *((famistudio_fds_mod_delay_counter) as *u8) = a;
    *((famistudio_fds_override_flags) as *u8) = a;
    if (FAMISTUDIO_USE_FDS_AUTOMOD) {
        *((famistudio_fds_automod_numer) as *u8) = a;
        *((famistudio_fds_automod_denom) as *u8) = a;
    }
    if (FAMISTUDIO_USE_PHASE_RESET) {
        *((famistudio_fds_prev_hi) as *u8) = a;
    }
}

if (FAMISTUDIO_EXP_N163) {
    a = 0;
    x = (FAMISTUDIO_EXP_N163_CHN_CNT - 1);
/* @clear_n163_loop: */
        *((famistudio_chn_n163_wave_index + x) as *u8) = a;
        *((famistudio_chn_n163_wave_len + x) as *u8) = a;
        --x;
        goto (@clear_n163_loop) if !negative;
}

if (FAMISTUDIO_EXP_S5B) {
    a = 0;
    *((famistudio_s5b_env_period_lo) as *u8) = a;
    *((famistudio_s5b_env_period_hi) as *u8) = a;
    *((famistudio_s5b_env_override) as *u8) = a;
    *((famistudio_s5b_chn_env_shape+0) as *u8) = a;
    *((famistudio_s5b_chn_env_shape+1) as *u8) = a;
    *((famistudio_s5b_chn_env_shape+2) as *u8) = a;
    *((famistudio_s5b_chn_env_octave+0) as *u8) = a;
    *((famistudio_s5b_chn_env_octave+1) as *u8) = a;
    *((famistudio_s5b_chn_env_octave+2) as *u8) = a;
}

/* @skip: */
    return;

//======================================================================================================================
// FAMISTUDIO_MUSIC_PAUSE (public)
//
// Pause/unpause the currently playing song. Note that this will not update the APU, so sound might linger. Calling
// famistudio_update after this will update the APU.
//
// [in] a : zero to play, non-zero to pause.
//======================================================================================================================

/* famistudio_music_pause: */

    x = a;
    goto (@unpause) if zero;

/* @pause: */

    famistudio_sample_stop();

    a = 0;
    *((famistudio_env_value+FAMISTUDIO_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_CH3_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
if (FAMISTUDIO_EXP_VRC6) {
    *((famistudio_env_value+FAMISTUDIO_VRC6_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_VRC6_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_VRC6_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
}
if (FAMISTUDIO_EXP_VRC7) {
    *((famistudio_env_value+FAMISTUDIO_VRC7_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_VRC7_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_VRC7_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_VRC7_CH3_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_VRC7_CH4_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_VRC7_CH5_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
}
if (FAMISTUDIO_EXP_FDS) {
    *((famistudio_env_value+FAMISTUDIO_FDS_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
}
if (FAMISTUDIO_EXP_MMC5) {
    *((famistudio_env_value+FAMISTUDIO_MMC5_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_MMC5_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
}
if (FAMISTUDIO_EXP_N163) {
    *((famistudio_env_value+FAMISTUDIO_N163_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_N163_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_N163_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_N163_CH3_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_N163_CH4_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_N163_CH5_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_N163_CH6_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_N163_CH7_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
}
if (FAMISTUDIO_EXP_S5B) {
    *((famistudio_env_value+FAMISTUDIO_S5B_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_S5B_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_S5B_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
}
if (FAMISTUDIO_EXP_EPSM) {
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 0) {
    *((famistudio_env_value+FAMISTUDIO_EPSM_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 1) {
    *((famistudio_env_value+FAMISTUDIO_EPSM_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 2) {
    *((famistudio_env_value+FAMISTUDIO_EPSM_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 3) {
    *((famistudio_env_value+FAMISTUDIO_EPSM_CH3_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 4) {
    *((famistudio_env_value+FAMISTUDIO_EPSM_CH4_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 5) {
    *((famistudio_env_value+FAMISTUDIO_EPSM_CH5_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 6) {
    *((famistudio_env_value+FAMISTUDIO_EPSM_CH6_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 7) {
    *((famistudio_env_value+FAMISTUDIO_EPSM_CH7_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 8) {
    *((famistudio_env_value+FAMISTUDIO_EPSM_CH8_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8) = a;
}
}
    a = *((famistudio_song_speed) as *u8); // <= 0 pauses the music
    a |= 0x80;
    goto (@done) if !zero;
/* @unpause: */
    a = *((famistudio_song_speed) as *u8); // > 0 unpause music
    a &= 0x7f;
/* @done: */
    *((famistudio_song_speed) as *u8) = a;

    return;

//======================================================================================================================
// FAMISTUDIO_GET_NOTE_PITCH_MACRO (internal)
//
// Uber-macro used to compute the final pitch of a note, taking into account the current note, arpeggios, instrument
// pitch envelopes, slide notes and fine pitch tracks.
//
// [in] x : note index.
// [in] y : slide/pitch envelope index.
// [out] famistudio_ptr1 : Final note pitch.
//======================================================================================================================

/* .macro famistudio_get_note_pitch_macro pitch_env_offset, pitch_shift, note_table_lsb, note_table_msb */

/* .local @pitch */
/* .local @tmp_ror */
/* .local @pos */
/* .local @no_slide */
/* .local @no_adjust */

/* @pitch   = famistudio_ptr1 */
/* @tmp_ror = famistudio_r0 */

if (FAMISTUDIO_USE_PITCH_TRACK) {

    // Pitch envelope + fine pitch (sign extended)
    carry = false;
    a = *((famistudio_pitch_env_fine_value+pitch_env_offset + y) as *u8);
    a +#= *((famistudio_pitch_env_value_lo+pitch_env_offset + y) as *u8);
    *((@pitch+0) as *u8) = a;
    a = *((famistudio_pitch_env_fine_value+pitch_env_offset + y) as *u8);
    a &= 0x80;
    goto (@pos) if zero;
    a = 0xff;
/* @pos: */
    a +#= *((famistudio_pitch_env_value_hi+pitch_env_offset + y) as *u8);
    *((@pitch+1) as *u8) = a;

} else {

    // Pitch envelope only
    a = *((famistudio_pitch_env_value_lo+pitch_env_offset + y) as *u8);
    *((@pitch+0) as *u8) = a;
    a = *((famistudio_pitch_env_value_hi+pitch_env_offset + y) as *u8);
    *((@pitch+1) as *u8) = a;

}

if (FAMISTUDIO_USE_SLIDE_NOTES) {

    // Check if there is an active slide.
    a = *((famistudio_slide_step+pitch_env_offset + y) as *u8);
    goto (@no_slide) if zero;

    // Add slide
if (pitch_shift >= 1) {
    // These channels dont have fractional part for slides and have the same shift for slides + pitch.
    carry = false;
    a = *((famistudio_slide_pitch_lo+pitch_env_offset + y) as *u8);
    a +#= *((@pitch+0) as *u8);
    *((@pitch+0) as *u8) = a;
    a = *((famistudio_slide_pitch_hi+pitch_env_offset + y) as *u8);
    a +#= *((@pitch+1) as *u8);
    *((@pitch+1) as *u8) = a;
 } else {
    // Most channels have 1 bit of fraction for slides.
    a = *((famistudio_slide_pitch_hi+pitch_env_offset + y) as *u8);
    cmp(a, 0x80); // Sign extend upcoming right shift.
    *(() as *u8) >>>>#= 1; // We have 1 bit of fraction for slides, shift right hi byte.
    *((@tmp_ror) as *u8) = a;
    a = *((famistudio_slide_pitch_lo+pitch_env_offset + y) as *u8);
    *(() as *u8) >>>>#= 1; // Shift right low byte.
    carry = false;
    a +#= *((@pitch+0) as *u8);
    *((@pitch+0) as *u8) = a;
    a = *((@tmp_ror) as *u8);
    a +#= *((@pitch+1) as *u8);
    *((@pitch+1) as *u8) = a;
}
}

/* @no_slide: */

    if (pitch_shift >= 1) {
        *((@pitch+0) as *u8) <<= 1;
        *((@pitch+1) as *u8) <<<<#= 1;
    if (pitch_shift >= 2) {
        *((@pitch+0) as *u8) <<= 1;
        *((@pitch+1) as *u8) <<<<#= 1;
    if (pitch_shift >= 3) {
        *((@pitch+0) as *u8) <<= 1;
        *((@pitch+1) as *u8) <<<<#= 1;
    if (pitch_shift >= 4) {
        *((@pitch+0) as *u8) <<= 1;
        *((@pitch+1) as *u8) <<<<#= 1;
    if (pitch_shift >= 5) {
        *((@pitch+0) as *u8) <<= 1;
        *((@pitch+1) as *u8) <<<<#= 1;
    }
    }
    }
    }
    }

    // Finally, add note pitch.
    carry = false;
    a = *((note_table_lsb + x) as *u8);
    a +#= *((@pitch+0) as *u8);
    *((@pitch+0) as *u8) = a;
    a = *((note_table_msb + x) as *u8);
    a +#= *((@pitch+1) as *u8);
    *((@pitch+1) as *u8) = a;

/* .endmacro */

/* famistudio_get_note_pitch: */
/* famistudio_get_note_pitch_macro 0, 0, famistudio_note_table_lsb, famistudio_note_table_msb */
    return;

if (FAMISTUDIO_EXP_VRC6) {
/* famistudio_get_note_pitch_vrc6_saw: */
/* famistudio_get_note_pitch_macro 0, 0, famistudio_saw_note_table_lsb, famistudio_saw_note_table_msb */
    return;
}

//======================================================================================================================
// FAMISTUDIO_SMOOTH_VIBRATO (internal)
//
// Implementation of Blaarg's smooth vibrato to eliminate pops on square channels. Called either from regular channel
// updates or from SFX code.
//
// [in] a : new hi period.
//======================================================================================================================

/* .macro famistudio_smooth_vibrato pulse_lo, pulse_prev, reg_hi, reg_lo, reg_sweep */

/* .local @hi_delta_too_big */
/* .local @done */

    // Blaarg's smooth vibrato technique, only used if high period delta is 1 or -1.
    a &= 7; // Clamp hi-period to sane range, breaks smooth vibrato otherwise.
    x = a; // X = new hi-period
    carry = true;
    a -#= *((pulse_prev) as *u8); // A = signed hi-period delta.
    goto (@done) if zero;
    *((pulse_prev) as *u8) = x;
    y = a;
    ++y; // We only care about -1 ($ff) and 1. Adding one means we only check of 0 or 2, we already checked for zero (so < 3).
    cmp(y, 0x03);
    goto (@hi_delta_too_big) if carry;
    x = 0x40;
    *((FAMISTUDIO_APU_FRAME_CNT) as *u8) = x; // Reset frame counter in case it was about to clock
    a = *((famistudio_smooth_vibrato_period_lo_lookup + y) as *u8); // Be sure low 8 bits of timer period are $ff (for positive delta), or $00 (for negative delta)
    *((reg_lo) as *u8) = a;
    a = *((famistudio_smooth_vibrato_sweep_lookup + y) as *u8); // Sweep enabled, shift = 7, set negative flag or delta is negative..
    *((reg_sweep) as *u8) = a;
    a = 0xc0;
    *((FAMISTUDIO_APU_FRAME_CNT) as *u8) = a; // Clock sweep immediately
    a = 0x08;
    *((reg_sweep) as *u8) = a; // Disable sweep
    a = *((pulse_lo) as *u8);
    *((reg_lo) as *u8) = a; // Restore lo-period.
    goto (*((@done) as *u8));
/* @hi_delta_too_big: */
    *((reg_hi) as *u8) = x;
/* @done: */
/* .endmacro */

//======================================================================================================================
// FAMISTUDIO_UPDATE_CHANNEL_SOUND (internal)
//
// Uber-macro used to update the APU registers for a given 2A03/VRC6/MMC5 channel. This macro is an absolute mess, but
// it is still more maintainable than having many different functions.
//
// [in] no input params.
//======================================================================================================================

/* .macro famistudio_update_channel_sound idx, env_offset, pulse_prev, reg_hi, reg_lo, reg_vol, reg_sweep */

/* .local @pitch */
/* .local @tmp */
/* .local @nocut */
/* .local @set_volume */
/* .local @compute_volume */
/* .local @hi_delta_too_big */
/* .local @noise_slide_shift_loop */
/* .local @no_noise_slide */

/* @tmp   = famistudio_r0 */
/* @pitch = famistudio_ptr1 */

    a = *((famistudio_chn_note+idx) as *u8);
    goto (@nocut) if !zero;
    goto (*((@set_volume) as *u8));

/* @nocut: */
    carry = false;
    a +#= *((famistudio_env_value+env_offset+FAMISTUDIO_ENV_NOTE_OFF) as *u8);

if (idx = 3) { // Noise channel is a bit special

if (FAMISTUDIO_USE_NOISE_SLIDE_NOTES) {

    // Check if there is an active slide on the noise channel.
    y = *((famistudio_slide_step+FAMISTUDIO_NOISE_SLIDE_INDEX) as *u8);
    goto (@no_noise_slide) if zero;

        // We have 4 bits of fraction for noise slides.
        *((@tmp) as *u8) = a;

        a = *((famistudio_slide_pitch_lo+FAMISTUDIO_NOISE_SLIDE_INDEX) as *u8);
        *((@pitch+0) as *u8) = a;
        a = *((famistudio_slide_pitch_hi+FAMISTUDIO_NOISE_SLIDE_INDEX) as *u8);
        cmp(a, 0x80);
        *(() as *u8) >>>>#= 1;
        *((@pitch+0) as *u8) >>>>#= 1;
        cmp(a, 0x80);
        *(() as *u8) >>>>#= 1;
        *((@pitch+0) as *u8) >>>>#= 1;
        cmp(a, 0x80);
        *(() as *u8) >>>>#= 1;
        *((@pitch+0) as *u8) >>>>#= 1;
        cmp(a, 0x80);
        *(() as *u8) >>>>#= 1;
        a = *((@pitch+0) as *u8);
        *(() as *u8) >>>>#= 1;

        carry = false;
        a +#= *((@tmp) as *u8);

}

/* @no_noise_slide: */
    a &= 0x0f;
    a ^= 0x0f;
    *((@tmp) as *u8) = a;

    x = *((famistudio_env_value+env_offset+FAMISTUDIO_ENV_DUTY_OFF) as *u8);
    a = *((famistudio_duty_lookup + x) as *u8);
    *((a) as *u8) <<= 1;
    a &= 0x80;
    a |= *((@tmp) as *u8);

} else {

    if (FAMISTUDIO_DUAL_SUPPORT) {
        carry = false;
        a +#= *((famistudio_pal_adjust) as *u8);
    }
    x = a;

    // This basically does same as "famistudio_channel_to_pitch_env"
    if (idx < 3) {
        y = idx;
    } else {
        y = (idx - 2);
    }

    if (FAMISTUDIO_EXP_VRC6 && idx = FAMISTUDIO_VRC6_CH2_IDX) {
        famistudio_get_note_pitch_vrc6_saw();
    } else {
        famistudio_get_note_pitch();
    }

    a = *((@pitch+0) as *u8);
    *((reg_lo) as *u8) = a;
    a = *((@pitch+1) as *u8);

    // HACK : VRC6 only. We are out of macro param for NESASM. TODO : Is that still true?
    if (idx >= FAMISTUDIO_VRC6_CH0_IDX && idx <= FAMISTUDIO_VRC6_CH2_IDX) {
        if (FAMISTUDIO_USE_PHASE_RESET) {
            *((pulse_prev) as *u8) = a;
        }
        a |= 0x80;
    } else {
        if ((!.blank(pulse_prev)) && ((!FAMISTUDIO_CFG_SFX_SUPPORT) || (.blank(reg_sweep)))) {
            if ((!.blank(reg_sweep)) && FAMISTUDIO_CFG_SMOOTH_VIBRATO) {
/* famistudio_smooth_vibrato @pitch, pulse_prev, reg_hi, reg_lo, reg_sweep */
            } else {
                cmp(a, *((pulse_prev) as *u8));
                goto (@compute_volume) if zero;
                *((pulse_prev) as *u8) = a;
            }
        }
    }

} // idx = 3

if (.blank(pulse_prev) || .blank(reg_sweep) || FAMISTUDIO_CFG_SFX_SUPPORT || (!FAMISTUDIO_CFG_SMOOTH_VIBRATO)) {
    *((reg_hi) as *u8) = a;
}

/* @compute_volume: */

    if (FAMISTUDIO_USE_VOLUME_TRACK) {
        a = *((famistudio_chn_volume_track+idx) as *u8);
        if (FAMISTUDIO_USE_VOLUME_SLIDES) {
            // During a slide, the lower 4 bits are fraction.
            a &= 0xf0;
        }
        a |= *((famistudio_env_value+env_offset+FAMISTUDIO_ENV_VOLUME_OFF) as *u8);
        x = a;
        a = *((famistudio_volume_table + x) as *u8);
    } else {
        a = *((famistudio_env_value+env_offset+FAMISTUDIO_ENV_VOLUME_OFF) as *u8);
    }

if (FAMISTUDIO_EXP_VRC6 && (idx = FAMISTUDIO_VRC6_CH2_IDX)) {
    // VRC6 saw has 6-bits
    x = *((famistudio_vrc6_saw_volume) as *u8);
    goto (@set_volume) if negative;
    *(() as *u8) <<= 1;
    x = *((famistudio_vrc6_saw_volume) as *u8);
    goto (@set_volume) if zero;
    *(() as *u8) <<= 1;
}

/* @set_volume: */

if (idx = 0 || idx = 1 || idx = 3 || (FAMISTUDIO_EXP_MMC5 && (idx = FAMISTUDIO_MMC5_CH0_IDX || idx = FAMISTUDIO_MMC5_CH1_IDX))) {
    x = *((famistudio_env_value+env_offset+FAMISTUDIO_ENV_DUTY_OFF) as *u8);
    a |= *((famistudio_duty_lookup + x) as *u8);
} else if (FAMISTUDIO_EXP_VRC6 && (idx = FAMISTUDIO_VRC6_CH0_IDX || idx = FAMISTUDIO_VRC6_CH1_IDX)) {
    x = *((famistudio_env_value+env_offset+FAMISTUDIO_ENV_DUTY_OFF) as *u8);
    a |= *((famistudio_vrc6_duty_lookup + x) as *u8);
}

// HACK : We are out of macro param for NESASM.
if (idx = 2) {
    a |= 0x80;
} else if (idx = 3) {
    a |= 0xf0;
}

    *((reg_vol) as *u8) = a;

/* .endmacro */

if (FAMISTUDIO_EXP_FDS) {

if (FAMISTUDIO_USE_FDS_AUTOMOD) {

//======================================================================================================================
// FAMISTUDIO_MUL (internal)
//
// From : https://codebase64.org/doku.php?id=base:8bit_multiplication_16bit_product
// Using the 16x8 version. May overflow if using too large numbers.
//
// [in]  ptr0 : 16-bit number
// [in]  r1   : 8-bit number
// [out] x+a  : Result lo-byte
// [out] y    : Result hi-byte
//======================================================================================================================

/* famistudio_mul: */

/* @num1 = famistudio_ptr1 */
/* @num2 = famistudio_r1 */

    a = 0x00;
    y = a;
    goto (@enter_loop) if zero;
/* @do_add: */
    carry = false;
    a +#= *((@num1+0) as *u8);
    x = a;
    a = y;
    a +#= *((@num1+1) as *u8);
    y = a;
    a = x;
/* @loop: */
    *((@num1+0) as *u8) <<= 1;
    *((@num1+1) as *u8) <<<<#= 1;
/* @enter_loop: */
    *((@num2) as *u8) >>>= 1;
    goto (@do_add) if carry;
    goto (@loop) if !zero;
    return;

//======================================================================================================================
// FAMISTUDIO_DIV (internal)
//
// From : https://forums.nesdev.org/viewtopic.php?p=895&sid=5c263dea8d9e3cf15cd1093856f211a9#p895 (tepples)
//
// [in]  ptr0 : 16-bit number
// [in]  r1   : 8-bit divisor
// [out] ptr0 : Result
// [out] a    : Remainder
//======================================================================================================================

/* famistudio_div: */

/* @dividend = famistudio_ptr1 */
/* @divisor  = famistudio_r1 */

    x = 16;
    a = 0;
/* @divloop: */
    *((@dividend) as *u8) <<= 1;
    *((@dividend+1) as *u8) <<<<#= 1;
    *((a) as *u8) <<<<#= 1;
    cmp(a, *((@divisor) as *u8));
    goto (@no_sub) if !carry;
    a -#= *((@divisor) as *u8);
    ++(*((@dividend) as *u8));
/* @no_sub: */
    --x;
    goto (@divloop) if !zero;
    return;

}

//======================================================================================================================
// FAMISTUDIO_UPDATE_FDS_CHANNEL_SOUND (internal)
//
// Updates the FDS audio registers.
//
// [in] no input params.
//======================================================================================================================

/* famistudio_update_fds_channel_sound: */

/* @pitch = famistudio_ptr1 */
/* @mul   = famistudio_r1 */
/* @div   = famistudio_r1 */

    a = *((famistudio_chn_note+FAMISTUDIO_FDS_CH0_IDX) as *u8);
    goto (@nocut) if !zero;
    goto (*((@set_volume) as *u8));

/* @nocut: */
    carry = false;
    a +#= *((famistudio_env_value+FAMISTUDIO_FDS_CH0_ENVS+FAMISTUDIO_ENV_NOTE_OFF) as *u8);
    if (FAMISTUDIO_DUAL_SUPPORT) {
        carry = false;
        a +#= *((famistudio_pal_adjust) as *u8);
    }
    x = a;

    y = 0;
/* famistudio_get_note_pitch_macro FAMISTUDIO_FDS_CH0_PITCH_ENV_IDX, 0, famistudio_fds_note_table_lsb, famistudio_fds_note_table_msb */

    a = *((@pitch+0) as *u8);
    *((FAMISTUDIO_FDS_FREQ_LO) as *u8) = a;
    a = *((@pitch+1) as *u8);
    *((FAMISTUDIO_FDS_FREQ_HI) as *u8) = a;
    if (FAMISTUDIO_USE_PHASE_RESET) {
        *((famistudio_fds_prev_hi) as *u8) = a;
    }

/* @check_mod_delay: */
    a = *((famistudio_fds_mod_delay_counter) as *u8);
    goto (@zero_delay) if zero;
    --(*((famistudio_fds_mod_delay_counter) as *u8));
    a = 0x80;
    *((FAMISTUDIO_FDS_MOD_HI) as *u8) = a;
    goto (@compute_volume) if !zero;

/* @zero_delay: */

    a = *((famistudio_fds_mod_depth) as *u8);
    goto (@mod_depth) if zero;

    if (FAMISTUDIO_USE_FDS_AUTOMOD) {
        a = *((famistudio_fds_automod_numer) as *u8);
        goto (@manual_mod) if zero;

/* @auto_mod_mul_div: */
            *((@mul) as *u8) = a;
            famistudio_mul();
            *((@pitch+0) as *u8) = x;
            *((@pitch+1) as *u8) = y;
            a = *((famistudio_fds_automod_denom) as *u8);
            *((@div) as *u8) = a;
            famistudio_div();
            a = *((@pitch+1) as *u8);
            cmp(a, 0x10);
            goto (@write_auto_mod) if !carry;
/* @write_max: */
                a = 0x0f;
                *((FAMISTUDIO_FDS_MOD_HI) as *u8) = a;
                a = 0xff;
                *((FAMISTUDIO_FDS_MOD_LO) as *u8) = a;
                goto (*((@mod_depth) as *u8));

/* @write_auto_mod: */
                *((FAMISTUDIO_FDS_MOD_HI) as *u8) = a;
                a = *((@pitch+0) as *u8);
                *((FAMISTUDIO_FDS_MOD_LO) as *u8) = a;
                goto (*((@mod_depth) as *u8));
    }

/* @manual_mod: */
        a = *((famistudio_fds_mod_speed+1) as *u8);
        *((FAMISTUDIO_FDS_MOD_HI) as *u8) = a;
        a = *((famistudio_fds_mod_speed+0) as *u8);
        *((FAMISTUDIO_FDS_MOD_LO) as *u8) = a;

/* @mod_depth: */
        a = *((famistudio_fds_mod_depth) as *u8);
        a |= 0x80;
        *((FAMISTUDIO_FDS_SWEEP_ENV) as *u8) = a;

/* @compute_volume: */
    if (FAMISTUDIO_USE_VOLUME_TRACK) {
        a = *((famistudio_chn_volume_track+FAMISTUDIO_FDS_CH0_IDX) as *u8);
        if (FAMISTUDIO_USE_VOLUME_SLIDES) {
            // During a slide, the lower 4 bits are fraction.
            a &= 0xf0;
        }
        a |= *((famistudio_env_value+FAMISTUDIO_FDS_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8);
        x = a;
        a = *((famistudio_volume_table + x) as *u8);
    } else {
        a = *((famistudio_env_value+FAMISTUDIO_FDS_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF) as *u8);
    }
    *(() as *u8) <<= 1; // FDS volume is 6-bits, but clamped to 32. Just double it.

/* @set_volume: */
    a |= 0x80;
    *((FAMISTUDIO_FDS_VOL_ENV) as *u8) = a;
    a = 0;
    *((famistudio_fds_override_flags) as *u8) = a;
    return;

}

if (FAMISTUDIO_EXP_VRC7) {

/* famistudio_vrc7_reg_table_lo: */
/* .byte FAMISTUDIO_VRC7_REG_LO_1, FAMISTUDIO_VRC7_REG_LO_2, FAMISTUDIO_VRC7_REG_LO_3, FAMISTUDIO_VRC7_REG_LO_4, FAMISTUDIO_VRC7_REG_LO_5, FAMISTUDIO_VRC7_REG_LO_6 */
/* famistudio_vrc7_reg_table_hi: */
/* .byte FAMISTUDIO_VRC7_REG_HI_1, FAMISTUDIO_VRC7_REG_HI_2, FAMISTUDIO_VRC7_REG_HI_3, FAMISTUDIO_VRC7_REG_HI_4, FAMISTUDIO_VRC7_REG_HI_5, FAMISTUDIO_VRC7_REG_HI_6 */
/* famistudio_vrc7_vol_table: */
/* .byte FAMISTUDIO_VRC7_REG_VOL_1, FAMISTUDIO_VRC7_REG_VOL_2, FAMISTUDIO_VRC7_REG_VOL_3, FAMISTUDIO_VRC7_REG_VOL_4, FAMISTUDIO_VRC7_REG_VOL_5, FAMISTUDIO_VRC7_REG_VOL_6 */
/* famistudio_vrc7_env_table: */
/* .byte FAMISTUDIO_VRC7_CH0_ENVS, FAMISTUDIO_VRC7_CH1_ENVS, FAMISTUDIO_VRC7_CH2_ENVS, FAMISTUDIO_VRC7_CH3_ENVS, FAMISTUDIO_VRC7_CH4_ENVS, FAMISTUDIO_VRC7_CH5_ENVS */
/* famistudio_vrc7_invert_vol_table: */
/* .byte $0f, $0e, $0d, $0c, $0b, $0a, $09, $08, $07, $06, $05, $04, $03, $02, $01, $00 */

// From nesdev wiki.
/* famistudio_vrc7_wait_reg_write: */
    *((famistudio_vrc7_dummy) as *u8) = x;
    x = 0x08;
/* @wait_loop: */
        --x;
        goto (@wait_loop) if !zero;
        x = *((famistudio_vrc7_dummy) as *u8);
    return;

// From nesdev wiki.
/* famistudio_vrc7_wait_reg_select: */
    return;

//======================================================================================================================
// FAMISTUDIO_UPDATE_VRC7_CHANNEL_SOUND (internal)
//
// Updates the VRC7 audio registers for a given channel.
//
// [in] y: VRC7 channel idx (0,1,2,3,4,5)
//======================================================================================================================

/* famistudio_update_vrc7_channel_sound: */

/* @tmp   = famistudio_r0 */
/* @pitch = famistudio_ptr1 */

/* @check_cut: */
    a = *((famistudio_chn_note+FAMISTUDIO_VRC7_CH0_IDX + y) as *u8);
    goto (@check_release) if !zero;

/* @cut: */
    // Untrigger note.
    a = *((famistudio_vrc7_reg_table_hi + y) as *u8);
    *((FAMISTUDIO_VRC7_REG_SEL) as *u8) = a;
    famistudio_vrc7_wait_reg_select();

    a = *((famistudio_chn_vrc7_prev_hi + y) as *u8);
    a &= 0xcf; // Remove trigger + sustain
    *((famistudio_chn_vrc7_prev_hi + y) as *u8) = a;
    *((FAMISTUDIO_VRC7_REG_WRITE) as *u8) = a;
    famistudio_vrc7_wait_reg_write();

    return;

/* @check_release: */

    a = *((famistudio_chn_vrc7_trigger + y) as *u8);
    goto (@check_attack) if !negative;

/* @release: */

        a = *((famistudio_chn_vrc7_prev_hi + y) as *u8);
        a &= 0xef; // remove trigger
        *((famistudio_chn_vrc7_prev_hi + y) as *u8) = a;
        goto (*((@musical_note) as *u8));

/* @check_attack: */

    a = *((famistudio_chn_vrc7_trigger + y) as *u8);
    a &= 1;
    goto (@musical_note) if zero;

/* @attack: */

        a = *((famistudio_chn_vrc7_prev_hi + y) as *u8);
        a &= 0x10;
        goto (@prev_note_had_release) if zero;

        // Two attacks in a row, need to insert a dummy release.
/* @prev_note_had_attack: */

            a = *((famistudio_vrc7_reg_table_hi + y) as *u8);
            *((FAMISTUDIO_VRC7_REG_SEL) as *u8) = a;
            famistudio_vrc7_wait_reg_select();
            a = 0;
            *((FAMISTUDIO_VRC7_REG_WRITE) as *u8) = a;
            famistudio_vrc7_wait_reg_write();
            goto (*((@musical_note) as *u8));

/* @prev_note_had_release: */
            a = *((famistudio_chn_vrc7_prev_hi + y) as *u8);
            a |= 0x10;
            *((famistudio_chn_vrc7_prev_hi + y) as *u8) = a;

/* @musical_note: */

    // Read/multiply volume
    x = *((famistudio_vrc7_env_table + y) as *u8);
    if (FAMISTUDIO_USE_VOLUME_TRACK) {
        a = *((famistudio_chn_volume_track+FAMISTUDIO_VRC7_CH0_IDX + y) as *u8);
        if (FAMISTUDIO_USE_VOLUME_SLIDES) {
            // During a slide, the lower 4 bits are fraction.
            a &= 0xf0;
        }
        a |= *((famistudio_env_value+FAMISTUDIO_ENV_VOLUME_OFF + x) as *u8);
    } else {
        a = *((famistudio_env_value+FAMISTUDIO_ENV_VOLUME_OFF + x) as *u8);
    }
    x = a;

    // Write volume
    a = *((famistudio_vrc7_vol_table + y) as *u8);
    *((FAMISTUDIO_VRC7_REG_SEL) as *u8) = a;
    famistudio_vrc7_wait_reg_select();
    if (FAMISTUDIO_USE_VOLUME_TRACK) {
        a = *((famistudio_volume_table + x) as *u8);
        x = a;
    }
    a = *((famistudio_vrc7_invert_vol_table + x) as *u8);
    a |= *((famistudio_chn_vrc7_patch + y) as *u8);
    *((FAMISTUDIO_VRC7_REG_WRITE) as *u8) = a;
    famistudio_vrc7_wait_reg_write();

    // Read note, apply arpeggio
    x = *((famistudio_vrc7_env_table + y) as *u8);
    a = *((famistudio_chn_note+FAMISTUDIO_VRC7_CH0_IDX + y) as *u8);
    carry = false;
    a +#= *((famistudio_env_value+FAMISTUDIO_ENV_NOTE_OFF + x) as *u8);
    x = a;

    // Apply pitch envelope, fine pitch & slides
/* famistudio_get_note_pitch_macro FAMISTUDIO_VRC7_CH0_PITCH_ENV_IDX, FAMISTUDIO_VRC7_PITCH_SHIFT, famistudio_vrc7_note_table_lsb, famistudio_vrc7_note_table_msb */

    // Compute octave by dividing by 2 until we are <= 512 (0x100).
    x = 0;
/* @compute_octave_loop: */
        a = *((@pitch+1) as *u8);
        cmp(a, 2);
        goto (@octave_done) if !carry;
        *(() as *u8) >>>= 1;
        *((@pitch+1) as *u8) = a;
        *((@pitch+0) as *u8) >>>>#= 1;
        ++x;
        goto (*((@compute_octave_loop) as *u8));

/* @octave_done: */

    // Write pitch (lo)
    a = *((famistudio_vrc7_reg_table_lo + y) as *u8);
    *((FAMISTUDIO_VRC7_REG_SEL) as *u8) = a;
    famistudio_vrc7_wait_reg_select();

    a = *((@pitch+0) as *u8);
    *((FAMISTUDIO_VRC7_REG_WRITE) as *u8) = a;
    famistudio_vrc7_wait_reg_write();

    // Write pitch (hi)
    a = *((famistudio_chn_vrc7_prev_hi + y) as *u8);
    a &= 0x10;
    *((@tmp) as *u8) = a;

    a = *((famistudio_vrc7_reg_table_hi + y) as *u8);
    *((FAMISTUDIO_VRC7_REG_SEL) as *u8) = a;
    famistudio_vrc7_wait_reg_select();

    a = x;
    *(() as *u8) <<= 1;
    a |= 0x20;
    a |= *((@pitch+1) as *u8);
    a |= *((@tmp) as *u8);
    *((famistudio_chn_vrc7_prev_hi + y) as *u8) = a;
    *((FAMISTUDIO_VRC7_REG_WRITE) as *u8) = a;
    famistudio_vrc7_wait_reg_write();

    a = 0;
    *((famistudio_chn_vrc7_trigger + y) as *u8) = a;

    return;

}

if (FAMISTUDIO_EXP_EPSM) {
/* FM_ENV_OFFSET = FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT*4 */
/* RHY_ENV_OFFSET = FM_ENV_OFFSET + FAMISTUDIO_EXP_EPSM_FM_CHN_CNT*2 */
if (FAMISTUDIO_EXP_EPSM_FM_CHN_CNT > 0) {
/* famistudio_epsm_vol_table_op1: */
/* .byte FAMISTUDIO_EPSM_REG_TL, FAMISTUDIO_EPSM_REG_TL+1, FAMISTUDIO_EPSM_REG_TL+2,FAMISTUDIO_EPSM_REG_TL, FAMISTUDIO_EPSM_REG_TL+1, FAMISTUDIO_EPSM_REG_TL+2 */
/* famistudio_epsm_vol_table_op2: */
/* .byte FAMISTUDIO_EPSM_REG_TL+8, FAMISTUDIO_EPSM_REG_TL+1+8, FAMISTUDIO_EPSM_REG_TL+2+8,FAMISTUDIO_EPSM_REG_TL+8, FAMISTUDIO_EPSM_REG_TL+1+8, FAMISTUDIO_EPSM_REG_TL+2+8 */
/* famistudio_epsm_vol_table_op3: */
/* .byte FAMISTUDIO_EPSM_REG_TL+4, FAMISTUDIO_EPSM_REG_TL+1+4, FAMISTUDIO_EPSM_REG_TL+2+4,FAMISTUDIO_EPSM_REG_TL+4, FAMISTUDIO_EPSM_REG_TL+1+4, FAMISTUDIO_EPSM_REG_TL+2+4 */
/* famistudio_epsm_vol_table_op4: */
/* .byte FAMISTUDIO_EPSM_REG_TL+12, FAMISTUDIO_EPSM_REG_TL+1+12, FAMISTUDIO_EPSM_REG_TL+2+12,FAMISTUDIO_EPSM_REG_TL+12, FAMISTUDIO_EPSM_REG_TL+1+12, FAMISTUDIO_EPSM_REG_TL+2+12 */
/* famistudio_epsm_fm_vol_table: */
/* .byte $7e, $65, $50, $3f, $32, $27, $1e, $17, $12, $0d, $09, $06, $04, $02, $01, $00 */
/* famistudio_epsm_fm_stereo_reg_table: */
/* .byte $b4,$b5,$b6 */
/* .byte $b4,$b5,$b6 */
/* famistudio_channel_epsm_chan_table: */
/* .byte $00, $01, $02 */
/* .byte $00, $01, $02 */
}
if (FAMISTUDIO_EXP_EPSM_RHYTHM_CNT > 0) {
/* famistudio_epsm_rhythm_key_table: */
/* .byte $01,$02,$04,$08,$10,$20 */
/* famistudio_epsm_rhythm_reg_table: */
/* .byte FAMISTUDIO_EPSM_REG_RHY_BD, FAMISTUDIO_EPSM_REG_RHY_SD, FAMISTUDIO_EPSM_REG_RHY_TC, FAMISTUDIO_EPSM_REG_RHY_HH, FAMISTUDIO_EPSM_REG_RHY_TOM, FAMISTUDIO_EPSM_REG_RHY_RIM */
}
if (FAMISTUDIO_EXP_EPSM_FM_CHN_CNT > 0) {
/* famistudio_epsm_reg_table_lo: */
/* .byte FAMISTUDIO_EPSM_REG_FN_LO, FAMISTUDIO_EPSM_REG_FN_LO2, FAMISTUDIO_EPSM_REG_FN_LO3, FAMISTUDIO_EPSM_REG_FN_LO, FAMISTUDIO_EPSM_REG_FN_LO2, FAMISTUDIO_EPSM_REG_FN_LO3 */
/* famistudio_epsm_reg_table_hi: */
/* .byte FAMISTUDIO_EPSM_REG_FN_HI, FAMISTUDIO_EPSM_REG_FN_HI2, FAMISTUDIO_EPSM_REG_FN_HI3, FAMISTUDIO_EPSM_REG_FN_HI, FAMISTUDIO_EPSM_REG_FN_HI2, FAMISTUDIO_EPSM_REG_FN_HI3 */
/* famistudio_epsm_vol_table: */
/* .byte FAMISTUDIO_EPSM_REG_VOL_1, FAMISTUDIO_EPSM_REG_VOL_2, FAMISTUDIO_EPSM_REG_VOL_3, FAMISTUDIO_EPSM_REG_VOL_4, FAMISTUDIO_EPSM_REG_VOL_5, FAMISTUDIO_EPSM_REG_VOL_6 */
/* famistudio_epsm_fm_env_table: */
/* .byte FAMISTUDIO_EPSM_CH0_ENVS + FM_ENV_OFFSET */
/* .byte FAMISTUDIO_EPSM_CH0_ENVS + FM_ENV_OFFSET + 2 */
/* .byte FAMISTUDIO_EPSM_CH0_ENVS + FM_ENV_OFFSET + 4 */
/* .byte FAMISTUDIO_EPSM_CH0_ENVS + FM_ENV_OFFSET + 6 */
/* .byte FAMISTUDIO_EPSM_CH0_ENVS + FM_ENV_OFFSET + 8 */
/* .byte FAMISTUDIO_EPSM_CH0_ENVS + FM_ENV_OFFSET + 10 */
/* famistudio_epsm_register_order: */
/* .byte $B0, $B4, $30, $50, $60, $70, $80, $90, $38, $58, $68, $78, $88, $98, $34, $54, $64, $74, $84, $94, $3c, $5c, $6c, $7c, $8c, $9c, $40, $48, $44, $4c, $22 ;40,48,44,4c replaced for not sending data there during instrument updates, */
/* famistudio_epsm_channel_key_table: */
/* .byte $f0, $f1, $f2, $f4, $f5, $f6 */
}
if (FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0) {
/* famistudio_epsm_sqr_reg_table_lo: */
/* .byte FAMISTUDIO_EPSM_REG_LO_A, FAMISTUDIO_EPSM_REG_LO_B, FAMISTUDIO_EPSM_REG_LO_C */
/* famistudio_epsm_sqr_reg_table_hi: */
/* .byte FAMISTUDIO_EPSM_REG_HI_A, FAMISTUDIO_EPSM_REG_HI_B, FAMISTUDIO_EPSM_REG_HI_C */
/* famistudio_epsm_square_vol_table: */
/* .byte FAMISTUDIO_EPSM_REG_VOL_A, FAMISTUDIO_EPSM_REG_VOL_B, FAMISTUDIO_EPSM_REG_VOL_C */
/* famistudio_epsm_square_env_table: */
/* .byte FAMISTUDIO_EPSM_CH0_ENVS, FAMISTUDIO_EPSM_CH1_ENVS, FAMISTUDIO_EPSM_CH2_ENVS */
/* famistudio_epsm_square_noise_mask: */
/* .byte $08, $10, $20 */
}
//======================================================================================================================
// FAMISTUDIO_UPDATE_EPSM_SQUARE_CHANNEL_SOUND (internal)
//
// Updates the EPSM audio registers for a given channel.
//
// [in] y: EPSM channel idx (0,1,2)
//======================================================================================================================

if (FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0) {
/* famistudio_update_epsm_square_channel_sound: */

/* @pitch   = famistudio_ptr1 */
/* @env_bit = famistudio_ptr1_lo */

    // These are shared by all 3 channels.
/* @env_period = famistudio_ptr0 */
/* @attack     = famistudio_ptr2 */
/* @env_shape  = famistudio_r1 */
/* @env_octave = famistudio_r2 */
/* @noise_freq = famistudio_r3 */

    // First channel will clear these, last channel will write the registers.
    cmp(y, 0);
    goto (@not_first_channel) if !zero;
    *((@env_shape) as *u8) = y;
    *((@noise_freq) as *u8) = y;
    *((@attack) as *u8) = y;
    a = 0x80; // This mean 'manual pitch'
    *((@env_octave) as *u8) = y;

/* @not_first_channel: */
    x = 0; // This will fetch volume 0.
    *((@env_bit) as *u8) = x;
    a = *((famistudio_chn_note+FAMISTUDIO_EPSM_CH0_IDX + y) as *u8);
    goto (@nocut) if !zero;
    goto (*((@update_volume) as *u8));

/* @nocut: */
    // Store noise if mixer has it enabled
    x = *((famistudio_epsm_square_env_table + y) as *u8);
    a = *((famistudio_env_value+FAMISTUDIO_ENV_MIXER_IDX_OFF + x) as *u8);
    a &= *((famistudio_epsm_square_noise_mask + y) as *u8);
    goto (@nonoise) if !zero;
    a = *((famistudio_env_value+FAMISTUDIO_ENV_NOISE_IDX_OFF + x) as *u8);
    *((@noise_freq) as *u8) = a;

/* @nonoise: */
    a = *((famistudio_chn_note+FAMISTUDIO_EPSM_CH0_IDX + y) as *u8);
    // Read note, apply arpeggio
    carry = false;
    x = *((famistudio_epsm_square_env_table + y) as *u8);
    a +#= *((famistudio_env_value+FAMISTUDIO_ENV_NOTE_OFF + x) as *u8);
    x = a;

    // Apply pitch envelope, fine pitch & slides
/* famistudio_get_note_pitch_macro FAMISTUDIO_EPSM_CH0_PITCH_ENV_IDX, 0, famistudio_epsm_s_note_table_lsb, famistudio_epsm_s_note_table_msb */

    // Write pitch
    a = *((famistudio_epsm_sqr_reg_table_lo + y) as *u8);
    *((FAMISTUDIO_EPSM_ADDR) as *u8) = a;
    a = *((@pitch+0) as *u8);
    *((FAMISTUDIO_EPSM_DATA) as *u8) = a;
    a = *((famistudio_epsm_sqr_reg_table_hi + y) as *u8);
    *((FAMISTUDIO_EPSM_ADDR) as *u8) = a;
    a = *((@pitch+1) as *u8);
    *((FAMISTUDIO_EPSM_DATA) as *u8) = a;

    // Store env shape + period if active.
    a = *((famistudio_epsm_chn_env_shape + y) as *u8);
    a &= 0x0f;
    goto (@noenv) if zero;
    *((@env_shape) as *u8) = a;

    // If bit 7 of any channel is on, well reset the envelope.
    a = *((famistudio_epsm_chn_env_shape + y) as *u8);
    a |= *((@attack) as *u8);
    *((@attack) as *u8) = a;
    a = *((famistudio_epsm_chn_env_shape + y) as *u8);
    a &= 0x0f;
    *((famistudio_epsm_chn_env_shape + y) as *u8) = a;

    // Store auto-period settings
    a = *((famistudio_epsm_chn_env_octave + y) as *u8);
    *((@env_octave) as *u8) = a;
    cmp(a, 0x80); // This mean 'manual pitch'
    goto (@manual_period) if zero;

/* @auto_period: */
        a = *((@pitch+0) as *u8);
        *((@env_period+0) as *u8) = a;
        a = *((@pitch+1) as *u8);
        *((@env_period+1) as *u8) = a;
        goto (*((@set_envelope_volume_flag) as *u8));

/* @manual_period: */
        a = *((famistudio_epsm_env_period_lo) as *u8);
        *((@env_period+0) as *u8) = a;
        a = *((famistudio_epsm_env_period_hi) as *u8);
        *((@env_period+1) as *u8) = a;

/* @set_envelope_volume_flag: */
    a = 0x10;

/* @noenv: */
    *((@env_bit) as *u8) = a;

    // Read/multiply volume
    x = *((famistudio_epsm_square_env_table + y) as *u8);
    if (FAMISTUDIO_USE_VOLUME_TRACK) {
        a = *((famistudio_chn_volume_track+FAMISTUDIO_EPSM_CH0_IDX + y) as *u8);
        if (FAMISTUDIO_USE_VOLUME_SLIDES) {
            // During a slide, the lower 4 bits are fraction.
            a &= 0xf0;
        }
        a |= *((famistudio_env_value+FAMISTUDIO_ENV_VOLUME_OFF + x) as *u8);
    } else {
        a = *((famistudio_env_value+FAMISTUDIO_ENV_VOLUME_OFF + x) as *u8);
    }
    x = a;

/* @update_volume: */
    // Write volume
    a = *((famistudio_epsm_square_vol_table + y) as *u8);
    *((FAMISTUDIO_EPSM_ADDR) as *u8) = a;
    if (FAMISTUDIO_USE_VOLUME_TRACK) {
        a = *((famistudio_volume_table + x) as *u8);
        a |= *((@env_bit) as *u8);
    } else {
        a = x;
        a |= *((@env_bit) as *u8);
    }
    *((FAMISTUDIO_EPSM_DATA) as *u8) = a;

/* @write_shared_registers: */
    // Channel 2 writes all 5 shared registers.
    cmp(y, (FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT - 1));
    goto (@done) if !zero;
    a = *((@env_shape) as *u8);
    goto (@write_shared_noise) if zero;
    x = *((@env_octave) as *u8);
    cmp(x, 0x80);
    goto (@write_shared_env_register) if zero;

/* @compute_auto_period: */
    cmp(x, 0);
    goto (@write_shared_env_register) if zero;
    goto (@positive_octave_loop) if !negative;

/* @negative_octave_loop: */
            *((@env_period+0) as *u8) <<= 1;
            *((@env_period+1) as *u8) <<<<#= 1;
            ++x;
            goto (@negative_octave_loop) if !zero;
        goto (@write_shared_env_register) if zero;

/* @positive_octave_loop: */
        cmp(x, 1);
        goto (@do_shift) if !zero;
/* @rounding: */
            a = *((@env_period+0) as *u8);
            a &= 1;
            goto (@do_shift) if zero;
            a = *((@env_period+0) as *u8);
            carry = false;
            a +#= 1;
            *((@env_period+0) as *u8) = a;
            goto (@do_shift) if !carry;
            ++(*((@env_period+1) as *u8));
/* @do_shift: */
            *((@env_period+1) as *u8) >>>= 1;
            *((@env_period+0) as *u8) >>>>#= 1;
            --x;
            goto (@positive_octave_loop) if !zero;

/* @write_shared_env_register: */

    // Envelope period.
    a = FAMISTUDIO_EPSM_REG_ENV_LO;
    *((FAMISTUDIO_EPSM_ADDR) as *u8) = a;
    a = *((@env_period+0) as *u8);
    *((FAMISTUDIO_EPSM_DATA) as *u8) = a;
    a = FAMISTUDIO_EPSM_REG_ENV_HI;
    *((FAMISTUDIO_EPSM_ADDR) as *u8) = a;
    a = *((@env_period+1) as *u8);
    *((FAMISTUDIO_EPSM_DATA) as *u8) = a;

    // Reset envelope if there was an attack.
    a = *((@attack) as *u8);
    goto (@write_shared_noise) if !negative;
        a = FAMISTUDIO_EPSM_REG_SHAPE;
        *((FAMISTUDIO_EPSM_ADDR) as *u8) = a;
        a = *((@env_shape) as *u8);
        *((FAMISTUDIO_EPSM_DATA) as *u8) = a;

/* @write_shared_noise: */

    // Tone/noise enabled.
    a = FAMISTUDIO_EPSM_REG_TONE;
    *((FAMISTUDIO_EPSM_ADDR) as *u8) = a;
if (FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT = 3) {
    a = *((famistudio_env_value+FAMISTUDIO_EPSM_CH2_ENVS+FAMISTUDIO_ENV_MIXER_IDX_OFF) as *u8);
    *(() as *u8) <<= 1;
    a |= *((famistudio_env_value+FAMISTUDIO_EPSM_CH1_ENVS+FAMISTUDIO_ENV_MIXER_IDX_OFF) as *u8);
    *(() as *u8) <<= 1;
    a |= *((famistudio_env_value+FAMISTUDIO_EPSM_CH0_ENVS+FAMISTUDIO_ENV_MIXER_IDX_OFF) as *u8);
} else if (FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT = 2) {
    a = *((famistudio_env_value+FAMISTUDIO_EPSM_CH1_ENVS+FAMISTUDIO_ENV_MIXER_IDX_OFF) as *u8);
    *(() as *u8) <<= 1;
    a |= *((famistudio_env_value+FAMISTUDIO_EPSM_CH0_ENVS+FAMISTUDIO_ENV_MIXER_IDX_OFF) as *u8);
} else {
    a = *((famistudio_env_value+FAMISTUDIO_EPSM_CH0_ENVS+FAMISTUDIO_ENV_MIXER_IDX_OFF) as *u8);
}
    *((FAMISTUDIO_EPSM_DATA) as *u8) = a;

    // Noise freq
    a = FAMISTUDIO_EPSM_REG_NOISE;
    *((FAMISTUDIO_EPSM_ADDR) as *u8) = a;
    a = *((@noise_freq) as *u8);
    *((FAMISTUDIO_EPSM_DATA) as *u8) = a;

    a = 0;
    *((famistudio_epsm_env_override) as *u8) = a;

/* @done: */
    return;

}
if (FAMISTUDIO_EXP_EPSM_FM_CHN_CNT > 0) {
//======================================================================================================================
// FAMISTUDIO_UPDATE_EPSM_FM_CHANNEL_SOUND (internal)
//
// Updates the EPSM audio registers for a given channel.
//
// [in] y: EPSM channel idx (0,1,2,3,4,5)
//======================================================================================================================
/* famistudio_update_epsm_fm_channel_sound: */

/* @pitch      = famistudio_ptr1 */
/* @reg_offset = famistudio_r1 */
/* @vol_offset = famistudio_r0 */
/* @chan_idx   = famistudio_r2 */

    *((@chan_idx) as *u8) = y;
    // If the writes are done to channels 0-2, use FAMISTUDIO_EPSM_REG_SEL0 if 3-5 use FAMISTUDIO_EPSM_REG_SEL1
    // This reg_offset stores the difference so we can later load it into x and do sta FAMISTUDIO_EPSM_REG_SEL0, x
    // to account for the difference
    a = 0;
    cmp(y, 3);
    goto (@fm_0_2) if !carry;
        a = 2;
/* @fm_0_2: */
    *((@reg_offset) as *u8) = a;

/* @check_cut: */

    a = *((famistudio_chn_note+FAMISTUDIO_EPSM_CHAN_FM_START + y) as *u8);
    goto (@nocut) if !zero;

/* @cut: */
    // Untrigger note.
    a = FAMISTUDIO_EPSM_REG_KEY;
    *((FAMISTUDIO_EPSM_REG_SEL0) as *u8) = a;

    a = *((famistudio_epsm_channel_key_table + y) as *u8);
    a &= 0x0f; // remove trigger
    *((FAMISTUDIO_EPSM_REG_WRITE0) as *u8) = a;

    //Mute channel
    x = *((@reg_offset) as *u8);
    a = *((famistudio_epsm_fm_stereo_reg_table + y) as *u8);
    *((FAMISTUDIO_EPSM_REG_SEL0 + x) as *u8) = a;
    a = 0x00;
    *((FAMISTUDIO_EPSM_REG_WRITE0 + x) as *u8) = a;
    return;

/* @nocut: */

    // Check if the channel needs to stop the note

    // Un-trigger previous note if needed.
    a = *((famistudio_chn_epsm_trigger + y) as *u8);
    goto (@update_instrument_check) if zero;
/* @untrigger_prev_note: */
        // Untrigger note.
        a = FAMISTUDIO_EPSM_REG_KEY;
        *((FAMISTUDIO_EPSM_REG_SEL0) as *u8) = a;

        a = *((famistudio_epsm_channel_key_table + y) as *u8);
        a &= 0x0f; // remove trigger
        *((FAMISTUDIO_EPSM_REG_WRITE0) as *u8) = a;
//        nop
//        nop
//        nop
        nop();
        nop();
        nop();
//        rts
/* @update_instrument_check: */
    a = *((famistudio_chn_epsm_fm_instrument + y) as *u8);
    cmp(a, 0xff);
    goto (@no_instrument_update) if zero;
    update_fm_instrument();
    y = *((@chan_idx) as *u8);
    a = 0xff;
    *((famistudio_chn_epsm_fm_instrument + y) as *u8) = a;
/* @no_instrument_update: */

    x = *((@reg_offset) as *u8);
    a = *((famistudio_epsm_fm_stereo_reg_table + y) as *u8);
    *((FAMISTUDIO_EPSM_REG_SEL0 + x) as *u8) = a;
    a = *((famistudio_chn_epsm_fm_stereo + y) as *u8);
    *((FAMISTUDIO_EPSM_REG_WRITE0 + x) as *u8) = a;
    a = *((famistudio_chn_note+FAMISTUDIO_EPSM_CHAN_FM_START + y) as *u8);
    // Read note, apply arpeggio
    carry = false;
    x = *((famistudio_epsm_fm_env_table + y) as *u8);
    a +#= *((famistudio_env_value+FAMISTUDIO_ENV_NOTE_OFF + x) as *u8);
    x = a;

    // Apply pitch envelope, fine pitch & slides
/* famistudio_get_note_pitch_macro (FAMISTUDIO_EPSM_CH0_PITCH_ENV_IDX + FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT), FAMISTUDIO_EPSM_PITCH_SHIFT, famistudio_epsm_note_table_lsb, famistudio_epsm_note_table_msb */

    // Compute octave by dividing by 2 until we are <= 512 (0x100).
    x = 0;

    a = *((@pitch+1) as *u8);
    cmp(a, 0x02); // check if shifted the pitch to a 9 bit number yet.
    goto (@octave_done) if !carry;
/* @compute_octave_loop: */
        ++x;
        *(() as *u8) >>>= 1;
        *((@pitch+0) as *u8) >>>>#= 1;
        cmp(a, 0x02);
        goto (@octave_done) if !carry;
        goto (@compute_octave_loop) if carry; //unconditional
/* @octave_done: */
    *((@pitch+1) as *u8) = a;

    // 9 bit pitch * 4 to get the pitch back to an 11 bit number
    // the final 16 bit pitch will look like 00ooohhh llllllll where o = octave, h = pitch bits 8-11, l = pitch bits 0-8
    *((@pitch+0) as *u8) <<= 1;
    *((@pitch+1) as *u8) <<<<#= 1;
    *((@pitch+0) as *u8) <<= 1;
    *((@pitch+1) as *u8) <<<<#= 1;

    a = x; // x holds the 3 bit octave information. octave = log2(pitch_hi)
    *(() as *u8) <<= 1;
    *(() as *u8) <<= 1;
    *(() as *u8) <<= 1;
    a |= *((@pitch+1) as *u8);
    *((@pitch+1) as *u8) = a;

/* @write_hi_period: */

    // Write pitch (hi)
    x = *((@reg_offset) as *u8);
    a = *((famistudio_epsm_reg_table_hi + y) as *u8);
    *((FAMISTUDIO_EPSM_REG_SEL0 + x) as *u8) = a;
    a = *((@pitch+1) as *u8);
    *((FAMISTUDIO_EPSM_REG_WRITE0 + x) as *u8) = a;

    // Write pitch (lo)
    a = *((famistudio_epsm_reg_table_lo + y) as *u8);
    *((FAMISTUDIO_EPSM_REG_SEL0 + x) as *u8) = a;
    a = *((@pitch+0) as *u8);
    *((FAMISTUDIO_EPSM_REG_WRITE0 + x) as *u8) = a;

    // Read/multiply volume
    x = *((famistudio_epsm_fm_env_table + y) as *u8);
    if (FAMISTUDIO_USE_VOLUME_TRACK) {
        a = *((famistudio_chn_volume_track+FAMISTUDIO_EPSM_CHAN_FM_START + y) as *u8);
        if (FAMISTUDIO_USE_VOLUME_SLIDES) {
            // During a slide, the lower 4 bits are fraction.
            a &= 0xf0;
        }
        a |= *((famistudio_env_value+FAMISTUDIO_ENV_VOLUME_OFF + x) as *u8);
    } else {
        a = *((famistudio_env_value+FAMISTUDIO_ENV_VOLUME_OFF + x) as *u8);
    }

    if (FAMISTUDIO_USE_VOLUME_TRACK) {
        x = a;
        a = *((famistudio_volume_table + x) as *u8);
    }
        *((@vol_offset) as *u8) = a;

/* @update_volume: */
    x = *((@vol_offset) as *u8);
    a = *((famistudio_epsm_fm_vol_table + x) as *u8);
    *((@vol_offset) as *u8) = a; // store volume level here

    x = *((@reg_offset) as *u8);
    a = *((famistudio_chn_epsm_alg + y) as *u8);
    cmp(a, 4);
    goto (@op_4) if !carry; // 0-1-2-3
    goto (@op_2_4) if zero; // 4
    cmp(a, 7); // 5
    goto (@op_2_3_4) if !carry; // 6
               // 7
/* @op_1_2_3_4: */
        a = *((famistudio_epsm_vol_table_op1 + y) as *u8);
        *((FAMISTUDIO_EPSM_REG_SEL0 + x) as *u8) = a;
        a = *((famistudio_chn_epsm_vol_op1 + y) as *u8);
        carry = false;
        a +#= *((@vol_offset) as *u8);
        goto (@save_op1) if !negative;
        a = 127;
/* @save_op1: */
        *((FAMISTUDIO_EPSM_REG_WRITE0 + x) as *u8) = a;
/* @op_2_3_4: */
        a = *((famistudio_epsm_vol_table_op3 + y) as *u8);
        *((FAMISTUDIO_EPSM_REG_SEL0 + x) as *u8) = a;
        a = *((famistudio_chn_epsm_vol_op3 + y) as *u8);
        carry = false;
        a +#= *((@vol_offset) as *u8);
        goto (@save_op3) if !negative;
        a = 127;
/* @save_op3: */
        *((FAMISTUDIO_EPSM_REG_WRITE0 + x) as *u8) = a;
/* @op_2_4: */
        a = *((famistudio_epsm_vol_table_op2 + y) as *u8);
        *((FAMISTUDIO_EPSM_REG_SEL0 + x) as *u8) = a;
        a = *((famistudio_chn_epsm_vol_op2 + y) as *u8);
        carry = false;
        a +#= *((@vol_offset) as *u8);
        goto (@save_op2) if !negative;
        a = 127;
/* @save_op2: */
        *((FAMISTUDIO_EPSM_REG_WRITE0 + x) as *u8) = a;
/* @op_4: */
        // Write volume
        a = *((famistudio_epsm_vol_table_op4 + y) as *u8); // 4
        *((FAMISTUDIO_EPSM_REG_SEL0 + x) as *u8) = a; // 5
        a = *((famistudio_chn_epsm_vol_op4 + y) as *u8); // 4
    carry = false; // 2
        a +#= *((@vol_offset) as *u8); // 3
        goto (@save_op4) if !negative; // 2/3
        a = 127; // 2
/* @save_op4: */
        *((FAMISTUDIO_EPSM_REG_WRITE0 + x) as *u8) = a; // 5  = 26/27

        nop();
        carry = false;
        a = *((famistudio_chn_epsm_trigger + y) as *u8);
        goto (@no_release) if !negative;

/* @release: */
        // Untrigger note.
        a = FAMISTUDIO_EPSM_REG_KEY;
        *((FAMISTUDIO_EPSM_REG_SEL0) as *u8) = a;

        a = *((famistudio_epsm_channel_key_table + y) as *u8);
        a &= 0x0f; // remove trigger
        *((FAMISTUDIO_EPSM_REG_WRITE0) as *u8) = a;

        return;
/* @no_release: */
        a = 0;
        *((famistudio_chn_epsm_trigger + y) as *u8) = a;
        a = FAMISTUDIO_EPSM_REG_KEY;
        *((FAMISTUDIO_EPSM_REG_SEL0) as *u8) = a;
        a = *((famistudio_epsm_channel_key_table + y) as *u8);
        *((FAMISTUDIO_EPSM_REG_WRITE0) as *u8) = a;

    return;


//======================================================================================================================
// FAMISTUDIO_EPSM_WRITE_PATCH_REGISTER (internal)
//
// Internal function to set a EPSM instrument for a given channel
//
// [in] y/r0: channel index
// [in] x:    index of first envelope of instrument
// [in] a:    instrument index.
//======================================================================================================================
/* .macro famistudio_epsm_write_patch_registers select, write */

/* .local @loop_main_patch */
/* .local @loop_extra_patch */
/* .local @alg_4 */
/* .local @alg_5_6 */
/* .local @alg_0_1_2_3 */

    y = 30-5; // we skip updating the 4 operators
    x = *((@reg_offset) as *u8);
/* @loop_extra_patch: */
        a = x; // 2
        a |= *((famistudio_epsm_register_order + y) as *u8); // 4
        *((select) as *u8) = a; // 4
        a = *(((@ex_patch),y) as *u8); // 5
        *((write) as *u8) = a; // 4
        --y; // 2
        nop(); // 2 DELAY FOR MESEN-X
        goto (@loop_extra_patch) if !negative; // 3  ; =26

    x = *((@chan_idx2) as *u8);
    a = *((famistudio_chn_epsm_alg + x) as *u8);
    cmp(a, 4);
    goto (@alg_0_1_2_3) if !carry; // 0-1-2-3
    goto (@alg_4) if zero; // 4
    goto (*((@alg_5_6) as *u8)); // 5
/* @alg_0_1_2_3: */
    //3+2+1
    y = 27;
    x = *((@reg_offset) as *u8);
    a = x; // 2
    a |= *((famistudio_epsm_register_order + y) as *u8); // 4
    *((select) as *u8) = a; // 4
    a = *(((@ex_patch),y) as *u8); // 5
    *((write) as *u8) = a; // 4
    nop(); // 2 DELAY FOR MESEN-X
/* @alg_4: */
    //3+1
    y = 28;
    x = *((@reg_offset) as *u8);
    a = x; // 2
    a |= *((famistudio_epsm_register_order + y) as *u8); // 4
    *((select) as *u8) = a; // 4
    a = *(((@ex_patch),y) as *u8); // 5
    *((write) as *u8) = a; // 4
    nop(); // 2 DELAY FOR MESEN-X
/* @alg_5_6: */
    //1
    y = 26;
    x = *((@reg_offset) as *u8);
    a = x; // 2
    a |= *((famistudio_epsm_register_order + y) as *u8); // 4
    *((select) as *u8) = a; // 4
    a = *(((@ex_patch),y) as *u8); // 5
    *((write) as *u8) = a; // 4
    nop(); // 2 DELAY FOR MESEN-X
/* .endmacro */

//======================================================================================================================
// FAMISTUDIO_UPDATE_EPSM_FM_INSTRUMENT (internal)
//
// Updates the EPSM audio registers for a given channel.
//
// [in] y: EPSM channel idx (0,1,2,3,4,5)
//======================================================================================================================
    // Now we are dealing with either a FM or Rhythm instrument. a = channel index
    // if we are an FM instrument then there is a offset we need to apply to the register select

    // Skip over the two SSG specific envelopes by jumping up 4 bytes
/* update_fm_instrument: */
/* @ptr          = famistudio_ptr1 */
/* @env_ptr      = famistudio_ptr2 */
/* @ex_patch     = famistudio_ptr2 */
/* @chan_idx     = famistudio_r0 */
/* @chan_idx2    = famistudio_r2 */
/* @update_flags = famistudio_r1 ; bit 7 = no attack, bit 6 = has set delayed cut */
/* @reg_offset   = famistudio_r3 */
    famistudio_get_exp_inst_ptr();
    carry = false;
    a = y;
    a +#= 14; // skip over envelopes + square stuff.
    y = a;
    // And then read the pointer to the extended instrument patch data
    a = *(((@ptr),y) as *u8);
    *((@ex_patch) as *u8) = a;
    ++y;
    a = *(((@ptr),y) as *u8);
    *((@ex_patch+1) as *u8) = a;

/* @fm_channel: */
    x = *((@chan_idx2) as *u8);
    // FM channel 1-6, we need to look up the register select offset from the table
    a = *((famistudio_channel_epsm_chan_table + x) as *u8);
    *((@reg_offset) as *u8) = a;
    y = 0;
    // Now we need to store the algorithm and stereo for later use
    a = *(((@ex_patch),y) as *u8);
    a &= 0x07;
    *((famistudio_chn_epsm_alg + x) as *u8) = a; //store algorithm
    ++y;
    a = *(((@ex_patch),y) as *u8);
    *((famistudio_chn_epsm_fm_stereo  + x) as *u8) = a;
    --y;

    // Now if we are channels 1-3 then we use @reg_set_0, otherwise for 4-6 its reg set 1
    a = *((@chan_idx2) as *u8);
    cmp(a, 3);
    goto (@reg_set_1) if !negative;

/* @reg_set_0: */
/* famistudio_epsm_write_patch_registers FAMISTUDIO_EPSM_REG_SEL0, FAMISTUDIO_EPSM_REG_WRITE0 */
        goto (*((@last_reg) as *u8));

/* @reg_set_1: */
/* famistudio_epsm_write_patch_registers FAMISTUDIO_EPSM_REG_SEL1, FAMISTUDIO_EPSM_REG_WRITE1 */
        nop();

/* @last_reg: */
        y = 30; // last reg patch ptr
        a = 0x22; // famistudio_epsm_register_order,x
        carry = false;
        a +#= *((@reg_offset) as *u8);
        *((FAMISTUDIO_EPSM_REG_SEL0) as *u8) = a;
        a = *(((@ex_patch),y) as *u8);
        *((FAMISTUDIO_EPSM_REG_WRITE0) as *u8) = a;
        a = *((@chan_idx2) as *u8);
        x = a;
        y = 26;
        a = *(((@ex_patch),y) as *u8);
        *((famistudio_chn_epsm_vol_op1 + x) as *u8) = a;
        ++y;
        a = *(((@ex_patch),y) as *u8);
        *((famistudio_chn_epsm_vol_op2 + x) as *u8) = a;
        ++y;
        a = *(((@ex_patch),y) as *u8);
        *((famistudio_chn_epsm_vol_op3 + x) as *u8) = a;
        ++y;
        a = *(((@ex_patch),y) as *u8);
        *((famistudio_chn_epsm_vol_op4 + x) as *u8) = a;
/* @done: */
return;
}
//======================================================================================================================
// FAMISTUDIO_UPDATE_EPSM_RHYTHM_CHANNEL_SOUND (internal)
//
// Updates the EPSM audio registers for a given channel.
//
// [in] y: EPSM channel idx (0,1,2,3,4,5)
//======================================================================================================================

if (FAMISTUDIO_EXP_EPSM_RHYTHM_CNT > 0) {
/* famistudio_update_epsm_rhythm_channel_sound: */

/* @pitch = famistudio_ptr1 */

    a = *((famistudio_chn_note+FAMISTUDIO_EPSM_CHAN_RHYTHM_START + y) as *u8);
    goto (@nocut) if !zero;
    *((famistudio_chn_epsm_trigger+FAMISTUDIO_EXP_EPSM_FM_CHN_CNT + y) as *u8) = a;
    x = 0; // This will fetch volume 0.
    goto (@noupdate) if zero;

/* @nocut: */

    a = *((famistudio_chn_epsm_trigger+FAMISTUDIO_EXP_EPSM_FM_CHN_CNT + y) as *u8);
    cmp(a, 0x10);
    goto (@noupdate) if zero;

    // Read/multiply volume
    x = *((famistudio_chn_epsm_rhythm_volume + y) as *u8);
    if (FAMISTUDIO_USE_VOLUME_TRACK) {
        a = *((famistudio_chn_volume_track+FAMISTUDIO_EPSM_CHAN_RHYTHM_START + y) as *u8);
        if (FAMISTUDIO_USE_VOLUME_SLIDES) {
            // During a slide, the lower 4 bits are fraction.
            a &= 0xf0;
        }
        a |= *((famistudio_chn_epsm_rhythm_volume + y) as *u8);
    } else {
        a = *((famistudio_chn_epsm_rhythm_volume + y) as *u8);
    }
    x = a;

/* @update_volume: */
    // Write volume
    a = *((famistudio_epsm_rhythm_reg_table + y) as *u8);
    *((FAMISTUDIO_EPSM_ADDR) as *u8) = a;
    if (FAMISTUDIO_USE_VOLUME_TRACK) {
        a = *((famistudio_volume_table + x) as *u8);
    } else {
        a = x;
    }
        *(() as *u8) <<<<#= 1;
        a +#= *((famistudio_chn_epsm_rhythm_stereo + y) as *u8);
        *((FAMISTUDIO_EPSM_DATA) as *u8) = a;

    a = 0x10; //FAMISTUDIO_EPSM_REG_RHY_KY
    *((famistudio_chn_epsm_trigger+FAMISTUDIO_EXP_EPSM_FM_CHN_CNT + y) as *u8) = a;
    *((FAMISTUDIO_EPSM_ADDR) as *u8) = a;
    nop(); //Some delay needed before writing the rhythm key
    nop();
    a = *((famistudio_epsm_rhythm_key_table + y) as *u8);
    *((FAMISTUDIO_EPSM_DATA) as *u8) = a;

/* @noupdate: */
    return;

}
}

if (FAMISTUDIO_EXP_N163) {

// This is getting out of hand. Maybe we should compute those on the fly.
/* famistudio_n163_freq_table_lo: */
/* .byte FAMISTUDIO_N163_REG_FREQ_LO - $00 */
/* .byte FAMISTUDIO_N163_REG_FREQ_LO - $08 */
/* .byte FAMISTUDIO_N163_REG_FREQ_LO - $10 */
/* .byte FAMISTUDIO_N163_REG_FREQ_LO - $18 */
/* .byte FAMISTUDIO_N163_REG_FREQ_LO - $20 */
/* .byte FAMISTUDIO_N163_REG_FREQ_LO - $28 */
/* .byte FAMISTUDIO_N163_REG_FREQ_LO - $30 */
/* .byte FAMISTUDIO_N163_REG_FREQ_LO - $38 */
/* famistudio_n163_freq_table_mid: */
/* .byte FAMISTUDIO_N163_REG_FREQ_MID - $00 */
/* .byte FAMISTUDIO_N163_REG_FREQ_MID - $08 */
/* .byte FAMISTUDIO_N163_REG_FREQ_MID - $10 */
/* .byte FAMISTUDIO_N163_REG_FREQ_MID - $18 */
/* .byte FAMISTUDIO_N163_REG_FREQ_MID - $20 */
/* .byte FAMISTUDIO_N163_REG_FREQ_MID - $28 */
/* .byte FAMISTUDIO_N163_REG_FREQ_MID - $30 */
/* .byte FAMISTUDIO_N163_REG_FREQ_MID - $38 */
/* famistudio_n163_freq_table_hi: */
/* .byte FAMISTUDIO_N163_REG_FREQ_HI - $00 */
/* .byte FAMISTUDIO_N163_REG_FREQ_HI - $08 */
/* .byte FAMISTUDIO_N163_REG_FREQ_HI - $10 */
/* .byte FAMISTUDIO_N163_REG_FREQ_HI - $18 */
/* .byte FAMISTUDIO_N163_REG_FREQ_HI - $20 */
/* .byte FAMISTUDIO_N163_REG_FREQ_HI - $28 */
/* .byte FAMISTUDIO_N163_REG_FREQ_HI - $30 */
/* .byte FAMISTUDIO_N163_REG_FREQ_HI - $38 */
/* famistudio_n163_vol_table: */
/* .byte FAMISTUDIO_N163_REG_VOLUME - $00 */
/* .byte FAMISTUDIO_N163_REG_VOLUME - $08 */
/* .byte FAMISTUDIO_N163_REG_VOLUME - $10 */
/* .byte FAMISTUDIO_N163_REG_VOLUME - $18 */
/* .byte FAMISTUDIO_N163_REG_VOLUME - $20 */
/* .byte FAMISTUDIO_N163_REG_VOLUME - $28 */
/* .byte FAMISTUDIO_N163_REG_VOLUME - $30 */
/* .byte FAMISTUDIO_N163_REG_VOLUME - $38 */
/* famistudio_n163_env_table: */
/* .byte FAMISTUDIO_N163_CH0_ENVS */
/* .byte FAMISTUDIO_N163_CH1_ENVS */
/* .byte FAMISTUDIO_N163_CH2_ENVS */
/* .byte FAMISTUDIO_N163_CH3_ENVS */
/* .byte FAMISTUDIO_N163_CH4_ENVS */
/* .byte FAMISTUDIO_N163_CH5_ENVS */
/* .byte FAMISTUDIO_N163_CH6_ENVS */
/* .byte FAMISTUDIO_N163_CH7_ENVS */
if (FAMISTUDIO_USE_PHASE_RESET) {
/* famistudio_n163_phase_table_lo: */
/* .byte FAMISTUDIO_N163_REG_PHASE_LO - $00 */
/* .byte FAMISTUDIO_N163_REG_PHASE_LO - $08 */
/* .byte FAMISTUDIO_N163_REG_PHASE_LO - $10 */
/* .byte FAMISTUDIO_N163_REG_PHASE_LO - $18 */
/* .byte FAMISTUDIO_N163_REG_PHASE_LO - $20 */
/* .byte FAMISTUDIO_N163_REG_PHASE_LO - $28 */
/* .byte FAMISTUDIO_N163_REG_PHASE_LO - $30 */
/* .byte FAMISTUDIO_N163_REG_PHASE_LO - $38 */
/* famistudio_n163_phase_table_mid: */
/* .byte FAMISTUDIO_N163_REG_PHASE_MID - $00 */
/* .byte FAMISTUDIO_N163_REG_PHASE_MID - $08 */
/* .byte FAMISTUDIO_N163_REG_PHASE_MID - $10 */
/* .byte FAMISTUDIO_N163_REG_PHASE_MID - $18 */
/* .byte FAMISTUDIO_N163_REG_PHASE_MID - $20 */
/* .byte FAMISTUDIO_N163_REG_PHASE_MID - $28 */
/* .byte FAMISTUDIO_N163_REG_PHASE_MID - $30 */
/* .byte FAMISTUDIO_N163_REG_PHASE_MID - $38 */
/* famistudio_n163_phase_table_hi: */
/* .byte FAMISTUDIO_N163_REG_PHASE_HI - $00 */
/* .byte FAMISTUDIO_N163_REG_PHASE_HI - $08 */
/* .byte FAMISTUDIO_N163_REG_PHASE_HI - $10 */
/* .byte FAMISTUDIO_N163_REG_PHASE_HI - $18 */
/* .byte FAMISTUDIO_N163_REG_PHASE_HI - $20 */
/* .byte FAMISTUDIO_N163_REG_PHASE_HI - $28 */
/* .byte FAMISTUDIO_N163_REG_PHASE_HI - $30 */
/* .byte FAMISTUDIO_N163_REG_PHASE_HI - $38 */
}

//======================================================================================================================
// FAMISTUDIO_UPDATE_N163_CHANNEL_SOUND (internal)
//
// Updates the N163 audio registers for a given channel.
//
// [in] y: N163 channel idx (0,1,2,3,4,5,6,7)
//======================================================================================================================

/* famistudio_update_n163_channel_sound: */

/* @pitch    = famistudio_ptr1 */
/* @pitch_hi = famistudio_r2 */

    a = *((famistudio_chn_note+FAMISTUDIO_N163_CH0_IDX + y) as *u8);
    goto (@nocut) if !zero;
    x = 0; // This will fetch volume 0.
    goto (*((@update_volume) as *u8));

/* @nocut: */

    famistudio_update_n163_wave();

    // Read note, apply arpeggio
    a = *((famistudio_chn_note+FAMISTUDIO_N163_CH0_IDX + y) as *u8);
    carry = false;
    x = *((famistudio_n163_env_table + y) as *u8);
    a +#= *((famistudio_env_value+FAMISTUDIO_ENV_NOTE_OFF + x) as *u8);
    if (FAMISTUDIO_DUAL_SUPPORT) {
        carry = false;
        a +#= *((famistudio_pal_adjust) as *u8);
    }
    x = a;

    // Apply pitch envelope, fine pitch & slides
/* famistudio_get_note_pitch_macro FAMISTUDIO_N163_CH0_PITCH_ENV_IDX, FAMISTUDIO_N163_PITCH_SHIFT, famistudio_n163_note_table_lsb, famistudio_n163_note_table_msb */

    // Convert 16-bit -> 18-bit.
    *((@pitch+0) as *u8) <<= 1;
    *((@pitch+1) as *u8) <<<<#= 1;
    a = 0;
    a +#= 0;
    *((@pitch_hi) as *u8) = a;
    *((@pitch+0) as *u8) <<= 1;
    *((@pitch+1) as *u8) <<<<#= 1;
    *((@pitch_hi) as *u8) <<<<#= 1;

    // Write pitch
    a = *((famistudio_n163_freq_table_lo + y) as *u8);
    *((FAMISTUDIO_N163_ADDR) as *u8) = a;
    a = *((@pitch+0) as *u8);
    *((FAMISTUDIO_N163_DATA) as *u8) = a;
    a = *((famistudio_n163_freq_table_mid + y) as *u8);
    *((FAMISTUDIO_N163_ADDR) as *u8) = a;
    a = *((@pitch+1) as *u8);
    *((FAMISTUDIO_N163_DATA) as *u8) = a;
    a = *((famistudio_n163_freq_table_hi + y) as *u8);
    *((FAMISTUDIO_N163_ADDR) as *u8) = a;
    a = *((famistudio_chn_n163_wave_len + y) as *u8);
    a |= *((@pitch_hi) as *u8);
    *((FAMISTUDIO_N163_DATA) as *u8) = a;

    // Read/multiply volume
    x = *((famistudio_n163_env_table + y) as *u8);
    if (FAMISTUDIO_USE_VOLUME_TRACK) {
        a = *((famistudio_chn_volume_track+FAMISTUDIO_N163_CH0_IDX + y) as *u8);
        if (FAMISTUDIO_USE_VOLUME_SLIDES) {
            // During a slide, the lower 4 bits are fraction.
            a &= 0xf0;
        }
        a |= *((famistudio_env_value+FAMISTUDIO_ENV_VOLUME_OFF + x) as *u8);
    } else {
        a = *((famistudio_env_value+FAMISTUDIO_ENV_VOLUME_OFF + x) as *u8);
    }
    x = a;

/* @update_volume: */
    // Write volume
    a = *((famistudio_n163_vol_table + y) as *u8);
    *((FAMISTUDIO_N163_ADDR) as *u8) = a;
    if (FAMISTUDIO_USE_VOLUME_TRACK) {
        a = *((famistudio_volume_table + x) as *u8);
    } else {
        a = x;
    }
    a |= FAMISTUDIO_N163_CHN_MASK;
    *((FAMISTUDIO_N163_DATA) as *u8) = a;

/* @done: */
    return;

}

if (FAMISTUDIO_EXP_S5B) {

/* famistudio_s5b_reg_table_lo: */
/* .byte FAMISTUDIO_S5B_REG_LO_A, FAMISTUDIO_S5B_REG_LO_B, FAMISTUDIO_S5B_REG_LO_C */
/* famistudio_s5b_reg_table_hi: */
/* .byte FAMISTUDIO_S5B_REG_HI_A, FAMISTUDIO_S5B_REG_HI_B, FAMISTUDIO_S5B_REG_HI_C */
/* famistudio_s5b_vol_table: */
/* .byte FAMISTUDIO_S5B_REG_VOL_A, FAMISTUDIO_S5B_REG_VOL_B, FAMISTUDIO_S5B_REG_VOL_C */
/* famistudio_s5b_env_table: */
/* .byte FAMISTUDIO_S5B_CH0_ENVS, FAMISTUDIO_S5B_CH1_ENVS, FAMISTUDIO_S5B_CH2_ENVS */
/* famistudio_s5b_noise_mask: */
/* .byte $08, $10, $20 */

//======================================================================================================================
// FAMISTUDIO_UPDATE_S5B_CHANNEL_SOUND (internal)
//
// Updates the S5B audio registers for a given channel.
//
// [in] y: S5B channel idx (0,1,2)
//======================================================================================================================

/* famistudio_update_s5b_channel_sound: */

/* @pitch   = famistudio_ptr1 */
/* @env_bit = famistudio_ptr1_lo */

    // These are shared by all 3 channels.
/* @env_period = famistudio_ptr0 */
/* @attack     = famistudio_ptr2 */
/* @env_shape  = famistudio_r1 */
/* @env_octave = famistudio_r2 */
/* @noise_freq = famistudio_r3 */

    // First channel will clear these, last channel will write the registers.
    cmp(y, 0);
    goto (@not_first_channel) if !zero;
    *((@env_shape) as *u8) = y;
    *((@noise_freq) as *u8) = y;
    *((@attack) as *u8) = y;
    a = 0x80; // This mean 'manual pitch'
    *((@env_octave) as *u8) = y;

/* @not_first_channel: */
    x = 0; // This will fetch volume 0.
    *((@env_bit) as *u8) = x;
    a = *((famistudio_chn_note+FAMISTUDIO_S5B_CH0_IDX + y) as *u8);
    goto (@nocut) if !zero;
    goto (*((@update_volume) as *u8));

/* @nocut: */
    // Store noise if mixer has it enabled
    x = *((famistudio_s5b_env_table + y) as *u8);
    a = *((famistudio_env_value+FAMISTUDIO_ENV_MIXER_IDX_OFF + x) as *u8);
    a &= *((famistudio_s5b_noise_mask + y) as *u8);
    goto (@nonoise) if !zero;
    a = *((famistudio_env_value+FAMISTUDIO_ENV_NOISE_IDX_OFF + x) as *u8);
    *((@noise_freq) as *u8) = a;

/* @nonoise: */
    a = *((famistudio_chn_note+FAMISTUDIO_S5B_CH0_IDX + y) as *u8);
    // Read note, apply arpeggio
    carry = false;
    x = *((famistudio_s5b_env_table + y) as *u8);
    a +#= *((famistudio_env_value+FAMISTUDIO_ENV_NOTE_OFF + x) as *u8);
    if (FAMISTUDIO_DUAL_SUPPORT) {
        carry = false;
        a +#= *((famistudio_pal_adjust) as *u8);
    }
    x = a;

    // Apply pitch envelope, fine pitch & slides
/* famistudio_get_note_pitch_macro FAMISTUDIO_S5B_CH0_PITCH_ENV_IDX, 0, famistudio_note_table_lsb, famistudio_note_table_msb */

    // Write pitch + 1 (pitches on S5B are off by one compared to regular note table)
    a = *((famistudio_s5b_reg_table_lo + y) as *u8);
    *((FAMISTUDIO_S5B_ADDR) as *u8) = a;
    a = *((@pitch+0) as *u8);
    carry = false;
    a +#= 1;
    *((FAMISTUDIO_S5B_DATA) as *u8) = a;
    *((@pitch+0) as *u8) = a;
    a = *((famistudio_s5b_reg_table_hi + y) as *u8);
    *((FAMISTUDIO_S5B_ADDR) as *u8) = a;
    a = *((@pitch+1) as *u8);
    a +#= 0;
    *((FAMISTUDIO_S5B_DATA) as *u8) = a;
    *((@pitch+1) as *u8) = a;

    // Store env shape + period if active.
    a = *((famistudio_s5b_chn_env_shape + y) as *u8);
    a &= 0x0f;
    goto (@noenv) if zero;
    *((@env_shape) as *u8) = a;

    // If bit 7 of any channel is on, well reset the envelope.
    a = *((famistudio_s5b_chn_env_shape + y) as *u8);
    a |= *((@attack) as *u8);
    *((@attack) as *u8) = a;
    a = *((famistudio_s5b_chn_env_shape + y) as *u8);
    a &= 0x0f;
    *((famistudio_s5b_chn_env_shape + y) as *u8) = a;

    // Store auto-period settings
    a = *((famistudio_s5b_chn_env_octave + y) as *u8);
    *((@env_octave) as *u8) = a;
    cmp(a, 0x80); // This mean 'manual pitch'
    goto (@manual_period) if zero;

/* @auto_period: */
        a = *((@pitch+0) as *u8);
        *((@env_period+0) as *u8) = a;
        a = *((@pitch+1) as *u8);
        *((@env_period+1) as *u8) = a;
        goto (*((@set_envelope_volume_flag) as *u8));

/* @manual_period: */
        a = *((famistudio_s5b_env_period_lo) as *u8);
        *((@env_period+0) as *u8) = a;
        a = *((famistudio_s5b_env_period_hi) as *u8);
        *((@env_period+1) as *u8) = a;

/* @set_envelope_volume_flag: */
    a = 0x10;

/* @noenv: */
    *((@env_bit) as *u8) = a;

    // Read/multiply volume
    x = *((famistudio_s5b_env_table + y) as *u8);
    if (FAMISTUDIO_USE_VOLUME_TRACK) {
        a = *((famistudio_chn_volume_track+FAMISTUDIO_S5B_CH0_IDX + y) as *u8);
        if (FAMISTUDIO_USE_VOLUME_SLIDES) {
            // During a slide, the lower 4 bits are fraction.
            a &= 0xf0;
        }
        a |= *((famistudio_env_value+FAMISTUDIO_ENV_VOLUME_OFF + x) as *u8);
    } else {
        a = *((famistudio_env_value+FAMISTUDIO_ENV_VOLUME_OFF + x) as *u8);
    }
    x = a;

/* @update_volume: */
    // Write volume
    a = *((famistudio_s5b_vol_table + y) as *u8);
    *((FAMISTUDIO_S5B_ADDR) as *u8) = a;
    if (FAMISTUDIO_USE_VOLUME_TRACK) {
        a = *((famistudio_volume_table + x) as *u8);
        a |= *((@env_bit) as *u8);
    } else {
        a = x;
        a |= *((@env_bit) as *u8);
    }
    *((FAMISTUDIO_S5B_DATA) as *u8) = a;

/* @write_shared_registers: */
    // Channel 2 writes all 5 shared registers.
    cmp(y, 2);
    goto (@done) if !zero;
    a = *((@env_shape) as *u8);
    goto (@write_shared_noise) if zero;
    x = *((@env_octave) as *u8);
    cmp(x, 0x80);
    goto (@write_shared_env_register) if zero;

/* @compute_auto_period: */
    cmp(x, 0);
    goto (@write_shared_env_register) if zero;
    goto (@positive_octave_loop) if !negative;

/* @negative_octave_loop: */
            *((@env_period+0) as *u8) <<= 1;
            *((@env_period+1) as *u8) <<<<#= 1;
            ++x;
            goto (@negative_octave_loop) if !zero;
        goto (@write_shared_env_register) if zero;

/* @positive_octave_loop: */
        cmp(x, 1);
        goto (@do_shift) if !zero;
/* @rounding: */
            a = *((@env_period+0) as *u8);
            a &= 1;
            goto (@do_shift) if zero;
            a = *((@env_period+0) as *u8);
            carry = false;
            a +#= 1;
            *((@env_period+0) as *u8) = a;
            goto (@do_shift) if !carry;
            ++(*((@env_period+1) as *u8));
/* @do_shift: */
            *((@env_period+1) as *u8) >>>= 1;
            *((@env_period+0) as *u8) >>>>#= 1;
            --x;
            goto (@positive_octave_loop) if !zero;

/* @write_shared_env_register: */

    // Envelope period.
    a = FAMISTUDIO_S5B_REG_ENV_LO;
    *((FAMISTUDIO_S5B_ADDR) as *u8) = a;
    a = *((@env_period+0) as *u8);
    *((FAMISTUDIO_S5B_DATA) as *u8) = a;
    a = FAMISTUDIO_S5B_REG_ENV_HI;
    *((FAMISTUDIO_S5B_ADDR) as *u8) = a;
    a = *((@env_period+1) as *u8);
    *((FAMISTUDIO_S5B_DATA) as *u8) = a;

    // Reset envelope if there was an attack.
    a = *((@attack) as *u8);
    goto (@write_shared_noise) if !negative;
        a = FAMISTUDIO_S5B_REG_SHAPE;
        *((FAMISTUDIO_S5B_ADDR) as *u8) = a;
        a = *((@env_shape) as *u8);
        *((FAMISTUDIO_S5B_DATA) as *u8) = a;

/* @write_shared_noise: */

    // Tone/noise enabled.
    a = FAMISTUDIO_S5B_REG_TONE;
    *((FAMISTUDIO_S5B_ADDR) as *u8) = a;
    a = *((famistudio_env_value+FAMISTUDIO_S5B_CH2_ENVS+FAMISTUDIO_ENV_MIXER_IDX_OFF) as *u8);
    *(() as *u8) <<= 1;
    a |= *((famistudio_env_value+FAMISTUDIO_S5B_CH1_ENVS+FAMISTUDIO_ENV_MIXER_IDX_OFF) as *u8);
    *(() as *u8) <<= 1;
    a |= *((famistudio_env_value+FAMISTUDIO_S5B_CH0_ENVS+FAMISTUDIO_ENV_MIXER_IDX_OFF) as *u8);
    *((FAMISTUDIO_S5B_DATA) as *u8) = a;

    // Noise freq
    a = FAMISTUDIO_S5B_REG_NOISE;
    *((FAMISTUDIO_S5B_ADDR) as *u8) = a;
    a = *((@noise_freq) as *u8);
    *((FAMISTUDIO_S5B_DATA) as *u8) = a;

    a = 0;
    *((famistudio_s5b_env_override) as *u8) = a;

/* @done: */
    return;

}

if (FAMISTUDIO_USE_PHASE_RESET) {

//======================================================================================================================
// FAMISTUDIO_PROCESS_PHASE_RESETS (internal)
//
// Reset phases for channels that requested it this frame.
//======================================================================================================================

/* .macro conditional_phase_reset_regular prev_hi, reg_hi */
/* .local @done */
    *(() as *u8) >>>= 1;
    goto (@done) if !carry;
    y = *((prev_hi) as *u8);
    *((reg_hi) as *u8) = y;
/* @done: */
/* .endmacro */

/* .macro conditional_phase_reset_vrc6 prev_hi, reg_hi */
/* .local @done */
    *(() as *u8) >>>= 1;
    goto (@done) if !carry;
    x = a;
    a = *((prev_hi) as *u8);
    *((reg_hi) as *u8) = a;
    a |= 0x80;
    *((reg_hi) as *u8) = a;
    a = x;
/* @done: */
/* .endmacro */

/* .macro conditional_phase_reset_fds prev_hi, reg_hi */
/* .local @done */
    *(() as *u8) >>>= 1;
    goto (@done) if !carry;
    a = *((prev_hi) as *u8);
    a |= 0x80;
    *((reg_hi) as *u8) = a;
    a &= 0x7f;
    *((reg_hi) as *u8) = a;
/* @done: */
/* .endmacro */

/* famistudio_process_phase_resets: */

    // We group all the phase resets here at the end of the frame to make it easier to replicate in the main app since
    // this routine will have very predictable # of cycle between channels, and having channels closers mean its easier
    // to sync 2 channels together. The downside is that we need to keep the previous hi-period for VRC6 (3-bytes) and
    // FDS (1-byte).

    a = *((famistudio_phase_reset) as *u8);

    // TODO : What about SFX here? A phase reset here will reset the SFX? Or will it?
/* conditional_phase_reset_regular famistudio_pulse1_prev, FAMISTUDIO_APU_PL1_HI */
/* conditional_phase_reset_regular famistudio_pulse2_prev, FAMISTUDIO_APU_PL2_HI */

    if (FAMISTUDIO_EXP_VRC6) {
/* conditional_phase_reset_vrc6 famistudio_vrc6_pulse1_prev_hi, FAMISTUDIO_VRC6_PL1_HI */
/* conditional_phase_reset_vrc6 famistudio_vrc6_pulse2_prev_hi, FAMISTUDIO_VRC6_PL2_HI */
/* conditional_phase_reset_vrc6 famistudio_vrc6_saw_prev_hi, FAMISTUDIO_VRC6_SAW_HI */
    } else {
        *(() as *u8) >>>= 1;
        *(() as *u8) >>>= 1;
        *(() as *u8) >>>= 1;
    }

    if (FAMISTUDIO_EXP_MMC5) {
/* conditional_phase_reset_regular famistudio_mmc5_pulse1_prev, FAMISTUDIO_MMC5_PL1_HI */
/* conditional_phase_reset_regular famistudio_mmc5_pulse2_prev, FAMISTUDIO_MMC5_PL2_HI */
    } else {
        *(() as *u8) >>>= 1;
        *(() as *u8) >>>= 1;
    }

    if (FAMISTUDIO_EXP_FDS) {
/* conditional_phase_reset_fds famistudio_fds_prev_hi, FAMISTUDIO_FDS_FREQ_HI */
    }

    if (FAMISTUDIO_EXP_N163) {
    x = 0;
/* @n163_phase_reset_loop: */
        a = *((famistudio_channel_to_phase_reset_mask+FAMISTUDIO_N163_CH0_IDX + x) as *u8);
        a &= *((famistudio_phase_reset_n163) as *u8);
        goto (@next_n163_channel) if zero;
            y = 0;
            a = *((famistudio_n163_phase_table_lo + x) as *u8);
            *((FAMISTUDIO_N163_ADDR) as *u8) = a;
            *((FAMISTUDIO_N163_DATA) as *u8) = y;
            a = *((famistudio_n163_phase_table_mid + x) as *u8);
            *((FAMISTUDIO_N163_ADDR) as *u8) = a;
            *((FAMISTUDIO_N163_DATA) as *u8) = y;
            a = *((famistudio_n163_phase_table_hi + x) as *u8);
            *((FAMISTUDIO_N163_ADDR) as *u8) = a;
            *((FAMISTUDIO_N163_DATA) as *u8) = y;
/* @next_n163_channel: */
            ++x;
            cmp(x, FAMISTUDIO_EXP_N163_CHN_CNT);
            goto (@n163_phase_reset_loop) if !zero;
    }

/* @clear_phase_reset_flags: */
        a = 0;
        *((famistudio_phase_reset) as *u8) = a;
        if (FAMISTUDIO_EXP_N163) {
            *((famistudio_phase_reset_n163) as *u8) = a;
        }
        return;

}

if (FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS) {

//======================================================================================================================
// FAMISTUDIO_UPDATE_ROW_WITH_DELAYS (internal)
//
// Advance the song for a given channel, but while managing notes/cuts delays.
//
// [in] x: channel index (also true when leaving the function)
//======================================================================================================================

/* famistudio_advance_channel_with_delays: */

    // Is the tempo telling us to advance by 1 row?
    a = *((famistudio_tempo_advance_row) as *u8);
    goto (@check_delayed_note) if zero;

    // Tempo says we need to advance, was there a delayed note wairing?
    a = *((famistudio_chn_note_delay + x) as *u8);
    goto (@advance) if negative;

    // Need to clear any pending delayed note before advancing (will be inaudible).
/* @clear_delayed_note: */
    a = 0xff;
    *((famistudio_chn_note_delay + x) as *u8) = a;
    famistudio_advance_channel(); // This is the update for the de delayed note.
    goto (*((@advance) as *u8));

    // Tempo said we didnt need to advance, see if there is delayed note with a counter that reached zero.
/* @check_delayed_note: */
    a = *((famistudio_chn_note_delay + x) as *u8);
    goto (@check_delayed_cut) if negative;
    carry = true;
    a -#= 1;
    *((famistudio_chn_note_delay + x) as *u8) = a;
    goto (@check_delayed_cut) if !negative; // When wrapping from 0 -> 0xff, we play the note.

    // Finally, advance by 1 row.
/* @advance: */
    famistudio_advance_channel();

    // Handle delayed cuts.
/* @check_delayed_cut: */
    a = *((famistudio_chn_cut_delay + x) as *u8);
    goto (@done) if negative;
    carry = true;
    a -#= 1;
    *((famistudio_chn_cut_delay + x) as *u8) = a;
    goto (@done) if !negative; // When wrapping from 0 -> 0xff, we play the note.

    // Write a stop note.
    a = 0;
    *((famistudio_chn_note + x) as *u8) = a;

    // Special case for DPCM, need to stop it manually.
    cmp(x, 4);
    goto (@done) if !zero;
    famistudio_sample_stop();

/* @done: */
    return;

}

//======================================================================================================================
// FAMISTUDIO_UPDATE (public)
//
// Main update function, should be called once per frame, ideally at the end of NMI. Will update the tempo, advance
// the song if needed, update instrument and apply any change to the APU registers.
//
// [in] no input params.
//======================================================================================================================

/* famistudio_update: */

/* @pitch_env_type = famistudio_r0 */
/* @temp_pitch     = famistudio_r1 */
/* @tempo_env_ptr  = famistudio_ptr0 */
/* @env_ptr        = famistudio_ptr0 */
/* @pitch_env_ptr  = famistudio_ptr0 */

if (FAMISTUDIO_CFG_THREAD) {
    a = *((famistudio_ptr0_lo) as *u8);
    push(a);
    a = *((famistudio_ptr0_hi) as *u8);
    push(a);
}

    a = *((famistudio_song_speed) as *u8); // Speed 0 means that no music is playing currently
    goto (@pause) if negative; // Bit 7 set is the pause flag
    goto (@update) if !zero;
/* @pause: */
if (!FAMISTUDIO_USE_FAMITRACKER_TEMPO) {
    a = 1;
    *((famistudio_tempo_frame_cnt) as *u8) = a;
}
    goto (*((@update_sound) as *u8));

//----------------------------------------------------------------------------------------------------------------------
/* @update: */

if (FAMISTUDIO_USE_FAMITRACKER_TEMPO) {

    a = *((famistudio_tempo_acc_hi) as *u8);
    cmp(a, *((famistudio_song_speed) as *u8));
    if (FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS) {
        x = 0;
        *((famistudio_tempo_advance_row) as *u8) = x;
        goto (@advance_song) if !carry;
    } else {
        goto (@update_envelopes) if !carry;
    }
    a -#= *((famistudio_song_speed) as *u8); // Carry is set.
    *((famistudio_tempo_acc_hi) as *u8) = a;
    if (FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS) {
        x = 1;
        *((famistudio_tempo_advance_row) as *u8) = x;
    }

} else { // FamiStudio tempo

    // Decrement envelope counter, see if we need to advance.
    --(*((famistudio_tempo_env_counter) as *u8));
    goto (@advance_tempo_envelope) if zero;
    a = 1;
    goto (*((@store_frame_count) as *u8));

/* @advance_tempo_envelope: */
    // Advance the envelope by one step.
    a = *((famistudio_tempo_env_ptr_lo) as *u8);
    *((@tempo_env_ptr+0) as *u8) = a;
    a = *((famistudio_tempo_env_ptr_hi) as *u8);
    *((@tempo_env_ptr+1) as *u8) = a;

    ++(*((famistudio_tempo_env_idx) as *u8));
    y = *((famistudio_tempo_env_idx) as *u8);
    a = *(((@tempo_env_ptr),y) as *u8);
    goto (@store_counter) if !negative; // Negative value means we loop back to to index 1.

/* @tempo_envelope_end: */
    y = 1;
    *((famistudio_tempo_env_idx) as *u8) = y;
    a = *(((@tempo_env_ptr),y) as *u8);

/* @store_counter: */
    // Reset the counter
    *((famistudio_tempo_env_counter) as *u8) = a;
    a = *((famistudio_tempo_frame_num) as *u8);
    goto (@store_frame_count) if !zero;
    goto (*((@skip_frame) as *u8));

/* @store_frame_count: */
    *((famistudio_tempo_frame_cnt) as *u8) = a;

}

//----------------------------------------------------------------------------------------------------------------------
/* @advance_song: */
    x = 0;
/* @channel_loop: */
        if (!FAMISTUDIO_CFG_DPCM_SUPPORT) {
            cmp(x, 4);
            goto (@channel_loop_end) if zero;
        }
        if (FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS) {
            famistudio_advance_channel_with_delays();
        } else {
            famistudio_advance_channel();
        }
/* @channel_loop_end: */
        ++x;
        cmp(x, FAMISTUDIO_NUM_CHANNELS);
        goto (@channel_loop) if !zero;

//----------------------------------------------------------------------------------------------------------------------
/* @update_envelopes: */
    x = 0;

/* @env_process: */
    a = *((famistudio_env_repeat + x) as *u8);
    goto (@env_read) if zero;
    --(*((famistudio_env_repeat + x) as *u8));
    goto (@env_next) if !zero;

/* @env_read: */
    a = *((famistudio_env_addr_lo + x) as *u8);
    *((@env_ptr+0) as *u8) = a;
    a = *((famistudio_env_addr_hi + x) as *u8);
    *((@env_ptr+1) as *u8) = a;
    y = *((famistudio_env_ptr + x) as *u8);

/* @env_read_value: */
    a = *(((@env_ptr),y) as *u8);
    goto (@env_special) if !negative; // Values below 128 used as a special code, loop or repeat
    carry = false; // Values above 128 are output value+192 (output values are signed -63..64)
    a +#= 256-192;
    *((famistudio_env_value + x) as *u8) = a;
    ++y;
    goto (@env_next_store_ptr) if !zero;

/* @env_special: */
    goto (@env_set_repeat) if !zero; // Zero is the loop point, non-zero values used for the repeat counter
    ++y;
    a = *(((@env_ptr),y) as *u8); // Read loop position
    y = a;
    goto (*((@env_read_value) as *u8));

/* @env_set_repeat: */
    ++y;
    *((famistudio_env_repeat + x) as *u8) = a; // Store the repeat counter value

/* @env_next_store_ptr: */
    a = y;
    *((famistudio_env_ptr + x) as *u8) = a;

/* @env_next: */
    ++x;

    cmp(x, FAMISTUDIO_NUM_ENVELOPES);
    goto (@env_process) if !zero;

//----------------------------------------------------------------------------------------------------------------------
/* @update_pitch_envelopes: */
    x = 0;
    goto (*((@pitch_env_process) as *u8));

/* @pitch_env_process: */
    a = *((famistudio_pitch_env_repeat + x) as *u8);
    goto (@pitch_env_read) if zero;
    --(*((famistudio_pitch_env_repeat + x) as *u8));
    goto (@pitch_env_next) if !zero;

/* @pitch_env_read: */
    a = *((famistudio_pitch_env_addr_lo + x) as *u8);
    *((@pitch_env_ptr+0) as *u8) = a;
    a = *((famistudio_pitch_env_addr_hi + x) as *u8);
    *((@pitch_env_ptr+1) as *u8) = a;
    y = 0;
    a = *(((@pitch_env_ptr),y) as *u8);
    *((@pitch_env_type) as *u8) = a; // First value is 0 for absolute envelope, 0x80 for relative.
    y = *((famistudio_pitch_env_ptr + x) as *u8);

/* @pitch_env_read_value: */
    a = *(((@pitch_env_ptr),y) as *u8);
    goto (@pitch_env_special) if !negative;
    carry = false;
    a +#= 256-192;
    bit(@pitch_env_type);
    goto (@pitch_relative) if negative;

/* @pitch_absolute: */
    *((famistudio_pitch_env_value_lo + x) as *u8) = a;
    a |= 0;
    goto (@pitch_absolute_neg) if negative;
    a = 0;
    goto (*((@pitch_absolute_set_value_hi) as *u8));
/* @pitch_absolute_neg: */
    a = 0xff;
/* @pitch_absolute_set_value_hi: */
    *((famistudio_pitch_env_value_hi + x) as *u8) = a;
    ++y;
    goto (*((@pitch_env_next_store_ptr) as *u8));

/* @pitch_relative: */
    *((@temp_pitch) as *u8) = a;
    carry = false;
    a +#= *((famistudio_pitch_env_value_lo + x) as *u8);
    *((famistudio_pitch_env_value_lo + x) as *u8) = a;
    a = *((@temp_pitch) as *u8);
    a &= 0x80;
    goto (@pitch_relative_pos) if !negative;
    a = 0xff;
/* @pitch_relative_pos: */
    a +#= *((famistudio_pitch_env_value_hi + x) as *u8);
    *((famistudio_pitch_env_value_hi + x) as *u8) = a;
    ++y;
    goto (*((@pitch_env_next_store_ptr) as *u8));

/* @pitch_env_special: */
    goto (@pitch_env_set_repeat) if !zero;
    ++y;
    a = *(((@pitch_env_ptr),y) as *u8);
    y = a;
    goto (*((@pitch_env_read_value) as *u8));

/* @pitch_env_set_repeat: */
    ++y;
    a |= *((@pitch_env_type) as *u8); // This is going to set the relative flag in the hi-bit.
    *((famistudio_pitch_env_repeat + x) as *u8) = a;

/* @pitch_env_next_store_ptr: */
    a = y;
    *((famistudio_pitch_env_ptr + x) as *u8) = a;

/* @pitch_env_next: */
    ++x;

    cmp(x, FAMISTUDIO_NUM_PITCH_ENVELOPES);
    goto (@pitch_env_process) if !zero;

if (FAMISTUDIO_USE_SLIDE_NOTES) {
//----------------------------------------------------------------------------------------------------------------------
/* @update_slides: */
    x = 0;

/* @slide_process: */
    a = *((famistudio_slide_step + x) as *u8); // Zero repeat means no active slide.
    goto (@slide_next) if zero;
    carry = false; // Add step to slide pitch (16bit + 8bit signed).
    a = *((famistudio_slide_step + x) as *u8);
    a +#= *((famistudio_slide_pitch_lo + x) as *u8);
    *((famistudio_slide_pitch_lo + x) as *u8) = a;
    a = *((famistudio_slide_step + x) as *u8);
    a &= 0x80;
    goto (@positive_slide) if zero;

/* @negative_slide: */
    a = 0xff;
    a +#= *((famistudio_slide_pitch_hi + x) as *u8);
    *((famistudio_slide_pitch_hi + x) as *u8) = a;
    goto (@slide_next) if !negative;
    goto (*((@clear_slide) as *u8));

/* @positive_slide: */
    a +#= *((famistudio_slide_pitch_hi + x) as *u8);
    *((famistudio_slide_pitch_hi + x) as *u8) = a;
    goto (@slide_next) if negative;

/* @clear_slide: */
    a = 0;
    *((famistudio_slide_step + x) as *u8) = a;

/* @slide_next: */
    ++x;
    cmp(x, FAMISTUDIO_NUM_SLIDES);
    goto (@slide_process) if !zero;
}

if (FAMISTUDIO_USE_VOLUME_SLIDES) {

// FIXME : This seem wayyyy more complicated than it should.
// - The track volume has 4 bits of fraction : VVVVFFFF
// - The slide step is signed : SVVVFFFF
// - The slide target (end volume) is simply : VVVV0000
//
// foreach slides
//     if step != 0
//         volume += step
//         if step > 0 && volume >= target || step < 0 && volume <= target
//             volume = target
//             step = 0

/* @update_volume_slides: */
    x = 0;

/* @volume_side_process: */
    a = *((famistudio_chn_volume_slide_step + x) as *u8);
    goto (@volume_slide_next) if zero;
    carry = false;
    goto (@negative_volume_slide) if negative;

/* @positive_volume_slide: */
    // If the slide goes up, stop if we hit the target or go over it, over 15 (carry will be set)
    a +#= *((famistudio_chn_volume_track + x) as *u8);
    goto (@clear_volume_slide) if carry;
    *((famistudio_chn_volume_track + x) as *u8) = a;
    cmp(a, *((famistudio_chn_volume_slide_target + x) as *u8));
    goto (@volume_slide_next) if !carry;
    goto (@clear_volume_slide) if carry;

/* @negative_volume_slide: */
    // If the slide goes do, stop if we hit the target or go below it, or below zero.
    // This is a bit trickier since we cant rely on the carry or any flag to
    // tell us if we wrapped around.
    a +#= *((famistudio_chn_volume_track + x) as *u8);
    y = *((famistudio_chn_volume_track + x) as *u8);
    goto (@slide_upper_half) if negative;

/* @slide_lower_half: */
    *((famistudio_chn_volume_track + x) as *u8) = a;
    cmp(a, *((famistudio_chn_volume_slide_target + x) as *u8));
    goto (@clear_volume_slide) if zero;
    goto (@clear_volume_slide) if negative;
    goto (@volume_slide_next) if !negative;

/* @slide_upper_half: */
    *((famistudio_chn_volume_track + x) as *u8) = a;
    cmp(a, *((famistudio_chn_volume_slide_target + x) as *u8));
    goto (@clear_volume_slide) if zero;
    goto (@volume_slide_next) if carry;

/* @clear_volume_slide: */
    a = *((famistudio_chn_volume_slide_target + x) as *u8);
    *((famistudio_chn_volume_track + x) as *u8) = a;
    a = 0;
    *((famistudio_chn_volume_slide_step + x) as *u8) = a;

/* @volume_slide_next: */
    ++x;
    cmp(x, FAMISTUDIO_NUM_VOLUME_SLIDES);
    goto (@volume_side_process) if !zero;
}

if (FAMISTUDIO_CFG_EQUALIZER) {
/* @update_equalizer: */
    x = 0;
/* @eq_channel_loop: */
        a = *((famistudio_chn_note_counter + x) as *u8);
        goto (@no_note) if zero;
            --(*((famistudio_chn_note_counter + x) as *u8));
/* @no_note: */
        ++x;
        cmp(x, FAMISTUDIO_NUM_CHANNELS);
        goto (@eq_channel_loop) if !zero;
}

//----------------------------------------------------------------------------------------------------------------------
/* @update_sound: */

/* famistudio_update_channel_sound 0, FAMISTUDIO_CH0_ENVS, famistudio_pulse1_prev, FAMISTUDIO_ALIAS_PL1_HI, FAMISTUDIO_ALIAS_PL1_LO, FAMISTUDIO_ALIAS_PL1_VOL, FAMISTUDIO_APU_PL1_SWEEP */
/* famistudio_update_channel_sound 1, FAMISTUDIO_CH1_ENVS, famistudio_pulse2_prev, FAMISTUDIO_ALIAS_PL2_HI, FAMISTUDIO_ALIAS_PL2_LO, FAMISTUDIO_ALIAS_PL2_VOL, FAMISTUDIO_APU_PL2_SWEEP */
/* famistudio_update_channel_sound 2, FAMISTUDIO_CH2_ENVS, , FAMISTUDIO_ALIAS_TRI_HI, FAMISTUDIO_ALIAS_TRI_LO, FAMISTUDIO_ALIAS_TRI_LINEAR */
/* famistudio_update_channel_sound 3, FAMISTUDIO_CH3_ENVS, , FAMISTUDIO_ALIAS_NOISE_LO, , FAMISTUDIO_ALIAS_NOISE_VOL */

if (FAMISTUDIO_EXP_VRC6) {
/* @update_vrc6_sound: */
/* famistudio_update_channel_sound FAMISTUDIO_VRC6_CH0_IDX, FAMISTUDIO_VRC6_CH0_ENVS, famistudio_vrc6_pulse1_prev_hi, FAMISTUDIO_VRC6_PL1_HI, FAMISTUDIO_VRC6_PL1_LO, FAMISTUDIO_VRC6_PL1_VOL */
/* famistudio_update_channel_sound FAMISTUDIO_VRC6_CH1_IDX, FAMISTUDIO_VRC6_CH1_ENVS, famistudio_vrc6_pulse2_prev_hi, FAMISTUDIO_VRC6_PL2_HI, FAMISTUDIO_VRC6_PL2_LO, FAMISTUDIO_VRC6_PL2_VOL */
/* famistudio_update_channel_sound FAMISTUDIO_VRC6_CH2_IDX, FAMISTUDIO_VRC6_CH2_ENVS, famistudio_vrc6_saw_prev_hi, FAMISTUDIO_VRC6_SAW_HI, FAMISTUDIO_VRC6_SAW_LO, FAMISTUDIO_VRC6_SAW_VOL */
}

if (FAMISTUDIO_EXP_MMC5) {
/* @update_mmc5_sound: */
/* famistudio_update_channel_sound FAMISTUDIO_MMC5_CH0_IDX, FAMISTUDIO_MMC5_CH0_ENVS, famistudio_mmc5_pulse1_prev, FAMISTUDIO_MMC5_PL1_HI, FAMISTUDIO_MMC5_PL1_LO, FAMISTUDIO_MMC5_PL1_VOL */
/* famistudio_update_channel_sound FAMISTUDIO_MMC5_CH1_IDX, FAMISTUDIO_MMC5_CH1_ENVS, famistudio_mmc5_pulse2_prev, FAMISTUDIO_MMC5_PL2_HI, FAMISTUDIO_MMC5_PL2_LO, FAMISTUDIO_MMC5_PL2_VOL */
}

if (FAMISTUDIO_EXP_FDS) {
/* @update_fds_sound: */
    famistudio_update_fds_channel_sound();
}

if (FAMISTUDIO_EXP_VRC7) {
/* @update_vrc7_sound: */
    y = 0;
/* @vrc7_channel_loop: */
        famistudio_update_vrc7_channel_sound();
        ++y;
        cmp(y, 6);
        goto (@vrc7_channel_loop) if !zero;
}

if (FAMISTUDIO_EXP_N163) {
/* @update_n163_sound: */
    y = 0;
/* @n163_channel_loop: */
        famistudio_update_n163_channel_sound();
        ++y;
        cmp(y, FAMISTUDIO_EXP_N163_CHN_CNT);
        goto (@n163_channel_loop) if !zero;
}

if (FAMISTUDIO_EXP_S5B) {
/* @update_s5b_sound: */
    y = 0;
/* @s5b_channel_loop: */
        famistudio_update_s5b_channel_sound();
        ++y;
        cmp(y, 3);
        goto (@s5b_channel_loop) if !zero;
}

if (FAMISTUDIO_EXP_EPSM) {
/* @update_epsm_sound: */
if (FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0) {
    y = 0;
/* @epsm_square_channel_loop: */
        famistudio_update_epsm_square_channel_sound();
        ++y;
        cmp(y, FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT);
        goto (@epsm_square_channel_loop) if !zero;
}
if (FAMISTUDIO_EXP_EPSM_FM_CHN_CNT > 0) {
    y = FAMISTUDIO_EXP_EPSM_FM_CHN_CNT - 1;
/* @epsm_fm_channel_loop: */
        famistudio_update_epsm_fm_channel_sound();
        --y;
        goto (@epsm_fm_channel_loop) if !negative;
}
if (FAMISTUDIO_EXP_EPSM_RHYTHM_CNT > 0) {
/* @loop_cnt = famistudio_r2 */
    a = 5;
    *((@loop_cnt) as *u8) = a;
/* @epsm_rhythm_channel_loop: */
        x = *((@loop_cnt) as *u8);
        y = *((famistudio_rhythm_lut + x) as *u8);
        goto (@skip_epsm_rhythm_update) if negative; // if the value we load is $ff then
        famistudio_update_epsm_rhythm_channel_sound();
/* @skip_epsm_rhythm_update: */
        --(*((@loop_cnt) as *u8));
        goto (@epsm_rhythm_channel_loop) if !negative;
}
}

if (FAMISTUDIO_USE_PHASE_RESET) {
    famistudio_process_phase_resets();
}

/* @update_sound_done: */
if (FAMISTUDIO_USE_FAMITRACKER_TEMPO) {
    a = *((famistudio_song_speed) as *u8);
    goto (@skip_famitracker_tempo_update) if negative; // bit 7 = paused
        carry = false; // Update frame counter that considers speed, tempo, and PAL/NTSC
        a = *((famistudio_tempo_acc_lo) as *u8);
        a +#= *((famistudio_tempo_step_lo) as *u8);
        *((famistudio_tempo_acc_lo) as *u8) = a;
        a = *((famistudio_tempo_acc_hi) as *u8);
        a +#= *((famistudio_tempo_step_hi) as *u8);
        *((famistudio_tempo_acc_hi) as *u8) = a;
/* @skip_famitracker_tempo_update: */
} else {
    // See if we need to run a double frame (playing NTSC song on PAL)
    --(*((famistudio_tempo_frame_cnt) as *u8));
    goto (@skip_frame) if zero;
    goto (*((@advance_song) as *u8));
}

/* @skip_frame: */

//----------------------------------------------------------------------------------------------------------------------
if (FAMISTUDIO_CFG_SFX_SUPPORT) {

    // Process all sound effect streams
    if (FAMISTUDIO_CFG_SFX_STREAMS > 0) {
    x = FAMISTUDIO_SFX_CH0;
    famistudio_sfx_update();
    }
    if (FAMISTUDIO_CFG_SFX_STREAMS > 1) {
    x = FAMISTUDIO_SFX_CH1;
    famistudio_sfx_update();
    }
    if (FAMISTUDIO_CFG_SFX_STREAMS > 2) {
    x = FAMISTUDIO_SFX_CH2;
    famistudio_sfx_update();
    }
    if (FAMISTUDIO_CFG_SFX_STREAMS > 3) {
    x = FAMISTUDIO_SFX_CH3;
    famistudio_sfx_update();
    }

    // Send data from the output buffer to the APU

    a = *((famistudio_output_buf) as *u8); // Pulse 1 volume
    *((FAMISTUDIO_APU_PL1_VOL) as *u8) = a;
    a = *((famistudio_output_buf+1) as *u8); // Pulse 1 period LSB
    *((FAMISTUDIO_APU_PL1_LO) as *u8) = a;
    a = *((famistudio_output_buf+2) as *u8); // Pulse 1 period MSB, only applied when changed

    if (FAMISTUDIO_CFG_SMOOTH_VIBRATO) {
/* famistudio_smooth_vibrato famistudio_output_buf+1, famistudio_pulse1_prev, FAMISTUDIO_APU_PL1_HI, FAMISTUDIO_APU_PL1_LO, FAMISTUDIO_APU_PL1_SWEEP */
    } else {
        cmp(a, *((famistudio_pulse1_prev) as *u8));
        goto (@no_pulse1_upd) if zero;
        *((famistudio_pulse1_prev) as *u8) = a;
        *((FAMISTUDIO_APU_PL1_HI) as *u8) = a;
    }

/* @no_pulse1_upd: */
    a = *((famistudio_output_buf+3) as *u8); // Pulse 2 volume
    *((FAMISTUDIO_APU_PL2_VOL) as *u8) = a;
    a = *((famistudio_output_buf+4) as *u8); // Pulse 2 period LSB
    *((FAMISTUDIO_APU_PL2_LO) as *u8) = a;
    a = *((famistudio_output_buf+5) as *u8); // Pulse 2 period MSB, only applied when changed

    if (FAMISTUDIO_CFG_SMOOTH_VIBRATO) {
/* famistudio_smooth_vibrato famistudio_output_buf+4, famistudio_pulse2_prev, FAMISTUDIO_APU_PL2_HI, FAMISTUDIO_APU_PL2_LO, FAMISTUDIO_APU_PL2_SWEEP */
    } else {
        cmp(a, *((famistudio_pulse2_prev) as *u8));
        goto (@no_pulse2_upd) if zero;
        *((famistudio_pulse2_prev) as *u8) = a;
        *((FAMISTUDIO_APU_PL2_HI) as *u8) = a;
    }

/* @no_pulse2_upd: */
    a = *((famistudio_output_buf+6) as *u8); // Triangle volume (plays or not)
    *((FAMISTUDIO_APU_TRI_LINEAR) as *u8) = a;
    a = *((famistudio_output_buf+7) as *u8); // Triangle period LSB
    *((FAMISTUDIO_APU_TRI_LO) as *u8) = a;
    a = *((famistudio_output_buf+8) as *u8); // Triangle period MSB
    *((FAMISTUDIO_APU_TRI_HI) as *u8) = a;

    a = *((famistudio_output_buf+9) as *u8); // Noise volume
    *((FAMISTUDIO_APU_NOISE_VOL) as *u8) = a;
    a = *((famistudio_output_buf+10) as *u8); // Noise period
    *((FAMISTUDIO_APU_NOISE_LO) as *u8) = a;

}

if (FAMISTUDIO_CFG_THREAD) {
    a = pop();
    *((famistudio_ptr0_hi) as *u8) = a;
    a = pop();
    *((famistudio_ptr0_lo) as *u8) = a;
}

    return;

//======================================================================================================================
// FAMISTUDIO_DO_NOTE_ATTACK + EXP VARIANTS (internal)
//
// Internal function to reset all the envelopes of a channnel (note attack).
//
// [in] x/r0 : channel index
//======================================================================================================================

if (FAMISTUDIO_EXP_VRC7) {

/* famistudio_do_vrc7_note_attack: */

/* @chan_idx = famistudio_r0 */

    // Set trigger flag for VRC7
    a = 1;
    x = *((@chan_idx) as *u8);
    *((famistudio_chn_vrc7_trigger-FAMISTUDIO_VRC7_CH0_IDX + x) as *u8) = a;
    return;

}

if (FAMISTUDIO_EXP_EPSM) {

/* famistudio_do_epsm_note_attack: */

/* @chan_idx = famistudio_r0 */
/* @tmp_y    = famistudio_r1 */

if (FAMISTUDIO_EXP_EPSM_FM_CHN_CNT+FAMISTUDIO_EXP_EPSM_RHYTHM_CNT > 0) {
    *((@tmp_y) as *u8) = y;
    y = *((@chan_idx) as *u8);
    cmp(y, FAMISTUDIO_EPSM_CHAN_FM_START);
    goto (@fm_or_rhythm_channel) if carry;
}

if (FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0) {
/* @square_channel: */

    // Reset mixer/noise envelopes.
    x = *((famistudio_channel_env + y) as *u8);
    a = 0;
    *((famistudio_env_repeat+FAMISTUDIO_ENV_MIXER_IDX_OFF + x) as *u8) = a;
    *((famistudio_env_ptr+FAMISTUDIO_ENV_MIXER_IDX_OFF + x) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_ENV_MIXER_IDX_OFF + x) as *u8) = a;
    *((famistudio_env_repeat+FAMISTUDIO_ENV_NOISE_IDX_OFF + x) as *u8) = a;
    *((famistudio_env_ptr+FAMISTUDIO_ENV_NOISE_IDX_OFF + x) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_ENV_NOISE_IDX_OFF + x) as *u8) = a;

    // Set hi-bit of envelope shape to remember to reset it.
    a = 0x80;
    x = *((@chan_idx) as *u8);
    a |= *((famistudio_epsm_chn_env_shape-FAMISTUDIO_EPSM_CH0_IDX + x) as *u8);
    *((famistudio_epsm_chn_env_shape-FAMISTUDIO_EPSM_CH0_IDX + x) as *u8) = a;

    goto (@done) if zero;
}

if (FAMISTUDIO_EXP_EPSM_FM_CHN_CNT+FAMISTUDIO_EXP_EPSM_RHYTHM_CNT > 0) {
/* @fm_or_rhythm_channel: */

    // Set trigger flag for FM/rhythm. For rhythm we'll actually write
    // out of bounds here, but the rhtyhm key array is immediately after.
    a = 1;
    *((famistudio_chn_epsm_trigger-FAMISTUDIO_EPSM_CHAN_FM_START + y) as *u8) = a;
}

/* @done: */
    x = *((@chan_idx) as *u8);
    y = *((@tmp_y) as *u8);
    return;

}

if (FAMISTUDIO_EXP_N163) {

/* famistudio_do_n163_note_attack: */

/* @chan_idx = famistudio_r0 */
/* @tmp_y    = famistudio_r1 */

    // Reset wave envelope.
    *((@tmp_y) as *u8) = y;
    y = *((@chan_idx) as *u8);
    x = *((famistudio_channel_env + y) as *u8);
    a = 0;
    *((famistudio_env_repeat+FAMISTUDIO_ENV_N163_WAVE_IDX_OFF + x) as *u8) = a;
    a = 1; // Index 0 is release point, so envelope starts at 1.
    *((famistudio_env_ptr+FAMISTUDIO_ENV_N163_WAVE_IDX_OFF + x) as *u8) = a;

    // Clear wave index to -1 to force reload.
    x = *((@chan_idx) as *u8);
    a = 0xff;
    *((famistudio_chn_n163_wave_index-FAMISTUDIO_N163_CH0_IDX + x) as *u8) = a;
    y = *((@tmp_y) as *u8);
    return;

}

if (FAMISTUDIO_EXP_S5B) {

/* famistudio_do_s5b_note_attack: */

/* @chan_idx = famistudio_r0 */
/* @tmp_y    = famistudio_r1 */

    // Reset mixer/noise envelopes.
    *((@tmp_y) as *u8) = y;
    y = *((@chan_idx) as *u8);
    x = *((famistudio_channel_env + y) as *u8);
    a = 0;
    *((famistudio_env_repeat+FAMISTUDIO_ENV_MIXER_IDX_OFF + x) as *u8) = a;
    *((famistudio_env_ptr+FAMISTUDIO_ENV_MIXER_IDX_OFF + x) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_ENV_MIXER_IDX_OFF + x) as *u8) = a;
    *((famistudio_env_repeat+FAMISTUDIO_ENV_NOISE_IDX_OFF + x) as *u8) = a;
    *((famistudio_env_ptr+FAMISTUDIO_ENV_NOISE_IDX_OFF + x) as *u8) = a;
    *((famistudio_env_value+FAMISTUDIO_ENV_NOISE_IDX_OFF + x) as *u8) = a;
    x = *((@chan_idx) as *u8);
    y = *((@tmp_y) as *u8);

    // Set hi-bit of envelope shape to remember to reset it.
    a = 0x80;
    a |= *((famistudio_s5b_chn_env_shape-FAMISTUDIO_S5B_CH0_IDX + x) as *u8);
    *((famistudio_s5b_chn_env_shape-FAMISTUDIO_S5B_CH0_IDX + x) as *u8) = a;
    return;

}

if (FAMISTUDIO_EXP_FDS) {

/* famistudio_do_fds_note_attack: */

/* @chan_idx = famistudio_r0 */

    // TODO : We used to set the modulation value here, but that's bad.
    // https://www.nesdev.org/wiki/FDS_audio#Mod_frequency_high_($4087)
    // lda #$80
    // sta FAMISTUDIO_FDS_MOD_HI
    // lda #0
    // sta FAMISTUDIO_FDS_SWEEP_BIAS

    a = *((famistudio_fds_mod_delay) as *u8);
    *((famistudio_fds_mod_delay_counter) as *u8) = a;
    x = *((@chan_idx) as *u8);
    return;

}

/* famistudio_do_note_attack: */

/* @chan_idx = famistudio_r0 */
/* @tmp_x    = famistudio_r2 */

if (FAMISTUDIO_CFG_EQUALIZER) {
    a = 9;
    *((famistudio_chn_note_counter + x) as *u8) = a;
}
if (FAMISTUDIO_EXP_EPSM_RHYTHM_CNT > 0) {
    a = *((@chan_idx) as *u8);
    cmp(a, FAMISTUDIO_EPSM_CHAN_RHYTHM_START);
    goto (@epsm_instrument) if carry;
}
    a = *((famistudio_channel_env + x) as *u8);
    x = a;

    // Volume envelope.
    a = 1;
    *((famistudio_env_ptr + x) as *u8) = a; // Reset volume envelope pointer to 1 (volume have releases point in index 0)
    a = 0;
    *((famistudio_env_repeat + x) as *u8) = a;

    // Arpeggio envelope
    *((famistudio_env_repeat+FAMISTUDIO_ENV_NOTE_OFF + x) as *u8) = a;
    *((famistudio_env_ptr+FAMISTUDIO_ENV_NOTE_OFF + x) as *u8) = a;

    // Duty envelope (optional)
    a = *((@chan_idx) as *u8);
    cmp(a, 2); // Triangle has no duty.
    goto (@no_duty) if zero;
if (FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_S5B || FAMISTUDIO_EXP_FDS || FAMISTUDIO_EXP_N163 || FAMISTUDIO_EXP_EPSM) {
    cmp(a, 5);
    goto (@no_duty) if carry;
}
/* @duty: */
    a = 0;
    *((famistudio_env_repeat+FAMISTUDIO_ENV_DUTY_OFF + x) as *u8) = a;
    *((famistudio_env_ptr+FAMISTUDIO_ENV_DUTY_OFF + x) as *u8) = a;
    if (FAMISTUDIO_USE_DUTYCYCLE_EFFECT) {
        *((@tmp_x) as *u8) = x;
        x = *((@chan_idx) as *u8);
        a = *((famistudio_channel_to_dutycycle + x) as *u8);
        x = a;
        a = *((famistudio_duty_cycle + x) as *u8);
        x = *((@tmp_x) as *u8);
    }
    *((famistudio_env_value+FAMISTUDIO_ENV_DUTY_OFF + x) as *u8) = a;

/* @no_duty: */
    // Pitch envelope
    x = *((@chan_idx) as *u8);
    a = *((famistudio_channel_to_pitch_env + x) as *u8);
    goto (@no_pitch) if negative;
    x = a;

/* @reset_pitch_env: */
    a = 0;
    *((famistudio_pitch_env_value_lo + x) as *u8) = a;
    *((famistudio_pitch_env_value_hi + x) as *u8) = a;
    *((famistudio_pitch_env_repeat + x) as *u8) = a;
    a = 1;
    *((famistudio_pitch_env_ptr + x) as *u8) = a; // Reset pitch envelope pointer to 1 (pitch envelope have relative/absolute flag in the first byte)

/* @no_pitch: */

if (FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_N163 || FAMISTUDIO_EXP_EPSM || FAMISTUDIO_EXP_S5B || FAMISTUDIO_EXP_FDS) {
    a = *((@chan_idx) as *u8);
    cmp(a, 5);
    goto (@done) if !carry;
/* @vrc7_instrument: */
    if (FAMISTUDIO_EXP_VRC7) {
        goto (*((famistudio_do_vrc7_note_attack) as *u8));
    }
/* @n163_instrument: */
    if (FAMISTUDIO_EXP_N163) {
        goto (*((famistudio_do_n163_note_attack) as *u8));
    }
/* @s5b_instrument: */
    if (FAMISTUDIO_EXP_S5B) {
        goto (*((famistudio_do_s5b_note_attack) as *u8));
    }
/* @fds_instrument: */
    if (FAMISTUDIO_EXP_FDS) {
        goto (*((famistudio_do_fds_note_attack) as *u8));
    }
/* @epsm_instrument: */
    if (FAMISTUDIO_EXP_EPSM) {
        goto (*((famistudio_do_epsm_note_attack) as *u8));
    }
}

/* @done: */
    x = *((@chan_idx) as *u8);
    return;

//======================================================================================================================
// FAMISTUDIO_LOAD_BASIC_ENVELOPES (internal)
//
// Internal function to load the most common envelopes (volume, arp, duty (optional) and pitch) for an instrument.
//
// [in] x:      first envelope index.
// [in] r0:     instrument index.
// [in] ptr1/y: point to instrument data to load.
//======================================================================================================================

/* famistudio_load_basic_envelopes: */

/* @instrument_ptr = famistudio_ptr1 */
/* @chan_idx      = famistudio_r0 */
/* @tmp_x         = famistudio_r3 */

    // Volume envelope
    a = *(((@instrument_ptr),y) as *u8);
    *((famistudio_env_addr_lo + x) as *u8) = a;
    ++y;
    a = *(((@instrument_ptr),y) as *u8);
    ++y;
    *((famistudio_env_addr_hi + x) as *u8) = a;
    ++x;

    // Arpeggio envelope
if (FAMISTUDIO_USE_ARPEGGIO) {
    *((@tmp_x) as *u8) = x;
    x = *((@chan_idx) as *u8);
    a = *((famistudio_chn_env_override + x) as *u8); // Check if its overriden by arpeggio.
    *(() as *u8) >>>= 1;
    x = *((@tmp_x) as *u8);
    goto (@arpeggio_envelope) if !carry;
    ++y; // Instrument arpeggio is overriden by arpeggio, dont touch!
    goto (*((@duty_envelope) as *u8));
}

/* @arpeggio_envelope: */
    a = *(((@instrument_ptr),y) as *u8);
    *((famistudio_env_addr_lo + x) as *u8) = a;
    ++y;
    a = *(((@instrument_ptr),y) as *u8);
    *((famistudio_env_addr_hi + x) as *u8) = a;

/* @duty_envelope: */
    // Duty cycle envelope
    a = *((@chan_idx) as *u8);
    cmp(a, 2); // Triangle has no duty.
    goto (@no_duty) if zero;
if (FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_S5B || FAMISTUDIO_EXP_FDS || FAMISTUDIO_EXP_N163 || FAMISTUDIO_EXP_EPSM) {
    cmp(a, 5);
    goto (@pitch_envelope) if carry;
}
/* @duty: */
        ++x;
        ++y;
        a = *(((@instrument_ptr),y) as *u8);
        *((famistudio_env_addr_lo + x) as *u8) = a;
        ++y;
        a = *(((@instrument_ptr),y) as *u8);
        *((famistudio_env_addr_hi + x) as *u8) = a;
        goto (*((@pitch_envelope) as *u8));
/* @no_duty: */
        ++y;
        ++y;

/* @pitch_envelope: */
    // Pitch envelopes.
if (!FAMISTUDIO_EXP_NONE) {
    *((@tmp_x) as *u8) = x;
}
    x = *((@chan_idx) as *u8);
if (FAMISTUDIO_USE_VIBRATO) {
    a = *((famistudio_chn_env_override + x) as *u8);
    *(() as *u8) <<= 1; // Bit-7 tells us if the pitch env is overriden, temporarely store in carry.
}
    a = *((famistudio_channel_to_pitch_env + x) as *u8);
    goto (@done) if negative;
    x = a;
if (FAMISTUDIO_USE_VIBRATO) {
    *(() as *u8) >>>>#= 1; // Bring back our bit-7 from above.
    goto (@no_vibrato) if !negative; // In bit 7 is set, instrument pitch is overriden by vibrato, dont touch pitch envelope!
    ++y;
    ++y;
    goto (@done) if !zero;
/* @no_vibrato: */
}
    ++y;
    a = *(((@instrument_ptr),y) as *u8);
    *((famistudio_pitch_env_addr_lo + x) as *u8) = a;
    ++y;
    a = *(((@instrument_ptr),y) as *u8);
    *((famistudio_pitch_env_addr_hi + x) as *u8) = a;
/* @done: */
if (!FAMISTUDIO_EXP_NONE) {
    // For expansion, preserve X (envelope index) and Y (pointer in instrument data)
    // as they may want to load more after.
    x = *((@tmp_x) as *u8);
    ++x;
    ++y;
}
    return;

//======================================================================================================================
// FAMISTUDIO_SET_INSTRUMENT (internal)
//
// Internal function to set an instrument for a given channel. Will initialize all instrument envelopes.
//
// [in] x/r0: channel index
// [in] a:    instrument index.
//======================================================================================================================

/* famistudio_set_instrument: */

/* @instrument_ptr = famistudio_ptr1 */
/* @chan_idx      = famistudio_r0 */

    // Pre-multiply by 4 if not using extended range, faster pointer arithmetic.
    if (!FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE) {
    *((a) as *u8) <<= 1;
    *((a) as *u8) <<= 1;
    }

    y = *((@chan_idx) as *u8);
    x = *((famistudio_channel_env + y) as *u8);

if (FAMISTUDIO_EXP_FDS || FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_N163 || FAMISTUDIO_EXP_EPSM || FAMISTUDIO_EXP_S5B) {
    cmp(y, 5);
    goto (@base_instrument) if !carry;
    if (FAMISTUDIO_EXP_FDS) {
/* @fds_instrument: */
        goto (*((famistudio_set_fds_instrument) as *u8));
    }
    if (FAMISTUDIO_EXP_VRC7) {
/* @vrc7_instrument: */
        goto (*((famistudio_set_vrc7_instrument) as *u8));
    }
    if (FAMISTUDIO_EXP_N163) {
/* @n163_instrument: */
        goto (*((famistudio_set_n163_instrument) as *u8));
    }
    if (FAMISTUDIO_EXP_S5B) {
/* @s5b_instrument: */
        goto (*((famistudio_set_s5b_instrument) as *u8));
    }
    if (FAMISTUDIO_EXP_EPSM) {
/* @epsm_instrument: */
        goto (*((famistudio_set_epsm_instrument) as *u8));
    }
}

/* @base_instrument: */

    if (!FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE) {
        *(() as *u8) <<= 1; // Instrument number is pre multiplied by 4
        y = a;
        a = *((famistudio_instrument_hi) as *u8);
        a +#= 0; // Use carry to extend range for 64 instruments
        *((@instrument_ptr+1) as *u8) = a;
        a = *((famistudio_instrument_lo) as *u8);
        *((@instrument_ptr+0) as *u8) = a;
    } else {
        // Multiply by instrument stride of 8.
        y = 0;
        *((@instrument_ptr+1) as *u8) = y;
        *(() as *u8) <<= 1;
        *((@instrument_ptr+1) as *u8) <<<<#= 1;
        *(() as *u8) <<= 1;
        *((@instrument_ptr+1) as *u8) <<<<#= 1;
        *(() as *u8) <<= 1;
        *((@instrument_ptr+1) as *u8) <<<<#= 1;
        carry = false;
        a +#= *((famistudio_instrument_lo) as *u8);
        *((@instrument_ptr+0) as *u8) = a;
        a = *((@instrument_ptr+1) as *u8);
        a +#= *((famistudio_instrument_hi) as *u8);
        *((@instrument_ptr+1) as *u8) = a;
    }

    goto (*((famistudio_load_basic_envelopes) as *u8)); // Will 'rts'

if (FAMISTUDIO_EXP_FDS || FAMISTUDIO_EXP_N163 || FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_EPSM || FAMISTUDIO_EXP_S5B) {

//======================================================================================================================
// FAMISTUDIO_GET_EXP_INST_PTR (internal)
//
// Retrives the expansion instrument pointer for a given index.
//
// [in]  a:      instrument index.
// [out] ptr1/y: the instrument pointer + offset
//======================================================================================================================

/* famistudio_get_exp_inst_ptr: */

/* @instrument_ptr = famistudio_ptr1 */

if (!FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE) {
    *(() as *u8) <<= 1; // Instrument number is pre multiplied by 4
    *(() as *u8) <<= 1;
    y = a;
    a = *((famistudio_exp_instrument_hi) as *u8);
    a +#= 0; // Use carry to extend range for 32 expansion instruments
    *((@instrument_ptr+1) as *u8) = a;
    a = *((famistudio_exp_instrument_lo) as *u8);
    *((@instrument_ptr+0) as *u8) = a;
} else {
    // Multiply by expansion instrument stride of 16.
    y = 0;
    *((@instrument_ptr+1) as *u8) = y;
    *(() as *u8) <<= 1;
    *((@instrument_ptr+1) as *u8) <<<<#= 1;
    *(() as *u8) <<= 1;
    *((@instrument_ptr+1) as *u8) <<<<#= 1;
    *(() as *u8) <<= 1;
    *((@instrument_ptr+1) as *u8) <<<<#= 1;
    *(() as *u8) <<= 1;
    *((@instrument_ptr+1) as *u8) <<<<#= 1;
    carry = false;
    a +#= *((famistudio_exp_instrument_lo) as *u8);
    *((@instrument_ptr+0) as *u8) = a;
    a = *((@instrument_ptr+1) as *u8);
    a +#= *((famistudio_exp_instrument_hi) as *u8);
    *((@instrument_ptr+1) as *u8) = a;
}

    return;

}

if (FAMISTUDIO_EXP_FDS || FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_EPSM) {

/* .macro skip_exp_basic_envelopes */
if (FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE) {
    y = 6;
} else {
    ++y;
    ++y;
    ++y;
    ++y;
    ++y;
    ++y;
}
/* .endmacro */

}

if (FAMISTUDIO_EXP_VRC7) {

//======================================================================================================================
// FAMISTUDIO_SET_VRC7_INSTRUMENT (internal)
//
// Internal function to set a VRC7 instrument for a given channel. Will load custom patch if needed.
//
// [in] y/r0: channel index
// [in] x:    index of first envelope of instrument
// [in] a:    instrument index.
//======================================================================================================================

/* famistudio_set_vrc7_instrument: */

/* @ptr          = famistudio_ptr1 */
/* @chan_idx     = famistudio_r0 */
/* @update_flags = famistudio_r1 ; bit 7 = no attack, bit 6 = has set delayed cut */

    famistudio_get_exp_inst_ptr();
    bit(@update_flags);
    goto (@load_envelopes) if !negative;

/* @skip_envelopes: */
/* skip_exp_basic_envelopes */
        goto (*((@load_patch) as *u8));
/* @load_envelopes: */
        famistudio_load_basic_envelopes();

/* @load_patch: */
    x = *((@chan_idx) as *u8);
    a = *(((@ptr),y) as *u8);
    *((famistudio_chn_vrc7_patch-FAMISTUDIO_VRC7_CH0_IDX + x) as *u8) = a;
    goto (@done) if !zero;

/* @read_custom_patch: */
    x = 0;
    ++y;
    ++y;
/* @read_patch_loop: */
        *((FAMISTUDIO_VRC7_REG_SEL) as *u8) = x;
        famistudio_vrc7_wait_reg_select();
        a = *(((@ptr),y) as *u8);
        ++y;
        *((FAMISTUDIO_VRC7_REG_WRITE) as *u8) = a;
        famistudio_vrc7_wait_reg_write();
        ++x;
        cmp(x, 8);
        goto (@read_patch_loop) if !zero;

/* @done: */
    return;

}

if (FAMISTUDIO_EXP_S5B) {

//======================================================================================================================
// FAMISTUDIO_SET_S5B_INSTRUMENT (internal)
//
// Internal function to set a S5B instrument.
//
// [in] y/r0: channel index
// [in] x:    index of first envelope of instrument
// [in] a:    instrument index.
//======================================================================================================================

/* famistudio_set_s5b_instrument: */

/* @chan_idx = famistudio_r0 */
/* @ptr      = famistudio_ptr1 */

    famistudio_get_exp_inst_ptr();
    famistudio_load_basic_envelopes();

/* @mixer: */
    carry = true;

    // After 'famistudio_load_basic_envelopes' x should point to the correct envelope.
/* @loop: */
        a = *(((@ptr),y) as *u8);
        *((famistudio_env_addr_lo + x) as *u8) = a;
        ++y;
        a = *(((@ptr),y) as *u8);
        *((famistudio_env_addr_hi + x) as *u8) = a;
        goto (@load_env_params) if !carry;
        carry = false;
        ++x;
        ++y;
        goto (@loop) if !carry;

/* @load_env_params: */

    // Envelope shape + auto-pitch octave
    x = *((@chan_idx) as *u8);
    ++y;
    a = *(((@ptr),y) as *u8);
    *((famistudio_s5b_chn_env_shape-FAMISTUDIO_S5B_CH0_IDX + x) as *u8) = a;
    ++y;
    a = *(((@ptr),y) as *u8);
    *((famistudio_s5b_chn_env_octave-FAMISTUDIO_S5B_CH0_IDX + x) as *u8) = a;

    // Skip if using auto-period
    cmp(a, 0x80);
    goto (@done) if !zero;

    // Skip if effect set manual period this frame.
    a = *((famistudio_s5b_env_override) as *u8);
    goto (@done) if !zero;

    ++y;
    a = *(((@ptr),y) as *u8);
    *((famistudio_s5b_env_period_lo) as *u8) = a;
    ++y;
    a = *(((@ptr),y) as *u8);
    *((famistudio_s5b_env_period_hi) as *u8) = a;

/* @done: */
    return;

}

if (FAMISTUDIO_EXP_EPSM) {

//======================================================================================================================
// FAMISTUDIO_SET_EPSM_INSTRUMENT (internal)
//
// Internal function to set a EPSM instrument.
//
// [in] x/r0: channel index
// [in] a:    instrument index.
//======================================================================================================================

/* famistudio_set_epsm_instrument: */

/* @ptr          = famistudio_ptr1 */
/* @env_ptr      = famistudio_ptr2 */
/* @ex_patch     = famistudio_ptr2 */
/* @chan_idx     = famistudio_r0 */
/* @chan_idx2    = famistudio_r0 */
/* @update_flags = famistudio_r1 ; bit 7 = no attack, bit 6 = has set delayed cut */
/* @reg_offset   = famistudio_r3 */

if (FAMISTUDIO_EXP_EPSM_RHYTHM_CNT > 0) {
    cmp(y, FAMISTUDIO_EPSM_CHAN_RHYTHM_START);
    goto (@process_regular_instrument) if !carry;
        // We are processing a rhythm instrument, so skip all the fluff.
        // We only need to load the volume of the instrument and store it in the attack.
        // load the instrument
        //sty @chan_idx
    famistudio_get_exp_inst_ptr();

        // Load the offset for the rhythm track and keep it in x
        x = *((@chan_idx) as *u8);
        a = *((famistudio_rhythm_lut-FAMISTUDIO_EPSM_CHAN_RHYTHM_START + x) as *u8);
        x = a;

        // Read the first envelope pointer for the volume, we'll use this to get the volume later
    *((@reg_offset) as *u8) = y;
    a = *(((@ptr),y) as *u8);
    *((@env_ptr) as *u8) = a;
    ++y;
    a = *(((@ptr),y) as *u8);
    *((@env_ptr+1) as *u8) = a;
    // the first value is the release point, so load the second offset which is the volume
    y = 1;
    a = *(((@env_ptr),y) as *u8);
    a &= 0x0F;
    *((famistudio_chn_epsm_rhythm_volume + x) as *u8) = a;
    a = *((@reg_offset) as *u8);
    carry = false;
    a +#= 14; // skip over envelopes + square stuff.
    y = a;
    a = *(((@ptr),y) as *u8);
    *((@ex_patch) as *u8) = a;
    ++y;
    a = *(((@ptr),y) as *u8);
    *((@ex_patch+1) as *u8) = a;
    y = 1;
    a = *(((@ex_patch),y) as *u8);
    a &= 0xc0;
    *((famistudio_chn_epsm_rhythm_stereo + x) as *u8) = a;

        return;
}
/* @process_regular_instrument: */
if (FAMISTUDIO_EXP_EPSM_FM_CHN_CNT > 0) {
    cmp(y, FAMISTUDIO_EPSM_CHAN_FM_START);
    goto (@skip_fm_instrument) if !carry;
        *((famistudio_chn_epsm_fm_instrument-FAMISTUDIO_EPSM_CHAN_FM_START + y) as *u8) = a;
/* @skip_fm_instrument: */
}
    famistudio_get_exp_inst_ptr();
    bit(@update_flags);
    goto (@load_envelopes) if !negative;

    // The exporter will ensure this only happens on FM channels.
/* @skip_envelopes: */
/* skip_exp_basic_envelopes */
        goto (*((@check_square_channel) as *u8));
/* @load_envelopes: */
        famistudio_load_basic_envelopes();

/* @check_square_channel: */
if (FAMISTUDIO_EXP_EPSM_FM_CHN_CNT > 0) {
    // channels 0-2 (square) do not need any further handling since they do not support patches
    a = *((@chan_idx) as *u8);
    cmp(a, FAMISTUDIO_EPSM_CHAN_FM_START);
    goto (@not_square_channel) if carry;
        //lda famistudio_channel_env,x
        //tax
}
if (FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0) {
/* @noise: */
        carry = true;

/* @loop: */
        a = *(((@ptr),y) as *u8);
        *((famistudio_env_addr_lo + x) as *u8) = a;
        ++y;
        a = *(((@ptr),y) as *u8);
        *((famistudio_env_addr_hi + x) as *u8) = a;
        goto (@load_env_params) if !carry;
        carry = false;
        ++x;
        ++y;
        goto (@loop) if !carry;

/* @load_env_params: */

        // Envelope shape + auto-pitch octave
        x = *((@chan_idx) as *u8);
        ++y;
        a = *(((@ptr),y) as *u8);
        *((famistudio_epsm_chn_env_shape-FAMISTUDIO_EPSM_CH0_IDX + x) as *u8) = a;
        ++y;
        a = *(((@ptr),y) as *u8);
        *((famistudio_epsm_chn_env_octave-FAMISTUDIO_EPSM_CH0_IDX + x) as *u8) = a;

        // Skip if using auto-period
        cmp(a, 0x80);
        goto (@done) if !zero;

        // Skip if effect set manual period this frame.
        a = *((famistudio_epsm_env_override) as *u8);
        goto (@done) if !zero;

        ++y;
        a = *(((@ptr),y) as *u8);
        *((famistudio_epsm_env_period_lo) as *u8) = a;
        ++y;
        a = *(((@ptr),y) as *u8);
        *((famistudio_epsm_env_period_hi) as *u8) = a;

/* @done: */

}
        return;

/* @not_square_channel: */
    return;
}

if (FAMISTUDIO_EXP_FDS) {

//======================================================================================================================
// FAMISTUDIO_SET_FDS_INSTRUMENT (internal)
//
// Internal function to set a FDS instrument. Will upload the wave and modulation envelope if needed.
//
// [in] y/r0: channel index
// [in] x:    index of first envelope of instrument
// [in] a:    instrument index.
//======================================================================================================================

/* famistudio_set_fds_instrument: */

/* @ptr          = famistudio_ptr1 */
/* @wave_ptr     = famistudio_ptr2 */
/* @tmp_y        = famistudio_r3 */

    famistudio_get_exp_inst_ptr();
    famistudio_load_basic_envelopes();

/* @write_fds_wave: */

        a |= 0x80;
        *((FAMISTUDIO_FDS_VOL) as *u8) = a; // Enable wave RAM write

        // FDS Waveform
        a = *(((@ptr),y) as *u8);
        *((@wave_ptr+0) as *u8) = a;
        ++y;
        a = *(((@ptr),y) as *u8);
        *((@wave_ptr+1) as *u8) = a;
        ++y;
        *((@tmp_y) as *u8) = y;

        y = 0;
/* @wave_loop: */
            a = *(((@wave_ptr),y) as *u8);
            *((FAMISTUDIO_FDS_WAV_START + y) as *u8) = a;
            ++y;
            cmp(y, 64);
            goto (@wave_loop) if !zero;

        y = *((@tmp_y) as *u8);
        a = 0x80;
        *((FAMISTUDIO_FDS_MOD_HI) as *u8) = a; // Need to disable modulation before writing.
        a = *(((@ptr),y) as *u8); // Read master volume
        *((FAMISTUDIO_FDS_VOL) as *u8) = a; // Disable RAM write.
        a = 0;
        *((FAMISTUDIO_FDS_SWEEP_BIAS) as *u8) = a;
        ++y;

        // FDS Modulation
        a = *(((@ptr),y) as *u8);
        *((@wave_ptr+0) as *u8) = a;
        ++y;
        a = *(((@ptr),y) as *u8);
        *((@wave_ptr+1) as *u8) = a;
        ++y;
        *((@tmp_y) as *u8) = y;

        y = 0;
/* @mod_loop: */
            a = *(((@wave_ptr),y) as *u8);
            *((FAMISTUDIO_FDS_MOD_TABLE) as *u8) = a;
            ++y;
            cmp(y, 32);
            goto (@mod_loop) if !zero;

        y = *((@tmp_y) as *u8);

/* @load_mod_param: */

    if (FAMISTUDIO_USE_FDS_AUTOMOD) {
        a = *(((@ptr),y) as *u8);
        goto (@check_mod_speed) if zero;

/* @auto_mod: */
            ++y;
            a = *(((@ptr),y) as *u8);
            *((famistudio_fds_automod_numer) as *u8) = a;
            ++y;
            a = *(((@ptr),y) as *u8);
            *((famistudio_fds_automod_denom) as *u8) = a;
            goto (@check_mod_depth) if !zero;
    } else {
        ++y;
        ++y;
    }

/* @check_mod_speed: */
            ++y;
            if (FAMISTUDIO_USE_FDS_AUTOMOD) {
                a = 0;
                *((famistudio_fds_automod_numer) as *u8) = a;
            }
            bit(famistudio_fds_override_flags);
            goto (@mod_speed_overriden) if negative;

/* @load_mod_speed: */
                a = *(((@ptr),y) as *u8);
                *((famistudio_fds_mod_speed+0) as *u8) = a;
                ++y;
                a = *(((@ptr),y) as *u8);
                *((famistudio_fds_mod_speed+1) as *u8) = a;
                goto (*((@check_mod_depth) as *u8));

/* @mod_speed_overriden: */
                ++y;

/* @check_mod_depth: */
            ++y;
            bit(famistudio_fds_override_flags);
            goto (@mod_depth_overriden) if overflow;

/* @load_mod_depth: */
                a = *(((@ptr),y) as *u8);
                *((famistudio_fds_mod_depth) as *u8) = a;

/* @mod_depth_overriden: */
                ++y;
                a = *(((@ptr),y) as *u8);
                *((famistudio_fds_mod_delay) as *u8) = a;
    return;

}

if (FAMISTUDIO_EXP_N163) {

/* famistudio_n163_wave_table: */
/* .byte FAMISTUDIO_N163_REG_WAVE - $00 */
/* .byte FAMISTUDIO_N163_REG_WAVE - $08 */
/* .byte FAMISTUDIO_N163_REG_WAVE - $10 */
/* .byte FAMISTUDIO_N163_REG_WAVE - $18 */
/* .byte FAMISTUDIO_N163_REG_WAVE - $20 */
/* .byte FAMISTUDIO_N163_REG_WAVE - $28 */
/* .byte FAMISTUDIO_N163_REG_WAVE - $30 */
/* .byte FAMISTUDIO_N163_REG_WAVE - $38 */

//======================================================================================================================
// FAMISTUDIO_UPDATE_N163_WAVE (internal)
//
// Internal function to upload the waveform (if needed) of an N163 instrument.
//
// [in] y: N163 channel idx (0,1,2,3,4,5,6,7)
//======================================================================================================================

/* famistudio_update_n163_wave: */

/* @ptr           = famistudio_ptr1 */
/* @wave_ptr      = famistudio_ptr0 */
/* @wave_pos      = famistudio_r1 */
/* @wave_len      = famistudio_r2 */

    a = *((famistudio_n163_env_table + y) as *u8);
    x = a;

    // See if the wave index has changed.
    a = *((famistudio_env_value+FAMISTUDIO_ENV_N163_WAVE_IDX_OFF + x) as *u8);
    cmp(a, *((famistudio_chn_n163_wave_index + y) as *u8));
    goto (@done) if zero;

    // Retrieve the instrument pointer.
    *((famistudio_chn_n163_wave_index + y) as *u8) = a;
    a = y;
    x = a;
    a = *((famistudio_chn_n163_instrument + y) as *u8);
    famistudio_get_exp_inst_ptr();

    a = *((famistudio_n163_wave_table + x) as *u8);
    *((FAMISTUDIO_N163_ADDR) as *u8) = a;

    // Wave position
    a = y;
    a +#= 8; // Carry is clear here.
    y = a;
    a = *(((@ptr),y) as *u8);
    *((@wave_pos) as *u8) = a;
    *((FAMISTUDIO_N163_DATA) as *u8) = a;
    ++y;

    // Wave length
    a = *(((@ptr),y) as *u8);
    *(() as *u8) >>>= 1;
    *((@wave_len) as *u8) = a;
    a = 0x80; // (128 - wave length / 2) * 2 == 256 - wave length
    carry = true;
    a -#= *((@wave_len) as *u8);
    *(() as *u8) <<= 1;
    *((famistudio_chn_n163_wave_len + x) as *u8) = a;
    ++y;

    // Load the wave table pointer.
    a = *(((@ptr),y) as *u8);
    *((@wave_ptr+0) as *u8) = a;
    ++y;
    a = *(((@ptr),y) as *u8);
    *((@wave_ptr+1) as *u8) = a;

    // Load the pointer for the current wave in the table.
    a = *((famistudio_chn_n163_wave_index + x) as *u8);
    *(() as *u8) <<= 1;
    y = a;
    a = *(((@wave_ptr),y) as *u8);
    *((@ptr+0) as *u8) = a;
    ++y;
    a = *(((@wave_ptr),y) as *u8);
    *((@ptr+1) as *u8) = a;

    // Upload to N163
    y = 0;
    a = *((@wave_pos) as *u8);
    *(() as *u8) >>>= 1;
    a |= 0x80;
    *((FAMISTUDIO_N163_ADDR) as *u8) = a;
    y = 0;
/* @wave_loop: */
        a = *(((@ptr),y) as *u8);
        *((FAMISTUDIO_N163_DATA) as *u8) = a;
        ++y;
        cmp(y, *((@wave_len) as *u8));
        goto (@wave_loop) if !zero;

    a = x;
    y = a;

/* @done: */
    return;

//======================================================================================================================
// FAMISTUDIO_SET_N163_INSTRUMENT (internal)
//
// Internal function to set a N163 instrument.
//
// [in] y/r0: channel index
// [in] x:    index of first envelope of instrument
// [in] a:    instrument index.
//======================================================================================================================

/* famistudio_set_n163_instrument: */

/* @ptr      = famistudio_ptr1 */
/* @chan_idx = famistudio_r0 */

    // Store instrument number (premultipled by 4 if not using extended range)
    *((famistudio_chn_n163_instrument-FAMISTUDIO_N163_CH0_IDX + y) as *u8) = a;

    famistudio_get_exp_inst_ptr();
    famistudio_load_basic_envelopes();

    // Load the wave index envelope, x will point to the correct envelope.
    a = *(((@ptr),y) as *u8);
    *((famistudio_env_addr_lo + x) as *u8) = a;
    ++y;
    a = *(((@ptr),y) as *u8);
    *((famistudio_env_addr_hi + x) as *u8) = a;

    return;

}

//======================================================================================================================
// FAMISTUDIO_UPDATE_CHANNEL (internal)
//
// Advances the song by one frame for a given channel. If a new note or effect(s) are found, they will be processed.
//
// [in]  x: channel index
// [out] z: non-zero if we triggered a new note.
//======================================================================================================================

/* famistudio_advance_channel: */

/* @chan_idx         = famistudio_r0 */
/* @update_flags     = famistudio_r1 ; bit 7 = no attack, bit 6 = has set delayed cut */
/* @temp_ptr_y       = famistudio_r2 */
/* @tmp_slide_from   = famistudio_r2 */
/* @tmp_slide_idx    = famistudio_r2 */
/* @tmp_duty_cycle   = famistudio_r2 */
/* @tmp_ptr_lo       = famistudio_r2 */
/* @tmp_y1           = famistudio_r2 */
/* @slide_delta_lo   = famistudio_ptr1_hi */
/* @tmp_y2           = famistudio_ptr1_lo */
/* @channel_data_ptr = famistudio_ptr0 */
/* @opcode_jmp_ptr   = famistudio_ptr1 */
/* @tempo_env_ptr    = famistudio_ptr1 */
/* @env_ptr          = famistudio_ptr1 */

    a = *((famistudio_chn_repeat + x) as *u8);
    goto (@no_repeat) if zero;
    --(*((famistudio_chn_repeat + x) as *u8));
    a = 0;
    return;

/* @no_repeat: */
    a = *((famistudio_chn_ptr_lo + x) as *u8);
    *((@channel_data_ptr+0) as *u8) = a;
    a = *((famistudio_chn_ptr_hi + x) as *u8);
    *((@channel_data_ptr+1) as *u8) = a;
    y = 0;
    *((@update_flags) as *u8) = y;
    *((@chan_idx) as *u8) = x;

/* @read_byte: */
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;

// $80 to $ff = sequence of empty notes (up to 64) or instrument changes (up to 64)
/* @check_negative: */
    a |= 0;
    goto (@empty_notes_or_instrument_change) if negative;

// $00 to $3f = notes from C1 to D6 (most common notes, same as FT2 range)
// $40 to $6f = opcodes for various things.
/* @check_regular_note: */
    cmp(a, 0x40);
    goto (@common_note) if !carry;

if (FAMISTUDIO_USE_VOLUME_TRACK) {
// $70 to $7f = volume change
/* @check_volume_track: */
    cmp(a, 0x70);
    goto (@jmp_to_opcode) if !carry;

/* @volume_track: */
    a &= 0x0f;
    *(() as *u8) <<= 1;
    *(() as *u8) <<= 1;
    *(() as *u8) <<= 1;
    *(() as *u8) <<= 1;
    *((famistudio_chn_volume_track + x) as *u8) = a;
    // Clear any volume slide.
    if (FAMISTUDIO_USE_VOLUME_SLIDES) {
        a = 0;
        *((famistudio_chn_volume_slide_step + x) as *u8) = a;
    }
    goto (@read_byte) if !carry;
}

/* @jmp_to_opcode: */
    a &= 0x3f;
    x = a;
    a = *((@famistudio_opcode_jmp_lo,x) as *u8);
    *((@opcode_jmp_ptr+0) as *u8) = a;
    a = *((@famistudio_opcode_jmp_hi,x) as *u8);
    *((@opcode_jmp_ptr+1) as *u8) = a;
    x = *((@chan_idx) as *u8);
    goto (*(((@opcode_jmp_ptr)) as *u8));

/* @empty_notes_or_instrument_change: */
    a &= 0x7f;
    *((a) as *u8) >>>= 1;
    goto (@set_repeat) if carry;

/* @instrument_change: */
    // Set the instrument. `famistudio_set_instrument` (or proc it calls) are not
    // allowed to clobber r0/r1/r2 or ptr0.
    *((@temp_ptr_y) as *u8) = y;
    famistudio_set_instrument(); // Will clobber x/y, need to save/restore them.
    y = *((@temp_ptr_y) as *u8);
    x = *((@chan_idx) as *u8);
    goto (*((@read_byte) as *u8));

/* @set_repeat: */
    *((famistudio_chn_repeat + x) as *u8) = a; // Set up repeat counter
    goto (@done) if carry;

/* @common_note: */
    cmp(a, 0);
    goto (@play_note) if zero;
        a +#= 11; // Carry is set here.

/* @play_note: */
    *((famistudio_chn_note + x) as *u8) = a; // Store note code

if (FAMISTUDIO_USE_SLIDE_NOTES) {
/* @clear_previous_slide: */
    a = *((famistudio_channel_to_slide + x) as *u8); // Clear any previous slide on new note.
    goto (@cancel_delayed_cut) if negative;
    x = a;
    a = 0;
    *((famistudio_slide_step + x) as *u8) = a;
    x = *((@chan_idx) as *u8);
}

/* @cancel_delayed_cut: */
if (FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS) {
    // Any note with an attack clears any pending delayed cut, unless it was set during this update (flags bit 6).
    bit(@update_flags);
    goto (@check_dpcm_channel) if overflow;
    a = 0xff;
    *((famistudio_chn_cut_delay + x) as *u8) = a;
}

/* @check_dpcm_channel: */
if (FAMISTUDIO_CFG_DPCM_SUPPORT) {
    // We play/stop DPCM samples immediately.
    cmp(x, 4);
    goto (@check_attack) if !zero;
        a = *((famistudio_chn_note+4) as *u8);
        goto (@play_sample) if !zero;
        famistudio_sample_stop();
        x = 4;
        goto (@done) if !zero;
/* @play_sample: */
            a -#= 12; // Carry already set. HACK : Our "notes" for DPCM start at SingleByteNoteMin (12). Need to undo that here. See C# code.
            *((@tmp_y1) as *u8) = y;
            famistudio_music_sample_play();
            y = *((@tmp_y1) as *u8);
            x = 4;
            if (FAMISTUDIO_CFG_EQUALIZER) {
                a = 9;
                *((famistudio_chn_note_counter + x) as *u8) = a;
            }
            goto (@done) if !zero;
}

/* @check_attack: */
    a = *((famistudio_chn_note + x) as *u8);
    goto (@done) if zero;
    bit(@update_flags);
    goto (@done) if negative;

    // Note attack. `famistudio_do_note_attack` (or any proc it calls) are not
    // allowed to clobber r0 or ptr0. They can clobber r1 if they are done using it.
    famistudio_do_note_attack(); // Note attack.

/* @done: */
    a = *((famistudio_chn_ref_len + x) as *u8); // Check reference row counter
    goto (@flush_y) if zero; // If it is zero, there is no reference
    --(*((famistudio_chn_ref_len + x) as *u8)); // Decrease row counter
    goto (@flush_y) if !zero;

    a = *((famistudio_chn_return_lo + x) as *u8); // End of a reference, return to previous pointer
    *((famistudio_chn_ptr_lo + x) as *u8) = a;
    a = *((famistudio_chn_return_hi + x) as *u8);
    *((famistudio_chn_ptr_hi + x) as *u8) = a;
    return;

/* @flush_y: */

    carry = false;
    a = y;
    a +#= *((@channel_data_ptr+0) as *u8);
    *((famistudio_chn_ptr_lo + x) as *u8) = a;
    a = 0;
    a +#= *((@channel_data_ptr+1) as *u8);
    *((famistudio_chn_ptr_hi + x) as *u8) = a;
    return;

/* @opcode_extended_note: */
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    goto (*((@play_note) as *u8));

/* @opcode_set_reference: */
    carry = false; // Remember return address+3
    a = y;
    a +#= 3;
    a +#= *((@channel_data_ptr+0) as *u8);
    *((famistudio_chn_return_lo + x) as *u8) = a;
    a = *((@channel_data_ptr+1) as *u8);
    a +#= 0;
    *((famistudio_chn_return_hi + x) as *u8) = a;
    a = *(((@channel_data_ptr),y) as *u8); // Read length of the reference (how many rows)
    *((famistudio_chn_ref_len + x) as *u8) = a;
    ++y;
    a = *(((@channel_data_ptr),y) as *u8); // Read 16-bit absolute address of the reference
    *((@tmp_ptr_lo) as *u8) = a;
    ++y;
    a = *(((@channel_data_ptr),y) as *u8);
    *((@channel_data_ptr+1) as *u8) = a;
    a = *((@tmp_ptr_lo) as *u8);
    *((@channel_data_ptr+0) as *u8) = a;
    y = 0;
    goto (*((@read_byte) as *u8));

/* @opcode_loop: */
    a = *(((@channel_data_ptr),y) as *u8);
    *((@tmp_ptr_lo) as *u8) = a;
    ++y;
    a = *(((@channel_data_ptr),y) as *u8);
    *((@channel_data_ptr+1) as *u8) = a;
    a = *((@tmp_ptr_lo) as *u8);
    *((@channel_data_ptr+0) as *u8) = a;
    y = 0;
    goto (*((@read_byte) as *u8));

/* @opcode_disable_attack: */
    a = 0x80;
    a |= *((@update_flags) as *u8);
    *((@update_flags) as *u8) = a;
    goto (*((@read_byte) as *u8));

/* @opcode_end_song: */
    a = 0x80; // TODO : Should we stop, or just call famistudio_music_stop here?
    *((famistudio_song_speed) as *u8) = a;
    goto (*((@read_byte) as *u8));

if (FAMISTUDIO_USE_RELEASE_NOTES) {
/* @jump_to_release_envelope: */
    a = *((famistudio_env_addr_lo + x) as *u8); // Load envelope data address into temp
    *((@env_ptr+0) as *u8) = a;
    a = *((famistudio_env_addr_hi + x) as *u8);
    *((@env_ptr+1) as *u8) = a;

    *((@tmp_y1) as *u8) = y;
    y = 0;
    a = *(((@env_ptr),y) as *u8); // Read first byte of the envelope data, this contains the release index.
    goto (@env_has_no_release) if zero;

    *((famistudio_env_ptr + x) as *u8) = a;
    a = 0;
    *((famistudio_env_repeat + x) as *u8) = a; // Need to reset envelope repeat to force update.

/* @env_has_no_release: */
    x = *((@chan_idx) as *u8);
    y = *((@tmp_y1) as *u8);
    return;

if (FAMISTUDIO_EXP_VRC7) {
/* @opcode_vrc7_release_note: */
    a = 0x80;
    *((famistudio_chn_vrc7_trigger-FAMISTUDIO_VRC7_CH0_IDX + x) as *u8) = a; // Set release flag for VRC7
}

if (FAMISTUDIO_EXP_FDS) {
/* @opcode_fds_release_note: */
    x = FAMISTUDIO_FDS_CH0_ENVS;
    @jump_to_release_envelope();
}

if (FAMISTUDIO_EXP_N163) {
/* @opcode_n163_release_note: */
    a = *((famistudio_channel_env + x) as *u8);
    x = a;
    ++x; // +2 for FAMISTUDIO_ENV_N163_WAVE_IDX_OFF.
    ++x;
    @jump_to_release_envelope();
}

if (FAMISTUDIO_EXP_EPSM) {
/* @opcode_epsm_release_note: */
    a = 0x80;
    if (FAMISTUDIO_EXP_EPSM_FM_CHN_CNT+FAMISTUDIO_EXP_EPSM_RHYTHM_CNT > 0) {
    *((famistudio_chn_epsm_trigger-FAMISTUDIO_EPSM_CHAN_FM_START + x) as *u8) = a; // Set release flag for EPSM
    }
}

/* @opcode_release_note: */
    a = *((famistudio_channel_to_volume_env + x) as *u8); // DPCM(5) will never have releases.
    x = a;
    @jump_to_release_envelope();
    carry = false;
    goto (*((@done) as *u8));
}

if (FAMISTUDIO_EXP_EPSM && FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0) {
/* @opcode_epsm_manual_env_period: */
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_epsm_env_period_lo) as *u8) = a;
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_epsm_env_period_hi) as *u8) = a;
    a = 1;
    *((famistudio_epsm_env_override) as *u8) = a;
    goto (*((@read_byte) as *u8));
}

if (FAMISTUDIO_EXP_S5B) {
/* @opcode_s5b_manual_env_period: */
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_s5b_env_period_lo) as *u8) = a;
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_s5b_env_period_hi) as *u8) = a;
    a = 1;
    *((famistudio_s5b_env_override) as *u8) = a;
    goto (*((@read_byte) as *u8));
}

if (FAMISTUDIO_USE_FAMITRACKER_TEMPO) {
/* @opcode_famitracker_speed: */
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_song_speed) as *u8) = a;
    goto (*((@read_byte) as *u8));
}

if (FAMISTUDIO_EXP_FDS) {
/* @opcode_fds_mod_depth: */
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_fds_mod_depth) as *u8) = a;
    a = 0x40;
    a |= *((famistudio_fds_override_flags) as *u8);
    *((famistudio_fds_override_flags) as *u8) = a;
    goto (*((@read_byte) as *u8));

/* @opcode_fds_mod_speed: */
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_fds_mod_speed+0) as *u8) = a;
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_fds_mod_speed+1) as *u8) = a;
    a = 0x80;
    a |= *((famistudio_fds_override_flags) as *u8);
    *((famistudio_fds_override_flags) as *u8) = a;
    goto (*((@read_byte) as *u8));
}

if (FAMISTUDIO_EXP_VRC6) {
/* @opcode_vrc6_saw_volume: */
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_vrc6_saw_volume) as *u8) = a;
    goto (*((@read_byte) as *u8));
}

if (FAMISTUDIO_USE_VOLUME_SLIDES) {
/* @opcode_volume_slide: */
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_chn_volume_slide_step + x) as *u8) = a;
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_chn_volume_slide_target + x) as *u8) = a;
    goto (*((@read_byte) as *u8));
}

if (FAMISTUDIO_USE_DELTA_COUNTER) {
/* @opcode_dmc_counter: */
    a = *(((@channel_data_ptr),y) as *u8);
    goto (@set_immediately) if negative;
/* @store_for_later: */
    *((famistudio_dmc_delta_counter) as *u8) = a;
    goto (@inc_and_return) if !negative;
/* @set_immediately: */
    a &= 0x7f;
    *((FAMISTUDIO_APU_DMC_RAW) as *u8) = a;
/* @inc_and_return: */
    ++y;
    goto (*((@read_byte) as *u8));
}

if (FAMISTUDIO_USE_PHASE_RESET) {
/* @opcode_phase_reset: */
    a = *((famistudio_channel_to_phase_reset_mask + x) as *u8);
    a |= *((famistudio_phase_reset) as *u8);
    *((famistudio_phase_reset) as *u8) = a;
    goto (*((@read_byte) as *u8));

if (FAMISTUDIO_EXP_N163) {
/* @opcode_n163_phase_reset: */
    a = *((famistudio_channel_to_phase_reset_mask + x) as *u8);
    a |= *((famistudio_phase_reset_n163) as *u8);
    *((famistudio_phase_reset_n163) as *u8) = a;
    goto (*((@read_byte) as *u8));
}
}

if (FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE) {
/* @opcode_extended_instrument: */
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    goto (*((@instrument_change) as *u8));
}

if (FAMISTUDIO_USE_PITCH_TRACK) {
/* @opcode_fine_pitch: */
    a = *((famistudio_channel_to_pitch_env + x) as *u8);
    x = a;
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_pitch_env_fine_value + x) as *u8) = a;
    x = *((@chan_idx) as *u8);
    goto (*((@read_byte) as *u8));
}

if (FAMISTUDIO_USE_VIBRATO) {
/* @opcode_clear_pitch_override_flag: */
    a = 0x7f;
    a &= *((famistudio_chn_env_override + x) as *u8);
    *((famistudio_chn_env_override + x) as *u8) = a;
    goto (*((@read_byte) as *u8));

/* @opcode_override_pitch_envelope: */
    a = 0x80;
    a |= *((famistudio_chn_env_override + x) as *u8);
    *((famistudio_chn_env_override + x) as *u8) = a;
    a = *((famistudio_channel_to_pitch_env + x) as *u8);
    x = a;
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_pitch_env_addr_lo + x) as *u8) = a;
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_pitch_env_addr_hi + x) as *u8) = a;
    a = 0;
    *((famistudio_pitch_env_repeat + x) as *u8) = a;
    a = 1;
    *((famistudio_pitch_env_ptr + x) as *u8) = a;
    x = *((@chan_idx) as *u8);
    goto (*((@read_byte) as *u8));
}

if (FAMISTUDIO_USE_ARPEGGIO) {
/* @opcode_clear_arpeggio_override_flag: */
    a = 0xfe;
    a &= *((famistudio_chn_env_override + x) as *u8);
    *((famistudio_chn_env_override + x) as *u8) = a;
    goto (*((@read_byte) as *u8));

/* @opcode_override_arpeggio_envelope: */
    a = 0x01;
    a |= *((famistudio_chn_env_override + x) as *u8);
    *((famistudio_chn_env_override + x) as *u8) = a;
    a = *((famistudio_channel_to_arpeggio_env + x) as *u8);
    x = a;
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_env_addr_lo + x) as *u8) = a;
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_env_addr_hi + x) as *u8) = a;
    a = 0;
    *((famistudio_env_repeat + x) as *u8) = a; // Reset the envelope since this might be a no-attack note.
    *((famistudio_env_value + x) as *u8) = a;
    *((famistudio_env_ptr + x) as *u8) = a;
    x = *((@chan_idx) as *u8);
    goto (*((@read_byte) as *u8));

/* @opcode_reset_arpeggio: */
    a = *((famistudio_channel_to_arpeggio_env + x) as *u8);
    x = a;
    a = 0;
    *((famistudio_env_repeat + x) as *u8) = a;
    *((famistudio_env_value + x) as *u8) = a;
    *((famistudio_env_ptr + x) as *u8) = a;
    x = *((@chan_idx) as *u8);
    goto (*((@read_byte) as *u8));
}

if (FAMISTUDIO_USE_DUTYCYCLE_EFFECT) {
/* @opcode_duty_cycle_effect: */
    a = *((famistudio_channel_to_dutycycle + x) as *u8);
    x = a;
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_duty_cycle + x) as *u8) = a;
    *((@tmp_duty_cycle) as *u8) = a;
    x = *((@chan_idx) as *u8);
    a = *((famistudio_channel_to_duty_env + x) as *u8);
    x = a;
    a = *((@tmp_duty_cycle) as *u8);
    *((famistudio_env_value + x) as *u8) = a;
    x = *((@chan_idx) as *u8);
    goto (*((@read_byte) as *u8));
}

if (FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS) {
/* @opcode_note_delay: */
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_chn_note_delay + x) as *u8) = a;
    goto (*((@flush_y) as *u8));

/* @opcode_cut_delay: */
    a = 0x40;
    *((@update_flags) as *u8) = a;
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_chn_cut_delay + x) as *u8) = a;
    goto (*((@read_byte) as *u8));
} else if (!FAMISTUDIO_USE_FAMITRACKER_TEMPO) {
/* @opcode_set_tempo_envelope: */
    // Load and reset the new tempo envelope.
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_tempo_env_ptr_lo) as *u8) = a;
    *((@tempo_env_ptr+0) as *u8) = a;
    a = *(((@channel_data_ptr),y) as *u8);
    ++y;
    *((famistudio_tempo_env_ptr_hi) as *u8) = a;
    *((@tempo_env_ptr+1) as *u8) = a;
    goto (*((@reset_tempo_env) as *u8));
/* @opcode_reset_tempo_envelope: */
    a = *((famistudio_tempo_env_ptr_lo) as *u8);
    *((@tempo_env_ptr+0) as *u8) = a;
    a = *((famistudio_tempo_env_ptr_hi) as *u8);
    *((@tempo_env_ptr+1) as *u8) = a;
/* @reset_tempo_env: */
    *((@tmp_y1) as *u8) = y;
    y = 0;
    *((famistudio_tempo_env_idx) as *u8) = y;
    a = *(((@tempo_env_ptr),y) as *u8);
    *((famistudio_tempo_env_counter) as *u8) = a;
    y = *((@tmp_y1) as *u8);
    goto (*((@read_byte) as *u8));
}

if (FAMISTUDIO_USE_SLIDE_NOTES) {

if (FAMISTUDIO_USE_NOISE_SLIDE_NOTES) {
/* @noise_slide: */
    a = *(((@channel_data_ptr),y) as *u8); // Read slide step size
    ++y;
    *((famistudio_slide_step+FAMISTUDIO_NOISE_SLIDE_INDEX) as *u8) = a;
    a = *(((@channel_data_ptr),y) as *u8); // Read slide note from
    ++y;
    carry = true;
    a -#= *(((@channel_data_ptr),y) as *u8); // Read slide note to
    *((famistudio_slide_pitch_lo+FAMISTUDIO_NOISE_SLIDE_INDEX) as *u8) = a;
    goto (@positive_noise_slide) if !negative;
/* @negative_noise_slide: */
    // Sign extend.
    a = 0xff;
    goto (@noise_shift) if negative;
/* @positive_noise_slide: */
    a = 0x00;
/* @noise_shift: */
    // Noise slides have 4-bits of fraction.
    *((famistudio_slide_pitch_lo+FAMISTUDIO_NOISE_SLIDE_INDEX) as *u8) <<= 1;
    *(() as *u8) <<<<#= 1;
    *((famistudio_slide_pitch_lo+FAMISTUDIO_NOISE_SLIDE_INDEX) as *u8) <<= 1;
    *(() as *u8) <<<<#= 1;
    *((famistudio_slide_pitch_lo+FAMISTUDIO_NOISE_SLIDE_INDEX) as *u8) <<= 1;
    *(() as *u8) <<<<#= 1;
    *((famistudio_slide_pitch_lo+FAMISTUDIO_NOISE_SLIDE_INDEX) as *u8) <<= 1;
    *(() as *u8) <<<<#= 1;
    *((famistudio_slide_pitch_hi+FAMISTUDIO_NOISE_SLIDE_INDEX) as *u8) = a;
    goto (*((@slide_done_pos) as *u8));
}

/* @opcode_slide: */
if (FAMISTUDIO_USE_NOISE_SLIDE_NOTES) {
    cmp(x, 3);
    goto (@noise_slide) if zero;
}
    a = *((famistudio_channel_to_slide + x) as *u8);
    x = a;
    a = *(((@channel_data_ptr),y) as *u8); // Read slide step size
    ++y;
    *((famistudio_slide_step + x) as *u8) = a;
    a = *(((@channel_data_ptr),y) as *u8); // Read slide note from
    ++y;
    *((@tmp_y2) as *u8) = y;
if (FAMISTUDIO_DUAL_SUPPORT) {
    carry = false;
    a +#= *((famistudio_pal_adjust) as *u8);
}
    *((@tmp_slide_from) as *u8) = a;
    a = *(((@channel_data_ptr),y) as *u8); // Read slide note to
    y = *((@tmp_slide_from) as *u8); // reload note from
if (FAMISTUDIO_DUAL_SUPPORT) {
    a +#= *((famistudio_pal_adjust) as *u8);
}
    *((@tmp_slide_idx) as *u8) = x; // X contained the slide index.
    x = a;
if (def FAMISTUDIO_EXP_NOTE_START) {
    a = *((@chan_idx) as *u8);
if (FAMISTUDIO_EXP_EPSM) {
    cmp(a, FAMISTUDIO_EPSM_CHAN_FM_START);
    goto (@note_table_epsm) if carry;
}
    cmp(a, FAMISTUDIO_EXP_NOTE_START);
    goto (@note_table_expansion) if carry;
}
    carry = true; // Subtract the pitch of both notes.
    a = *((famistudio_note_table_lsb + y) as *u8);
    a -#= *((famistudio_note_table_lsb + x) as *u8);
    *((@slide_delta_lo) as *u8) = a;
    a = *((famistudio_note_table_msb + y) as *u8);
    a -#= *((famistudio_note_table_msb + x) as *u8);
if (def FAMISTUDIO_EXP_NOTE_START) {
    goto (*((@note_table_done) as *u8));
if (FAMISTUDIO_EXP_EPSM) {
/* @note_table_epsm: */
if (FAMISTUDIO_EXP_EPSM_FM_CHN_CNT > 0) {
    a = *((famistudio_epsm_note_table_lsb + y) as *u8);
    a -#= *((famistudio_epsm_note_table_lsb + x) as *u8);
    *((@slide_delta_lo) as *u8) = a;
    a = *((famistudio_epsm_note_table_msb + y) as *u8);
    a -#= *((famistudio_epsm_note_table_msb + x) as *u8);
    goto (*((@note_table_done) as *u8));
}
}
/* @note_table_expansion: */
    a = *((famistudio_exp_note_table_lsb + y) as *u8);
    a -#= *((famistudio_exp_note_table_lsb + x) as *u8);
    *((@slide_delta_lo) as *u8) = a;
    a = *((famistudio_exp_note_table_msb + y) as *u8);
    a -#= *((famistudio_exp_note_table_msb + x) as *u8);
/* @note_table_done: */
}
    x = *((@tmp_slide_idx) as *u8); // slide index.
    *((famistudio_slide_pitch_hi + x) as *u8) = a;
    if (FAMISTUDIO_EXP_N163 || FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_EPSM) {
        cmp(x, FAMISTUDIO_FIRST_POSITIVE_SLIDE_CHANNEL); // Slide #3 is the first of expansion slides.
        goto (@positive_shift) if carry;
    }
/* @negative_shift: */
        a = *((@slide_delta_lo) as *u8);
        *(() as *u8) <<= 1; // Shift-left, we have 1 bit of fractional slide.
        *((famistudio_slide_pitch_lo + x) as *u8) = a;
        *((famistudio_slide_pitch_hi + x) as *u8) <<<<#= 1; // Shift-left, we have 1 bit of fractional slide.
    if (FAMISTUDIO_EXP_N163 || FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_EPSM) {
        goto (*((@shift_done) as *u8));
/* @positive_shift: */
        a = *((@slide_delta_lo) as *u8);
        *((famistudio_slide_pitch_lo + x) as *u8) = a;
        y = FAMISTUDIO_PITCH_SHIFT;
/* @positive_shift_loop: */
            a = *((famistudio_slide_pitch_hi + x) as *u8);
            cmp(a, 0x80);
            *((famistudio_slide_pitch_hi + x) as *u8) >>>>#= 1;
            *((famistudio_slide_pitch_lo + x) as *u8) >>>>#= 1;
            --y;
            goto (@positive_shift_loop) if !zero;
/* @shift_done: */
    }
    x = *((@chan_idx) as *u8);
    y = *((@tmp_y2) as *u8);

/* @slide_done_pos: */
    a = *(((@channel_data_ptr),y) as *u8); // Re-read the target note (ugly...)
    *((famistudio_chn_note + x) as *u8) = a; // Store note code
    ++y;
    goto (*((@cancel_delayed_cut) as *u8));
}

/* @opcode_invalid: */

    // If you hit this, this mean you either:
    // - exported a song that uses FamiStudio tempo but have defined "FAMISTUDIO_USE_FAMITRACKER_TEMPO"
    // - use delayed notes/cuts, but didnt enable "FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS"
    // - use vibrato effect, but didnt enable "FAMISTUDIO_USE_VIBRATO"
    // - use arpeggiated chords, but didnt enable "FAMISTUDIO_USE_ARPEGGIO"
    // - use fine pitches, but didnt enable "FAMISTUDIO_USE_PITCH_TRACK"
    // - use a duty cycle effect, but didnt enable "FAMISTUDIO_USE_DUTYCYCLE_EFFECT"
    // - use slide notes, but didnt enable "FAMISTUDIO_USE_SLIDE_NOTES"
    // - use volume slides, but didnt enable "FAMISTUDIO_USE_VOLUME_SLIDES"
    // - use DMC counter effect, but didnt enable "FAMISTUDIO_USE_DELTA_COUNTER"
    // - use a Phase Reset efect, but didnt enable the "FAMISTUDIO_USE_PHASE_RESET"
    // - use an instrument > 63, but didnt enable "FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE"

    irqcall(0);

/* @famistudio_opcode_jmp_lo: */
/* .byte <@opcode_extended_note                ; $40 */
/* .byte <@opcode_set_reference                ; $41 */
/* .byte <@opcode_loop                         ; $42 */
/* .byte <@opcode_disable_attack               ; $43 */
/* .byte <@opcode_end_song                     ; $44 */
if (FAMISTUDIO_USE_RELEASE_NOTES) {
/* .byte <@opcode_release_note                 ; $45 */
} else {
/* .byte <@opcode_invalid                      ; $45 */
}
if (FAMISTUDIO_USE_FAMITRACKER_TEMPO) {
/* .byte <@opcode_famitracker_speed            ; $46 */
} else {
/* .byte <@opcode_invalid                      ; $46 */
}
if (FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS) {
/* .byte <@opcode_note_delay                   ; $47 */
/* .byte <@opcode_cut_delay                    ; $48 */
} else if (!FAMISTUDIO_USE_FAMITRACKER_TEMPO) {
/* .byte <@opcode_set_tempo_envelope           ; $47 */
/* .byte <@opcode_reset_tempo_envelope         ; $48 */
} else {
/* .byte <@opcode_invalid                      ; $47 */
/* .byte <@opcode_invalid                      ; $48 */
}
if (FAMISTUDIO_USE_VIBRATO) {
/* .byte <@opcode_override_pitch_envelope      ; $49 */
/* .byte <@opcode_clear_pitch_override_flag    ; $4a */
} else {
/* .byte <@opcode_invalid                      ; $49 */
/* .byte <@opcode_invalid                      ; $4a */
}
if (FAMISTUDIO_USE_ARPEGGIO) {
/* .byte <@opcode_override_arpeggio_envelope   ; $4b */
/* .byte <@opcode_clear_arpeggio_override_flag ; $4c */
/* .byte <@opcode_reset_arpeggio               ; $4d */
} else {
/* .byte <@opcode_invalid                      ; $4b */
/* .byte <@opcode_invalid                      ; $4c */
/* .byte <@opcode_invalid                      ; $4d */
}
if (FAMISTUDIO_USE_PITCH_TRACK) {
/* .byte <@opcode_fine_pitch                   ; $4e */
} else {
/* .byte <@opcode_invalid                      ; $4e */
}
if (FAMISTUDIO_USE_DUTYCYCLE_EFFECT) {
/* .byte <@opcode_duty_cycle_effect            ; $4f */
} else {
/* .byte <@opcode_invalid                      ; $4f */
}
if (FAMISTUDIO_USE_SLIDE_NOTES) {
/* .byte <@opcode_slide                        ; $50 */
} else {
/* .byte <@opcode_invalid                      ; $50 */
}
if (FAMISTUDIO_USE_VOLUME_SLIDES) {
/* .byte <@opcode_volume_slide                 ; $51 */
} else {
/* .byte <@opcode_invalid                      ; $51 */
}
if (FAMISTUDIO_USE_DELTA_COUNTER) {
/* .byte <@opcode_dmc_counter                  ; $52 */
} else {
/* .byte <@opcode_invalid                      ; $52 */
}
if (FAMISTUDIO_USE_PHASE_RESET) {
/* .byte <@opcode_phase_reset                  ; $53 */
} else {
/* .byte <@opcode_invalid                      ; $53 */
}
if (FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE) {
/* .byte <@opcode_extended_instrument          ; $54 */
} else {
/* .byte <@opcode_invalid                      ; $54 */
}
if (!FAMISTUDIO_EXP_NONE) { // Begin expansion-specific opcodes
if (FAMISTUDIO_EXP_VRC6) {
/* .byte <@opcode_vrc6_saw_volume              ; $55 */
} else {
/* .byte <@opcode_invalid                      ; $55 */
}
if (FAMISTUDIO_EXP_VRC7 && FAMISTUDIO_USE_RELEASE_NOTES) {
/* .byte <@opcode_vrc7_release_note            ; $56 */
} else {
/* .byte <@opcode_invalid                      ; $56 */
}
if (FAMISTUDIO_EXP_FDS) {
/* .byte <@opcode_fds_mod_speed                ; $57 */
/* .byte <@opcode_fds_mod_depth                ; $58 */
} else {
/* .byte <@opcode_invalid                      ; $57 */
/* .byte <@opcode_invalid                      ; $58 */
}
if (FAMISTUDIO_EXP_FDS && FAMISTUDIO_USE_RELEASE_NOTES) {
/* .byte <@opcode_fds_release_note             ; $59 */
} else {
/* .byte <@opcode_invalid                      ; $59 */
}
if (FAMISTUDIO_EXP_N163 && FAMISTUDIO_USE_RELEASE_NOTES) {
/* .byte <@opcode_n163_release_note            ; $5a */
} else {
/* .byte <@opcode_invalid                      ; $5a */
}
if (FAMISTUDIO_EXP_N163 && FAMISTUDIO_USE_PHASE_RESET) {
/* .byte <@opcode_n163_phase_reset             ; $5b */
} else {
/* .byte <@opcode_invalid                      ; $5b */
}
if (FAMISTUDIO_EXP_EPSM && FAMISTUDIO_USE_RELEASE_NOTES) {
/* .byte <@opcode_epsm_release_note            ; $5c */
} else {
/* .byte <@opcode_invalid                      ; $5c */
}
if (FAMISTUDIO_EXP_EPSM && FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0) {
/* .byte <@opcode_epsm_manual_env_period       ; $5d */
} else {
/* .byte <@opcode_invalid                      ; $5d */
}
if (FAMISTUDIO_EXP_S5B) {
/* .byte <@opcode_s5b_manual_env_period        ; $5e */
} else {
/* .byte <@opcode_invalid                      ; $5e */
}
}

/* @famistudio_opcode_jmp_hi: */
/* .byte >@opcode_extended_note                ; $40 */
/* .byte >@opcode_set_reference                ; $41 */
/* .byte >@opcode_loop                         ; $42 */
/* .byte >@opcode_disable_attack               ; $43 */
/* .byte >@opcode_end_song                     ; $44 */
if (FAMISTUDIO_USE_RELEASE_NOTES) {
/* .byte >@opcode_release_note                 ; $45 */
} else {
/* .byte >@opcode_invalid                      ; $45 */
}
if (FAMISTUDIO_USE_FAMITRACKER_TEMPO) {
/* .byte >@opcode_famitracker_speed            ; $46 */
} else {
/* .byte >@opcode_invalid                      ; $46 */
}
if (FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS) {
/* .byte >@opcode_note_delay                   ; $47 */
/* .byte >@opcode_cut_delay                    ; $48 */
} else if (!FAMISTUDIO_USE_FAMITRACKER_TEMPO) {
/* .byte >@opcode_set_tempo_envelope           ; $47 */
/* .byte >@opcode_reset_tempo_envelope         ; $48 */
} else {
/* .byte >@opcode_invalid                      ; $47 */
/* .byte >@opcode_invalid                      ; $48 */
}
if (FAMISTUDIO_USE_VIBRATO) {
/* .byte >@opcode_override_pitch_envelope      ; $49 */
/* .byte >@opcode_clear_pitch_override_flag    ; $4a */
} else {
/* .byte >@opcode_invalid                      ; $49 */
/* .byte >@opcode_invalid                      ; $4a */
}
if (FAMISTUDIO_USE_ARPEGGIO) {
/* .byte >@opcode_override_arpeggio_envelope   ; $4b */
/* .byte >@opcode_clear_arpeggio_override_flag ; $4c */
/* .byte >@opcode_reset_arpeggio               ; $4d */
} else {
/* .byte >@opcode_invalid                      ; $4b */
/* .byte >@opcode_invalid                      ; $4c */
/* .byte >@opcode_invalid                      ; $4d */
}
if (FAMISTUDIO_USE_PITCH_TRACK) {
/* .byte >@opcode_fine_pitch                   ; $4e */
} else {
/* .byte >@opcode_invalid                      ; $4e */
}
if (FAMISTUDIO_USE_DUTYCYCLE_EFFECT) {
/* .byte >@opcode_duty_cycle_effect            ; $4f */
} else {
/* .byte >@opcode_invalid                      ; $4f */
}
if (FAMISTUDIO_USE_SLIDE_NOTES) {
/* .byte >@opcode_slide                        ; $50 */
} else {
/* .byte >@opcode_invalid                      ; $50 */
}
if (FAMISTUDIO_USE_VOLUME_SLIDES) {
/* .byte >@opcode_volume_slide                 ; $51 */
} else {
/* .byte >@opcode_invalid                      ; $51 */
}
if (FAMISTUDIO_USE_DELTA_COUNTER) {
/* .byte >@opcode_dmc_counter                  ; $52 */
} else {
/* .byte >@opcode_invalid                      ; $52 */
}
if (FAMISTUDIO_USE_PHASE_RESET) {
/* .byte >@opcode_phase_reset                  ; $53 */
} else {
/* .byte >@opcode_invalid                      ; $53 */
}
if (FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE) {
/* .byte >@opcode_extended_instrument          ; $54 */
} else {
/* .byte >@opcode_invalid                      ; $54 */
}
if (!FAMISTUDIO_EXP_NONE) { // Begin expansion-specific opcodes
if (FAMISTUDIO_EXP_VRC6) {
/* .byte >@opcode_vrc6_saw_volume              ; $55 */
} else {
/* .byte >@opcode_invalid                      ; $55 */
}
if (FAMISTUDIO_EXP_VRC7 && FAMISTUDIO_USE_RELEASE_NOTES) {
/* .byte >@opcode_vrc7_release_note            ; $56 */
} else {
/* .byte >@opcode_invalid                      ; $56 */
}
if (FAMISTUDIO_EXP_FDS) {
/* .byte >@opcode_fds_mod_speed                ; $57 */
/* .byte >@opcode_fds_mod_depth                ; $58 */
} else {
/* .byte >@opcode_invalid                      ; $57 */
/* .byte >@opcode_invalid                      ; $58 */
}
if (FAMISTUDIO_EXP_FDS && FAMISTUDIO_USE_RELEASE_NOTES) {
/* .byte >@opcode_fds_release_note             ; $59 */
} else {
/* .byte >@opcode_invalid                      ; $59 */
}
if (FAMISTUDIO_EXP_N163 && FAMISTUDIO_USE_RELEASE_NOTES) {
/* .byte >@opcode_n163_release_note            ; $5a */
} else {
/* .byte >@opcode_invalid                      ; $5a */
}
if (FAMISTUDIO_EXP_N163 && FAMISTUDIO_USE_PHASE_RESET) {
/* .byte >@opcode_n163_phase_reset             ; $5b */
} else {
/* .byte >@opcode_invalid                      ; $5b */
}
if (FAMISTUDIO_EXP_EPSM && FAMISTUDIO_USE_RELEASE_NOTES) {
/* .byte >@opcode_epsm_release_note            ; $5c */
} else {
/* .byte >@opcode_invalid                      ; $5c */
}
if (FAMISTUDIO_EXP_EPSM && FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0) {
/* .byte >@opcode_epsm_manual_env_period       ; $5d */
} else {
/* .byte >@opcode_invalid                      ; $5d */
}
if (FAMISTUDIO_EXP_S5B) {
/* .byte >@opcode_s5b_manual_env_period        ; $5e */
} else {
/* .byte >@opcode_invalid                      ; $5e */
}
}

//======================================================================================================================
// FAMISTUDIO_SAMPLE_STOP (internal)
//
// Stop DPCM sample if it plays
//
// [in] no input params.
//======================================================================================================================

/* famistudio_sample_stop: */

    a = %00001111;
    *((FAMISTUDIO_APU_SND_CHN) as *u8) = a;
    return;


if (FAMISTUDIO_CFG_DPCM_SUPPORT) {

//======================================================================================================================
// FAMISTUDIO_SAMPLE_PLAY_SFX (public)
//
// Play DPCM sample with higher priority, for sound effects
//
// [in] a: Sample index, 1...63.
//======================================================================================================================

/* famistudio_sfx_sample_play: */

    x = 1;
    *((famistudio_dpcm_effect) as *u8) = x;

/* sample_play: */

/* @tmp = famistudio_r3 */
/* @sample_index = famistudio_r3 */
/* @sample_data_ptr = famistudio_ptr1 */

if (FAMISTUDIO_USE_DPCM_BANKSWITCHING || FAMISTUDIO_USE_DPCM_EXTENDED_RANGE) {
    // famistudio_dpcm_list + sample number * (4 or 5)
    *((@sample_index) as *u8) = a;
    y = 0;
    *((@sample_data_ptr+1) as *u8) = y;
    *(() as *u8) <<= 1;
    *((@sample_data_ptr+1) as *u8) <<<<#= 1;
    *(() as *u8) <<= 1;
    *((@sample_data_ptr+1) as *u8) <<<<#= 1; // Will clear carry
if (FAMISTUDIO_USE_DPCM_BANKSWITCHING) {
    // Multiply by 5 instead of 4.
    a +#= *((@sample_index) as *u8);
    goto (@add_list_ptr) if !carry;
        ++(*((@sample_data_ptr+1) as *u8));
        carry = false;
/* @add_list_ptr: */
}
        a +#= *((famistudio_dpcm_list_lo) as *u8);
        *((@sample_data_ptr+0) as *u8) = a;
        a = *((@sample_data_ptr+1) as *u8);
        a +#= *((famistudio_dpcm_list_hi) as *u8);
        *((@sample_data_ptr+1) as *u8) = a;
} else {
    *(() as *u8) <<= 1; // Sample number * 4, offset in the sample table
    *(() as *u8) <<= 1; // Carry should be clear now, we dont allow more than 63 sample mappings.
    a +#= *((famistudio_dpcm_list_lo) as *u8);
    *((@sample_data_ptr+0) as *u8) = a;
    a = 0;
    a +#= *((famistudio_dpcm_list_hi) as *u8);
    *((@sample_data_ptr+1) as *u8) = a;
}

/* @stop_dpcm: */
    a = %00001111; // Stop DPCM
    *((FAMISTUDIO_APU_SND_CHN) as *u8) = a;

    y = 0;
    a = *(((@sample_data_ptr),y) as *u8); // Sample offset
    *((FAMISTUDIO_APU_DMC_START) as *u8) = a;
    ++y;
    a = *(((@sample_data_ptr),y) as *u8); // Sample length
    *((FAMISTUDIO_APU_DMC_LEN) as *u8) = a;
    ++y;
    a = *(((@sample_data_ptr),y) as *u8); // Pitch and loop
    *((FAMISTUDIO_APU_DMC_FREQ) as *u8) = a;
    ++y;

if (FAMISTUDIO_USE_DELTA_COUNTER) {
    a = *((famistudio_dmc_delta_counter) as *u8);
    goto (@read_dmc_initial_value) if negative;
    *((FAMISTUDIO_APU_DMC_RAW) as *u8) = a;
    a = 0xff;
    *((famistudio_dmc_delta_counter) as *u8) = a;
    goto (@start_dmc) if negative;
/* @read_dmc_initial_value: */
}

    a = *(((@sample_data_ptr),y) as *u8); // Initial DMC counter
    *((FAMISTUDIO_APU_DMC_RAW) as *u8) = a;

/* @start_dmc: */
if (FAMISTUDIO_USE_DPCM_BANKSWITCHING) {
    ++y;
    a = *(((@sample_data_ptr),y) as *u8); // Bank number
    famistudio_dpcm_bank_callback();
}

    a = %00011111; // Start DMC
    *((FAMISTUDIO_APU_SND_CHN) as *u8) = a;

    return;

//======================================================================================================================
// FAMISTUDIO_SAMPLE_PLAY_MUSIC (internal)
//
// Play DPCM sample, used by music player, could be used externally. Samples played for music have lower priority than
// samples played by SFX.
//
// [in] a: Sample index, 1...63.
//======================================================================================================================

/* famistudio_music_sample_play: */

    x = *((famistudio_dpcm_effect) as *u8);
    goto (sample_play) if zero;
    x = a;
    a = *((FAMISTUDIO_APU_SND_CHN) as *u8);
    a &= 16;
    goto (@not_busy) if zero;
    return;

/* @not_busy: */
    *((famistudio_dpcm_effect) as *u8) = a;
    a = x;
    goto (*((sample_play) as *u8));

}

if (FAMISTUDIO_CFG_SFX_SUPPORT) {

//======================================================================================================================
// FAMISTUDIO_SFX_INIT (public)
//
// Initialize the sound effect player.
//
// [in] x: Sound effect data pointer (lo)
// [in] y: Sound effect data pointer (hi)
//======================================================================================================================

/* famistudio_sfx_init: */

/* @effect_list_ptr = famistudio_ptr0 */

    *((@effect_list_ptr+0) as *u8) = x;
    *((@effect_list_ptr+1) as *u8) = y;

    y = 0;

if (FAMISTUDIO_DUAL_SUPPORT) {
    a = *((famistudio_pal_adjust) as *u8); // Add 2 to the sound list pointer for PAL
    goto (@ntsc) if !zero;
    ++y;
    ++y;
/* @ntsc: */
}

    a = *(((@effect_list_ptr),y) as *u8);
    *((famistudio_sfx_addr_lo) as *u8) = a;
    ++y;
    a = *(((@effect_list_ptr),y) as *u8);
    *((famistudio_sfx_addr_hi) as *u8) = a;

    x = FAMISTUDIO_SFX_CH0;

/* @set_channels: */
    famistudio_sfx_clear_channel();
    a = x;
    carry = false;
    a +#= FAMISTUDIO_SFX_STRUCT_SIZE;
    x = a;
    cmp(x, FAMISTUDIO_SFX_STRUCT_SIZE*FAMISTUDIO_CFG_SFX_STREAMS);
    goto (@set_channels) if !zero;

    return;

//======================================================================================================================
// FAMISTUDIO_SFX_CLEAR_CHANNEL (internal)
//
// Clears output buffer of a sound effect.
//
// [in] x: Offset of the sound effect stream.
//======================================================================================================================

/* famistudio_sfx_clear_channel: */

    a = 0;
    *((famistudio_sfx_ptr_hi + x) as *u8) = a; // This stops the effect
    *((famistudio_sfx_repeat + x) as *u8) = a;
    *((famistudio_sfx_offset + x) as *u8) = a;
    *((famistudio_sfx_buffer+6 + x) as *u8) = a; // Mute triangle
    a = 0x30;
    *((famistudio_sfx_buffer+0 + x) as *u8) = a; // Mute pulse1
    *((famistudio_sfx_buffer+3 + x) as *u8) = a; // Mute pulse2
    *((famistudio_sfx_buffer+9 + x) as *u8) = a; // Mute noise
    return;

//======================================================================================================================
// FAMISTUDIO_SFX_PLAY (public)
//
// Plays a sound effect.
//
// [in] a: Sound effect index (0...127)
// [in] x: Offset of sound effect channel, should be FAMISTUDIO_SFX_CH0..FAMISTUDIO_SFX_CH3
//======================================================================================================================

/* famistudio_sfx_play: */

/* @effect_data_ptr = famistudio_ptr0 */

    *((a) as *u8) <<= 1;
    y = a;

    famistudio_sfx_clear_channel(); // Stops the effect if it plays

    a = *((famistudio_sfx_addr_lo) as *u8);
    *((@effect_data_ptr+0) as *u8) = a;
    a = *((famistudio_sfx_addr_hi) as *u8);
    *((@effect_data_ptr+1) as *u8) = a;

    a = *(((@effect_data_ptr),y) as *u8);
    *((famistudio_sfx_ptr_lo + x) as *u8) = a;
    ++y;
    a = *(((@effect_data_ptr),y) as *u8);
    *((famistudio_sfx_ptr_hi + x) as *u8) = a; // This write enables the effect

    return;

//======================================================================================================================
// FAMISTUDIO_SFX_UPDATE (internal)
//
// Updates a single sound effect stream.
//
// [in] x: Offset of sound effect channel, should be FAMISTUDIO_SFX_CH0..FAMISTUDIO_SFX_CH3
//======================================================================================================================

/* famistudio_sfx_update: */

/* @tmp = famistudio_r0 */
/* @tmpx = famistudio_r1 */
/* @effect_data_ptr = famistudio_ptr0 */

    a = *((famistudio_sfx_repeat + x) as *u8); // Check if repeat counter is not zero
    goto (@no_repeat) if zero;
    --(*((famistudio_sfx_repeat + x) as *u8)); // Decrement and return
    goto (@update_buf) if !zero; // Just mix with output buffer

/* @no_repeat: */
    a = *((famistudio_sfx_ptr_hi + x) as *u8); // Check if MSB of the pointer is not zero
    goto (@sfx_active) if !zero;
    return; // Return otherwise, no active effect

/* @sfx_active: */
    *((@effect_data_ptr+1) as *u8) = a; //load effect pointer into temp
    a = *((famistudio_sfx_ptr_lo + x) as *u8);
    *((@effect_data_ptr+0) as *u8) = a;
    y = *((famistudio_sfx_offset + x) as *u8);
    carry = false;

/* @read_byte: */
    a = *(((@effect_data_ptr),y) as *u8); // Read byte of effect
    goto (@get_data) if negative; // If bit 7 is set, it is a register write
    goto (@eof) if zero;
    ++y;
    goto (@store_repeat) if !zero;
    @inc_sfx();
/* @store_repeat: */
    *((famistudio_sfx_repeat + x) as *u8) = a; // If bit 7 is reset, it is number of repeats
    a = y;
    *((famistudio_sfx_offset + x) as *u8) = a;
    goto (*((@update_buf) as *u8));

/* @get_data: */
    ++y;
    goto (@get_data2) if !zero;
    @inc_sfx();
/* @get_data2: */
    *((@tmp) as *u8) = x; // It is a register write
    a +#= *((@tmp) as *u8); // Get offset in the effect output buffer
    x = a;
    a = *(((@effect_data_ptr),y) as *u8);
    ++y;
    goto (@write_buffer) if !zero;
    *((@tmpx) as *u8) = x;
    x = *((@tmp) as *u8);
    @inc_sfx();
    x = *((@tmpx) as *u8);
/* @write_buffer: */
    *((famistudio_sfx_buffer-128 + x) as *u8) = a;
    x = *((@tmp) as *u8);
    goto (*((@read_byte) as *u8));

/* @eof: */
    *((famistudio_sfx_ptr_hi + x) as *u8) = a; // Mark channel as inactive

/* @update_buf: */
    a = *((famistudio_output_buf) as *u8); // Compare effect output buffer with main output buffer
    a &= 0x0f; // If volume of pulse 1 of effect is higher than that of the main buffer, overwrite the main buffer value with the new one
    *((@tmp) as *u8) = a;
    a = *((famistudio_sfx_buffer+0 + x) as *u8);
    a &= 0x0f;
    cmp(a, *((@tmp) as *u8));
    goto (@no_pulse1) if !carry;
    a = *((famistudio_sfx_buffer+0 + x) as *u8);
    *((famistudio_output_buf+0) as *u8) = a;
    a = *((famistudio_sfx_buffer+1 + x) as *u8);
    *((famistudio_output_buf+1) as *u8) = a;
    a = *((famistudio_sfx_buffer+2 + x) as *u8);
    *((famistudio_output_buf+2) as *u8) = a;

/* @no_pulse1: */
    a = *((famistudio_output_buf+3) as *u8);
    a &= 0x0f;
    *((@tmp) as *u8) = a;
    a = *((famistudio_sfx_buffer+3 + x) as *u8);
    a &= 0x0f;
    cmp(a, *((@tmp) as *u8));
    goto (@no_pulse2) if !carry;
    a = *((famistudio_sfx_buffer+3 + x) as *u8);
    *((famistudio_output_buf+3) as *u8) = a;
    a = *((famistudio_sfx_buffer+4 + x) as *u8);
    *((famistudio_output_buf+4) as *u8) = a;
    a = *((famistudio_sfx_buffer+5 + x) as *u8);
    *((famistudio_output_buf+5) as *u8) = a;

/* @no_pulse2: */
    a = *((famistudio_sfx_buffer+6 + x) as *u8); // Overwrite triangle of main output buffer if it is active
    goto (@no_triangle) if zero;
    *((famistudio_output_buf+6) as *u8) = a;
    a = *((famistudio_sfx_buffer+7 + x) as *u8);
    *((famistudio_output_buf+7) as *u8) = a;
    a = *((famistudio_sfx_buffer+8 + x) as *u8);
    *((famistudio_output_buf+8) as *u8) = a;

/* @no_triangle: */
    a = *((famistudio_output_buf+9) as *u8);
    a &= 0x0f;
    *((@tmp) as *u8) = a;
    a = *((famistudio_sfx_buffer+9 + x) as *u8);
    a &= 0x0f;
    cmp(a, *((@tmp) as *u8));
    goto (@no_noise) if !carry;
    a = *((famistudio_sfx_buffer+9 + x) as *u8);
    *((famistudio_output_buf+9) as *u8) = a;
    a = *((famistudio_sfx_buffer+10 + x) as *u8);
    *((famistudio_output_buf+10) as *u8) = a;

/* @no_noise: */
    return;

/* @inc_sfx: */
    ++(*((@effect_data_ptr+1) as *u8));
    ++(*((famistudio_sfx_ptr_hi + x) as *u8));
    return;

}

// Dummy envelope used to initialize all channels with silence
/* famistudio_dummy_envelope: */
/* .byte $c0,$7f,$00,$00 */

/* famistudio_dummy_pitch_envelope: */
/* .byte $00,$c0,$7f,$00,$01 */

// Note tables
if (FAMISTUDIO_EXP_S5B) {
/* famistudio_exp_note_table_lsb: */
/* famistudio_s5b_note_table_lsb: */
}
/* famistudio_note_table_lsb: */
    if (FAMISTUDIO_CFG_PAL_SUPPORT) {
/* .incbin "NoteTables/famistudio_note_table_pal_lsb.bin" */
    }
    if (FAMISTUDIO_CFG_NTSC_SUPPORT) {
/* .incbin "NoteTables/famistudio_note_table_lsb.bin" */
    }

if (FAMISTUDIO_EXP_S5B) {
/* famistudio_exp_note_table_msb: */
/* famistudio_s5b_note_table_msb: */
}
/* famistudio_note_table_msb: */
    if (FAMISTUDIO_CFG_PAL_SUPPORT) {
/* .incbin "NoteTables/famistudio_note_table_pal_msb.bin" */
    }
    if (FAMISTUDIO_CFG_NTSC_SUPPORT) {
/* .incbin "NoteTables/famistudio_note_table_msb.bin" */
    }

if (FAMISTUDIO_EXP_VRC6) {
/* famistudio_exp_note_table_lsb: */
/* famistudio_saw_note_table_lsb: */
    if (FAMISTUDIO_CFG_PAL_SUPPORT) {
/* .incbin "NoteTables/famistudio_saw_note_table_pal_lsb.bin" */
    }
    if (FAMISTUDIO_CFG_NTSC_SUPPORT) {
/* .incbin "NoteTables/famistudio_saw_note_table_lsb.bin" */
    }
/* famistudio_exp_note_table_msb: */
/* famistudio_saw_note_table_msb: */
    if (FAMISTUDIO_CFG_PAL_SUPPORT) {
/* .incbin "NoteTables/famistudio_saw_note_table_pal_msb.bin" */
    }
    if (FAMISTUDIO_CFG_NTSC_SUPPORT) {
/* .incbin "NoteTables/famistudio_saw_note_table_msb.bin" */
    }
}

if (FAMISTUDIO_EXP_VRC7) {
/* famistudio_exp_note_table_lsb: */
/* famistudio_vrc7_note_table_lsb: */
/* .incbin "NoteTables/famistudio_vrc7_note_table_lsb.bin" */
/* famistudio_exp_note_table_msb: */
/* famistudio_vrc7_note_table_msb: */
/* .incbin "NoteTables/famistudio_vrc7_note_table_msb.bin" */
}

if (FAMISTUDIO_EXP_EPSM) {
    if (FAMISTUDIO_EXP_EPSM_FM_CHN_CNT > 0) {
/* famistudio_epsm_note_table_lsb: */
/* .incbin "NoteTables/famistudio_epsm_note_table_lsb.bin" */
/* famistudio_epsm_note_table_msb: */
/* .incbin "NoteTables/famistudio_epsm_note_table_msb.bin" */
    }
/* famistudio_exp_note_table_lsb: */
/* famistudio_epsm_s_note_table_lsb: */
/* .incbin "NoteTables/famistudio_epsm_s_note_table_lsb.bin" */
/* famistudio_exp_note_table_msb: */
/* famistudio_epsm_s_note_table_msb: */
/* .incbin "NoteTables/famistudio_epsm_s_note_table_msb.bin" */
}

if (FAMISTUDIO_EXP_FDS) {
/* famistudio_exp_note_table_lsb: */
/* famistudio_fds_note_table_lsb: */
    if (FAMISTUDIO_CFG_PAL_SUPPORT) {
/* .incbin "NoteTables/famistudio_fds_note_table_pal_lsb.bin" */
    }
    if (FAMISTUDIO_CFG_NTSC_SUPPORT) {
/* .incbin "NoteTables/famistudio_fds_note_table_lsb.bin" */
    }
/* famistudio_exp_note_table_msb: */
/* famistudio_fds_note_table_msb: */
    if (FAMISTUDIO_CFG_PAL_SUPPORT) {
/* .incbin "NoteTables/famistudio_fds_note_table_pal_msb.bin" */
    }
    if (FAMISTUDIO_CFG_NTSC_SUPPORT) {
/* .incbin "NoteTables/famistudio_fds_note_table_msb.bin" */
    }
}

if (FAMISTUDIO_EXP_N163) {
/* famistudio_exp_note_table_lsb: */
/* famistudio_n163_note_table_lsb: */
    if (FAMISTUDIO_CFG_PAL_SUPPORT) {
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 1) {
/* .incbin "NoteTables/famistudio_n163_note_table_pal_1ch_lsb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 2) {
/* .incbin "NoteTables/famistudio_n163_note_table_pal_2ch_lsb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 3) {
/* .incbin "NoteTables/famistudio_n163_note_table_pal_3ch_lsb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 4) {
/* .incbin "NoteTables/famistudio_n163_note_table_pal_4ch_lsb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 5) {
/* .incbin "NoteTables/famistudio_n163_note_table_pal_5ch_lsb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 6) {
/* .incbin "NoteTables/famistudio_n163_note_table_pal_6ch_lsb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 7) {
/* .incbin "NoteTables/famistudio_n163_note_table_pal_7ch_lsb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 8) {
/* .incbin "NoteTables/famistudio_n163_note_table_pal_8ch_lsb.bin" */
        }
    }
    if (FAMISTUDIO_CFG_NTSC_SUPPORT) {
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 1) {
/* .incbin "NoteTables/famistudio_n163_note_table_1ch_lsb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 2) {
/* .incbin "NoteTables/famistudio_n163_note_table_2ch_lsb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 3) {
/* .incbin "NoteTables/famistudio_n163_note_table_3ch_lsb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 4) {
/* .incbin "NoteTables/famistudio_n163_note_table_4ch_lsb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 5) {
/* .incbin "NoteTables/famistudio_n163_note_table_5ch_lsb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 6) {
/* .incbin "NoteTables/famistudio_n163_note_table_6ch_lsb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 7) {
/* .incbin "NoteTables/famistudio_n163_note_table_7ch_lsb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 8) {
/* .incbin "NoteTables/famistudio_n163_note_table_8ch_lsb.bin" */
        }
    }
/* famistudio_exp_note_table_msb: */
/* famistudio_n163_note_table_msb: */
    if (FAMISTUDIO_CFG_PAL_SUPPORT) {
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 1) {
/* .incbin "NoteTables/famistudio_n163_note_table_pal_1ch_msb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 2) {
/* .incbin "NoteTables/famistudio_n163_note_table_pal_2ch_msb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 3) {
/* .incbin "NoteTables/famistudio_n163_note_table_pal_3ch_msb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 4) {
/* .incbin "NoteTables/famistudio_n163_note_table_pal_4ch_msb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 5) {
/* .incbin "NoteTables/famistudio_n163_note_table_pal_5ch_msb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 6) {
/* .incbin "NoteTables/famistudio_n163_note_table_pal_6ch_msb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 7) {
/* .incbin "NoteTables/famistudio_n163_note_table_pal_7ch_msb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 8) {
/* .incbin "NoteTables/famistudio_n163_note_table_pal_8ch_msb.bin" */
        }
    }
    if (FAMISTUDIO_CFG_NTSC_SUPPORT) {
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 1) {
/* .incbin "NoteTables/famistudio_n163_note_table_1ch_msb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 2) {
/* .incbin "NoteTables/famistudio_n163_note_table_2ch_msb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 3) {
/* .incbin "NoteTables/famistudio_n163_note_table_3ch_msb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 4) {
/* .incbin "NoteTables/famistudio_n163_note_table_4ch_msb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 5) {
/* .incbin "NoteTables/famistudio_n163_note_table_5ch_msb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 6) {
/* .incbin "NoteTables/famistudio_n163_note_table_6ch_msb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 7) {
/* .incbin "NoteTables/famistudio_n163_note_table_7ch_msb.bin" */
        }
        if (FAMISTUDIO_EXP_N163_CHN_CNT = 8) {
/* .incbin "NoteTables/famistudio_n163_note_table_8ch_msb.bin" */
        }
    }
}

// For a given channel, returns the index of the volume envelope.
/* famistudio_channel_env: */
/* famistudio_channel_to_volume_env: */
/* .byte FAMISTUDIO_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte FAMISTUDIO_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte FAMISTUDIO_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte FAMISTUDIO_CH3_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte $ff */
if (FAMISTUDIO_EXP_VRC6) {
/* .byte FAMISTUDIO_VRC6_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte FAMISTUDIO_VRC6_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte FAMISTUDIO_VRC6_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
}
if (FAMISTUDIO_EXP_VRC7) {
/* .byte FAMISTUDIO_VRC7_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte FAMISTUDIO_VRC7_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte FAMISTUDIO_VRC7_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte FAMISTUDIO_VRC7_CH3_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte FAMISTUDIO_VRC7_CH4_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte FAMISTUDIO_VRC7_CH5_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
}
if (FAMISTUDIO_EXP_FDS) {
/* .byte FAMISTUDIO_FDS_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
}
if (FAMISTUDIO_EXP_MMC5) {
/* .byte FAMISTUDIO_MMC5_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte FAMISTUDIO_MMC5_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
}
if (FAMISTUDIO_EXP_N163) {
/* .byte FAMISTUDIO_N163_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte FAMISTUDIO_N163_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte FAMISTUDIO_N163_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte FAMISTUDIO_N163_CH3_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte FAMISTUDIO_N163_CH4_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte FAMISTUDIO_N163_CH5_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte FAMISTUDIO_N163_CH6_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte FAMISTUDIO_N163_CH7_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
}
if (FAMISTUDIO_EXP_S5B) {
/* .byte FAMISTUDIO_S5B_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte FAMISTUDIO_S5B_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
/* .byte FAMISTUDIO_S5B_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
}
if (FAMISTUDIO_EXP_EPSM) {
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 0) {
/* .byte FAMISTUDIO_EPSM_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 1) {
/* .byte FAMISTUDIO_EPSM_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 2) {
/* .byte FAMISTUDIO_EPSM_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 3) {
/* .byte FAMISTUDIO_EPSM_CH3_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 4) {
/* .byte FAMISTUDIO_EPSM_CH4_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 5) {
/* .byte FAMISTUDIO_EPSM_CH5_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 6) {
/* .byte FAMISTUDIO_EPSM_CH6_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 7) {
/* .byte FAMISTUDIO_EPSM_CH7_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 8) {
/* .byte FAMISTUDIO_EPSM_CH8_ENVS+FAMISTUDIO_ENV_VOLUME_OFF */
}
}

if (FAMISTUDIO_USE_ARPEGGIO) {
// For a given channel, returns the index of the arpeggio envelope.
/* famistudio_channel_to_arpeggio_env: */
/* .byte FAMISTUDIO_CH0_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte FAMISTUDIO_CH1_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte FAMISTUDIO_CH2_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte FAMISTUDIO_CH3_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte $ff */
if (FAMISTUDIO_EXP_VRC6) {
/* .byte FAMISTUDIO_VRC6_CH0_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte FAMISTUDIO_VRC6_CH1_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte FAMISTUDIO_VRC6_CH2_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
}
if (FAMISTUDIO_EXP_VRC7) {
/* .byte FAMISTUDIO_VRC7_CH0_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte FAMISTUDIO_VRC7_CH1_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte FAMISTUDIO_VRC7_CH2_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte FAMISTUDIO_VRC7_CH3_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte FAMISTUDIO_VRC7_CH4_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte FAMISTUDIO_VRC7_CH5_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
}
if (FAMISTUDIO_EXP_FDS) {
/* .byte FAMISTUDIO_FDS_CH0_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
}
if (FAMISTUDIO_EXP_MMC5) {
/* .byte FAMISTUDIO_MMC5_CH0_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte FAMISTUDIO_MMC5_CH1_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
}
if (FAMISTUDIO_EXP_N163) {
/* .byte FAMISTUDIO_N163_CH0_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte FAMISTUDIO_N163_CH1_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte FAMISTUDIO_N163_CH2_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte FAMISTUDIO_N163_CH3_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte FAMISTUDIO_N163_CH4_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte FAMISTUDIO_N163_CH5_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte FAMISTUDIO_N163_CH6_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte FAMISTUDIO_N163_CH7_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
}
if (FAMISTUDIO_EXP_S5B) {
/* .byte FAMISTUDIO_S5B_CH0_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte FAMISTUDIO_S5B_CH1_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
/* .byte FAMISTUDIO_S5B_CH2_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
}
if (FAMISTUDIO_EXP_EPSM) {
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 0) {
/* .byte FAMISTUDIO_EPSM_CH0_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 1) {
/* .byte FAMISTUDIO_EPSM_CH1_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 2) {
/* .byte FAMISTUDIO_EPSM_CH2_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 3) {
/* .byte FAMISTUDIO_EPSM_CH3_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 4) {
/* .byte FAMISTUDIO_EPSM_CH4_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 5) {
/* .byte FAMISTUDIO_EPSM_CH5_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 6) {
/* .byte FAMISTUDIO_EPSM_CH6_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 7) {
/* .byte FAMISTUDIO_EPSM_CH7_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 8) {
/* .byte FAMISTUDIO_EPSM_CH8_ENVS+FAMISTUDIO_ENV_NOTE_OFF */
} // FAMISTUDIO_EXP_EPSM_ENV_CNT > 8
} // FAMISTUDIO_EXP_EPSM
} // FAMISTUDIO_USE_ARPEGGIO

if (FAMISTUDIO_USE_SLIDE_NOTES) {
/* famistudio_channel_to_slide: */
// This table will only be defined if we use noise slides, otherwise identical to "famistudio_channel_to_pitch_env".
if (FAMISTUDIO_USE_NOISE_SLIDE_NOTES) {
/* .byte $00 */
/* .byte $01 */
/* .byte $02 */
/* .byte FAMISTUDIO_NOISE_SLIDE_INDEX ; Keep the noise slide at the end so the pitch envelopes/slides are in sync. */
/* .byte $ff ; no slide for DPCM */
if (FAMISTUDIO_EXP_VRC6) {
/* .byte FAMISTUDIO_VRC6_CH0_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_VRC6_CH1_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_VRC6_CH2_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_VRC7) {
/* .byte FAMISTUDIO_VRC7_CH0_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_VRC7_CH1_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_VRC7_CH2_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_VRC7_CH3_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_VRC7_CH4_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_VRC7_CH5_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_FDS) {
/* .byte FAMISTUDIO_FDS_CH0_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_MMC5) {
/* .byte FAMISTUDIO_MMC5_CH0_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_MMC5_CH1_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_N163) {
/* .byte FAMISTUDIO_N163_CH0_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_N163_CH1_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_N163_CH2_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_N163_CH3_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_N163_CH4_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_N163_CH5_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_N163_CH6_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_N163_CH7_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_S5B) {
/* .byte FAMISTUDIO_S5B_CH0_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_S5B_CH1_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_S5B_CH2_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_EPSM) {
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 0) {
/* .byte FAMISTUDIO_EPSM_CH0_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 1) {
/* .byte FAMISTUDIO_EPSM_CH1_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 2) {
/* .byte FAMISTUDIO_EPSM_CH2_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 3) {
/* .byte FAMISTUDIO_EPSM_CH3_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 4) {
/* .byte FAMISTUDIO_EPSM_CH4_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 5) {
/* .byte FAMISTUDIO_EPSM_CH5_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 6) {
/* .byte FAMISTUDIO_EPSM_CH6_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 7) {
/* .byte FAMISTUDIO_EPSM_CH7_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 8) {
/* .byte FAMISTUDIO_EPSM_CH8_PITCH_ENV_IDX */
} // FAMISTUDIO_EXP_EPSM_ENV_CNT > 8
} // FAMISTUDIO_EXP_EPSM
} // FAMISTUDIO_USE_NOISE_SLIDE_NOTES

} // FAMISTUDIO_USE_SLIDE_NOTES

// For a given channel, returns the index of the pitch envelope.
/* famistudio_channel_to_pitch_env: */
/* .byte $00 */
/* .byte $01 */
/* .byte $02 */
/* .byte $ff ; no pitch envelopes for noise */
/* .byte $ff ; no pitch envelopes slide for DPCM */
if (FAMISTUDIO_EXP_VRC6) {
/* .byte FAMISTUDIO_VRC6_CH0_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_VRC6_CH1_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_VRC6_CH2_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_VRC7) {
/* .byte FAMISTUDIO_VRC7_CH0_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_VRC7_CH1_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_VRC7_CH2_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_VRC7_CH3_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_VRC7_CH4_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_VRC7_CH5_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_FDS) {
/* .byte FAMISTUDIO_FDS_CH0_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_MMC5) {
/* .byte FAMISTUDIO_MMC5_CH0_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_MMC5_CH1_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_N163) {
/* .byte FAMISTUDIO_N163_CH0_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_N163_CH1_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_N163_CH2_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_N163_CH3_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_N163_CH4_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_N163_CH5_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_N163_CH6_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_N163_CH7_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_S5B) {
/* .byte FAMISTUDIO_S5B_CH0_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_S5B_CH1_PITCH_ENV_IDX */
/* .byte FAMISTUDIO_S5B_CH2_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_EPSM) {
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 0) {
/* .byte FAMISTUDIO_EPSM_CH0_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 1) {
/* .byte FAMISTUDIO_EPSM_CH1_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 2) {
/* .byte FAMISTUDIO_EPSM_CH2_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 3) {
/* .byte FAMISTUDIO_EPSM_CH3_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 4) {
/* .byte FAMISTUDIO_EPSM_CH4_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 5) {
/* .byte FAMISTUDIO_EPSM_CH5_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 6) {
/* .byte FAMISTUDIO_EPSM_CH6_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 7) {
/* .byte FAMISTUDIO_EPSM_CH7_PITCH_ENV_IDX */
}
if (FAMISTUDIO_EXP_EPSM_ENV_CNT > 8) {
/* .byte FAMISTUDIO_EPSM_CH8_PITCH_ENV_IDX */
} // FAMISTUDIO_EXP_EPSM_ENV_CNT > 8
} // FAMISTUDIO_EXP_EPSM

if (FAMISTUDIO_USE_DUTYCYCLE_EFFECT) {
// For a given channel, returns the index of the duty cycle in the "famistudio_duty_cycle" array.
/* famistudio_channel_to_dutycycle: */
/* .byte $00 */
/* .byte $01 */
/* .byte $ff */
/* .byte $02 */
/* .byte $ff */
if (FAMISTUDIO_EXP_VRC6) {
/* .byte FAMISTUDIO_VRC6_CH0_DUTY_IDX */
/* .byte FAMISTUDIO_VRC6_CH1_DUTY_IDX */
/* .byte FAMISTUDIO_VRC6_CH2_DUTY_IDX */
}
if (FAMISTUDIO_EXP_MMC5) {
/* .byte FAMISTUDIO_MMC5_CH0_DUTY_IDX */
/* .byte FAMISTUDIO_MMC5_CH1_DUTY_IDX */
}

// For a given channel, returns the index of the duty cycle envelope.
/* famistudio_channel_to_duty_env: */
/* .byte FAMISTUDIO_CH0_ENVS+FAMISTUDIO_ENV_DUTY_OFF */
/* .byte FAMISTUDIO_CH1_ENVS+FAMISTUDIO_ENV_DUTY_OFF */
/* .byte $ff */
/* .byte FAMISTUDIO_CH3_ENVS+FAMISTUDIO_ENV_DUTY_OFF */
/* .byte $ff */
if (FAMISTUDIO_EXP_VRC6) {
/* .byte FAMISTUDIO_VRC6_CH0_ENVS+FAMISTUDIO_ENV_DUTY_OFF */
/* .byte FAMISTUDIO_VRC6_CH1_ENVS+FAMISTUDIO_ENV_DUTY_OFF */
/* .byte FAMISTUDIO_VRC6_CH2_ENVS+FAMISTUDIO_ENV_DUTY_OFF */
}
if (FAMISTUDIO_EXP_MMC5) {
/* .byte FAMISTUDIO_MMC5_CH0_ENVS+FAMISTUDIO_ENV_DUTY_OFF */
/* .byte FAMISTUDIO_MMC5_CH1_ENVS+FAMISTUDIO_ENV_DUTY_OFF */
}
}

// Duty lookup table.
/* famistudio_duty_lookup: */
/* .byte $30 */
/* .byte $70 */
/* .byte $b0 */
/* .byte $f0 */

if (FAMISTUDIO_EXP_VRC6) {
// Duty lookup table for VRC6.
/* famistudio_vrc6_duty_lookup: */
/* .byte $00 */
/* .byte $10 */
/* .byte $20 */
/* .byte $30 */
/* .byte $40 */
/* .byte $50 */
/* .byte $60 */
/* .byte $70 */
}

if (FAMISTUDIO_USE_PHASE_RESET) {
// For a given channel, returns the bit mask to set in the phase reset byte
/* famistudio_channel_to_phase_reset_mask: */
/* .byte $01 */
/* .byte $02 */
if (!FAMISTUDIO_EXP_NONE) {
/* .byte $ff */
/* .byte $ff */
/* .byte $ff */
if (FAMISTUDIO_EXP_VRC6) {
/* .byte $04 */
/* .byte $08 */
/* .byte $10 */
}
if (FAMISTUDIO_EXP_FDS) {
/* .byte $80 */
}
if (FAMISTUDIO_EXP_MMC5) {
/* .byte $20 */
/* .byte $40 */
}
if (FAMISTUDIO_EXP_N163) {
/* .byte $01 */
/* .byte $02 */
/* .byte $04 */
/* .byte $08 */
/* .byte $10 */
/* .byte $20 */
/* .byte $40 */
/* .byte $80 */
}
}
}

if (!FAMISTUDIO_USE_FAMITRACKER_TEMPO) {
/* famistudio_tempo_frame_lookup: */
/* .byte $01, $02 ; NTSC -> NTSC, NTSC -> PAL */
/* .byte $00, $01 ; PAL  -> NTSC, PAL  -> PAL */
}

if (FAMISTUDIO_CFG_SMOOTH_VIBRATO) {
// lookup table for the 2 registers we need to set for smooth vibrato.
// Index 0 decrement the hi-period, index 2 increments. Index 1 is unused.
/* famistudio_smooth_vibrato_period_lo_lookup: */
/* .byte $00, $00, $ff */
/* famistudio_smooth_vibrato_sweep_lookup: */
/* .byte $8f, $00, $87 */
}

if (FAMISTUDIO_USE_VOLUME_TRACK) {

// Precomputed volume multiplication table (rounded but never to zero unless one of the value is zero).
// Load the 2 volumes in the lo/hi nibble and fetch.

/* famistudio_volume_table: */
/* .byte $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00 */
/* .byte $00, $01, $01, $01, $01, $01, $01, $01, $01, $01, $01, $01, $01, $01, $01, $01 */
/* .byte $00, $01, $01, $01, $01, $01, $01, $01, $01, $01, $01, $01, $02, $02, $02, $02 */
/* .byte $00, $01, $01, $01, $01, $01, $01, $01, $02, $02, $02, $02, $02, $03, $03, $03 */
/* .byte $00, $01, $01, $01, $01, $01, $02, $02, $02, $02, $03, $03, $03, $03, $04, $04 */
/* .byte $00, $01, $01, $01, $01, $02, $02, $02, $03, $03, $03, $04, $04, $04, $05, $05 */
/* .byte $00, $01, $01, $01, $02, $02, $02, $03, $03, $04, $04, $04, $05, $05, $06, $06 */
/* .byte $00, $01, $01, $01, $02, $02, $03, $03, $04, $04, $05, $05, $06, $06, $07, $07 */
/* .byte $00, $01, $01, $02, $02, $03, $03, $04, $04, $05, $05, $06, $06, $07, $07, $08 */
/* .byte $00, $01, $01, $02, $02, $03, $04, $04, $05, $05, $06, $07, $07, $08, $08, $09 */
/* .byte $00, $01, $01, $02, $03, $03, $04, $05, $05, $06, $07, $07, $08, $09, $09, $0a */
/* .byte $00, $01, $01, $02, $03, $04, $04, $05, $06, $07, $07, $08, $09, $0a, $0a, $0b */
/* .byte $00, $01, $02, $02, $03, $04, $05, $06, $06, $07, $08, $09, $0a, $0a, $0b, $0c */
/* .byte $00, $01, $02, $03, $03, $04, $05, $06, $07, $08, $09, $0a, $0a, $0b, $0c, $0d */
/* .byte $00, $01, $02, $03, $04, $05, $06, $07, $07, $08, $09, $0a, $0b, $0c, $0d, $0e */
/* .byte $00, $01, $02, $03, $04, $05, $06, $07, $08, $09, $0a, $0b, $0c, $0d, $0e, $0f */

}


if (FAMISTUDIO_EXP_EPSM) {
// Mapping for the channel id of the rhythm channel, to the RAM offset for it
// If the user disables various channels, then we want to save on the ram for them
// by just not reserving it, so this maps from channel ID to the new RAM offset for the channel
// The end result should be a table that looks like this if you have channel 2, 3, and 5 enabled
// .byte $ff, $00, $01, $ff, $02, $ff
/* EPSM_CHANNEL1_RHYTHM_OFFSET = -1 + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN1_ENABLE */
/* EPSM_CHANNEL2_RHYTHM_OFFSET = EPSM_CHANNEL1_RHYTHM_OFFSET + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN2_ENABLE */
/* EPSM_CHANNEL3_RHYTHM_OFFSET = EPSM_CHANNEL2_RHYTHM_OFFSET + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN3_ENABLE */
/* EPSM_CHANNEL4_RHYTHM_OFFSET = EPSM_CHANNEL3_RHYTHM_OFFSET + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN4_ENABLE */
/* EPSM_CHANNEL5_RHYTHM_OFFSET = EPSM_CHANNEL4_RHYTHM_OFFSET + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN5_ENABLE */
/* EPSM_CHANNEL6_RHYTHM_OFFSET = EPSM_CHANNEL5_RHYTHM_OFFSET + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN6_ENABLE */

/* famistudio_rhythm_lut: */
if (FAMISTUDIO_EXP_EPSM_RHYTHM_CHN1_ENABLE) {
/* .byte .lobyte(EPSM_CHANNEL1_RHYTHM_OFFSET) */
} else {
/* .byte $ff */
}
if (FAMISTUDIO_EXP_EPSM_RHYTHM_CHN2_ENABLE) {
/* .byte .lobyte(EPSM_CHANNEL2_RHYTHM_OFFSET) */
} else {
/* .byte $ff */
}
if (FAMISTUDIO_EXP_EPSM_RHYTHM_CHN3_ENABLE) {
/* .byte .lobyte(EPSM_CHANNEL3_RHYTHM_OFFSET) */
} else {
/* .byte $ff */
}
if (FAMISTUDIO_EXP_EPSM_RHYTHM_CHN4_ENABLE) {
/* .byte .lobyte(EPSM_CHANNEL4_RHYTHM_OFFSET) */
} else {
/* .byte $ff */
}
if (FAMISTUDIO_EXP_EPSM_RHYTHM_CHN5_ENABLE) {
/* .byte .lobyte(EPSM_CHANNEL5_RHYTHM_OFFSET) */
} else {
/* .byte $ff */
}
if (FAMISTUDIO_EXP_EPSM_RHYTHM_CHN6_ENABLE) {
/* .byte .lobyte(EPSM_CHANNEL6_RHYTHM_OFFSET) */
} else {
/* .byte $ff */
}
}
// ======================================================================================================================
// Alternative entry points for calling from c code
//
// Notes: the C function definitions use __fastcall__ meaning they will put the
// last parameter in a register before the call according to the rules laid out
// in the documentation here: https://cc65.github.io/doc/cc65-intern.html
// and here: https://github.com/cc65/wiki/wiki/Parameter-passing-and-calling-conventions
// and here: https://github.com/cc65/wiki/wiki/Parameter-and-return-stacks
// ======================================================================================================================
if (FAMISTUDIO_CFG_C_BINDINGS) {

// Required to fetch the extra parameter from the C stack
/* .import popa */

/* .export _famistudio_init */
/* _famistudio_init: */
    // A = ptr[lo]; X = ptr[hi]; SP[0] = platform
/* @tmp = famistudio_r0 */
    *((@tmp) as *u8) = x;
    x = a;
    // Note that the C stack 'popa' function uses Y as scratch
    popa();
    y = *((@tmp) as *u8);
    goto (*((famistudio_init) as *u8));


// A = song_index; So we can safely re-export the symbol
/* .export _famistudio_music_play=famistudio_music_play */
// A = mode; safe to re-export the symbol as well
/* .export _famistudio_music_pause=famistudio_music_pause */

// No parameters so its safe to re-export
/* .export _famistudio_music_stop=famistudio_music_stop */
/* .export _famistudio_update=famistudio_update */

if (FAMISTUDIO_CFG_SFX_SUPPORT) {

/* .export _famistudio_sfx_init */
/* .export _famistudio_sfx_play */
/* .export _famistudio_sfx_sample_play */

/* _famistudio_sfx_init: */
    // A = ptr[lo]; X = ptr[hi]
/* @tmp = famistudio_r0 */
    *((@tmp) as *u8) = x;
    y = *((@tmp) as *u8);
    x = a;
    goto (*((famistudio_sfx_init) as *u8));

/* _famistudio_sfx_play: */
    // A = offset; SP[0] = index
    x = a;
    popa();
    goto (*((famistudio_sfx_play) as *u8));

// A = sample_index; So we can safely re-export the symbol
/* .export _famistudio_sfx_sample_play=famistudio_sfx_sample_play */

}
}

