{# ======================================================================================================================   #}
{#  FAMISTUDIO SOUND ENGINE (4.2.0)                                                                                         #}
{#  Copyright (c) 2019-2023 Mathieu Gauthier                                                                                #}
{#                                                                                                                          #}
{#  Copying and distribution of this file, with or without                                                                  #}
{#  modification, are permitted in any medium without royalty provided                                                      #}
{#  the copyright notice and this notice are preserved in all source                                                        #}
{#  code copies. This file is offered as-is, without any warranty.                                                          #}
{# ======================================================================================================================   #}

{# ======================================================================================================================   #}
{#  This is the FamiStudio sound engine. It is used by the NSF and ROM exporter of FamiStudio and can be used to make       #}
{#  games. It supports every feature from FamiStudio, some of them are toggeable to save CPU/memory.                        #}
{#                                                                                                                          #}
{#  This is essentially a heavily modified version of FamiTone2 by Shiru. A lot of his code and comments are still          #}
{#  present here, so massive thanks to him!! I am not trying to steal his work or anything, i renamed a lot of functions    #}
{#  and variables because at some point it was becoming a mess of coding standards and getting hard to maintain.            #}
{#                                                                                                                          #}
{#  Moderately advanced users can probably figure out how to use the sound engine simply by reading these comments.         #}
{#  For more in-depth documentation, please go to:                                                                          #}
{#                                                                                                                          #}
{#     https://famistudio.org/doc/soundengine/                                                                              #}
{# ======================================================================================================================   #}

{# ======================================================================================================================   #}
{#  INTERFACE                                                                                                               #}
{#                                                                                                                          #}
{#  The interface is pretty much the same as FamiTone2, with a slightly different naming convention. The subroutines you    #}
{#  can call from your game are:                                                                                            #}
{#                                                                                                                          #}
{#    - famistudio_init            : Initialize the engine with some music data.                                            #}
{#    - famistudio_music_play      : Start music playback with a specific song.                                             #}
{#    - famistudio_music_pause     : Pause/unpause music playback.                                                          #}
{#    - famistudio_music_stop      : Stops music playback.                                                                  #}
{#    - famistudio_sfx_init        : Initialize SFX engine with SFX data.                                                   #}
{#    - famistudio_sfx_play        : Play a SFX.                                                                            #}
{#    - famistudio_sfx_sample_play : Play a DPCM SFX.                                                                       #}
{#    - famistudio_update          : Updates the music/SFX engine, call once per frame, ideally from NMI.                   #}
{#                                                                                                                          #}
{#  You can check the demo ROM to see how they are used or check out the online documentation for more info.                #}
{# ======================================================================================================================   #}

{# ======================================================================================================================   #}
{#  CONFIGURATION                                                                                                           #}
{#                                                                                                                          #}
{#  There are 2 main ways of configuring the engine.                                                                        #}
{#                                                                                                                          #}
{#    1) The simplest way is right here, in the section below. Simply comment/uncomment these defines, and move on          #}
{#       with your life.                                                                                                    #}
{#                                                                                                                          #}
{#    2) The second way is "externally", using definitions coming from elsewhere in your app or the command line. If you    #}
{#       wish do so, simply define FAMISTUDIO_CFG_EXTERNAL=1 and this whole section will be ignored. You are then           #}
{#       responsible for providing all configuration. This is useful if you have multiple projects that needs               #}
{#       different configurations, while pointing to the same code file. This is how the provided demos and FamiStudio      #}
{#       uses it.                                                                                                           #}
{#                                                                                                                          #}
{#  Note that unless specified, the engine uses "if" and not "ifdef" for all boolean values so you need to define these     #}
{#  to non-zero values. Undefined values will be assumed to be zero.                                                        #}
{#                                                                                                                          #}
{#  There are 4 main things to configure, each of them will be detailed below.                                              #}
{#                                                                                                                          #}
{#    1) Segments (ZP/RAM/PRG)                                                                                              #}
{#    2) Audio expansion                                                                                                    #}
{#    3) Global engine parameters                                                                                           #}
{#    4) Supported features                                                                                                 #}
{# ======================================================================================================================   #}

{% if ndef FAMISTUDIO_CFG_EXTERNAL                                                                                             %}
{# !!! AMISTUDIO_CFG_EXTERNAL = 0                                                                                               !!! #}
{% endif 120 %}

{#  Set this to configure the sound engine from outside (in your app, or from the command line)                             #}
{% if !FAMISTUDIO_CFG_EXTERNAL                                                                                                 %}

{# ======================================================================================================================   #}
{#  1) SEGMENT CONFIGURATION                                                                                                #}
{#                                                                                                                          #}
{#  You need to tell where you want to allocate the zeropage, RAM and code. This section will be slightly different for     #}
{#  each assembler.                                                                                                         #}
{#                                                                                                                          #}
{#  For ASM6, you need to specify the .enum location for zeroage and RAM/BSS as well as the .org for the engine code.       #}
{# ======================================================================================================================   #}

{# !!! AMISTUDIO_ASM6_ZP_ENUM   = $0000                                                                                         !!! #}
{# !!! AMISTUDIO_ASM6_BSS_ENUM  = $0200                                                                                         !!! #}
{# !!! AMISTUDIO_ASM6_CODE_BASE = $8000                                                                                         !!! #}

{# ======================================================================================================================   #}
{#  2) AUDIO EXPANSION CONFIGURATION                                                                                        #}
{#                                                                                                                          #}
{#  You can enable up to one audio expansion (FAMISTUDIO_EXP_XXX). Enabling more than one expansion will lead to            #}
{#  undefined behavior. Memory usage goes up as more complex expansions are used. The audio expansion you choose            #}
{#  **MUST MATCH** with the data you will load in the engine. Loading a FDS song while enabling VRC6 will lead to           #}
{#  undefined behavior.                                                                                                     #}
{# ======================================================================================================================   #}

{#  Konami VRC6 (2 extra square + saw)                                                                                      #}
{#  FAMISTUDIO_EXP_VRC6          = 1                                                                                        #}

{#  Rainbow-Net (homebrew clone of VRC6)                                                                                    #}
{#  FAMISTUDIO_EXP_RAINBOW       = 1                                                                                        #}

{#  Konami VRC7 (6 FM channels)                                                                                             #}
{#  FAMISTUDIO_EXP_VRC7          = 1                                                                                        #}

{#  Nintendo MMC5 (2 extra squares, extra DPCM not supported)                                                               #}
{#  FAMISTUDIO_EXP_MMC5          = 1                                                                                        #}

{#  Sunsoft S5B (2 extra squares, advanced features not supported.)                                                         #}
{#  FAMISTUDIO_EXP_S5B           = 1                                                                                        #}

{#  Famicom Disk System (extra wavetable channel)                                                                           #}
{#  FAMISTUDIO_EXP_FDS           = 1                                                                                        #}

{#  Namco 163 (between 1 and 8 extra wavetable channels) + number of channels.                                              #}
{#  FAMISTUDIO_EXP_N163          = 1                                                                                        #}
{#  FAMISTUDIO_EXP_N163_CHN_CNT  = 4                                                                                        #}

{#  EPSM (Expansion Port Sound Module)                                                                                      #}
{#  FAMISTUDIO_EXP_EPSM          = 1                                                                                        #}
{#  Fine-tune control for enabling specific channels                                                                        #}
{#  Default values for the channels are to enable all channels.                                                             #}
{#  FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT     = 3                                                                                 #}
{#  FAMISTUDIO_EXP_EPSM_FM_CHN_CNT      = 6                                                                                 #}
{#  FAMISTUDIO_EXP_EPSM_RHYTHM_CHN1_ENABLE = 1                                                                              #}
{#  FAMISTUDIO_EXP_EPSM_RHYTHM_CHN2_ENABLE = 1                                                                              #}
{#  FAMISTUDIO_EXP_EPSM_RHYTHM_CHN3_ENABLE = 1                                                                              #}
{#  FAMISTUDIO_EXP_EPSM_RHYTHM_CHN4_ENABLE = 1                                                                              #}
{#  FAMISTUDIO_EXP_EPSM_RHYTHM_CHN5_ENABLE = 1                                                                              #}
{#  FAMISTUDIO_EXP_EPSM_RHYTHM_CHN6_ENABLE = 1                                                                              #}

{# ======================================================================================================================   #}
{#  3) GLOBAL ENGINE CONFIGURATION                                                                                          #}
{#                                                                                                                          #}
{#  These are parameters that configures the engine, but are independent of the data you will be importing, such as         #}
{#  which platform (PAL/NTSC) you want to support playback for, whether SFX are enabled or not, etc. They all have the      #}
{#  form FAMISTUDIO_CFG_XXX.                                                                                                #}
{# ======================================================================================================================   #}

{#  One of these MUST be defined (PAL or NTSC playback). Note that only NTSC support is supported when using any of the audio expansions. #}
{#  FAMISTUDIO_CFG_PAL_SUPPORT   = 1                                                                                        #}
{# !!! AMISTUDIO_CFG_NTSC_SUPPORT  = 1                                                                                          !!! #}

{#  Support for sound effects playback + number of SFX that can play at once.                                               #}
{#  FAMISTUDIO_CFG_SFX_SUPPORT   = 1                                                                                        #}
{#  FAMISTUDIO_CFG_SFX_STREAMS   = 2                                                                                        #}

{#  Blaarg's smooth vibrato technique. Eliminates phase resets ("pops") on square channels.                                 #}
{#  FAMISTUDIO_CFG_SMOOTH_VIBRATO = 1                                                                                       #}

{#  Enables DPCM playback support.                                                                                          #}
{# !!! AMISTUDIO_CFG_DPCM_SUPPORT   = 1                                                                                         !!! #}

{#  Must be enabled if you are calling sound effects from a different thread than the sound engine update.                  #}
{#  FAMISTUDIO_CFG_THREAD         = 1                                                                                       #}

{#  Enable to use the CC65 compatible entrypoints via the provided header file                                              #}
{#  FAMISTUDIO_CFG_C_BINDINGS   = 1                                                                                         #}

{# ======================================================================================================================   #}
{#  4) SUPPORTED FEATURES CONFIGURATION                                                                                     #}
{#                                                                                                                          #}
{#  Every feature supported in FamiStudio is supported by this sound engine. If you know for sure that you are not using    #}
{#  specific features in your music, you can disable them to save memory/processing time. Using a feature in your song      #}
{#  and failing to enable it will likely lead to crashes (BRK), or undefined behavior. They all have the form               #}
{#  FAMISTUDIO_USE_XXX.                                                                                                     #}
{# ======================================================================================================================   #}

{#  Must be enabled if the songs you will be importing have been created using FamiTracker tempo mode. If you are using     #}
{#  FamiStudio tempo mode, this must be undefined. You cannot mix and match tempo modes, the engine can only run in one     #}
{#  mode or the other.                                                                                                      #}
{#  More information at: https://famistudio.org/doc/song/#tempo-modes                                                       #}
{#  FAMISTUDIO_USE_FAMITRACKER_TEMPO = 1                                                                                    #}

{#  Must be enabled if the songs uses delayed notes or delayed cuts. This is obviously only available when using            #}
{#  FamiTracker tempo mode as FamiStudio tempo mode does not need this.                                                     #}
{#  FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS = 1                                                                    #}

{#  Must be enabled if the songs uses release notes.                                                                        #}
{#  More information at: https://famistudio.org/doc/pianoroll/#release-point                                                #}
{# !!! AMISTUDIO_USE_RELEASE_NOTES = 1                                                                                          !!! #}

{#  Must be enabled if any song uses the volume track. The volume track allows manipulating the volume at the track level   #}
{#  independently from instruments.                                                                                         #}
{#  More information at: https://famistudio.org/doc/pianoroll/#editing-volume-tracks-effects                                #}
{# !!! AMISTUDIO_USE_VOLUME_TRACK      = 1                                                                                      !!! #}

{#  Must be enabled if any song uses slides on the volume track. Volume track must be enabled too.                          #}
{#  More information at: https://famistudio.org/doc/pianoroll/#editing-volume-tracks-effects                                #}
{#  FAMISTUDIO_USE_VOLUME_SLIDES     = 1                                                                                    #}

{#  Must be enabled if any song uses the pitch track. The pitch track allows manipulating the pitch at the track level      #}
{#  independently from instruments.                                                                                         #}
{#  More information at: https://famistudio.org/doc/pianoroll/#pitch                                                        #}
{# !!! AMISTUDIO_USE_PITCH_TRACK       = 1                                                                                      !!! #}

{#  Must be enabled if any song uses slide notes. Slide notes allows portamento and slide effects.                          #}
{#  More information at: https://famistudio.org/doc/pianoroll/#slide-notes                                                  #}
{# !!! AMISTUDIO_USE_SLIDE_NOTES       = 1                                                                                      !!! #}

{#  Must be enabled if any song uses slide notes on the noise channel too.                                                  #}
{#  More information at: https://famistudio.org/doc/pianoroll/#slide-notes                                                  #}
{#  FAMISTUDIO_USE_NOISE_SLIDE_NOTES = 1                                                                                    #}

{#  Must be enabled if any song uses the vibrato speed/depth effect track.                                                  #}
{#  More information at: https://famistudio.org/doc/pianoroll/#vibrato-depth-speed                                          #}
{# !!! AMISTUDIO_USE_VIBRATO           = 1                                                                                      !!! #}

{#  Must be enabled if any song uses arpeggios (not to be confused with instrument arpeggio envelopes, those are always     #}
{#  supported).                                                                                                             #}
{#  More information at: (TODO)                                                                                             #}
{# !!! AMISTUDIO_USE_ARPEGGIO          = 1                                                                                      !!! #}

{#  Must be enabled if any song uses the "Duty Cycle" effect (equivalent of FamiTracker Vxx, also called "Timbre").         #}
{#  FAMISTUDIO_USE_DUTYCYCLE_EFFECT  = 1                                                                                    #}

{#  Must be enabled if any song uses the DPCM delta counter. Only makes sense if DPCM samples                               #}
{#  are enabled (FAMISTUDIO_CFG_DPCM_SUPPORT).                                                                              #}
{#  More information at: (TODO)                                                                                             #}
{#  FAMISTUDIO_USE_DELTA_COUNTER     = 1                                                                                    #}

{#  Must be enabled if your project uses more than 1 bank of DPCM samples.                                                  #}
{#  When using this, you must implement the "famistudio_dpcm_bank_callback" callback                                        #}
{#  and switch to the correct bank every time a sample is played.                                                           #}
{#  FAMISTUDIO_USE_DPCM_BANKSWITCHING = 1                                                                                   #}

{#  Must be enabled if your project uses more than 63 unique DPCM mappings (a mapping is DPCM sample                        #}
{#  assigned to a note, with a specific pitch/loop, etc.). Implied when using FAMISTUDIO_USE_DPCM_BANKSWITCHING.            #}
{#  FAMISTUDIO_USE_DPCM_EXTENDED_RANGE = 1                                                                                  #}

{#  Allows having up to 256 instrument at the cost of slightly higher CPU usage when switching instrument.                  #}
{#  When this is off, the limit is 64 for regular instruments and 32 for expansion instrumnets.                             #}
{#  FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE = 1                                                                            #}

{#  Must be enabled if your project uses the "Phase Reset" effect.                                                          #}
{#  FAMISTUDIO_USE_PHASE_RESET = 1                                                                                          #}

{#  Must be enabled if your project uses the FDS expansion and at least one instrument with FDS Auto-Mod enabled.           #}
{#  FAMISTUDIO_USE_FDS_AUTOMOD  = 1                                                                                         #}

{% endif 120 %}

{#  Memory location of the DPCM samples. Must be between $c000 and $ffc0, and a multiple of 64.                             #}
{% if ndef FAMISTUDIO_DPCM_OFF                                                                                                 %}
{# !!! AMISTUDIO_DPCM_OFF = $c000                                                                                               !!! #}
{% endif 120 %}

{# ======================================================================================================================   #}
{#  END OF CONFIGURATION                                                                                                    #}
{#                                                                                                                          #}
{#  Ideally, you should not have to change anything below this line.                                                        #}
{# ======================================================================================================================   #}

{# ======================================================================================================================   #}
{#  INTERNAL DEFINES (Do not touch)                                                                                         #}
{# ======================================================================================================================   #}

{% if ndef FAMISTUDIO_EXP_RAINBOW                                                                                              %}
{# !!! AMISTUDIO_EXP_RAINBOW = 0                                                                                                !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_RAINBOW                                                                                                   %}
{# !!! AMISTUDIO_EXP_VRC6 = 1                                                                                                   !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_EXP_VRC6                                                                                                 %}
{# !!! AMISTUDIO_EXP_VRC6 = 0                                                                                                   !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_EXP_VRC7                                                                                                 %}
{# !!! AMISTUDIO_EXP_VRC7 = 0                                                                                                   !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_EXP_EPSM                                                                                                 %}
{# !!! AMISTUDIO_EXP_EPSM = 0                                                                                                   !!! #}
{# !!! AMISTUDIO_EXP_EPSM_ENV_CNT = 0                                                                                           !!! #}
{# !!! AMISTUDIO_EXP_EPSM_RHYTHM_CNT = 0                                                                                        !!! #}
{# !!! AMISTUDIO_EXP_EPSM_FM_CHN_CNT = 0                                                                                        !!! #}
{# !!! AMISTUDIO_EXP_EPSM_SSG_CHN_CNT = 0                                                                                       !!! #}
{# !!! AMISTUDIO_EXP_EPSM_TRIG_CHN = 0                                                                                          !!! #}
{% else 120 %}
    {% if ndef FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT                                                                                     %}
{# !!! AMISTUDIO_EXP_EPSM_SSG_CHN_CNT     = 3                                                                                   !!! #}
    {% endif 120 %}
    {% if ndef FAMISTUDIO_EXP_EPSM_FM_CHN_CNT                                                                                      %}
{# !!! AMISTUDIO_EXP_EPSM_FM_CHN_CNT      = 6                                                                                   !!! #}
    {% endif 120 %}
    {% if ndef FAMISTUDIO_EXP_EPSM_RHYTHM_CHN1_ENABLE                                                                              %}
{# !!! AMISTUDIO_EXP_EPSM_RHYTHM_CHN1_ENABLE = 1                                                                                !!! #}
    {% endif 120 %}
    {% if ndef FAMISTUDIO_EXP_EPSM_RHYTHM_CHN2_ENABLE                                                                              %}
{# !!! AMISTUDIO_EXP_EPSM_RHYTHM_CHN2_ENABLE = 1                                                                                !!! #}
    {% endif 120 %}
    {% if ndef FAMISTUDIO_EXP_EPSM_RHYTHM_CHN3_ENABLE                                                                              %}
{# !!! AMISTUDIO_EXP_EPSM_RHYTHM_CHN3_ENABLE = 1                                                                                !!! #}
    {% endif 120 %}
    {% if ndef FAMISTUDIO_EXP_EPSM_RHYTHM_CHN4_ENABLE                                                                              %}
{# !!! AMISTUDIO_EXP_EPSM_RHYTHM_CHN4_ENABLE = 1                                                                                !!! #}
    {% endif 120 %}
    {% if ndef FAMISTUDIO_EXP_EPSM_RHYTHM_CHN5_ENABLE                                                                              %}
{# !!! AMISTUDIO_EXP_EPSM_RHYTHM_CHN5_ENABLE = 1                                                                                !!! #}
    {% endif 120 %}
    {% if ndef FAMISTUDIO_EXP_EPSM_RHYTHM_CHN6_ENABLE                                                                              %}
{# !!! AMISTUDIO_EXP_EPSM_RHYTHM_CHN6_ENABLE = 1                                                                                !!! #}
    {% endif 120 %}
{% endif 120 %}

{% if ndef FAMISTUDIO_EXP_MMC5                                                                                                 %}
{# !!! AMISTUDIO_EXP_MMC5 = 0                                                                                                   !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_EXP_S5B                                                                                                  %}
{# !!! AMISTUDIO_EXP_S5B = 0                                                                                                    !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_EXP_FDS                                                                                                  %}
{# !!! AMISTUDIO_EXP_FDS = 0                                                                                                    !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_EXP_N163                                                                                                 %}
{# !!! AMISTUDIO_EXP_N163 = 0                                                                                                   !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_EXP_N163_CHN_CNT                                                                                         %}
{# !!! AMISTUDIO_EXP_N163_CHN_CNT = 1                                                                                           !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_CFG_PAL_SUPPORT                                                                                          %}
{# !!! AMISTUDIO_CFG_PAL_SUPPORT = 0                                                                                            !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_CFG_NTSC_SUPPORT                                                                                         %}
    {% if FAMISTUDIO_CFG_PAL_SUPPORT                                                                                               %}
{# !!! AMISTUDIO_CFG_NTSC_SUPPORT = 0                                                                                           !!! #}
    {% else 120 %}
{# !!! AMISTUDIO_CFG_NTSC_SUPPORT = 1                                                                                           !!! #}
    {% endif 120 %}
{% endif 120 %}

{% if FAMISTUDIO_CFG_NTSC_SUPPORT && FAMISTUDIO_CFG_PAL_SUPPORT                                                                %}
{# !!! AMISTUDIO_DUAL_SUPPORT = 1                                                                                               !!! #}
{% else 120 %}
{# !!! AMISTUDIO_DUAL_SUPPORT = 0                                                                                               !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_CFG_SFX_SUPPORT                                                                                          %}
{# !!! AMISTUDIO_CFG_SFX_SUPPORT = 0                                                                                            !!! #}
{# !!! AMISTUDIO_CFG_SFX_STREAMS = 0                                                                                            !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_CFG_SFX_STREAMS                                                                                          %}
{# !!! AMISTUDIO_CFG_SFX_STREAMS = 1                                                                                            !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_CFG_C_BINDINGS                                                                                           %}
{# !!! AMISTUDIO_CFG_C_BINDINGS = 0                                                                                             !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_CFG_SMOOTH_VIBRATO                                                                                       %}
{# !!! AMISTUDIO_CFG_SMOOTH_VIBRATO = 0                                                                                         !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_CFG_DPCM_SUPPORT                                                                                         %}
{# !!! AMISTUDIO_CFG_DPCM_SUPPORT = 0                                                                                           !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_CFG_EQUALIZER                                                                                            %}
{# !!! AMISTUDIO_CFG_EQUALIZER = 0                                                                                              !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_USE_FAMITRACKER_TEMPO                                                                                    %}
{# !!! AMISTUDIO_USE_FAMITRACKER_TEMPO = 0                                                                                      !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS                                                                    %}
{# !!! AMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS = 0                                                                      !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_USE_VOLUME_TRACK                                                                                         %}
{# !!! AMISTUDIO_USE_VOLUME_TRACK = 0                                                                                           !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_USE_VOLUME_SLIDES                                                                                        %}
{# !!! AMISTUDIO_USE_VOLUME_SLIDES = 0                                                                                          !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_USE_PITCH_TRACK                                                                                          %}
{# !!! AMISTUDIO_USE_PITCH_TRACK = 0                                                                                            !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_USE_SLIDE_NOTES                                                                                          %}
{# !!! AMISTUDIO_USE_SLIDE_NOTES = 0                                                                                            !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_USE_NOISE_SLIDE_NOTES                                                                                    %}
{# !!! AMISTUDIO_USE_NOISE_SLIDE_NOTES = 0                                                                                      !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_USE_VIBRATO                                                                                              %}
{# !!! AMISTUDIO_USE_VIBRATO = 0                                                                                                !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_USE_ARPEGGIO                                                                                             %}
{# !!! AMISTUDIO_USE_ARPEGGIO = 0                                                                                               !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_USE_DUTYCYCLE_EFFECT                                                                                     %}
{# !!! AMISTUDIO_USE_DUTYCYCLE_EFFECT = 0                                                                                       !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_USE_DELTA_COUNTER                                                                                        %}
{# !!! AMISTUDIO_USE_DELTA_COUNTER = 0                                                                                          !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_USE_PHASE_RESET                                                                                          %}
{# !!! AMISTUDIO_USE_PHASE_RESET = 0                                                                                            !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_USE_FDS_AUTOMOD                                                                                          %}
{# !!! AMISTUDIO_USE_FDS_AUTOMOD = 0                                                                                            !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_USE_RELEASE_NOTES                                                                                        %}
{# !!! AMISTUDIO_USE_RELEASE_NOTES = 0                                                                                          !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_USE_DPCM_EXTENDED_RANGE                                                                                  %}
{# !!! AMISTUDIO_USE_DPCM_EXTENDED_RANGE = 0                                                                                    !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE                                                                            %}
{# !!! AMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE = 0                                                                              !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_USE_DPCM_BANKSWITCHING                                                                                   %}
{# !!! AMISTUDIO_USE_DPCM_BANKSWITCHING = 0                                                                                     !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_CFG_THREAD                                                                                               %}
{# !!! AMISTUDIO_CFG_THREAD = 0                                                                                                 !!! #}
{% endif 120 %}

{% if (FAMISTUDIO_EXP_VRC6 + FAMISTUDIO_EXP_VRC7 + FAMISTUDIO_EXP_EPSM + FAMISTUDIO_EXP_MMC5 + FAMISTUDIO_EXP_S5B + FAMISTUDIO_EXP_FDS + FAMISTUDIO_EXP_N163) = 0 %}
{# !!! AMISTUDIO_EXP_NONE = 1                                                                                                   !!! #}
{% else 120 %}
{# !!! AMISTUDIO_EXP_NONE = 0                                                                                                   !!! #}
{% endif 120 %}

{% if (FAMISTUDIO_EXP_VRC7 + FAMISTUDIO_EXP_EPSM + FAMISTUDIO_EXP_N163 + FAMISTUDIO_EXP_FDS + FAMISTUDIO_EXP_S5B)              %}
{# !!! AMISTUDIO_EXP_NOTE_START = 5                                                                                             !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! AMISTUDIO_EXP_NOTE_START = 7                                                                                             !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_NOISE_SLIDE_NOTES && (FAMISTUDIO_USE_SLIDE_NOTES = 0)                                                     %}
{# !!! error "Noise slide notes can only be used when regular slide notes are enabled too."                                     !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_VOLUME_SLIDES && (FAMISTUDIO_USE_VOLUME_TRACK = 0)                                                        %}
{# !!! error "Volume slides can only be used when the volume track is enabled too."                                             !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS && (FAMISTUDIO_USE_FAMITRACKER_TEMPO = 0)                               %}
{# !!! error "Delayed notes or cuts only make sense when using FamiTracker tempo."                                              !!! #}
{% endif 120 %}

{% if (FAMISTUDIO_EXP_VRC6 + FAMISTUDIO_EXP_VRC7 + FAMISTUDIO_EXP_EPSM + FAMISTUDIO_EXP_MMC5 + FAMISTUDIO_EXP_S5B + FAMISTUDIO_EXP_FDS + FAMISTUDIO_EXP_N163) > 1 %}
{# !!! error "Only one audio expansion can be enabled."                                                                         !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_N163 && ((FAMISTUDIO_EXP_N163_CHN_CNT < 1) || (FAMISTUDIO_EXP_N163_CHN_CNT > 8))                          %}
{# !!! error "N163 only supports between 1 and 8 channels."                                                                     !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_DELTA_COUNTER && (FAMISTUDIO_CFG_DPCM_SUPPORT = 0)                                                        %}
{# !!! error "Delta counter only makes sense if DPCM samples are enabled."                                                      !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_DPCM_BANKSWITCHING && (FAMISTUDIO_CFG_DPCM_SUPPORT = 0)                                                   %}
{# !!! error "DPCM bankswitching only makes sense if DPCM samples are enabled."                                                 !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_ASM6_ZP_ENUM                                                                                             %}
{# !!! error "You need to set FAMISTUDIO_ASM6_ZP_ENUM to the location of the zeropage variables."                               !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_ASM6_BSS_ENUM                                                                                            %}
{# !!! error "You need to set FAMISTUDIO_ASM6_BSS_ENUM to the location of the RAM/BSS variables."                               !!! #}
{% endif 120 %}

{% if ndef FAMISTUDIO_ASM6_CODE_BASE                                                                                           %}
{# !!! error "You need to set FAMISTUDIO_ASM6_CODE_BASE to the location of the engine code."                                    !!! #}
{% endif 120 %}

{# !!! AMISTUDIO_DPCM_PTR = (FAMISTUDIO_DPCM_OFF & $3fff) >> 6                                                                  !!! #}

{% if FAMISTUDIO_EXP_NONE                                                                                                      %}
{# !!! AMISTUDIO_NUM_ENVELOPES        = 3+3+2+3                                                                                 !!! #}
{# !!! AMISTUDIO_NUM_PITCH_ENVELOPES  = 3                                                                                       !!! #}
{# !!! AMISTUDIO_NUM_CHANNELS         = 5                                                                                       !!! #}
{# !!! AMISTUDIO_NUM_DUTY_CYCLES      = 3                                                                                       !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! AMISTUDIO_NUM_ENVELOPES        = 3+3+2+3+3+3+3                                                                           !!! #}
{# !!! AMISTUDIO_NUM_PITCH_ENVELOPES  = 6                                                                                       !!! #}
{# !!! AMISTUDIO_NUM_CHANNELS         = 8                                                                                       !!! #}
{# !!! AMISTUDIO_NUM_DUTY_CYCLES      = 6                                                                                       !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_VRC7                                                                                                      %}
{# !!! AMISTUDIO_NUM_ENVELOPES        = 3+3+2+3+2+2+2+2+2+2                                                                     !!! #}
{# !!! AMISTUDIO_NUM_PITCH_ENVELOPES  = 9                                                                                       !!! #}
{# !!! AMISTUDIO_NUM_CHANNELS         = 11                                                                                      !!! #}
{# !!! AMISTUDIO_NUM_DUTY_CYCLES      = 3                                                                                       !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{# !!! AMISTUDIO_EXP_EPSM_RHYTHM_CNT  = FAMISTUDIO_EXP_EPSM_RHYTHM_CHN1_ENABLE + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN2_ENABLE + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN3_ENABLE + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN4_ENABLE + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN5_ENABLE + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN6_ENABLE !!! #}
{# !!! AMISTUDIO_EXP_EPSM_ENV_CNT     = FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT + FAMISTUDIO_EXP_EPSM_FM_CHN_CNT                        !!! #}
{# !!! AMISTUDIO_EXP_EPSM_CHANNELS    = FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT + FAMISTUDIO_EXP_EPSM_FM_CHN_CNT + FAMISTUDIO_EXP_EPSM_RHYTHM_CNT !!! #}
{# !!! AMISTUDIO_EXP_EPSM_TRIG_CHN    = FAMISTUDIO_EXP_EPSM_FM_CHN_CNT + FAMISTUDIO_EXP_EPSM_RHYTHM_CNT                         !!! #}

{# !!! AMISTUDIO_NUM_ENVELOPES        = 3+3+2+3+(FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT * 4) + (FAMISTUDIO_EXP_EPSM_FM_CHN_CNT * 2)    !!! #}
{# !!! AMISTUDIO_NUM_PITCH_ENVELOPES  = 3 + FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT + FAMISTUDIO_EXP_EPSM_FM_CHN_CNT                    !!! #}
{# !!! AMISTUDIO_NUM_CHANNELS         = 5 + FAMISTUDIO_EXP_EPSM_CHANNELS                                                        !!! #}
{# !!! AMISTUDIO_NUM_DUTY_CYCLES      = 3                                                                                       !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! AMISTUDIO_NUM_ENVELOPES        = 3+3+2+3+2                                                                               !!! #}
{# !!! AMISTUDIO_NUM_PITCH_ENVELOPES  = 4                                                                                       !!! #}
{# !!! AMISTUDIO_NUM_CHANNELS         = 6                                                                                       !!! #}
{# !!! AMISTUDIO_NUM_DUTY_CYCLES      = 3                                                                                       !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_MMC5                                                                                                      %}
{# !!! AMISTUDIO_NUM_ENVELOPES        = 3+3+2+3+3+3                                                                             !!! #}
{# !!! AMISTUDIO_NUM_PITCH_ENVELOPES  = 5                                                                                       !!! #}
{# !!! AMISTUDIO_NUM_CHANNELS         = 7                                                                                       !!! #}
{# !!! AMISTUDIO_NUM_DUTY_CYCLES      = 5                                                                                       !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! AMISTUDIO_NUM_ENVELOPES        = 3+3+2+3+(FAMISTUDIO_EXP_N163_CHN_CNT*3)                                                 !!! #}
{# !!! AMISTUDIO_NUM_PITCH_ENVELOPES  = 3+FAMISTUDIO_EXP_N163_CHN_CNT                                                           !!! #}
{# !!! AMISTUDIO_NUM_CHANNELS         = 5+FAMISTUDIO_EXP_N163_CHN_CNT                                                           !!! #}
{# !!! AMISTUDIO_NUM_DUTY_CYCLES      = 3                                                                                       !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_S5B                                                                                                       %}
{# !!! AMISTUDIO_NUM_ENVELOPES        = 3+3+2+3+4+4+4                                                                           !!! #}
{# !!! AMISTUDIO_NUM_PITCH_ENVELOPES  = 6                                                                                       !!! #}
{# !!! AMISTUDIO_NUM_CHANNELS         = 8                                                                                       !!! #}
{# !!! AMISTUDIO_NUM_DUTY_CYCLES      = 3                                                                                       !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_NONE                                                                                                      %}
{# !!! AMISTUDIO_NUM_VOLUME_SLIDES = 4                                                                                          !!! #}
{% else 120 %}
{# !!! AMISTUDIO_NUM_VOLUME_SLIDES = FAMISTUDIO_NUM_CHANNELS ; DPCM volume is unused.                                           !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_NOISE_SLIDE_NOTES                                                                                         %}
{# !!! AMISTUDIO_NUM_SLIDES = FAMISTUDIO_NUM_PITCH_ENVELOPES + 1                                                                !!! #}
{% else 120 %}
{# !!! AMISTUDIO_NUM_SLIDES = FAMISTUDIO_NUM_PITCH_ENVELOPES                                                                    !!! #}
{% endif 120 %}

{#  Keep the noise slide at the end so the pitch envelopes/slides are in sync.                                              #}
{# !!! AMISTUDIO_NOISE_SLIDE_INDEX = FAMISTUDIO_NUM_SLIDES - 1                                                                  !!! #}

{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! AMISTUDIO_VRC6_CH0_PITCH_ENV_IDX = 3                                                                                     !!! #}
{# !!! AMISTUDIO_VRC6_CH1_PITCH_ENV_IDX = 4                                                                                     !!! #}
{# !!! AMISTUDIO_VRC6_CH2_PITCH_ENV_IDX = 5                                                                                     !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_VRC7                                                                                                      %}
{# !!! AMISTUDIO_VRC7_CH0_PITCH_ENV_IDX = 3                                                                                     !!! #}
{# !!! AMISTUDIO_VRC7_CH1_PITCH_ENV_IDX = 4                                                                                     !!! #}
{# !!! AMISTUDIO_VRC7_CH2_PITCH_ENV_IDX = 5                                                                                     !!! #}
{# !!! AMISTUDIO_VRC7_CH3_PITCH_ENV_IDX = 6                                                                                     !!! #}
{# !!! AMISTUDIO_VRC7_CH4_PITCH_ENV_IDX = 7                                                                                     !!! #}
{# !!! AMISTUDIO_VRC7_CH5_PITCH_ENV_IDX = 8                                                                                     !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! AMISTUDIO_FDS_CH0_PITCH_ENV_IDX  = 3                                                                                     !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_MMC5                                                                                                      %}
{# !!! AMISTUDIO_MMC5_CH0_PITCH_ENV_IDX = 3                                                                                     !!! #}
{# !!! AMISTUDIO_MMC5_CH1_PITCH_ENV_IDX = 4                                                                                     !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! AMISTUDIO_N163_CH0_PITCH_ENV_IDX = 3                                                                                     !!! #}
{# !!! AMISTUDIO_N163_CH1_PITCH_ENV_IDX = 4                                                                                     !!! #}
{# !!! AMISTUDIO_N163_CH2_PITCH_ENV_IDX = 5                                                                                     !!! #}
{# !!! AMISTUDIO_N163_CH3_PITCH_ENV_IDX = 6                                                                                     !!! #}
{# !!! AMISTUDIO_N163_CH4_PITCH_ENV_IDX = 7                                                                                     !!! #}
{# !!! AMISTUDIO_N163_CH5_PITCH_ENV_IDX = 8                                                                                     !!! #}
{# !!! AMISTUDIO_N163_CH6_PITCH_ENV_IDX = 9                                                                                     !!! #}
{# !!! AMISTUDIO_N163_CH7_PITCH_ENV_IDX = 10                                                                                    !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_S5B                                                                                                       %}
{# !!! AMISTUDIO_S5B_CH0_PITCH_ENV_IDX  = 3                                                                                     !!! #}
{# !!! AMISTUDIO_S5B_CH1_PITCH_ENV_IDX  = 4                                                                                     !!! #}
{# !!! AMISTUDIO_S5B_CH2_PITCH_ENV_IDX  = 5                                                                                     !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{# !!! AMISTUDIO_EPSM_CH0_PITCH_ENV_IDX = 3                                                                                     !!! #}
{# !!! AMISTUDIO_EPSM_CH1_PITCH_ENV_IDX = 4                                                                                     !!! #}
{# !!! AMISTUDIO_EPSM_CH2_PITCH_ENV_IDX = 5                                                                                     !!! #}
{# !!! AMISTUDIO_EPSM_CH3_PITCH_ENV_IDX = 6                                                                                     !!! #}
{# !!! AMISTUDIO_EPSM_CH4_PITCH_ENV_IDX = 7                                                                                     !!! #}
{# !!! AMISTUDIO_EPSM_CH5_PITCH_ENV_IDX = 8                                                                                     !!! #}
{# !!! AMISTUDIO_EPSM_CH6_PITCH_ENV_IDX = 9                                                                                     !!! #}
{# !!! AMISTUDIO_EPSM_CH7_PITCH_ENV_IDX = 10                                                                                    !!! #}
{# !!! AMISTUDIO_EPSM_CH8_PITCH_ENV_IDX = 11                                                                                    !!! #}
{% endif 120 %}

{#  TODO: Investigate reshuffling the envelopes to keep them contiguously                                                   #}
{#  by type (all volumes envelopes, all arp envelopes, etc.) instead of                                                     #}
{#  by channel. This *may* simplify a lot of places where we need a lookup                                                  #}
{#  table (famistudio_channel_to_volume_env, etc.)                                                                          #}
{# !!! AMISTUDIO_CH0_ENVS = 0                                                                                                   !!! #}
{# !!! AMISTUDIO_CH1_ENVS = 3                                                                                                   !!! #}
{# !!! AMISTUDIO_CH2_ENVS = 6                                                                                                   !!! #}
{# !!! AMISTUDIO_CH3_ENVS = 8                                                                                                   !!! #}

{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! AMISTUDIO_VRC6_CH0_ENVS = 11                                                                                             !!! #}
{# !!! AMISTUDIO_VRC6_CH1_ENVS = 14                                                                                             !!! #}
{# !!! AMISTUDIO_VRC6_CH2_ENVS = 17                                                                                             !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_VRC7                                                                                                      %}
{# !!! AMISTUDIO_VRC7_CH0_ENVS = 11                                                                                             !!! #}
{# !!! AMISTUDIO_VRC7_CH1_ENVS = 13                                                                                             !!! #}
{# !!! AMISTUDIO_VRC7_CH2_ENVS = 15                                                                                             !!! #}
{# !!! AMISTUDIO_VRC7_CH3_ENVS = 17                                                                                             !!! #}
{# !!! AMISTUDIO_VRC7_CH4_ENVS = 19                                                                                             !!! #}
{# !!! AMISTUDIO_VRC7_CH5_ENVS = 21                                                                                             !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! AMISTUDIO_FDS_CH0_ENVS = 11                                                                                              !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_MMC5                                                                                                      %}
{# !!! AMISTUDIO_MMC5_CH0_ENVS = 11                                                                                             !!! #}
{# !!! AMISTUDIO_MMC5_CH1_ENVS = 14                                                                                             !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! AMISTUDIO_N163_CH0_ENVS = 11                                                                                             !!! #}
{# !!! AMISTUDIO_N163_CH1_ENVS = 14                                                                                             !!! #}
{# !!! AMISTUDIO_N163_CH2_ENVS = 17                                                                                             !!! #}
{# !!! AMISTUDIO_N163_CH3_ENVS = 20                                                                                             !!! #}
{# !!! AMISTUDIO_N163_CH4_ENVS = 23                                                                                             !!! #}
{# !!! AMISTUDIO_N163_CH5_ENVS = 26                                                                                             !!! #}
{# !!! AMISTUDIO_N163_CH6_ENVS = 29                                                                                             !!! #}
{# !!! AMISTUDIO_N163_CH7_ENVS = 32                                                                                             !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_S5B                                                                                                       %}
{# !!! AMISTUDIO_S5B_CH0_ENVS = 11                                                                                              !!! #}
{# !!! AMISTUDIO_S5B_CH1_ENVS = 15                                                                                              !!! #}
{# !!! AMISTUDIO_S5B_CH2_ENVS = 19                                                                                              !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{% if FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0                                                                                      %}
{# !!! PSM_ENV_CH1_INCREMENT = 4                                                                                                !!! #}
{% else 120 %}
{# !!! PSM_ENV_CH1_INCREMENT = 2                                                                                                !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 1                                                                                      %}
{# !!! PSM_ENV_CH2_INCREMENT = 4                                                                                                !!! #}
{% else 120 %}
{# !!! PSM_ENV_CH2_INCREMENT = 2                                                                                                !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 2                                                                                      %}
{# !!! PSM_ENV_CH3_INCREMENT = 4                                                                                                !!! #}
{% else 120 %}
{# !!! PSM_ENV_CH3_INCREMENT = 2                                                                                                !!! #}
{% endif 120 %}
{# !!! AMISTUDIO_EPSM_CH0_ENVS = 11                                                                                             !!! #}
{# !!! AMISTUDIO_EPSM_CH1_ENVS =  FAMISTUDIO_EPSM_CH0_ENVS + EPSM_ENV_CH1_INCREMENT                                             !!! #}
{# !!! AMISTUDIO_EPSM_CH2_ENVS =  FAMISTUDIO_EPSM_CH1_ENVS + EPSM_ENV_CH2_INCREMENT                                             !!! #}
{# !!! AMISTUDIO_EPSM_CH3_ENVS =  FAMISTUDIO_EPSM_CH2_ENVS + EPSM_ENV_CH3_INCREMENT                                             !!! #}
{# !!! AMISTUDIO_EPSM_CH4_ENVS =  FAMISTUDIO_EPSM_CH3_ENVS + 2                                                                  !!! #}
{# !!! AMISTUDIO_EPSM_CH5_ENVS =  FAMISTUDIO_EPSM_CH4_ENVS + 2                                                                  !!! #}
{# !!! AMISTUDIO_EPSM_CH6_ENVS =  FAMISTUDIO_EPSM_CH5_ENVS + 2                                                                  !!! #}
{# !!! AMISTUDIO_EPSM_CH7_ENVS =  FAMISTUDIO_EPSM_CH6_ENVS + 2                                                                  !!! #}
{# !!! AMISTUDIO_EPSM_CH8_ENVS =  FAMISTUDIO_EPSM_CH7_ENVS + 2                                                                  !!! #}
{% endif 120 %}

{# !!! AMISTUDIO_ENV_VOLUME_OFF        = 0                                                                                      !!! #}
{# !!! AMISTUDIO_ENV_NOTE_OFF          = 1                                                                                      !!! #}
{# !!! AMISTUDIO_ENV_DUTY_OFF          = 2                                                                                      !!! #}
{# !!! AMISTUDIO_ENV_N163_WAVE_IDX_OFF = 2                                                                                      !!! #}
{# !!! AMISTUDIO_ENV_MIXER_IDX_OFF     = 2                                                                                      !!! #}
{# !!! AMISTUDIO_ENV_NOISE_IDX_OFF     = 3                                                                                      !!! #}

{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! AMISTUDIO_VRC6_CH0_DUTY_IDX = 3                                                                                          !!! #}
{# !!! AMISTUDIO_VRC6_CH1_DUTY_IDX = 4                                                                                          !!! #}
{# !!! AMISTUDIO_VRC6_CH2_DUTY_IDX = 5                                                                                          !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_MMC5                                                                                                      %}
{# !!! AMISTUDIO_MMC5_CH0_DUTY_IDX = 3                                                                                          !!! #}
{# !!! AMISTUDIO_MMC5_CH1_DUTY_IDX = 4                                                                                          !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! AMISTUDIO_VRC6_CH0_IDX = 5                                                                                               !!! #}
{# !!! AMISTUDIO_VRC6_CH1_IDX = 6                                                                                               !!! #}
{# !!! AMISTUDIO_VRC6_CH2_IDX = 7                                                                                               !!! #}
{% else 120 %}
{# !!! AMISTUDIO_VRC6_CH0_IDX = -1                                                                                              !!! #}
{# !!! AMISTUDIO_VRC6_CH1_IDX = -1                                                                                              !!! #}
{# !!! AMISTUDIO_VRC6_CH2_IDX = -1                                                                                              !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_VRC7                                                                                                      %}
{# !!! AMISTUDIO_VRC7_CH0_IDX = 5                                                                                               !!! #}
{# !!! AMISTUDIO_VRC7_CH1_IDX = 6                                                                                               !!! #}
{# !!! AMISTUDIO_VRC7_CH2_IDX = 7                                                                                               !!! #}
{# !!! AMISTUDIO_VRC7_CH3_IDX = 8                                                                                               !!! #}
{# !!! AMISTUDIO_VRC7_CH4_IDX = 9                                                                                               !!! #}
{# !!! AMISTUDIO_VRC7_CH5_IDX = 10                                                                                              !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! AMISTUDIO_FDS_CH0_IDX  = 5                                                                                               !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_MMC5                                                                                                      %}
{# !!! AMISTUDIO_MMC5_CH0_IDX = 5                                                                                               !!! #}
{# !!! AMISTUDIO_MMC5_CH1_IDX = 6                                                                                               !!! #}
{% else 120 %}
{# !!! AMISTUDIO_MMC5_CH0_IDX = -1                                                                                              !!! #}
{# !!! AMISTUDIO_MMC5_CH1_IDX = -1                                                                                              !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! AMISTUDIO_N163_CH0_IDX = 5                                                                                               !!! #}
{# !!! AMISTUDIO_N163_CH1_IDX = 6                                                                                               !!! #}
{# !!! AMISTUDIO_N163_CH2_IDX = 7                                                                                               !!! #}
{# !!! AMISTUDIO_N163_CH3_IDX = 8                                                                                               !!! #}
{# !!! AMISTUDIO_N163_CH4_IDX = 9                                                                                               !!! #}
{# !!! AMISTUDIO_N163_CH5_IDX = 10                                                                                              !!! #}
{# !!! AMISTUDIO_N163_CH6_IDX = 11                                                                                              !!! #}
{# !!! AMISTUDIO_N163_CH7_IDX = 12                                                                                              !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_S5B                                                                                                       %}
{# !!! AMISTUDIO_S5B_CH0_IDX  = 5                                                                                               !!! #}
{# !!! AMISTUDIO_S5B_CH1_IDX  = 6                                                                                               !!! #}
{# !!! AMISTUDIO_S5B_CH2_IDX  = 7                                                                                               !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{# !!! AMISTUDIO_EPSM_CH0_IDX = 5                                                                                               !!! #}
{# !!! AMISTUDIO_EPSM_CH1_IDX = 6                                                                                               !!! #}
{# !!! AMISTUDIO_EPSM_CH2_IDX = 7                                                                                               !!! #}
{# !!! AMISTUDIO_EPSM_CH3_IDX = 8                                                                                               !!! #}
{# !!! AMISTUDIO_EPSM_CH4_IDX = 9                                                                                               !!! #}
{# !!! AMISTUDIO_EPSM_CH5_IDX = 10                                                                                              !!! #}
{# !!! AMISTUDIO_EPSM_CH6_IDX = 11                                                                                              !!! #}
{# !!! AMISTUDIO_EPSM_CH7_IDX = 12                                                                                              !!! #}
{# !!! AMISTUDIO_EPSM_CH8_IDX = 13                                                                                              !!! #}
{# !!! AMISTUDIO_EPSM_CH9_IDX = 14                                                                                              !!! #}
{# !!! AMISTUDIO_EPSM_CH10_IDX = 15                                                                                             !!! #}
{# !!! AMISTUDIO_EPSM_CH11_IDX = 16                                                                                             !!! #}
{# !!! AMISTUDIO_EPSM_CH12_IDX = 17                                                                                             !!! #}
{# !!! AMISTUDIO_EPSM_CH13_IDX = 18                                                                                             !!! #}
{# !!! AMISTUDIO_EPSM_CH14_IDX = 19                                                                                             !!! #}
{# !!! AMISTUDIO_EPSM_CHAN_FM_START = FAMISTUDIO_EPSM_CH0_IDX + FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT                                 !!! #}
{# !!! AMISTUDIO_EPSM_CHAN_RHYTHM_START = FAMISTUDIO_EPSM_CHAN_FM_START + FAMISTUDIO_EXP_EPSM_FM_CHN_CNT                        !!! #}
{% endif 120 %}

{# !!! AMISTUDIO_VRC7_PITCH_SHIFT = 3                                                                                           !!! #}
{# !!! AMISTUDIO_EPSM_PITCH_SHIFT = 3                                                                                           !!! #}

{% if (FAMISTUDIO_EXP_N163_CHN_CNT > 4)                                                                                        %}
{# !!! AMISTUDIO_N163_PITCH_SHIFT = 5                                                                                           !!! #}
{% endif 120 %}
{% if (FAMISTUDIO_EXP_N163_CHN_CNT > 2) & (FAMISTUDIO_EXP_N163_CHN_CNT <= 4)                                                   %}
{# !!! AMISTUDIO_N163_PITCH_SHIFT = 4                                                                                           !!! #}
{% endif 120 %}
{% if (FAMISTUDIO_EXP_N163_CHN_CNT > 1) & (FAMISTUDIO_EXP_N163_CHN_CNT <= 2)                                                   %}
{# !!! AMISTUDIO_N163_PITCH_SHIFT = 3                                                                                           !!! #}
{% endif 120 %}
{% if (FAMISTUDIO_EXP_N163_CHN_CNT = 1)                                                                                        %}
{# !!! AMISTUDIO_N163_PITCH_SHIFT = 2                                                                                           !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_VRC7                                                                                                      %}
{# !!! AMISTUDIO_PITCH_SHIFT = FAMISTUDIO_VRC7_PITCH_SHIFT                                                                      !!! #}
{% else 120 %}
    {% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{# !!! AMISTUDIO_PITCH_SHIFT = FAMISTUDIO_EPSM_PITCH_SHIFT                                                                      !!! #}
    {% else 120 %}
        {% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! AMISTUDIO_PITCH_SHIFT = FAMISTUDIO_N163_PITCH_SHIFT                                                                      !!! #}
        {% else 120 %}
{# !!! AMISTUDIO_PITCH_SHIFT = 0                                                                                                !!! #}
        {% endif 120 %}
    {% endif 120 %}
{% endif 120 %}

{% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! AMISTUDIO_N163_CHN_MASK = (FAMISTUDIO_EXP_N163_CHN_CNT - 1) << 4                                                         !!! #}
{% endif 120 %}

{% if FAMISTUDIO_CFG_SFX_SUPPORT                                                                                               %}
{# !!! AMISTUDIO_SFX_STRUCT_SIZE = 15                                                                                           !!! #}

{# !!! AMISTUDIO_SFX_CH0 = FAMISTUDIO_SFX_STRUCT_SIZE * 0                                                                       !!! #}
{# !!! AMISTUDIO_SFX_CH1 = FAMISTUDIO_SFX_STRUCT_SIZE * 1                                                                       !!! #}
{# !!! AMISTUDIO_SFX_CH2 = FAMISTUDIO_SFX_STRUCT_SIZE * 2                                                                       !!! #}
{# !!! AMISTUDIO_SFX_CH3 = FAMISTUDIO_SFX_STRUCT_SIZE * 3                                                                       !!! #}
{% endif 120 %}

{# !!! AMISTUDIO_FIRST_EXP_INST_CHANNEL = 5                                                                                     !!! #}

{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{# !!! AMISTUDIO_FIRST_POSITIVE_SLIDE_CHANNEL = 3 + FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT                                             !!! #}
{% else 120 %}
{# !!! AMISTUDIO_FIRST_POSITIVE_SLIDE_CHANNEL = 3                                                                               !!! #}
{% endif 120 %}

{# ======================================================================================================================   #}
{#  RAM VARIABLES (You should not have to play with these)                                                                  #}
{# ======================================================================================================================   #}

{# !!! enum FAMISTUDIO_ASM6_BSS_ENUM                                                                                            !!! #}

{# !!! amistudio_env_value:             .dsb FAMISTUDIO_NUM_ENVELOPES                                                           !!! #}
{# !!! amistudio_env_repeat:            .dsb FAMISTUDIO_NUM_ENVELOPES                                                           !!! #}
{# !!! amistudio_env_addr_lo:           .dsb FAMISTUDIO_NUM_ENVELOPES                                                           !!! #}
{# !!! amistudio_env_addr_hi:           .dsb FAMISTUDIO_NUM_ENVELOPES                                                           !!! #}
{# !!! amistudio_env_ptr:               .dsb FAMISTUDIO_NUM_ENVELOPES                                                           !!! #}

{# !!! amistudio_pitch_env_value_lo:    .dsb FAMISTUDIO_NUM_PITCH_ENVELOPES                                                     !!! #}
{# !!! amistudio_pitch_env_value_hi:    .dsb FAMISTUDIO_NUM_PITCH_ENVELOPES                                                     !!! #}
{# !!! amistudio_pitch_env_repeat:      .dsb FAMISTUDIO_NUM_PITCH_ENVELOPES                                                     !!! #}
{# !!! amistudio_pitch_env_addr_lo:     .dsb FAMISTUDIO_NUM_PITCH_ENVELOPES                                                     !!! #}
{# !!! amistudio_pitch_env_addr_hi:     .dsb FAMISTUDIO_NUM_PITCH_ENVELOPES                                                     !!! #}
{# !!! amistudio_pitch_env_ptr:         .dsb FAMISTUDIO_NUM_PITCH_ENVELOPES                                                     !!! #}
{% if FAMISTUDIO_USE_PITCH_TRACK                                                                                               %}
{# !!! amistudio_pitch_env_fine_value:  .dsb FAMISTUDIO_NUM_PITCH_ENVELOPES                                                     !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_SLIDE_NOTES                                                                                               %}
{# !!! amistudio_slide_step:            .dsb FAMISTUDIO_NUM_SLIDES                                                              !!! #}
{# !!! amistudio_slide_pitch_lo:        .dsb FAMISTUDIO_NUM_SLIDES                                                              !!! #}
{# !!! amistudio_slide_pitch_hi:        .dsb FAMISTUDIO_NUM_SLIDES                                                              !!! #}
{% endif 120 %}

{# !!! amistudio_chn_ptr_lo:            .dsb FAMISTUDIO_NUM_CHANNELS                                                            !!! #}
{# !!! amistudio_chn_ptr_hi:            .dsb FAMISTUDIO_NUM_CHANNELS                                                            !!! #}
{# !!! amistudio_chn_note:              .dsb FAMISTUDIO_NUM_CHANNELS                                                            !!! #}
{# !!! amistudio_chn_repeat:            .dsb FAMISTUDIO_NUM_CHANNELS                                                            !!! #}
{# !!! amistudio_chn_return_lo:         .dsb FAMISTUDIO_NUM_CHANNELS                                                            !!! #}
{# !!! amistudio_chn_return_hi:         .dsb FAMISTUDIO_NUM_CHANNELS                                                            !!! #}
{# !!! amistudio_chn_ref_len:           .dsb FAMISTUDIO_NUM_CHANNELS                                                            !!! #}
{% if FAMISTUDIO_USE_VOLUME_TRACK                                                                                              %}
{# !!! amistudio_chn_volume_track:      .dsb FAMISTUDIO_NUM_CHANNELS                                                            !!! #}
{% if FAMISTUDIO_USE_VOLUME_SLIDES                                                                                             %}
{# !!! amistudio_chn_volume_slide_step:   .dsb FAMISTUDIO_NUM_VOLUME_SLIDES                                                     !!! #}
{# !!! amistudio_chn_volume_slide_target: .dsb FAMISTUDIO_NUM_VOLUME_SLIDES                                                     !!! #}
{% endif 120 %}
{% endif 120 %}
{% if FAMISTUDIO_USE_VIBRATO || FAMISTUDIO_USE_ARPEGGIO                                                                        %}
{# !!! amistudio_chn_env_override:      .dsb FAMISTUDIO_NUM_CHANNELS ; bit 7 = pitch, bit 0 = arpeggio.                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS                                                                         %}
{# !!! amistudio_chn_note_delay:        .dsb FAMISTUDIO_NUM_CHANNELS                                                            !!! #}
{# !!! amistudio_chn_cut_delay:         .dsb FAMISTUDIO_NUM_CHANNELS                                                            !!! #}
{% endif 120 %}
{% if FAMISTUDIO_CFG_EQUALIZER                                                                                                 %}
{# !!! amistudio_chn_note_counter:      .dsb FAMISTUDIO_NUM_CHANNELS                                                            !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_PHASE_RESET                                                                                               %}
{# !!! amistudio_phase_reset:           .dsb 1 ; bit 0/1 = 2a03, bit 2/3/4 = vrc6, 5/6 = mmc5, bit 7 = fds                      !!! #}
{% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! amistudio_phase_reset_n163:      .dsb 1 ; bit 0...7 = n163                                                               !!! #}
{% endif 120 %}
{% endif 120 %}
{% if FAMISTUDIO_USE_DELTA_COUNTER                                                                                             %}
{# !!! amistudio_dmc_delta_counter:     .dsb 1                                                                                  !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! amistudio_vrc6_saw_volume:       .dsb 1 ; -1 = 1/4, 0 = 1/2, 1 = Full                                                    !!! #}
{% if FAMISTUDIO_USE_PHASE_RESET                                                                                               %}
{# !!! amistudio_vrc6_pulse1_prev_hi:   .dsb 1                                                                                  !!! #}
{# !!! amistudio_vrc6_pulse2_prev_hi:   .dsb 1                                                                                  !!! #}
{# !!! amistudio_vrc6_saw_prev_hi:      .dsb 1                                                                                  !!! #}
{% else 120 %}
{# !!! amistudio_vrc6_pulse1_prev_hi = famistudio_vrc6_saw_volume                                                               !!! #}
{# !!! amistudio_vrc6_pulse2_prev_hi = famistudio_vrc6_saw_volume                                                               !!! #}
{# !!! amistudio_vrc6_saw_prev_hi    = famistudio_vrc6_saw_volume                                                               !!! #}
{% endif 120 %}
{% endif 120 %}
{% if FAMISTUDIO_EXP_VRC7                                                                                                      %}
{# !!! amistudio_chn_vrc7_prev_hi:      .dsb 6                                                                                  !!! #}
{# !!! amistudio_chn_vrc7_patch:        .dsb 6                                                                                  !!! #}
{# !!! amistudio_chn_vrc7_trigger:      .dsb 6 ; bit 0 = new note triggered, bit 7 = note released.                             !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{% if FAMISTUDIO_EXP_EPSM_RHYTHM_CNT > 0                                                                                       %}
{# !!! amistudio_chn_epsm_rhythm_volume: .dsb FAMISTUDIO_EXP_EPSM_RHYTHM_CNT                                                    !!! #}
{# !!! amistudio_chn_epsm_rhythm_stereo: .dsb FAMISTUDIO_EXP_EPSM_RHYTHM_CNT                                                    !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_FM_CHN_CNT+FAMISTUDIO_EXP_EPSM_RHYTHM_CNT > 0                                                        %}
{# !!! amistudio_chn_epsm_trigger:       .dsb FAMISTUDIO_EXP_EPSM_FM_CHN_CNT + FAMISTUDIO_EXP_EPSM_RHYTHM_CNT ; bit 0 = new note triggered, bit 7 = note released. !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_FM_CHN_CNT > 0                                                                                       %}
{# !!! amistudio_chn_epsm_fm_stereo:     .dsb FAMISTUDIO_EXP_EPSM_FM_CHN_CNT                                                    !!! #}
{# !!! amistudio_chn_epsm_fm_instrument: .dsb FAMISTUDIO_EXP_EPSM_FM_CHN_CNT                                                    !!! #}
{# !!! amistudio_chn_epsm_alg:           .dsb FAMISTUDIO_EXP_EPSM_FM_CHN_CNT                                                    !!! #}
{# !!! amistudio_chn_epsm_vol_op1:       .dsb FAMISTUDIO_EXP_EPSM_FM_CHN_CNT                                                    !!! #}
{# !!! amistudio_chn_epsm_vol_op2:       .dsb FAMISTUDIO_EXP_EPSM_FM_CHN_CNT                                                    !!! #}
{# !!! amistudio_chn_epsm_vol_op3:       .dsb FAMISTUDIO_EXP_EPSM_FM_CHN_CNT                                                    !!! #}
{# !!! amistudio_chn_epsm_vol_op4:       .dsb FAMISTUDIO_EXP_EPSM_FM_CHN_CNT                                                    !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0                                                                                      %}
{# !!! amistudio_epsm_env_period_lo:     .dsb 1                                                                                 !!! #}
{# !!! amistudio_epsm_env_period_hi:     .dsb 1                                                                                 !!! #}
{# !!! amistudio_epsm_env_override:      .dsb 1                                                                                 !!! #}
{# !!! amistudio_epsm_chn_env_shape:     .dsb FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT ; bit 7 = note attack.                            !!! #}
{# !!! amistudio_epsm_chn_env_octave:    .dsb FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT                                                   !!! #}
{% endif 120 %}
{% endif 120 %}
{% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! amistudio_chn_n163_instrument:   .dsb FAMISTUDIO_EXP_N163_CHN_CNT                                                        !!! #}
{# !!! amistudio_chn_n163_wave_index:   .dsb FAMISTUDIO_EXP_N163_CHN_CNT                                                        !!! #}
{# !!! amistudio_chn_n163_wave_len:     .dsb FAMISTUDIO_EXP_N163_CHN_CNT                                                        !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_S5B                                                                                                       %}
{# !!! amistudio_s5b_env_period_lo:     .dsb 1                                                                                  !!! #}
{# !!! amistudio_s5b_env_period_hi:     .dsb 1                                                                                  !!! #}
{# !!! amistudio_s5b_env_override:      .dsb 1 ; if non zero, it means we had an env period effect this frame.                  !!! #}
{# !!! amistudio_s5b_chn_env_shape:     .dsb 3 ; bit 7 = note attack                                                            !!! #}
{# !!! amistudio_s5b_chn_env_octave:    .dsb 3                                                                                  !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_DUTYCYCLE_EFFECT                                                                                          %}
{# !!! amistudio_duty_cycle:            .dsb FAMISTUDIO_NUM_DUTY_CYCLES                                                         !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_FAMITRACKER_TEMPO                                                                                         %}
{# !!! amistudio_tempo_step_lo:         .dsb 1                                                                                  !!! #}
{# !!! amistudio_tempo_step_hi:         .dsb 1                                                                                  !!! #}
{# !!! amistudio_tempo_acc_lo:          .dsb 1                                                                                  !!! #}
{# !!! amistudio_tempo_acc_hi:          .dsb 1                                                                                  !!! #}
{% if FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS                                                                         %}
{# !!! amistudio_tempo_advance_row:     .dsb 1                                                                                  !!! #}
{% endif 120 %}
{% else 120 %}
{# !!! amistudio_tempo_env_ptr_lo:      .dsb 1                                                                                  !!! #}
{# !!! amistudio_tempo_env_ptr_hi:      .dsb 1                                                                                  !!! #}
{# !!! amistudio_tempo_env_counter:     .dsb 1                                                                                  !!! #}
{# !!! amistudio_tempo_env_idx:         .dsb 1                                                                                  !!! #}
{# !!! amistudio_tempo_frame_num:       .dsb 1                                                                                  !!! #}
{# !!! amistudio_tempo_frame_cnt:       .dsb 1                                                                                  !!! #}
{% endif 120 %}

{# !!! amistudio_pal_adjust:            .dsb 1                                                                                  !!! #}
{# !!! amistudio_song_list_lo:          .dsb 1                                                                                  !!! #}
{# !!! amistudio_song_list_hi:          .dsb 1                                                                                  !!! #}
{# !!! amistudio_instrument_lo:         .dsb 1                                                                                  !!! #}
{# !!! amistudio_instrument_hi:         .dsb 1                                                                                  !!! #}
{# !!! amistudio_dpcm_list_lo:          .dsb 1 ; TODO: Not needed if DPCM support is disabled.                                  !!! #}
{# !!! amistudio_dpcm_list_hi:          .dsb 1 ; TODO: Not needed if DPCM support is disabled.                                  !!! #}
{# !!! amistudio_dpcm_effect:           .dsb 1 ; TODO: Not needed if DPCM support is disabled.                                  !!! #}
{# !!! amistudio_pulse1_prev:           .dsb 1                                                                                  !!! #}
{# !!! amistudio_pulse2_prev:           .dsb 1                                                                                  !!! #}
{# !!! amistudio_song_speed:            .dsb 1                                                                                  !!! #}

{% if FAMISTUDIO_EXP_MMC5                                                                                                      %}
{# !!! amistudio_mmc5_pulse1_prev:      .dsb 1                                                                                  !!! #}
{# !!! amistudio_mmc5_pulse2_prev:      .dsb 1                                                                                  !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! amistudio_fds_mod_speed:         .dsb 2                                                                                  !!! #}
{# !!! amistudio_fds_mod_depth:         .dsb 1                                                                                  !!! #}
{# !!! amistudio_fds_mod_delay:         .dsb 1                                                                                  !!! #}
{# !!! amistudio_fds_mod_delay_counter: .dsb 1                                                                                  !!! #}
{# !!! amistudio_fds_override_flags:    .dsb 1 ; Bit 7 = mod speed overriden, bit 6 mod depth overriden                         !!! #}
{% if FAMISTUDIO_USE_FDS_AUTOMOD                                                                                               %}
{# !!! amistudio_fds_automod_numer:     .dsb 1 ; 0 = auto-mod off.                                                              !!! #}
{# !!! amistudio_fds_automod_denom:     .dsb 1                                                                                  !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_PHASE_RESET                                                                                               %}
{# !!! amistudio_fds_prev_hi:           .dsb 1                                                                                  !!! #}
{% endif 120 %}
{% endif 120 %}

{% if FAMISTUDIO_EXP_VRC7                                                                                                      %}
{# !!! amistudio_vrc7_dummy:            .dsb 1 ; TODO: Find a dummy address i can simply write to without side effects.         !!! #}
{% endif 120 %}

{#  FDS, N163 and VRC7 have very different instrument layout and are 16-bytes, so we keep them seperate.                    #}
{% if FAMISTUDIO_EXP_FDS || FAMISTUDIO_EXP_N163 || FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_EPSM || FAMISTUDIO_EXP_S5B            %}
{# !!! amistudio_exp_instrument_lo:     .dsb 1                                                                                  !!! #}
{# !!! amistudio_exp_instrument_hi:     .dsb 1                                                                                  !!! #}
{% endif 120 %}

{% if FAMISTUDIO_CFG_SFX_SUPPORT                                                                                               %}

{# !!! amistudio_output_buf:     .dsb 11                                                                                        !!! #}
{# !!! amistudio_sfx_addr_lo:    .dsb 1                                                                                         !!! #}
{# !!! amistudio_sfx_addr_hi:    .dsb 1                                                                                         !!! #}
{# !!! amistudio_sfx_base_addr:  .dsb (FAMISTUDIO_CFG_SFX_STREAMS * FAMISTUDIO_SFX_STRUCT_SIZE)                                 !!! #}

{#  TODO: Refactor SFX memory layout. These uses a AoS approach, not a fan.                                                 #}
{# !!! amistudio_sfx_repeat = famistudio_sfx_base_addr + 0                                                                      !!! #}
{# !!! amistudio_sfx_ptr_lo = famistudio_sfx_base_addr + 1                                                                      !!! #}
{# !!! amistudio_sfx_ptr_hi = famistudio_sfx_base_addr + 2                                                                      !!! #}
{# !!! amistudio_sfx_offset = famistudio_sfx_base_addr + 3                                                                      !!! #}
{# !!! amistudio_sfx_buffer = famistudio_sfx_base_addr + 4                                                                      !!! #}

{% endif 120 %}

{# !!! ende                                                                                                                     !!! #}

{# ======================================================================================================================   #}
{#  ZEROPAGE VARIABLES                                                                                                      #}
{#                                                                                                                          #}
{#  These are only used as temporary variable during the famistudio_xxx calls.                                              #}
{#  Feel free to alias those with other ZP values in your programs to save a few bytes.                                     #}
{# ======================================================================================================================   #}

{# !!! enum FAMISTUDIO_ASM6_ZP_ENUM                                                                                             !!! #}

{# !!! amistudio_r0:   .dsb 1                                                                                                   !!! #}
{# !!! amistudio_r1:   .dsb 1                                                                                                   !!! #}
{# !!! amistudio_r2:   .dsb 1                                                                                                   !!! #}
{# !!! amistudio_r3:   .dsb 1                                                                                                   !!! #}

{# !!! amistudio_ptr0: .dsb 2                                                                                                   !!! #}
{# !!! amistudio_ptr1: .dsb 2                                                                                                   !!! #}
{% if FAMISTUDIO_EXP_EPSM || FAMISTUDIO_EXP_FDS || FAMISTUDIO_EXP_S5B                                                          %}
{# !!! amistudio_ptr2: .dsb 2                                                                                                   !!! #}
{% endif 120 %}

{# !!! amistudio_ptr0_lo = famistudio_ptr0+0                                                                                    !!! #}
{# !!! amistudio_ptr0_hi = famistudio_ptr0+1                                                                                    !!! #}
{# !!! amistudio_ptr1_lo = famistudio_ptr1+0                                                                                    !!! #}
{# !!! amistudio_ptr1_hi = famistudio_ptr1+1                                                                                    !!! #}

{# !!! ende                                                                                                                     !!! #}

{# ======================================================================================================================   #}
{#  CODE                                                                                                                    #}
{# ======================================================================================================================   #}

{# !!! base FAMISTUDIO_ASM6_CODE_BASE                                                                                           !!! #}

{# !!! AMISTUDIO_APU_PL1_VOL    = $4000                                                                                         !!! #}
{# !!! AMISTUDIO_APU_PL1_SWEEP  = $4001                                                                                         !!! #}
{# !!! AMISTUDIO_APU_PL1_LO     = $4002                                                                                         !!! #}
{# !!! AMISTUDIO_APU_PL1_HI     = $4003                                                                                         !!! #}
{# !!! AMISTUDIO_APU_PL2_VOL    = $4004                                                                                         !!! #}
{# !!! AMISTUDIO_APU_PL2_SWEEP  = $4005                                                                                         !!! #}
{# !!! AMISTUDIO_APU_PL2_LO     = $4006                                                                                         !!! #}
{# !!! AMISTUDIO_APU_PL2_HI     = $4007                                                                                         !!! #}
{# !!! AMISTUDIO_APU_TRI_LINEAR = $4008                                                                                         !!! #}
{# !!! AMISTUDIO_APU_TRI_LO     = $400a                                                                                         !!! #}
{# !!! AMISTUDIO_APU_TRI_HI     = $400b                                                                                         !!! #}
{# !!! AMISTUDIO_APU_NOISE_VOL  = $400c                                                                                         !!! #}
{# !!! AMISTUDIO_APU_NOISE_LO   = $400e                                                                                         !!! #}
{# !!! AMISTUDIO_APU_NOISE_HI   = $400f                                                                                         !!! #}
{# !!! AMISTUDIO_APU_DMC_FREQ   = $4010                                                                                         !!! #}
{# !!! AMISTUDIO_APU_DMC_RAW    = $4011                                                                                         !!! #}
{# !!! AMISTUDIO_APU_DMC_START  = $4012                                                                                         !!! #}
{# !!! AMISTUDIO_APU_DMC_LEN    = $4013                                                                                         !!! #}
{# !!! AMISTUDIO_APU_SND_CHN    = $4015                                                                                         !!! #}
{# !!! AMISTUDIO_APU_FRAME_CNT  = $4017                                                                                         !!! #}

{% if FAMISTUDIO_EXP_RAINBOW                                                                                                   %}
{# !!! AMISTUDIO_VRC6_PL1_VOL   = $41a0                                                                                         !!! #}
{# !!! AMISTUDIO_VRC6_PL1_LO    = $41a1                                                                                         !!! #}
{# !!! AMISTUDIO_VRC6_PL1_HI    = $41a2                                                                                         !!! #}
{# !!! AMISTUDIO_VRC6_FREQ_CTRL = $41a0 ; Dummy                                                                                 !!! #}
{# !!! AMISTUDIO_VRC6_PL2_VOL   = $41a3                                                                                         !!! #}
{# !!! AMISTUDIO_VRC6_PL2_LO    = $41a4                                                                                         !!! #}
{# !!! AMISTUDIO_VRC6_PL2_HI    = $41a5                                                                                         !!! #}
{# !!! AMISTUDIO_VRC6_SAW_VOL   = $41a6                                                                                         !!! #}
{# !!! AMISTUDIO_VRC6_SAW_LO    = $41a7                                                                                         !!! #}
{# !!! AMISTUDIO_VRC6_SAW_HI    = $41a8                                                                                         !!! #}
{% else 120 %}
{# !!! AMISTUDIO_VRC6_PL1_VOL   = $9000                                                                                         !!! #}
{# !!! AMISTUDIO_VRC6_PL1_LO    = $9001                                                                                         !!! #}
{# !!! AMISTUDIO_VRC6_PL1_HI    = $9002                                                                                         !!! #}
{# !!! AMISTUDIO_VRC6_FREQ_CTRL = $9003                                                                                         !!! #}
{# !!! AMISTUDIO_VRC6_PL2_VOL   = $a000                                                                                         !!! #}
{# !!! AMISTUDIO_VRC6_PL2_LO    = $a001                                                                                         !!! #}
{# !!! AMISTUDIO_VRC6_PL2_HI    = $a002                                                                                         !!! #}
{# !!! AMISTUDIO_VRC6_SAW_VOL   = $b000                                                                                         !!! #}
{# !!! AMISTUDIO_VRC6_SAW_LO    = $b001                                                                                         !!! #}
{# !!! AMISTUDIO_VRC6_SAW_HI    = $b002                                                                                         !!! #}
{% endif 120 %}

{# !!! AMISTUDIO_VRC7_SILENCE   = $e000                                                                                         !!! #}
{# !!! AMISTUDIO_VRC7_REG_SEL   = $9010                                                                                         !!! #}
{# !!! AMISTUDIO_VRC7_REG_WRITE = $9030                                                                                         !!! #}
{# !!! AMISTUDIO_VRC7_REG_LO_1  = $10                                                                                           !!! #}
{# !!! AMISTUDIO_VRC7_REG_LO_2  = $11                                                                                           !!! #}
{# !!! AMISTUDIO_VRC7_REG_LO_3  = $12                                                                                           !!! #}
{# !!! AMISTUDIO_VRC7_REG_LO_4  = $13                                                                                           !!! #}
{# !!! AMISTUDIO_VRC7_REG_LO_5  = $14                                                                                           !!! #}
{# !!! AMISTUDIO_VRC7_REG_LO_6  = $15                                                                                           !!! #}
{# !!! AMISTUDIO_VRC7_REG_HI_1  = $20                                                                                           !!! #}
{# !!! AMISTUDIO_VRC7_REG_HI_2  = $21                                                                                           !!! #}
{# !!! AMISTUDIO_VRC7_REG_HI_3  = $22                                                                                           !!! #}
{# !!! AMISTUDIO_VRC7_REG_HI_4  = $23                                                                                           !!! #}
{# !!! AMISTUDIO_VRC7_REG_HI_5  = $24                                                                                           !!! #}
{# !!! AMISTUDIO_VRC7_REG_HI_6  = $25                                                                                           !!! #}
{# !!! AMISTUDIO_VRC7_REG_VOL_1 = $30                                                                                           !!! #}
{# !!! AMISTUDIO_VRC7_REG_VOL_2 = $31                                                                                           !!! #}
{# !!! AMISTUDIO_VRC7_REG_VOL_3 = $32                                                                                           !!! #}
{# !!! AMISTUDIO_VRC7_REG_VOL_4 = $33                                                                                           !!! #}
{# !!! AMISTUDIO_VRC7_REG_VOL_5 = $34                                                                                           !!! #}
{# !!! AMISTUDIO_VRC7_REG_VOL_6 = $35                                                                                           !!! #}

{# !!! AMISTUDIO_EPSM_REG_SEL0   = $401c                                                                                        !!! #}
{# !!! AMISTUDIO_EPSM_REG_WRITE0 = $401d                                                                                        !!! #}
{# !!! AMISTUDIO_EPSM_REG_SEL1   = $401e                                                                                        !!! #}
{# !!! AMISTUDIO_EPSM_REG_WRITE1 = $401f                                                                                        !!! #}
{# !!! AMISTUDIO_EPSM_REG_KEY    = $28                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_DT_MUL = $30                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_TL     = $40                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_KS_AR  = $50                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_AMO_DR = $60                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_SR     = $70                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_SL_RR  = $80                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_SSG    = $90                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_FN_LO  = $A0                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_FN_LO2 = $A1                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_FN_LO3 = $A2                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_FN_HI  = $A4                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_FN_HI2 = $A5                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_FN_HI3 = $A6                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_FB     = $B0                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_AM_PM  = $B4                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_LFO    = $22                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_RHY_KY = $10                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_RHY_BD = $18                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_RHY_SD = $19                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_RHY_TC = $1a                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_RHY_HH = $1b                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_RHY_TOM = $1c                                                                                         !!! #}
{# !!! AMISTUDIO_EPSM_REG_RHY_RIM = $1d                                                                                         !!! #}
{# !!! AMISTUDIO_EPSM_REG_LO_1  = $10                                                                                           !!! #}
{# !!! AMISTUDIO_EPSM_REG_LO_2  = $11                                                                                           !!! #}
{# !!! AMISTUDIO_EPSM_REG_LO_3  = $12                                                                                           !!! #}
{# !!! AMISTUDIO_EPSM_REG_LO_4  = $13                                                                                           !!! #}
{# !!! AMISTUDIO_EPSM_REG_LO_5  = $14                                                                                           !!! #}
{# !!! AMISTUDIO_EPSM_REG_LO_6  = $15                                                                                           !!! #}
{# !!! AMISTUDIO_EPSM_REG_HI_1  = $20                                                                                           !!! #}
{# !!! AMISTUDIO_EPSM_REG_HI_2  = $21                                                                                           !!! #}
{# !!! AMISTUDIO_EPSM_REG_HI_3  = $22                                                                                           !!! #}
{# !!! AMISTUDIO_EPSM_REG_HI_4  = $23                                                                                           !!! #}
{# !!! AMISTUDIO_EPSM_REG_HI_5  = $24                                                                                           !!! #}
{# !!! AMISTUDIO_EPSM_REG_HI_6  = $25                                                                                           !!! #}
{# !!! AMISTUDIO_EPSM_REG_VOL_1 = $30                                                                                           !!! #}
{# !!! AMISTUDIO_EPSM_REG_VOL_2 = $31                                                                                           !!! #}
{# !!! AMISTUDIO_EPSM_REG_VOL_3 = $32                                                                                           !!! #}
{# !!! AMISTUDIO_EPSM_REG_VOL_4 = $33                                                                                           !!! #}
{# !!! AMISTUDIO_EPSM_REG_VOL_5 = $34                                                                                           !!! #}
{# !!! AMISTUDIO_EPSM_REG_VOL_6 = $35                                                                                           !!! #}
{# !!! AMISTUDIO_EPSM_ADDR       = $401c                                                                                        !!! #}
{# !!! AMISTUDIO_EPSM_DATA       = $401d                                                                                        !!! #}
{# !!! AMISTUDIO_EPSM_REG_LO_A   = $00                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_HI_A   = $01                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_LO_B   = $02                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_HI_B   = $03                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_LO_C   = $04                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_HI_C   = $05                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_NOISE  = $06                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_TONE   = $07                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_VOL_A  = $08                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_VOL_B  = $09                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_VOL_C  = $0a                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_ENV_LO = $0b                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_ENV_HI = $0c                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_SHAPE  = $0d                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_IO_A   = $0e                                                                                          !!! #}
{# !!! AMISTUDIO_EPSM_REG_IO_B   = $0f                                                                                          !!! #}

{# !!! AMISTUDIO_MMC5_PL1_VOL    = $5000                                                                                        !!! #}
{# !!! AMISTUDIO_MMC5_PL1_SWEEP  = $5001                                                                                        !!! #}
{# !!! AMISTUDIO_MMC5_PL1_LO     = $5002                                                                                        !!! #}
{# !!! AMISTUDIO_MMC5_PL1_HI     = $5003                                                                                        !!! #}
{# !!! AMISTUDIO_MMC5_PL2_VOL    = $5004                                                                                        !!! #}
{# !!! AMISTUDIO_MMC5_PL2_SWEEP  = $5005                                                                                        !!! #}
{# !!! AMISTUDIO_MMC5_PL2_LO     = $5006                                                                                        !!! #}
{# !!! AMISTUDIO_MMC5_PL2_HI     = $5007                                                                                        !!! #}
{# !!! AMISTUDIO_MMC5_PCM_MODE   = $5010                                                                                        !!! #}
{# !!! AMISTUDIO_MMC5_SND_CHN    = $5015                                                                                        !!! #}
{# !!! AMISTUDIO_MMC5_EXRAM_MODE = $5104                                                                                        !!! #}

{# !!! AMISTUDIO_N163_SILENCE       = $e000                                                                                     !!! #}
{# !!! AMISTUDIO_N163_ADDR          = $f800                                                                                     !!! #}
{# !!! AMISTUDIO_N163_DATA          = $4800                                                                                     !!! #}
{# !!! AMISTUDIO_N163_REG_FREQ_LO   = $78                                                                                       !!! #}
{# !!! AMISTUDIO_N163_REG_PHASE_LO  = $79                                                                                       !!! #}
{# !!! AMISTUDIO_N163_REG_FREQ_MID  = $7a                                                                                       !!! #}
{# !!! AMISTUDIO_N163_REG_PHASE_MID = $7b                                                                                       !!! #}
{# !!! AMISTUDIO_N163_REG_FREQ_HI   = $7c                                                                                       !!! #}
{# !!! AMISTUDIO_N163_REG_PHASE_HI  = $7d                                                                                       !!! #}
{# !!! AMISTUDIO_N163_REG_WAVE      = $7e                                                                                       !!! #}
{# !!! AMISTUDIO_N163_REG_VOLUME    = $7f                                                                                       !!! #}

{# !!! AMISTUDIO_S5B_ADDR       = $c000                                                                                         !!! #}
{# !!! AMISTUDIO_S5B_DATA       = $e001 ; To avoid VRC7 conflict.                                                               !!! #}
{# !!! AMISTUDIO_S5B_REG_LO_A   = $00                                                                                           !!! #}
{# !!! AMISTUDIO_S5B_REG_HI_A   = $01                                                                                           !!! #}
{# !!! AMISTUDIO_S5B_REG_LO_B   = $02                                                                                           !!! #}
{# !!! AMISTUDIO_S5B_REG_HI_B   = $03                                                                                           !!! #}
{# !!! AMISTUDIO_S5B_REG_LO_C   = $04                                                                                           !!! #}
{# !!! AMISTUDIO_S5B_REG_HI_C   = $05                                                                                           !!! #}
{# !!! AMISTUDIO_S5B_REG_NOISE  = $06                                                                                           !!! #}
{# !!! AMISTUDIO_S5B_REG_TONE   = $07                                                                                           !!! #}
{# !!! AMISTUDIO_S5B_REG_VOL_A  = $08                                                                                           !!! #}
{# !!! AMISTUDIO_S5B_REG_VOL_B  = $09                                                                                           !!! #}
{# !!! AMISTUDIO_S5B_REG_VOL_C  = $0a                                                                                           !!! #}
{# !!! AMISTUDIO_S5B_REG_ENV_LO = $0b                                                                                           !!! #}
{# !!! AMISTUDIO_S5B_REG_ENV_HI = $0c                                                                                           !!! #}
{# !!! AMISTUDIO_S5B_REG_SHAPE  = $0d                                                                                           !!! #}
{# !!! AMISTUDIO_S5B_REG_IO_A   = $0e                                                                                           !!! #}
{# !!! AMISTUDIO_S5B_REG_IO_B   = $0f                                                                                           !!! #}

{# !!! AMISTUDIO_FDS_WAV_START  = $4040                                                                                         !!! #}
{# !!! AMISTUDIO_FDS_VOL_ENV    = $4080                                                                                         !!! #}
{# !!! AMISTUDIO_FDS_FREQ_LO    = $4082                                                                                         !!! #}
{# !!! AMISTUDIO_FDS_FREQ_HI    = $4083                                                                                         !!! #}
{# !!! AMISTUDIO_FDS_SWEEP_ENV  = $4084                                                                                         !!! #}
{# !!! AMISTUDIO_FDS_SWEEP_BIAS = $4085                                                                                         !!! #}
{# !!! AMISTUDIO_FDS_MOD_LO     = $4086                                                                                         !!! #}
{# !!! AMISTUDIO_FDS_MOD_HI     = $4087                                                                                         !!! #}
{# !!! AMISTUDIO_FDS_MOD_TABLE  = $4088                                                                                         !!! #}
{# !!! AMISTUDIO_FDS_VOL        = $4089                                                                                         !!! #}
{# !!! AMISTUDIO_FDS_ENV_SPEED  = $408A                                                                                         !!! #}

{% if !FAMISTUDIO_CFG_SFX_SUPPORT                                                                                              %}
{#  Output directly to APU                                                                                                  #}
{# !!! AMISTUDIO_ALIAS_PL1_VOL    = FAMISTUDIO_APU_PL1_VOL                                                                      !!! #}
{# !!! AMISTUDIO_ALIAS_PL1_LO     = FAMISTUDIO_APU_PL1_LO                                                                       !!! #}
{# !!! AMISTUDIO_ALIAS_PL1_HI     = FAMISTUDIO_APU_PL1_HI                                                                       !!! #}
{# !!! AMISTUDIO_ALIAS_PL2_VOL    = FAMISTUDIO_APU_PL2_VOL                                                                      !!! #}
{# !!! AMISTUDIO_ALIAS_PL2_LO     = FAMISTUDIO_APU_PL2_LO                                                                       !!! #}
{# !!! AMISTUDIO_ALIAS_PL2_HI     = FAMISTUDIO_APU_PL2_HI                                                                       !!! #}
{# !!! AMISTUDIO_ALIAS_TRI_LINEAR = FAMISTUDIO_APU_TRI_LINEAR                                                                   !!! #}
{# !!! AMISTUDIO_ALIAS_TRI_LO     = FAMISTUDIO_APU_TRI_LO                                                                       !!! #}
{# !!! AMISTUDIO_ALIAS_TRI_HI     = FAMISTUDIO_APU_TRI_HI                                                                       !!! #}
{# !!! AMISTUDIO_ALIAS_NOISE_VOL  = FAMISTUDIO_APU_NOISE_VOL                                                                    !!! #}
{# !!! AMISTUDIO_ALIAS_NOISE_LO   = FAMISTUDIO_APU_NOISE_LO                                                                     !!! #}
{% else 120 %}
{#  Otherwise write to the output buffer                                                                                    #}
{# !!! AMISTUDIO_ALIAS_PL1_VOL    = famistudio_output_buf + 0                                                                   !!! #}
{# !!! AMISTUDIO_ALIAS_PL1_LO     = famistudio_output_buf + 1                                                                   !!! #}
{# !!! AMISTUDIO_ALIAS_PL1_HI     = famistudio_output_buf + 2                                                                   !!! #}
{# !!! AMISTUDIO_ALIAS_PL2_VOL    = famistudio_output_buf + 3                                                                   !!! #}
{# !!! AMISTUDIO_ALIAS_PL2_LO     = famistudio_output_buf + 4                                                                   !!! #}
{# !!! AMISTUDIO_ALIAS_PL2_HI     = famistudio_output_buf + 5                                                                   !!! #}
{# !!! AMISTUDIO_ALIAS_TRI_LINEAR = famistudio_output_buf + 6                                                                   !!! #}
{# !!! AMISTUDIO_ALIAS_TRI_LO     = famistudio_output_buf + 7                                                                   !!! #}
{# !!! AMISTUDIO_ALIAS_TRI_HI     = famistudio_output_buf + 8                                                                   !!! #}
{# !!! AMISTUDIO_ALIAS_NOISE_VOL  = famistudio_output_buf + 9                                                                   !!! #}
{# !!! AMISTUDIO_ALIAS_NOISE_LO   = famistudio_output_buf + 10                                                                  !!! #}
{% endif 120 %}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_INIT (public)                                                                                                #}
{#                                                                                                                          #}
{#  Reset APU, initialize the sound engine with some music data.                                                            #}
{#                                                                                                                          #}
{#  [in] a : Playback platform, zero for PAL, non-zero for NTSC.                                                            #}
{#  [in] x : Pointer to music data (lo)                                                                                     #}
{#  [in] y : Pointer to music data (hi)                                                                                     #}
{# ======================================================================================================================   #}

{# !!! amistudio_init:                                                                                                          !!! #}

{# !!! usic_data_ptr = famistudio_ptr0                                                                                          !!! #}

{# !!! tx famistudio_song_list_lo                                                                                               !!! #}
{# !!! ty famistudio_song_list_hi                                                                                               !!! #}
{# !!! tx music_data_ptr+0                                                                                                      !!! #}
{# !!! ty music_data_ptr+1                                                                                                      !!! #}

{% if FAMISTUDIO_DUAL_SUPPORT                                                                                                  %}
{# !!! ax                                                                                                                       !!! #}
{# !!! eq @pal                                                                                                                  !!! #}
{# !!! da #97                                                                                                                   !!! #}
{# !!! pal:                                                                                                                     !!! #}
{% else 120 %}
    {% if FAMISTUDIO_CFG_PAL_SUPPORT                                                                                               %}
{# !!! da #0                                                                                                                    !!! #}
    {% endif 120 %}
    {% if FAMISTUDIO_CFG_NTSC_SUPPORT                                                                                              %}
{# !!! da #97                                                                                                                   !!! #}
    {% endif 120 %}
{% endif 120 %}
{# !!! ta famistudio_pal_adjust                                                                                                 !!! #}

{# !!! sr famistudio_music_stop                                                                                                 !!! #}

{#  Instrument address                                                                                                      #}
{# !!! dy #1                                                                                                                    !!! #}
{# !!! da (music_data_ptr),y                                                                                                    !!! #}
{# !!! ta famistudio_instrument_lo                                                                                              !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (music_data_ptr),y                                                                                                    !!! #}
{# !!! ta famistudio_instrument_hi                                                                                              !!! #}
{# !!! ny                                                                                                                       !!! #}

{#  Expansions instrument address                                                                                           #}
    {% if FAMISTUDIO_EXP_FDS || FAMISTUDIO_EXP_N163 || FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_EPSM || FAMISTUDIO_EXP_S5B            %}
{# !!! da (music_data_ptr),y                                                                                                    !!! #}
{# !!! ta famistudio_exp_instrument_lo                                                                                          !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (music_data_ptr),y                                                                                                    !!! #}
{# !!! ta famistudio_exp_instrument_hi                                                                                          !!! #}
{# !!! ny                                                                                                                       !!! #}
    {% endif 120 %}

{#  Sample list address                                                                                                     #}
{# !!! da (music_data_ptr),y                                                                                                    !!! #}
{# !!! ta famistudio_dpcm_list_lo                                                                                               !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (music_data_ptr),y                                                                                                    !!! #}
{# !!! ta famistudio_dpcm_list_hi                                                                                               !!! #}

{# !!! da #$80 ; Previous pulse period MSB, to not write it when not changed                                                    !!! #}
{# !!! ta famistudio_pulse1_prev                                                                                                !!! #}
{# !!! ta famistudio_pulse2_prev                                                                                                !!! #}

{# !!! da #$0f ; Enable channels, stop DMC                                                                                      !!! #}
{# !!! ta FAMISTUDIO_APU_SND_CHN                                                                                                !!! #}
{# !!! da #$80 ; Disable triangle length counter                                                                                !!! #}
{# !!! ta FAMISTUDIO_APU_TRI_LINEAR                                                                                             !!! #}
{# !!! da #$00 ; Load noise length                                                                                              !!! #}
{# !!! ta FAMISTUDIO_APU_NOISE_HI                                                                                               !!! #}

{# !!! da #$30 ; Volumes to 0                                                                                                   !!! #}
{# !!! ta FAMISTUDIO_APU_PL1_VOL                                                                                                !!! #}
{# !!! ta FAMISTUDIO_APU_PL2_VOL                                                                                                !!! #}
{# !!! ta FAMISTUDIO_APU_NOISE_VOL                                                                                              !!! #}
{# !!! da #$08 ; No sweep                                                                                                       !!! #}
{# !!! ta FAMISTUDIO_APU_PL1_SWEEP                                                                                              !!! #}
{# !!! ta FAMISTUDIO_APU_PL2_SWEEP                                                                                              !!! #}

{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! init_vrc6:                                                                                                               !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta FAMISTUDIO_VRC6_FREQ_CTRL ; NESDEV wiki says to write zero at startup.                                                !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_VRC7                                                                                                      %}
{# !!! init_vrc7:                                                                                                               !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta FAMISTUDIO_VRC7_SILENCE ; Enable VRC7 audio.                                                                          !!! #}
{% endif 120 %}

{# !!! init_epsm:                                                                                                               !!! #}
{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{# !!! da #FAMISTUDIO_EPSM_REG_TONE                                                                                             !!! #}
{# !!! ta FAMISTUDIO_EPSM_ADDR                                                                                                  !!! #}
{# !!! da #$38 ; No noise, just 3 tones for now.                                                                                !!! #}
{# !!! ta FAMISTUDIO_EPSM_DATA                                                                                                  !!! #}
{# !!! da #$29                                                                                                                  !!! #}
{# !!! ta FAMISTUDIO_EPSM_ADDR                                                                                                  !!! #}
{# !!! da #$80                                                                                                                  !!! #}
{# !!! ta FAMISTUDIO_EPSM_DATA                                                                                                  !!! #}
{# !!! da #$27                                                                                                                  !!! #}
{# !!! ta FAMISTUDIO_EPSM_ADDR                                                                                                  !!! #}
{# !!! da #$00                                                                                                                  !!! #}
{# !!! ta FAMISTUDIO_EPSM_DATA                                                                                                  !!! #}
{# !!! da #$11                                                                                                                  !!! #}
{# !!! ta FAMISTUDIO_EPSM_ADDR                                                                                                  !!! #}
{# !!! da #$37                                                                                                                  !!! #}
{# !!! ta FAMISTUDIO_EPSM_DATA                                                                                                  !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_MMC5                                                                                                      %}
{# !!! init_mmc5:                                                                                                               !!! #}
{# !!! da #$00                                                                                                                  !!! #}
{# !!! ta FAMISTUDIO_MMC5_PCM_MODE                                                                                              !!! #}
{# !!! da #$03                                                                                                                  !!! #}
{# !!! ta FAMISTUDIO_MMC5_SND_CHN                                                                                               !!! #}
{# !!! da #$80 ; Previous pulse period MSB, to not write it when not changed                                                    !!! #}
{# !!! ta famistudio_mmc5_pulse1_prev                                                                                           !!! #}
{# !!! ta famistudio_mmc5_pulse2_prev                                                                                           !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_S5B                                                                                                       %}
{# !!! init_s5b:                                                                                                                !!! #}
{# !!! da #FAMISTUDIO_S5B_REG_TONE                                                                                              !!! #}
{# !!! ta FAMISTUDIO_S5B_ADDR                                                                                                   !!! #}
{# !!! da #$38 ; No noise, just 3 tones for now.                                                                                !!! #}
{# !!! ta FAMISTUDIO_S5B_DATA                                                                                                   !!! #}
{% endif 120 %}

{# !!! mp famistudio_music_stop                                                                                                 !!! #}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_MUSIC_STOP (public)                                                                                          #}
{#                                                                                                                          #}
{#  Stops any music currently playing, if any. Note that this will not update the APU, so sound might linger. Calling       #}
{#  famistudio_update after this will update the APU.                                                                       #}
{#                                                                                                                          #}
{#  [in] no input params.                                                                                                   #}
{# ======================================================================================================================   #}

{# !!! amistudio_music_stop:                                                                                                    !!! #}

{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_song_speed                                                                                                 !!! #}
{# !!! ta famistudio_dpcm_effect                                                                                                !!! #}

{# !!! dx #0                                                                                                                    !!! #}

{# !!! set_channels:                                                                                                            !!! #}

{# !!! ta famistudio_chn_repeat,x                                                                                               !!! #}
{# !!! ta famistudio_chn_note,x                                                                                                 !!! #}
{# !!! ta famistudio_chn_ref_len,x                                                                                              !!! #}
    {% if FAMISTUDIO_USE_VOLUME_TRACK                                                                                              %}
{# !!! ta famistudio_chn_volume_track,x                                                                                         !!! #}
    {% endif 120 %}
    {% if FAMISTUDIO_USE_VIBRATO || FAMISTUDIO_USE_ARPEGGIO                                                                        %}
{# !!! ta famistudio_chn_env_override,x                                                                                         !!! #}
    {% endif 120 %}
    {% if FAMISTUDIO_CFG_EQUALIZER                                                                                                 %}
{# !!! ta famistudio_chn_note_counter,x                                                                                         !!! #}
    {% endif 120 %}
    {% if FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS                                                                         %}
{# !!! da #$ff                                                                                                                  !!! #}
{# !!! ta famistudio_chn_note_delay,x                                                                                           !!! #}
{# !!! ta famistudio_chn_cut_delay,x                                                                                            !!! #}
{# !!! da #0                                                                                                                    !!! #}
    {% endif 120 %}
{# !!! nx                                                                                                                       !!! #}
{# !!! px #FAMISTUDIO_NUM_CHANNELS                                                                                              !!! #}
{# !!! ne @set_channels                                                                                                         !!! #}

{% if FAMISTUDIO_USE_DUTYCYCLE_EFFECT                                                                                          %}
{# !!! dx #0                                                                                                                    !!! #}
{# !!! set_duty_cycles:                                                                                                         !!! #}
{# !!! ta famistudio_duty_cycle,x                                                                                               !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! px #FAMISTUDIO_NUM_DUTY_CYCLES                                                                                           !!! #}
{# !!! ne @set_duty_cycles                                                                                                      !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_SLIDE_NOTES                                                                                               %}
{# !!! dx #0                                                                                                                    !!! #}
{# !!! set_slides:                                                                                                              !!! #}
{# !!! ta famistudio_slide_step, x                                                                                              !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! px #FAMISTUDIO_NUM_SLIDES                                                                                                !!! #}
{# !!! ne @set_slides                                                                                                           !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_VOLUME_SLIDES                                                                                             %}
{# !!! dx #0                                                                                                                    !!! #}
{# !!! set_volume_slides:                                                                                                       !!! #}
{# !!! ta famistudio_chn_volume_slide_step, x                                                                                   !!! #}
{# !!! ta famistudio_chn_volume_slide_target, x                                                                                 !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! px #FAMISTUDIO_NUM_VOLUME_SLIDES                                                                                         !!! #}
{# !!! ne @set_volume_slides                                                                                                    !!! #}
{% endif 120 %}

{# !!! dx #0                                                                                                                    !!! #}

{# !!! set_envelopes:                                                                                                           !!! #}

{# !!! da #<famistudio_dummy_envelope                                                                                           !!! #}
{# !!! ta famistudio_env_addr_lo,x                                                                                              !!! #}
{# !!! da #>famistudio_dummy_envelope                                                                                           !!! #}
{# !!! ta famistudio_env_addr_hi,x                                                                                              !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_env_repeat,x                                                                                               !!! #}
{# !!! ta famistudio_env_value,x                                                                                                !!! #}
{# !!! ta famistudio_env_ptr,x                                                                                                  !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! px #FAMISTUDIO_NUM_ENVELOPES                                                                                             !!! #}
{# !!! ne @set_envelopes                                                                                                        !!! #}

{# !!! dx #0                                                                                                                    !!! #}
{# !!! set_pitch_envelopes:                                                                                                     !!! #}

{# !!! da #<famistudio_dummy_pitch_envelope                                                                                     !!! #}
{# !!! ta famistudio_pitch_env_addr_lo,x                                                                                        !!! #}
{# !!! da #>famistudio_dummy_pitch_envelope                                                                                     !!! #}
{# !!! ta famistudio_pitch_env_addr_hi,x                                                                                        !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_pitch_env_repeat,x                                                                                         !!! #}
{# !!! ta famistudio_pitch_env_value_lo,x                                                                                       !!! #}
{# !!! ta famistudio_pitch_env_value_hi,x                                                                                       !!! #}
    {% if FAMISTUDIO_USE_PITCH_TRACK                                                                                               %}
{# !!! ta famistudio_pitch_env_fine_value,x                                                                                     !!! #}
    {% endif 120 %}
{# !!! da #1                                                                                                                    !!! #}
{# !!! ta famistudio_pitch_env_ptr,x                                                                                            !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! px #FAMISTUDIO_NUM_PITCH_ENVELOPES                                                                                       !!! #}
{# !!! ne @set_pitch_envelopes                                                                                                  !!! #}

{# !!! mp famistudio_sample_stop                                                                                                !!! #}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_MUSIC_PLAY (public)                                                                                          #}
{#                                                                                                                          #}
{#  Plays a song from the loaded music data (from a previous call to famistudio_init).                                      #}
{#                                                                                                                          #}
{#  [in] a : Song index.                                                                                                    #}
{# ======================================================================================================================   #}

{# !!! amistudio_music_play:                                                                                                    !!! #}

{# !!! mp = famistudio_r0                                                                                                       !!! #}
{# !!! ong_list_ptr = famistudio_ptr0                                                                                           !!! #}
{# !!! emp_env_ptr  = famistudio_ptr1                                                                                           !!! #}

{# !!! dx famistudio_song_list_lo                                                                                               !!! #}
{# !!! tx song_list_ptr+0                                                                                                       !!! #}
{# !!! dx famistudio_song_list_hi                                                                                               !!! #}
{# !!! tx song_list_ptr+1                                                                                                       !!! #}

{# !!! dy #0                                                                                                                    !!! #}
{# !!! mp (song_list_ptr),y                                                                                                     !!! #}
{# !!! cc @valid_song                                                                                                           !!! #}
{# !!! ts ; Invalid song index.                                                                                                 !!! #}

{# !!! valid_song:                                                                                                              !!! #}
{% if FAMISTUDIO_NUM_CHANNELS = 5                                                                                              %}
{#  Here we basically assume we have 17 songs or less (17 songs * 14 bytes per song + 5 bytes header < 256).                #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ta tmp                                                                                                                   !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! dc tmp                                                                                                                   !!! #}
{# !!! tx tmp                                                                                                                   !!! #}
{# !!! dc tmp                                                                                                                   !!! #}
{# !!! dc #5 ; Song count + instrument ptr + sample ptr                                                                         !!! #}
{# !!! ay                                                                                                                       !!! #}
{% else 120 %}
{#  This supports a larger number of songs as it increments the pointer itself, not Y.                                      #}
{#  As the number of channel becomes huge, this become necessary to support a decent                                        #}
{#  number of songs.                                                                                                        #}
{# !!! ax                                                                                                                       !!! #}
{# !!! da song_list_ptr+0                                                                                                       !!! #}
{# !!! song_mult_loop:                                                                                                          !!! #}
{# !!! ex                                                                                                                       !!! #}
{# !!! mi @song_mult_loop_done                                                                                                  !!! #}
{# !!! dc #(FAMISTUDIO_NUM_CHANNELS * 2 + 4)                                                                                    !!! #}
{# !!! cc @song_mult_loop                                                                                                       !!! #}
{# !!! nc song_list_ptr+1                                                                                                       !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! cc @song_mult_loop                                                                                                       !!! #}

{# !!! song_mult_loop_done:                                                                                                     !!! #}
{# !!! ta song_list_ptr+0                                                                                                       !!! #}

{% if FAMISTUDIO_EXP_FDS || FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_EPSM || FAMISTUDIO_EXP_N163 || FAMISTUDIO_EXP_S5B            %}
{# !!! dy #7 ; Song count + instrument ptr + exp instrument ptr + sample ptr                                                    !!! #}
{% else 120 %}
{# !!! dy #5 ; Song count + instrument ptr + sample ptr                                                                         !!! #}
{% endif 120 %}
{% endif 120 %}

{# !!! sr famistudio_music_stop                                                                                                 !!! #}

{# !!! dx #0                                                                                                                    !!! #}

{# !!! set_channels:                                                                                                            !!! #}

{#  Channel data address                                                                                                    #}
{# !!! da (song_list_ptr),y                                                                                                     !!! #}
{# !!! ta famistudio_chn_ptr_lo,x                                                                                               !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (song_list_ptr),y                                                                                                     !!! #}
{# !!! ta famistudio_chn_ptr_hi,x                                                                                               !!! #}
{# !!! ny                                                                                                                       !!! #}

{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_chn_repeat,x                                                                                               !!! #}
{# !!! ta famistudio_chn_note,x                                                                                                 !!! #}
{# !!! ta famistudio_chn_ref_len,x                                                                                              !!! #}
    {% if FAMISTUDIO_USE_VOLUME_TRACK                                                                                              %}
{# !!! da #$f0                                                                                                                  !!! #}
{# !!! ta famistudio_chn_volume_track,x                                                                                         !!! #}
    {% endif 120 %}
    {% if FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS                                                                         %}
{# !!! da #$ff                                                                                                                  !!! #}
{# !!! ta famistudio_chn_note_delay,x                                                                                           !!! #}
{# !!! ta famistudio_chn_cut_delay,x                                                                                            !!! #}
    {% endif 120 %}

{# !!! nextchannel:                                                                                                             !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! px #FAMISTUDIO_NUM_CHANNELS                                                                                              !!! #}
{# !!! ne @set_channels                                                                                                         !!! #}

{% if FAMISTUDIO_USE_FAMITRACKER_TEMPO                                                                                         %}
{# !!! da famistudio_pal_adjust                                                                                                 !!! #}
{# !!! eq @pal                                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! pal:                                                                                                                     !!! #}

{#  Tempo increment.                                                                                                        #}
{# !!! da (song_list_ptr),y                                                                                                     !!! #}
{# !!! ta famistudio_tempo_step_lo                                                                                              !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (song_list_ptr),y                                                                                                     !!! #}
{# !!! ta famistudio_tempo_step_hi                                                                                              !!! #}

{# !!! da #0 ; Reset tempo accumulator                                                                                          !!! #}
{# !!! ta famistudio_tempo_acc_lo                                                                                               !!! #}
{# !!! da #6 ; Default speed                                                                                                    !!! #}
{# !!! ta famistudio_tempo_acc_hi                                                                                               !!! #}
{# !!! ta famistudio_song_speed ; Apply default speed, this also enables music                                                  !!! #}
{% else 120 %}
{# !!! da (song_list_ptr),y                                                                                                     !!! #}
{# !!! ta famistudio_tempo_env_ptr_lo                                                                                           !!! #}
{# !!! ta temp_env_ptr+0                                                                                                        !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (song_list_ptr),y                                                                                                     !!! #}
{# !!! ta famistudio_tempo_env_ptr_hi                                                                                           !!! #}
{# !!! ta temp_env_ptr+1                                                                                                        !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (song_list_ptr),y                                                                                                     !!! #}
{% if FAMISTUDIO_DUAL_SUPPORT                                                                                                  %} {#  Dual mode #}
{# !!! dx famistudio_pal_adjust                                                                                                 !!! #}
{# !!! ne @ntsc_target                                                                                                          !!! #}
{# !!! ra #1                                                                                                                    !!! #}
{# !!! ntsc_target:                                                                                                             !!! #}
{% elif FAMISTUDIO_CFG_PAL_SUPPORT                                                                                               %} {#  PAL only #}
{# !!! ra #1                                                                                                                    !!! #}
{% endif 120 %}
{# !!! ax                                                                                                                       !!! #}
{# !!! da famistudio_tempo_frame_lookup, x ; Lookup contains the number of frames to run (0,1,2) to maintain tempo              !!! #}
{# !!! ta famistudio_tempo_frame_num                                                                                            !!! #}
{# !!! dy #0                                                                                                                    !!! #}
{# !!! ty famistudio_tempo_env_idx                                                                                              !!! #}
{# !!! da (temp_env_ptr),y                                                                                                      !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc #1                                                                                                                    !!! #}
{# !!! ta famistudio_tempo_env_counter                                                                                          !!! #}
{# !!! da #6                                                                                                                    !!! #}
{# !!! ta famistudio_song_speed ; Non-zero simply so the song isnt considered paused.                                           !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_VRC7                                                                                                      %}
{# !!! da #0                                                                                                                    !!! #}
{# !!! dx #5                                                                                                                    !!! #}
{# !!! clear_vrc7_loop:                                                                                                         !!! #}
{# !!! ta famistudio_chn_vrc7_prev_hi, x                                                                                        !!! #}
{# !!! ta famistudio_chn_vrc7_patch, x                                                                                          !!! #}
{# !!! ta famistudio_chn_vrc7_trigger,x                                                                                         !!! #}
{# !!! ex                                                                                                                       !!! #}
{# !!! pl @clear_vrc7_loop                                                                                                      !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{% if FAMISTUDIO_EXP_EPSM_TRIG_CHN > 0                                                                                         %}
{# !!! da #0                                                                                                                    !!! #}
{# !!! dx #FAMISTUDIO_EXP_EPSM_FM_CHN_CNT + FAMISTUDIO_EXP_EPSM_RHYTHM_CNT - 1                                                  !!! #}
{# !!! clear_epsm_loop:                                                                                                         !!! #}
{# !!! ta famistudio_chn_epsm_trigger,x                                                                                         !!! #}
{# !!! ex                                                                                                                       !!! #}
{# !!! pl @clear_epsm_loop                                                                                                      !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0                                                                                      %}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_epsm_env_period_lo                                                                                         !!! #}
{# !!! ta famistudio_epsm_env_period_hi                                                                                         !!! #}
{# !!! ta famistudio_epsm_env_override                                                                                          !!! #}
{# !!! dx #(FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT - 1)                                                                                !!! #}
{# !!! clear_epsm_sq_loop:                                                                                                      !!! #}
{# !!! ta famistudio_epsm_chn_env_shape, x                                                                                      !!! #}
{# !!! ta famistudio_epsm_chn_env_octave, x                                                                                     !!! #}
{# !!! ex                                                                                                                       !!! #}
{# !!! pl @clear_epsm_sq_loop                                                                                                   !!! #}
{% endif 120 %}
{% endif 120 %}

{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_vrc6_saw_volume                                                                                            !!! #}
    {% if FAMISTUDIO_USE_PHASE_RESET                                                                                               %}
{# !!! ta famistudio_vrc6_pulse1_prev_hi                                                                                        !!! #}
{# !!! ta famistudio_vrc6_pulse2_prev_hi                                                                                        !!! #}
{# !!! ta famistudio_vrc6_saw_prev_hi                                                                                           !!! #}
    {% endif 120 %}
{% endif 120 %}

{% if FAMISTUDIO_USE_PHASE_RESET                                                                                               %}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_phase_reset                                                                                                !!! #}
    {% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! ta famistudio_phase_reset_n163                                                                                           !!! #}
    {% endif 120 %}
{% endif 120 %}

{% if FAMISTUDIO_USE_DELTA_COUNTER                                                                                             %}
{# !!! da #$ff                                                                                                                  !!! #}
{# !!! ta famistudio_dmc_delta_counter                                                                                          !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_fds_mod_speed+0                                                                                            !!! #}
{# !!! ta famistudio_fds_mod_speed+1                                                                                            !!! #}
{# !!! ta famistudio_fds_mod_depth                                                                                              !!! #}
{# !!! ta famistudio_fds_mod_delay                                                                                              !!! #}
{# !!! ta famistudio_fds_mod_delay_counter                                                                                      !!! #}
{# !!! ta famistudio_fds_override_flags                                                                                         !!! #}
    {% if FAMISTUDIO_USE_FDS_AUTOMOD                                                                                               %}
{# !!! ta famistudio_fds_automod_numer                                                                                          !!! #}
{# !!! ta famistudio_fds_automod_denom                                                                                          !!! #}
    {% endif 120 %}
    {% if FAMISTUDIO_USE_PHASE_RESET                                                                                               %}
{# !!! ta famistudio_fds_prev_hi                                                                                                !!! #}
    {% endif 120 %}
{% endif 120 %}

{% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! da #0                                                                                                                    !!! #}
{# !!! dx #(FAMISTUDIO_EXP_N163_CHN_CNT - 1)                                                                                    !!! #}
{# !!! clear_n163_loop:                                                                                                         !!! #}
{# !!! ta famistudio_chn_n163_wave_index, x                                                                                     !!! #}
{# !!! ta famistudio_chn_n163_wave_len, x                                                                                       !!! #}
{# !!! ex                                                                                                                       !!! #}
{# !!! pl @clear_n163_loop                                                                                                      !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_S5B                                                                                                       %}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_s5b_env_period_lo                                                                                          !!! #}
{# !!! ta famistudio_s5b_env_period_hi                                                                                          !!! #}
{# !!! ta famistudio_s5b_env_override                                                                                           !!! #}
{# !!! ta famistudio_s5b_chn_env_shape+0                                                                                        !!! #}
{# !!! ta famistudio_s5b_chn_env_shape+1                                                                                        !!! #}
{# !!! ta famistudio_s5b_chn_env_shape+2                                                                                        !!! #}
{# !!! ta famistudio_s5b_chn_env_octave+0                                                                                       !!! #}
{# !!! ta famistudio_s5b_chn_env_octave+1                                                                                       !!! #}
{# !!! ta famistudio_s5b_chn_env_octave+2                                                                                       !!! #}
{% endif 120 %}

{# !!! skip:                                                                                                                    !!! #}
{# !!! ts                                                                                                                       !!! #}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_MUSIC_PAUSE (public)                                                                                         #}
{#                                                                                                                          #}
{#  Pause/unpause the currently playing song. Note that this will not update the APU, so sound might linger. Calling        #}
{#  famistudio_update after this will update the APU.                                                                       #}
{#                                                                                                                          #}
{#  [in] a : zero to play, non-zero to pause.                                                                               #}
{# ======================================================================================================================   #}

{# !!! amistudio_music_pause:                                                                                                   !!! #}

{# !!! ax                                                                                                                       !!! #}
{# !!! eq @unpause                                                                                                              !!! #}

{# !!! pause:                                                                                                                   !!! #}

{# !!! sr famistudio_sample_stop                                                                                                !!! #}

{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                    !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                    !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                    !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_CH3_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                    !!! #}
{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! ta famistudio_env_value+FAMISTUDIO_VRC6_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_VRC6_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_VRC6_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_VRC7                                                                                                      %}
{# !!! ta famistudio_env_value+FAMISTUDIO_VRC7_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_VRC7_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_VRC7_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_VRC7_CH3_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_VRC7_CH4_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_VRC7_CH5_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! ta famistudio_env_value+FAMISTUDIO_FDS_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_MMC5                                                                                                      %}
{# !!! ta famistudio_env_value+FAMISTUDIO_MMC5_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_MMC5_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! ta famistudio_env_value+FAMISTUDIO_N163_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_N163_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_N163_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_N163_CH3_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_N163_CH4_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_N163_CH5_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_N163_CH6_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_N163_CH7_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_S5B                                                                                                       %}
{# !!! ta famistudio_env_value+FAMISTUDIO_S5B_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_S5B_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_S5B_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 0                                                                                          %}
{# !!! ta famistudio_env_value+FAMISTUDIO_EPSM_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 1                                                                                          %}
{# !!! ta famistudio_env_value+FAMISTUDIO_EPSM_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 2                                                                                          %}
{# !!! ta famistudio_env_value+FAMISTUDIO_EPSM_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 3                                                                                          %}
{# !!! ta famistudio_env_value+FAMISTUDIO_EPSM_CH3_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 4                                                                                          %}
{# !!! ta famistudio_env_value+FAMISTUDIO_EPSM_CH4_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 5                                                                                          %}
{# !!! ta famistudio_env_value+FAMISTUDIO_EPSM_CH5_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 6                                                                                          %}
{# !!! ta famistudio_env_value+FAMISTUDIO_EPSM_CH6_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 7                                                                                          %}
{# !!! ta famistudio_env_value+FAMISTUDIO_EPSM_CH7_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 8                                                                                          %}
{# !!! ta famistudio_env_value+FAMISTUDIO_EPSM_CH8_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                               !!! #}
{% endif 120 %}
{% endif 120 %}
{# !!! da famistudio_song_speed ; <= 0 pauses the music                                                                         !!! #}
{# !!! ra #$80                                                                                                                  !!! #}
{# !!! ne @done                                                                                                                 !!! #}
{# !!! unpause:                                                                                                                 !!! #}
{# !!! da famistudio_song_speed ; > 0 unpause music                                                                             !!! #}
{# !!! nd #$7f                                                                                                                  !!! #}
{# !!! done:                                                                                                                    !!! #}
{# !!! ta famistudio_song_speed                                                                                                 !!! #}

{# !!! ts                                                                                                                       !!! #}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_GET_NOTE_PITCH_MACRO (internal)                                                                              #}
{#                                                                                                                          #}
{#  Uber-macro used to compute the final pitch of a note, taking into account the current note, arpeggios, instrument       #}
{#  pitch envelopes, slide notes and fine pitch tracks.                                                                     #}
{#                                                                                                                          #}
{#  [in] x : note index.                                                                                                    #}
{#  [in] y : slide/pitch envelope index.                                                                                    #}
{#  [out] famistudio_ptr1 : Final note pitch.                                                                               #}
{# ======================================================================================================================   #}

{# !!! macro famistudio_get_note_pitch_macro pitch_env_offset, pitch_shift, note_table_lsb, note_table_msb                      !!! #}

{# !!! itch   = famistudio_ptr1                                                                                                 !!! #}
{# !!! mp_ror = famistudio_r0                                                                                                   !!! #}

{% if FAMISTUDIO_USE_PITCH_TRACK                                                                                               %}

{#  Pitch envelope + fine pitch (sign extended)                                                                             #}
{# !!! lc                                                                                                                       !!! #}
{# !!! da famistudio_pitch_env_fine_value+pitch_env_offset, y                                                                   !!! #}
{# !!! dc famistudio_pitch_env_value_lo+pitch_env_offset, y                                                                     !!! #}
{# !!! ta pitch+0                                                                                                               !!! #}
{# !!! da famistudio_pitch_env_fine_value+pitch_env_offset, y                                                                   !!! #}
{# !!! nd #$80                                                                                                                  !!! #}
{# !!! eq pos                                                                                                                   !!! #}
{# !!! da #$ff                                                                                                                  !!! #}
{# !!! os:                                                                                                                      !!! #}
{# !!! dc famistudio_pitch_env_value_hi+pitch_env_offset, y                                                                     !!! #}
{# !!! ta pitch+1                                                                                                               !!! #}

{% else 120 %}

{#  Pitch envelope only                                                                                                     #}
{# !!! da famistudio_pitch_env_value_lo+pitch_env_offset, y                                                                     !!! #}
{# !!! ta pitch+0                                                                                                               !!! #}
{# !!! da famistudio_pitch_env_value_hi+pitch_env_offset, y                                                                     !!! #}
{# !!! ta pitch+1                                                                                                               !!! #}

{% endif 120 %}

{% if FAMISTUDIO_USE_SLIDE_NOTES                                                                                               %}

{#  Check if there is an active slide.                                                                                      #}
{# !!! da famistudio_slide_step+pitch_env_offset, y                                                                             !!! #}
{# !!! eq no_slide                                                                                                              !!! #}

{#  Add slide                                                                                                               #}
{% if pitch_shift >= 1                                                                                                         %}
{#  These channels dont have fractional part for slides and have the same shift for slides + pitch.                         #}
{# !!! lc                                                                                                                       !!! #}
{# !!! da famistudio_slide_pitch_lo+pitch_env_offset, y                                                                         !!! #}
{# !!! dc pitch+0                                                                                                               !!! #}
{# !!! ta pitch+0                                                                                                               !!! #}
{# !!! da famistudio_slide_pitch_hi+pitch_env_offset, y                                                                         !!! #}
{# !!! dc pitch+1                                                                                                               !!! #}
{# !!! ta pitch+1                                                                                                               !!! #}
 {% else 120 %}
{#  Most channels have 1 bit of fraction for slides.                                                                        #}
{# !!! da famistudio_slide_pitch_hi+pitch_env_offset, y                                                                         !!! #}
{# !!! mp #$80 ; Sign extend upcoming right shift.                                                                              !!! #}
{# !!! or ; We have 1 bit of fraction for slides, shift right hi byte.                                                          !!! #}
{# !!! ta tmp_ror                                                                                                               !!! #}
{# !!! da famistudio_slide_pitch_lo+pitch_env_offset, y                                                                         !!! #}
{# !!! or ; Shift right low byte.                                                                                               !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc pitch+0                                                                                                               !!! #}
{# !!! ta pitch+0                                                                                                               !!! #}
{# !!! da tmp_ror                                                                                                               !!! #}
{# !!! dc pitch+1                                                                                                               !!! #}
{# !!! ta pitch+1                                                                                                               !!! #}
{% endif 120 %}
{% endif 120 %}

{# !!! o_slide:                                                                                                                 !!! #}

    {% if pitch_shift >= 1                                                                                                         %}
{# !!! sl pitch+0                                                                                                               !!! #}
{# !!! ol pitch+1                                                                                                               !!! #}
    {% if pitch_shift >= 2                                                                                                         %}
{# !!! sl pitch+0                                                                                                               !!! #}
{# !!! ol pitch+1                                                                                                               !!! #}
    {% if pitch_shift >= 3                                                                                                         %}
{# !!! sl pitch+0                                                                                                               !!! #}
{# !!! ol pitch+1                                                                                                               !!! #}
    {% if pitch_shift >= 4                                                                                                         %}
{# !!! sl pitch+0                                                                                                               !!! #}
{# !!! ol pitch+1                                                                                                               !!! #}
    {% if pitch_shift >= 5                                                                                                         %}
{# !!! sl pitch+0                                                                                                               !!! #}
{# !!! ol pitch+1                                                                                                               !!! #}
    {% endif 120 %}
    {% endif 120 %}
    {% endif 120 %}
    {% endif 120 %}
    {% endif 120 %}

{#  Finally, add note pitch.                                                                                                #}
{# !!! lc                                                                                                                       !!! #}
{# !!! da note_table_lsb,x                                                                                                      !!! #}
{# !!! dc pitch+0                                                                                                               !!! #}
{# !!! ta pitch+0                                                                                                               !!! #}
{# !!! da note_table_msb,x                                                                                                      !!! #}
{# !!! dc pitch+1                                                                                                               !!! #}
{# !!! ta pitch+1                                                                                                               !!! #}

{# !!! endm                                                                                                                     !!! #}

{# !!! amistudio_get_note_pitch:                                                                                                !!! #}
{# !!! amistudio_get_note_pitch_macro 0, 0, famistudio_note_table_lsb, famistudio_note_table_msb                                !!! #}
{# !!! ts                                                                                                                       !!! #}

{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! amistudio_get_note_pitch_vrc6_saw:                                                                                       !!! #}
{# !!! amistudio_get_note_pitch_macro 0, 0, famistudio_saw_note_table_lsb, famistudio_saw_note_table_msb                        !!! #}
{# !!! ts                                                                                                                       !!! #}
{% endif 120 %}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_SMOOTH_VIBRATO (internal)                                                                                    #}
{#                                                                                                                          #}
{#  Implementation of Blaarg's smooth vibrato to eliminate pops on square channels. Called either from regular channel      #}
{#  updates or from SFX code.                                                                                               #}
{#                                                                                                                          #}
{#  [in] a : new hi period.                                                                                                 #}
{# ======================================================================================================================   #}

{# !!! macro famistudio_smooth_vibrato pulse_lo, pulse_prev, reg_hi, reg_lo, reg_sweep                                          !!! #}

{#  Blaarg's smooth vibrato technique, only used if high period delta is 1 or -1.                                           #}
{# !!! nd #7 ; Clamp hi-period to sane range, breaks smooth vibrato otherwise.                                                  !!! #}
{# !!! ax ; X = new hi-period                                                                                                   !!! #}
{# !!! ec                                                                                                                       !!! #}
{# !!! bc pulse_prev ; A = signed hi-period delta.                                                                              !!! #}
{# !!! eq done                                                                                                                  !!! #}
{# !!! tx pulse_prev                                                                                                            !!! #}
{# !!! ay                                                                                                                       !!! #}
{# !!! ny ; We only care about -1 ($ff) and 1. Adding one means we only check of 0 or 2, we already checked for zero (so < 3).  !!! #}
{# !!! py #$03                                                                                                                  !!! #}
{# !!! cs hi_delta_too_big                                                                                                      !!! #}
{# !!! dx #$40                                                                                                                  !!! #}
{# !!! tx FAMISTUDIO_APU_FRAME_CNT ; Reset frame counter in case it was about to clock                                          !!! #}
{# !!! da famistudio_smooth_vibrato_period_lo_lookup, y ; Be sure low 8 bits of timer period are $ff (for positive delta), or $00 (for negative delta) !!! #}
{# !!! ta reg_lo                                                                                                                !!! #}
{# !!! da famistudio_smooth_vibrato_sweep_lookup, y ; Sweep enabled, shift = 7, set negative flag or delta is negative..        !!! #}
{# !!! ta reg_sweep                                                                                                             !!! #}
{# !!! da #$c0                                                                                                                  !!! #}
{# !!! ta FAMISTUDIO_APU_FRAME_CNT ; Clock sweep immediately                                                                    !!! #}
{# !!! da #$08                                                                                                                  !!! #}
{# !!! ta reg_sweep ; Disable sweep                                                                                             !!! #}
{# !!! da pulse_lo                                                                                                              !!! #}
{# !!! ta reg_lo ; Restore lo-period.                                                                                           !!! #}
{# !!! mp done                                                                                                                  !!! #}
{# !!! i_delta_too_big:                                                                                                         !!! #}
{# !!! tx reg_hi                                                                                                                !!! #}
{# !!! one:                                                                                                                     !!! #}
{# !!! endm                                                                                                                     !!! #}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_UPDATE_CHANNEL_SOUND (internal)                                                                              #}
{#                                                                                                                          #}
{#  Uber-macro used to update the APU registers for a given 2A03/VRC6/MMC5 channel. This macro is an absolute mess, but     #}
{#  it is still more maintainable than having many different functions.                                                     #}
{#                                                                                                                          #}
{#  [in] no input params.                                                                                                   #}
{# ======================================================================================================================   #}

{# !!! macro famistudio_update_channel_sound idx, env_offset, pulse_prev, reg_hi, reg_lo, reg_vol, reg_sweep, phase_reset_mask  !!! #}

{# !!! mp   = famistudio_r0                                                                                                     !!! #}
{# !!! itch = famistudio_ptr1                                                                                                   !!! #}

{# !!! da famistudio_chn_note+idx                                                                                               !!! #}
{# !!! ne nocut                                                                                                                 !!! #}
{# !!! mp set_volume                                                                                                            !!! #}

{# !!! ocut:                                                                                                                    !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc famistudio_env_value+env_offset+FAMISTUDIO_ENV_NOTE_OFF                                                               !!! #}

{% if idx = 3                                                                                                                  %} {#  Noise channel is a bit special #}

{% if FAMISTUDIO_USE_NOISE_SLIDE_NOTES                                                                                         %}

{#  Check if there is an active slide on the noise channel.                                                                 #}
{# !!! dy famistudio_slide_step+FAMISTUDIO_NOISE_SLIDE_INDEX                                                                    !!! #}
{# !!! eq no_noise_slide                                                                                                        !!! #}

{#  We have 4 bits of fraction for noise slides.                                                                            #}
{# !!! ta tmp                                                                                                                   !!! #}

{# !!! da famistudio_slide_pitch_lo+FAMISTUDIO_NOISE_SLIDE_INDEX                                                                !!! #}
{# !!! ta pitch+0                                                                                                               !!! #}
{# !!! da famistudio_slide_pitch_hi+FAMISTUDIO_NOISE_SLIDE_INDEX                                                                !!! #}
{# !!! mp #$80                                                                                                                  !!! #}
{# !!! or                                                                                                                       !!! #}
{# !!! or pitch+0                                                                                                               !!! #}
{# !!! mp #$80                                                                                                                  !!! #}
{# !!! or                                                                                                                       !!! #}
{# !!! or pitch+0                                                                                                               !!! #}
{# !!! mp #$80                                                                                                                  !!! #}
{# !!! or                                                                                                                       !!! #}
{# !!! or pitch+0                                                                                                               !!! #}
{# !!! mp #$80                                                                                                                  !!! #}
{# !!! or                                                                                                                       !!! #}
{# !!! da pitch+0                                                                                                               !!! #}
{# !!! or                                                                                                                       !!! #}

{# !!! lc                                                                                                                       !!! #}
{# !!! dc tmp                                                                                                                   !!! #}

{% endif 120 %}

{# !!! o_noise_slide:                                                                                                           !!! #}
{# !!! nd #$0f                                                                                                                  !!! #}
{# !!! or #$0f                                                                                                                  !!! #}
{# !!! ta tmp                                                                                                                   !!! #}

{# !!! dx famistudio_env_value+env_offset+FAMISTUDIO_ENV_DUTY_OFF                                                               !!! #}
{# !!! da famistudio_duty_lookup, x                                                                                             !!! #}
{# !!! sl a                                                                                                                     !!! #}
{# !!! nd #$80                                                                                                                  !!! #}
{# !!! ra tmp                                                                                                                   !!! #}

{% else 120 %}

    {% if FAMISTUDIO_DUAL_SUPPORT                                                                                                  %}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc famistudio_pal_adjust                                                                                                 !!! #}
    {% endif 120 %}
{# !!! ax                                                                                                                       !!! #}

{#  This basically does same as "famistudio_channel_to_pitch_env"                                                           #}
    {% if idx < 3                                                                                                                  %}
{# !!! dy #idx                                                                                                                  !!! #}
    {% else 120 %}
{# !!! dy #(idx - 2)                                                                                                            !!! #}
    {% endif 120 %}

    {% if FAMISTUDIO_EXP_VRC6 && idx = FAMISTUDIO_VRC6_CH2_IDX                                                                     %}
{# !!! sr famistudio_get_note_pitch_vrc6_saw                                                                                    !!! #}
    {% else 120 %}
{# !!! sr famistudio_get_note_pitch                                                                                             !!! #}
    {% endif 120 %}

{# !!! da pitch+0                                                                                                               !!! #}
{# !!! ta reg_lo                                                                                                                !!! #}
{# !!! da pitch+1                                                                                                               !!! #}

{#  HACK : VRC6 only. We are out of macro param for NESASM. TODO : Is that still true?                                      #}
    {% if idx >= FAMISTUDIO_VRC6_CH0_IDX && idx <= FAMISTUDIO_VRC6_CH2_IDX                                                         %}
        {% if FAMISTUDIO_USE_PHASE_RESET                                                                                               %}
{# !!! ta pulse_prev                                                                                                            !!! #}
        {% endif 120 %}
{# !!! ra #$80                                                                                                                  !!! #}
    {% else 120 %}
        {% if pulse_prev && (!FAMISTUDIO_CFG_SFX_SUPPORT || !reg_sweep)                                                                %}
            {% if reg_sweep && FAMISTUDIO_CFG_SMOOTH_VIBRATO                                                                               %}
{# !!! amistudio_smooth_vibrato famistudio_ptr1, pulse_prev, reg_hi, reg_lo, reg_sweep                                          !!! #}
            {% else 120 %}
{# !!! mp pulse_prev                                                                                                            !!! #}
{# !!! eq compute_volume                                                                                                        !!! #}
{# !!! ta pulse_prev                                                                                                            !!! #}
            {% endif 120 %}
        {% endif 120 %}
    {% endif 120 %}

{% endif 120 %} {#  idx = 3 #}

{% if (!pulse_prev) || (!reg_sweep) || FAMISTUDIO_CFG_SFX_SUPPORT || (!FAMISTUDIO_CFG_SMOOTH_VIBRATO)                          %}
{# !!! ta reg_hi                                                                                                                !!! #}
{% endif 120 %}

{# !!! ompute_volume:                                                                                                           !!! #}

    {% if FAMISTUDIO_USE_VOLUME_TRACK                                                                                              %}
{# !!! da famistudio_chn_volume_track+idx                                                                                       !!! #}
        {% if FAMISTUDIO_USE_VOLUME_SLIDES                                                                                             %}
{#  During a slide, the lower 4 bits are fraction.                                                                          #}
{# !!! nd #$f0                                                                                                                  !!! #}
        {% endif 120 %}
{# !!! ra famistudio_env_value+env_offset+FAMISTUDIO_ENV_VOLUME_OFF                                                             !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! da famistudio_volume_table, x                                                                                            !!! #}
    {% else 120 %}
{# !!! da famistudio_env_value+env_offset+FAMISTUDIO_ENV_VOLUME_OFF                                                             !!! #}
    {% endif 120 %}

{% if FAMISTUDIO_EXP_VRC6 && (idx = FAMISTUDIO_VRC6_CH2_IDX)                                                                   %}
{#  VRC6 saw has 6-bits                                                                                                     #}
{# !!! dx famistudio_vrc6_saw_volume                                                                                            !!! #}
{# !!! mi set_volume                                                                                                            !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! dx famistudio_vrc6_saw_volume                                                                                            !!! #}
{# !!! eq set_volume                                                                                                            !!! #}
{# !!! sl                                                                                                                       !!! #}
{% endif 120 %}

{# !!! et_volume:                                                                                                               !!! #}

{% if idx = 0 || idx = 1 || idx = 3 || (FAMISTUDIO_EXP_MMC5 && (idx = FAMISTUDIO_MMC5_CH0_IDX || idx = FAMISTUDIO_MMC5_CH1_IDX)) %}
{# !!! dx famistudio_env_value+env_offset+FAMISTUDIO_ENV_DUTY_OFF                                                               !!! #}
{# !!! ra famistudio_duty_lookup, x                                                                                             !!! #}
{% elif FAMISTUDIO_EXP_VRC6 && (idx = FAMISTUDIO_VRC6_CH0_IDX || idx = FAMISTUDIO_VRC6_CH1_IDX)                                  %}
{# !!! dx famistudio_env_value+env_offset+FAMISTUDIO_ENV_DUTY_OFF                                                               !!! #}
{# !!! ra famistudio_vrc6_duty_lookup, x                                                                                        !!! #}
{% endif 120 %}

{#  HACK : We are out of macro param for NESASM.                                                                            #}
{% if idx = 2                                                                                                                  %}
{# !!! ra #$80                                                                                                                  !!! #}
{% elif idx = 3                                                                                                                  %}
{# !!! ra #$f0                                                                                                                  !!! #}
{% endif 120 %}

{# !!! ta reg_vol                                                                                                               !!! #}

{# !!! endm                                                                                                                     !!! #}

{% if FAMISTUDIO_EXP_FDS                                                                                                       %}

{% if FAMISTUDIO_USE_FDS_AUTOMOD                                                                                               %}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_MUL (internal)                                                                                               #}
{#                                                                                                                          #}
{#  From : https://codebase64.org/doku.php?id=base:8bit_multiplication_16bit_product                                        #}
{#  Using the 16x8 version. May overflow if using too large numbers.                                                        #}
{#                                                                                                                          #}
{#  [in]  ptr0 : 16-bit number                                                                                              #}
{#  [in]  r1   : 8-bit number                                                                                               #}
{#  [out] x+a  : Result lo-byte                                                                                             #}
{#  [out] y    : Result hi-byte                                                                                             #}
{# ======================================================================================================================   #}

{# !!! amistudio_mul:                                                                                                           !!! #}

{# !!! um1 = famistudio_ptr1                                                                                                    !!! #}
{# !!! um2 = famistudio_r1                                                                                                      !!! #}

{# !!! da #$00                                                                                                                  !!! #}
{# !!! ay                                                                                                                       !!! #}
{# !!! eq @enter_loop                                                                                                           !!! #}
{# !!! do_add:                                                                                                                  !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc num1+0                                                                                                                !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! ya                                                                                                                       !!! #}
{# !!! dc num1+1                                                                                                                !!! #}
{# !!! ay                                                                                                                       !!! #}
{# !!! xa                                                                                                                       !!! #}
{# !!! loop:                                                                                                                    !!! #}
{# !!! sl num1+0                                                                                                                !!! #}
{# !!! ol num1+1                                                                                                                !!! #}
{# !!! enter_loop:                                                                                                              !!! #}
{# !!! sr num2                                                                                                                  !!! #}
{# !!! cs @do_add                                                                                                               !!! #}
{# !!! ne @loop                                                                                                                 !!! #}
{# !!! ts                                                                                                                       !!! #}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_DIV (internal)                                                                                               #}
{#                                                                                                                          #}
{#  From : https://forums.nesdev.org/viewtopic.php?p=895&sid=5c263dea8d9e3cf15cd1093856f211a9#p895 (tepples)                #}
{#                                                                                                                          #}
{#  [in]  ptr0 : 16-bit number                                                                                              #}
{#  [in]  r1   : 8-bit divisor                                                                                              #}
{#  [out] ptr0 : Result                                                                                                     #}
{#  [out] a    : Remainder                                                                                                  #}
{# ======================================================================================================================   #}

{# !!! amistudio_div:                                                                                                           !!! #}

{# !!! ividend = famistudio_ptr1                                                                                                !!! #}
{# !!! ivisor  = famistudio_r1                                                                                                  !!! #}

{# !!! dx #16                                                                                                                   !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! divloop:                                                                                                                 !!! #}
{# !!! sl dividend                                                                                                              !!! #}
{# !!! ol dividend+1                                                                                                            !!! #}
{# !!! ol a                                                                                                                     !!! #}
{# !!! mp divisor                                                                                                               !!! #}
{# !!! cc @no_sub                                                                                                               !!! #}
{# !!! bc divisor                                                                                                               !!! #}
{# !!! nc dividend                                                                                                              !!! #}
{# !!! no_sub:                                                                                                                  !!! #}
{# !!! ex                                                                                                                       !!! #}
{# !!! ne @divloop                                                                                                              !!! #}
{# !!! ts                                                                                                                       !!! #}

{% endif 120 %}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_UPDATE_FDS_CHANNEL_SOUND (internal)                                                                          #}
{#                                                                                                                          #}
{#  Updates the FDS audio registers.                                                                                        #}
{#                                                                                                                          #}
{#  [in] no input params.                                                                                                   #}
{# ======================================================================================================================   #}

{# !!! amistudio_update_fds_channel_sound:                                                                                      !!! #}

{# !!! itch = famistudio_ptr1                                                                                                   !!! #}
{# !!! ul   = famistudio_r1                                                                                                     !!! #}
{# !!! iv   = famistudio_r1                                                                                                     !!! #}

{# !!! da famistudio_chn_note+FAMISTUDIO_FDS_CH0_IDX                                                                            !!! #}
{# !!! ne @nocut                                                                                                                !!! #}
{# !!! mp @set_volume                                                                                                           !!! #}

{# !!! nocut:                                                                                                                   !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc famistudio_env_value+FAMISTUDIO_FDS_CH0_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                  !!! #}
    {% if FAMISTUDIO_DUAL_SUPPORT                                                                                                  %}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc famistudio_pal_adjust                                                                                                 !!! #}
    {% endif 120 %}
{# !!! ax                                                                                                                       !!! #}

{# !!! dy #0                                                                                                                    !!! #}
{# !!! amistudio_get_note_pitch_macro FAMISTUDIO_FDS_CH0_PITCH_ENV_IDX, 0, famistudio_fds_note_table_lsb, famistudio_fds_note_table_msb !!! #}

{# !!! da pitch+0                                                                                                               !!! #}
{# !!! ta FAMISTUDIO_FDS_FREQ_LO                                                                                                !!! #}
{# !!! da pitch+1                                                                                                               !!! #}
{# !!! ta FAMISTUDIO_FDS_FREQ_HI                                                                                                !!! #}
    {% if FAMISTUDIO_USE_PHASE_RESET                                                                                               %}
{# !!! ta famistudio_fds_prev_hi                                                                                                !!! #}
    {% endif 120 %}

{# !!! check_mod_delay:                                                                                                         !!! #}
{# !!! da famistudio_fds_mod_delay_counter                                                                                      !!! #}
{# !!! eq @zero_delay                                                                                                           !!! #}
{# !!! ec famistudio_fds_mod_delay_counter                                                                                      !!! #}
{# !!! da #$80                                                                                                                  !!! #}
{# !!! ta FAMISTUDIO_FDS_MOD_HI                                                                                                 !!! #}
{# !!! ne @compute_volume                                                                                                       !!! #}

{# !!! zero_delay:                                                                                                              !!! #}

{# !!! da famistudio_fds_mod_depth                                                                                              !!! #}
{# !!! eq @mod_depth                                                                                                            !!! #}

    {% if FAMISTUDIO_USE_FDS_AUTOMOD                                                                                               %}
{# !!! da famistudio_fds_automod_numer                                                                                          !!! #}
{# !!! eq @manual_mod                                                                                                           !!! #}

{# !!! auto_mod_mul_div:                                                                                                        !!! #}
{# !!! ta mul                                                                                                                   !!! #}
{# !!! sr famistudio_mul                                                                                                        !!! #}
{# !!! tx pitch+0                                                                                                               !!! #}
{# !!! ty pitch+1                                                                                                               !!! #}
{# !!! da famistudio_fds_automod_denom                                                                                          !!! #}
{# !!! ta div                                                                                                                   !!! #}
{# !!! sr famistudio_div                                                                                                        !!! #}
{# !!! da pitch+1                                                                                                               !!! #}
{# !!! mp #$10                                                                                                                  !!! #}
{# !!! cc @write_auto_mod                                                                                                       !!! #}
{# !!! write_max:                                                                                                               !!! #}
{# !!! da #$0f                                                                                                                  !!! #}
{# !!! ta FAMISTUDIO_FDS_MOD_HI                                                                                                 !!! #}
{# !!! da #$ff                                                                                                                  !!! #}
{# !!! ta FAMISTUDIO_FDS_MOD_LO                                                                                                 !!! #}
{# !!! mp @mod_depth                                                                                                            !!! #}

{# !!! write_auto_mod:                                                                                                          !!! #}
{# !!! ta FAMISTUDIO_FDS_MOD_HI                                                                                                 !!! #}
{# !!! da pitch+0                                                                                                               !!! #}
{# !!! ta FAMISTUDIO_FDS_MOD_LO                                                                                                 !!! #}
{# !!! mp @mod_depth                                                                                                            !!! #}
    {% endif 120 %}

{# !!! manual_mod:                                                                                                              !!! #}
{# !!! da famistudio_fds_mod_speed+1                                                                                            !!! #}
{# !!! ta FAMISTUDIO_FDS_MOD_HI                                                                                                 !!! #}
{# !!! da famistudio_fds_mod_speed+0                                                                                            !!! #}
{# !!! ta FAMISTUDIO_FDS_MOD_LO                                                                                                 !!! #}

{# !!! mod_depth:                                                                                                               !!! #}
{# !!! da famistudio_fds_mod_depth                                                                                              !!! #}
{# !!! ra #$80                                                                                                                  !!! #}
{# !!! ta FAMISTUDIO_FDS_SWEEP_ENV                                                                                              !!! #}

{# !!! compute_volume:                                                                                                          !!! #}
    {% if FAMISTUDIO_USE_VOLUME_TRACK                                                                                              %}
{# !!! da famistudio_chn_volume_track+FAMISTUDIO_FDS_CH0_IDX                                                                    !!! #}
        {% if FAMISTUDIO_USE_VOLUME_SLIDES                                                                                             %}
{#  During a slide, the lower 4 bits are fraction.                                                                          #}
{# !!! nd #$f0                                                                                                                  !!! #}
        {% endif 120 %}
{# !!! ra famistudio_env_value+FAMISTUDIO_FDS_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! da famistudio_volume_table, x                                                                                            !!! #}
    {% else 120 %}
{# !!! da famistudio_env_value+FAMISTUDIO_FDS_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                !!! #}
    {% endif 120 %}
{# !!! sl ; FDS volume is 6-bits, but clamped to 32. Just double it.                                                            !!! #}

{# !!! set_volume:                                                                                                              !!! #}
{# !!! ra #$80                                                                                                                  !!! #}
{# !!! ta FAMISTUDIO_FDS_VOL_ENV                                                                                                !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_fds_override_flags                                                                                         !!! #}
{# !!! ts                                                                                                                       !!! #}

{% endif 120 %}

{% if FAMISTUDIO_EXP_VRC7                                                                                                      %}

{# !!! amistudio_vrc7_reg_table_lo:                                                                                             !!! #}
{# !!! byte FAMISTUDIO_VRC7_REG_LO_1, FAMISTUDIO_VRC7_REG_LO_2, FAMISTUDIO_VRC7_REG_LO_3, FAMISTUDIO_VRC7_REG_LO_4, FAMISTUDIO_VRC7_REG_LO_5, FAMISTUDIO_VRC7_REG_LO_6 !!! #}
{# !!! amistudio_vrc7_reg_table_hi:                                                                                             !!! #}
{# !!! byte FAMISTUDIO_VRC7_REG_HI_1, FAMISTUDIO_VRC7_REG_HI_2, FAMISTUDIO_VRC7_REG_HI_3, FAMISTUDIO_VRC7_REG_HI_4, FAMISTUDIO_VRC7_REG_HI_5, FAMISTUDIO_VRC7_REG_HI_6 !!! #}
{# !!! amistudio_vrc7_vol_table:                                                                                                !!! #}
{# !!! byte FAMISTUDIO_VRC7_REG_VOL_1, FAMISTUDIO_VRC7_REG_VOL_2, FAMISTUDIO_VRC7_REG_VOL_3, FAMISTUDIO_VRC7_REG_VOL_4, FAMISTUDIO_VRC7_REG_VOL_5, FAMISTUDIO_VRC7_REG_VOL_6 !!! #}
{# !!! amistudio_vrc7_env_table:                                                                                                !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH0_ENVS, FAMISTUDIO_VRC7_CH1_ENVS, FAMISTUDIO_VRC7_CH2_ENVS, FAMISTUDIO_VRC7_CH3_ENVS, FAMISTUDIO_VRC7_CH4_ENVS, FAMISTUDIO_VRC7_CH5_ENVS !!! #}
{# !!! amistudio_vrc7_invert_vol_table:                                                                                         !!! #}
{# !!! byte $0f, $0e, $0d, $0c, $0b, $0a, $09, $08, $07, $06, $05, $04, $03, $02, $01, $00                                      !!! #}

{#  From nesdev wiki.                                                                                                       #}
{# !!! amistudio_vrc7_wait_reg_write:                                                                                           !!! #}
{# !!! tx famistudio_vrc7_dummy                                                                                                 !!! #}
{# !!! dx #$08                                                                                                                  !!! #}
{# !!! wait_loop:                                                                                                               !!! #}
{# !!! ex                                                                                                                       !!! #}
{# !!! ne @wait_loop                                                                                                            !!! #}
{# !!! dx famistudio_vrc7_dummy                                                                                                 !!! #}
{# !!! ts                                                                                                                       !!! #}

{#  From nesdev wiki.                                                                                                       #}
{# !!! amistudio_vrc7_wait_reg_select:                                                                                          !!! #}
{# !!! ts                                                                                                                       !!! #}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_UPDATE_VRC7_CHANNEL_SOUND (internal)                                                                         #}
{#                                                                                                                          #}
{#  Updates the VRC7 audio registers for a given channel.                                                                   #}
{#                                                                                                                          #}
{#  [in] y: VRC7 channel idx (0,1,2,3,4,5)                                                                                  #}
{# ======================================================================================================================   #}

{# !!! amistudio_update_vrc7_channel_sound:                                                                                     !!! #}

{# !!! mp   = famistudio_r0                                                                                                     !!! #}
{# !!! itch = famistudio_ptr1                                                                                                   !!! #}

{# !!! heck_cut:                                                                                                                !!! #}
{# !!! da famistudio_chn_note+FAMISTUDIO_VRC7_CH0_IDX,y                                                                         !!! #}
{# !!! ne check_release                                                                                                         !!! #}

{# !!! ut:                                                                                                                      !!! #}
{#  Untrigger note.                                                                                                         #}
{# !!! da famistudio_vrc7_reg_table_hi,y                                                                                        !!! #}
{# !!! ta FAMISTUDIO_VRC7_REG_SEL                                                                                               !!! #}
{# !!! sr famistudio_vrc7_wait_reg_select                                                                                       !!! #}

{# !!! da famistudio_chn_vrc7_prev_hi, y                                                                                        !!! #}
{# !!! nd #$cf ; Remove trigger + sustain                                                                                       !!! #}
{# !!! ta famistudio_chn_vrc7_prev_hi, y                                                                                        !!! #}
{# !!! ta FAMISTUDIO_VRC7_REG_WRITE                                                                                             !!! #}
{# !!! sr famistudio_vrc7_wait_reg_write                                                                                        !!! #}

{# !!! ts                                                                                                                       !!! #}

{# !!! heck_release:                                                                                                            !!! #}

{# !!! da famistudio_chn_vrc7_trigger,y                                                                                         !!! #}
{# !!! pl check_attack                                                                                                          !!! #}

{# !!! elease:                                                                                                                  !!! #}

{# !!! da famistudio_chn_vrc7_prev_hi, y                                                                                        !!! #}
{# !!! nd #$ef ; remove trigger                                                                                                 !!! #}
{# !!! ta famistudio_chn_vrc7_prev_hi, y                                                                                        !!! #}
{# !!! mp musical_note                                                                                                          !!! #}

{# !!! heck_attack:                                                                                                             !!! #}

{# !!! da famistudio_chn_vrc7_trigger,y                                                                                         !!! #}
{# !!! nd #1                                                                                                                    !!! #}
{# !!! eq musical_note                                                                                                          !!! #}

{# !!! ttack:                                                                                                                   !!! #}

{# !!! da famistudio_chn_vrc7_prev_hi, y                                                                                        !!! #}
{# !!! nd #$10                                                                                                                  !!! #}
{# !!! eq prev_note_had_release                                                                                                 !!! #}

{#  Two attacks in a row, need to insert a dummy release.                                                                   #}
{# !!! rev_note_had_attack:                                                                                                     !!! #}

{# !!! da famistudio_vrc7_reg_table_hi,y                                                                                        !!! #}
{# !!! ta FAMISTUDIO_VRC7_REG_SEL                                                                                               !!! #}
{# !!! sr famistudio_vrc7_wait_reg_select                                                                                       !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta FAMISTUDIO_VRC7_REG_WRITE                                                                                             !!! #}
{# !!! sr famistudio_vrc7_wait_reg_write                                                                                        !!! #}
{# !!! mp musical_note                                                                                                          !!! #}

{# !!! rev_note_had_release:                                                                                                    !!! #}
{# !!! da famistudio_chn_vrc7_prev_hi, y                                                                                        !!! #}
{# !!! ra #$10                                                                                                                  !!! #}
{# !!! ta famistudio_chn_vrc7_prev_hi, y                                                                                        !!! #}

{# !!! usical_note:                                                                                                             !!! #}

{#  Read/multiply volume                                                                                                    #}
{# !!! dx famistudio_vrc7_env_table,y                                                                                           !!! #}
    {% if FAMISTUDIO_USE_VOLUME_TRACK                                                                                              %}
{# !!! da famistudio_chn_volume_track+FAMISTUDIO_VRC7_CH0_IDX, y                                                                !!! #}
        {% if FAMISTUDIO_USE_VOLUME_SLIDES                                                                                             %}
{#  During a slide, the lower 4 bits are fraction.                                                                          #}
{# !!! nd #$f0                                                                                                                  !!! #}
        {% endif 120 %}
{# !!! ra famistudio_env_value+FAMISTUDIO_ENV_VOLUME_OFF,x                                                                      !!! #}
    {% else 120 %}
{# !!! da famistudio_env_value+FAMISTUDIO_ENV_VOLUME_OFF,x                                                                      !!! #}
    {% endif 120 %}
{# !!! ax                                                                                                                       !!! #}

{#  Write volume                                                                                                            #}
{# !!! da famistudio_vrc7_vol_table,y                                                                                           !!! #}
{# !!! ta FAMISTUDIO_VRC7_REG_SEL                                                                                               !!! #}
{# !!! sr famistudio_vrc7_wait_reg_select                                                                                       !!! #}
    {% if FAMISTUDIO_USE_VOLUME_TRACK                                                                                              %}
{# !!! da famistudio_volume_table,x                                                                                             !!! #}
{# !!! ax                                                                                                                       !!! #}
    {% endif 120 %}
{# !!! da famistudio_vrc7_invert_vol_table,x                                                                                    !!! #}
{# !!! ra famistudio_chn_vrc7_patch,y                                                                                           !!! #}
{# !!! ta FAMISTUDIO_VRC7_REG_WRITE                                                                                             !!! #}
{# !!! sr famistudio_vrc7_wait_reg_write                                                                                        !!! #}

{#  Read note, apply arpeggio                                                                                               #}
{# !!! dx famistudio_vrc7_env_table,y                                                                                           !!! #}
{# !!! da famistudio_chn_note+FAMISTUDIO_VRC7_CH0_IDX,y                                                                         !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc famistudio_env_value+FAMISTUDIO_ENV_NOTE_OFF,x                                                                        !!! #}
{# !!! ax                                                                                                                       !!! #}

{#  Apply pitch envelope, fine pitch & slides                                                                               #}
{# !!! amistudio_get_note_pitch_macro FAMISTUDIO_VRC7_CH0_PITCH_ENV_IDX, FAMISTUDIO_VRC7_PITCH_SHIFT, famistudio_vrc7_note_table_lsb, famistudio_vrc7_note_table_msb !!! #}

{#  Compute octave by dividing by 2 until we are <= 512 (0x100).                                                            #}
{# !!! dx #0                                                                                                                    !!! #}
{# !!! ompute_octave_loop:                                                                                                      !!! #}
{# !!! da pitch+1                                                                                                               !!! #}
{# !!! mp #2                                                                                                                    !!! #}
{# !!! cc octave_done                                                                                                           !!! #}
{# !!! sr                                                                                                                       !!! #}
{# !!! ta pitch+1                                                                                                               !!! #}
{# !!! or pitch+0                                                                                                               !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! mp compute_octave_loop                                                                                                   !!! #}

{# !!! ctave_done:                                                                                                              !!! #}

{#  Write pitch (lo)                                                                                                        #}
{# !!! da famistudio_vrc7_reg_table_lo,y                                                                                        !!! #}
{# !!! ta FAMISTUDIO_VRC7_REG_SEL                                                                                               !!! #}
{# !!! sr famistudio_vrc7_wait_reg_select                                                                                       !!! #}

{# !!! da pitch+0                                                                                                               !!! #}
{# !!! ta FAMISTUDIO_VRC7_REG_WRITE                                                                                             !!! #}
{# !!! sr famistudio_vrc7_wait_reg_write                                                                                        !!! #}

{#  Write pitch (hi)                                                                                                        #}
{# !!! da famistudio_chn_vrc7_prev_hi, y                                                                                        !!! #}
{# !!! nd #$10                                                                                                                  !!! #}
{# !!! ta tmp                                                                                                                   !!! #}

{# !!! da famistudio_vrc7_reg_table_hi,y                                                                                        !!! #}
{# !!! ta FAMISTUDIO_VRC7_REG_SEL                                                                                               !!! #}
{# !!! sr famistudio_vrc7_wait_reg_select                                                                                       !!! #}

{# !!! xa                                                                                                                       !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ra #$20                                                                                                                  !!! #}
{# !!! ra pitch+1                                                                                                               !!! #}
{# !!! ra tmp                                                                                                                   !!! #}
{# !!! ta famistudio_chn_vrc7_prev_hi, y                                                                                        !!! #}
{# !!! ta FAMISTUDIO_VRC7_REG_WRITE                                                                                             !!! #}
{# !!! sr famistudio_vrc7_wait_reg_write                                                                                        !!! #}

{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_chn_vrc7_trigger,y                                                                                         !!! #}

{# !!! ts                                                                                                                       !!! #}

{% endif 120 %}

{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{# !!! M_ENV_OFFSET = FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT*4                                                                         !!! #}
{# !!! HY_ENV_OFFSET = FM_ENV_OFFSET + FAMISTUDIO_EXP_EPSM_FM_CHN_CNT*2                                                         !!! #}
{% if FAMISTUDIO_EXP_EPSM_FM_CHN_CNT > 0                                                                                       %}
{# !!! amistudio_epsm_vol_table_op1:                                                                                            !!! #}
{# !!! byte FAMISTUDIO_EPSM_REG_TL, FAMISTUDIO_EPSM_REG_TL+1, FAMISTUDIO_EPSM_REG_TL+2,FAMISTUDIO_EPSM_REG_TL, FAMISTUDIO_EPSM_REG_TL+1, FAMISTUDIO_EPSM_REG_TL+2 !!! #}
{# !!! amistudio_epsm_vol_table_op2:                                                                                            !!! #}
{# !!! byte FAMISTUDIO_EPSM_REG_TL+8, FAMISTUDIO_EPSM_REG_TL+1+8, FAMISTUDIO_EPSM_REG_TL+2+8,FAMISTUDIO_EPSM_REG_TL+8, FAMISTUDIO_EPSM_REG_TL+1+8, FAMISTUDIO_EPSM_REG_TL+2+8 !!! #}
{# !!! amistudio_epsm_vol_table_op3:                                                                                            !!! #}
{# !!! byte FAMISTUDIO_EPSM_REG_TL+4, FAMISTUDIO_EPSM_REG_TL+1+4, FAMISTUDIO_EPSM_REG_TL+2+4,FAMISTUDIO_EPSM_REG_TL+4, FAMISTUDIO_EPSM_REG_TL+1+4, FAMISTUDIO_EPSM_REG_TL+2+4 !!! #}
{# !!! amistudio_epsm_vol_table_op4:                                                                                            !!! #}
{# !!! byte FAMISTUDIO_EPSM_REG_TL+12, FAMISTUDIO_EPSM_REG_TL+1+12, FAMISTUDIO_EPSM_REG_TL+2+12,FAMISTUDIO_EPSM_REG_TL+12, FAMISTUDIO_EPSM_REG_TL+1+12, FAMISTUDIO_EPSM_REG_TL+2+12 !!! #}
{# !!! amistudio_epsm_fm_vol_table:                                                                                             !!! #}
{# !!! byte $7e, $65, $50, $3f, $32, $27, $1e, $17, $12, $0d, $09, $06, $04, $02, $01, $00                                      !!! #}
{# !!! amistudio_epsm_fm_stereo_reg_table:                                                                                      !!! #}
{# !!! byte $b4,$b5,$b6                                                                                                         !!! #}
{# !!! byte $b4,$b5,$b6                                                                                                         !!! #}
{# !!! amistudio_channel_epsm_chan_table:                                                                                       !!! #}
{# !!! byte $00, $01, $02                                                                                                       !!! #}
{# !!! byte $00, $01, $02                                                                                                       !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_RHYTHM_CNT > 0                                                                                       %}
{# !!! amistudio_epsm_rhythm_key_table:                                                                                         !!! #}
{# !!! byte $01,$02,$04,$08,$10,$20                                                                                             !!! #}
{# !!! amistudio_epsm_rhythm_reg_table:                                                                                         !!! #}
{# !!! byte FAMISTUDIO_EPSM_REG_RHY_BD, FAMISTUDIO_EPSM_REG_RHY_SD, FAMISTUDIO_EPSM_REG_RHY_TC, FAMISTUDIO_EPSM_REG_RHY_HH, FAMISTUDIO_EPSM_REG_RHY_TOM, FAMISTUDIO_EPSM_REG_RHY_RIM !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_FM_CHN_CNT > 0                                                                                       %}
{# !!! amistudio_epsm_reg_table_lo:                                                                                             !!! #}
{# !!! byte FAMISTUDIO_EPSM_REG_FN_LO, FAMISTUDIO_EPSM_REG_FN_LO2, FAMISTUDIO_EPSM_REG_FN_LO3, FAMISTUDIO_EPSM_REG_FN_LO, FAMISTUDIO_EPSM_REG_FN_LO2, FAMISTUDIO_EPSM_REG_FN_LO3 !!! #}
{# !!! amistudio_epsm_reg_table_hi:                                                                                             !!! #}
{# !!! byte FAMISTUDIO_EPSM_REG_FN_HI, FAMISTUDIO_EPSM_REG_FN_HI2, FAMISTUDIO_EPSM_REG_FN_HI3, FAMISTUDIO_EPSM_REG_FN_HI, FAMISTUDIO_EPSM_REG_FN_HI2, FAMISTUDIO_EPSM_REG_FN_HI3 !!! #}
{# !!! amistudio_epsm_vol_table:                                                                                                !!! #}
{# !!! byte FAMISTUDIO_EPSM_REG_VOL_1, FAMISTUDIO_EPSM_REG_VOL_2, FAMISTUDIO_EPSM_REG_VOL_3, FAMISTUDIO_EPSM_REG_VOL_4, FAMISTUDIO_EPSM_REG_VOL_5, FAMISTUDIO_EPSM_REG_VOL_6 !!! #}
{# !!! amistudio_epsm_fm_env_table:                                                                                             !!! #}
{# !!! byte FAMISTUDIO_EPSM_CH0_ENVS + FM_ENV_OFFSET                                                                            !!! #}
{# !!! byte FAMISTUDIO_EPSM_CH0_ENVS + FM_ENV_OFFSET + 2                                                                        !!! #}
{# !!! byte FAMISTUDIO_EPSM_CH0_ENVS + FM_ENV_OFFSET + 4                                                                        !!! #}
{# !!! byte FAMISTUDIO_EPSM_CH0_ENVS + FM_ENV_OFFSET + 6                                                                        !!! #}
{# !!! byte FAMISTUDIO_EPSM_CH0_ENVS + FM_ENV_OFFSET + 8                                                                        !!! #}
{# !!! byte FAMISTUDIO_EPSM_CH0_ENVS + FM_ENV_OFFSET + 10                                                                       !!! #}
{# !!! amistudio_epsm_register_order:                                                                                           !!! #}
{# !!! byte $B0, $B4, $30, $50, $60, $70, $80, $90, $38, $58, $68, $78, $88, $98, $34, $54, $64, $74, $84, $94, $3c, $5c, $6c, $7c, $8c, $9c, $40, $48, $44, $4c, $22 ;40,48,44,4c replaced for not sending data there during instrument updates, !!! #}
{# !!! amistudio_epsm_channel_key_table:                                                                                        !!! #}
{# !!! byte $f0, $f1, $f2, $f4, $f5, $f6                                                                                        !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0                                                                                      %}
{# !!! amistudio_epsm_sqr_reg_table_lo:                                                                                         !!! #}
{# !!! byte FAMISTUDIO_EPSM_REG_LO_A, FAMISTUDIO_EPSM_REG_LO_B, FAMISTUDIO_EPSM_REG_LO_C                                        !!! #}
{# !!! amistudio_epsm_sqr_reg_table_hi:                                                                                         !!! #}
{# !!! byte FAMISTUDIO_EPSM_REG_HI_A, FAMISTUDIO_EPSM_REG_HI_B, FAMISTUDIO_EPSM_REG_HI_C                                        !!! #}
{# !!! amistudio_epsm_square_vol_table:                                                                                         !!! #}
{# !!! byte FAMISTUDIO_EPSM_REG_VOL_A, FAMISTUDIO_EPSM_REG_VOL_B, FAMISTUDIO_EPSM_REG_VOL_C                                     !!! #}
{# !!! amistudio_epsm_square_env_table:                                                                                         !!! #}
{# !!! byte FAMISTUDIO_EPSM_CH0_ENVS, FAMISTUDIO_EPSM_CH1_ENVS, FAMISTUDIO_EPSM_CH2_ENVS                                        !!! #}
{# !!! amistudio_epsm_square_noise_mask:                                                                                        !!! #}
{# !!! byte $08, $10, $20                                                                                                       !!! #}
{% endif 120 %}
{# ======================================================================================================================   #}
{#  FAMISTUDIO_UPDATE_EPSM_SQUARE_CHANNEL_SOUND (internal)                                                                  #}
{#                                                                                                                          #}
{#  Updates the EPSM audio registers for a given channel.                                                                   #}
{#                                                                                                                          #}
{#  [in] y: EPSM channel idx (0,1,2)                                                                                        #}
{# ======================================================================================================================   #}

{% if FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0                                                                                      %}
{# !!! amistudio_update_epsm_square_channel_sound:                                                                              !!! #}

{# !!! itch   = famistudio_ptr1                                                                                                 !!! #}
{# !!! nv_bit = famistudio_ptr1_lo                                                                                              !!! #}

{#  These are shared by all 3 channels.                                                                                     #}
{# !!! nv_period = famistudio_ptr0                                                                                              !!! #}
{# !!! ttack     = famistudio_ptr2                                                                                              !!! #}
{# !!! nv_shape  = famistudio_r1                                                                                                !!! #}
{# !!! nv_octave = famistudio_r2                                                                                                !!! #}
{# !!! oise_freq = famistudio_r3                                                                                                !!! #}

{#  First channel will clear these, last channel will write the registers.                                                  #}
{# !!! py #0                                                                                                                    !!! #}
{# !!! ne @not_first_channel                                                                                                    !!! #}
{# !!! ty env_shape                                                                                                             !!! #}
{# !!! ty noise_freq                                                                                                            !!! #}
{# !!! ty attack                                                                                                                !!! #}
{# !!! da #$80 ; This mean 'manual pitch'                                                                                       !!! #}
{# !!! ty env_octave                                                                                                            !!! #}

{# !!! not_first_channel:                                                                                                       !!! #}
{# !!! dx #0 ; This will fetch volume 0.                                                                                        !!! #}
{# !!! tx env_bit                                                                                                               !!! #}
{# !!! da famistudio_chn_note+FAMISTUDIO_EPSM_CH0_IDX,y                                                                         !!! #}
{# !!! ne @nocut                                                                                                                !!! #}
{# !!! mp @update_volume                                                                                                        !!! #}

{# !!! nocut:                                                                                                                   !!! #}
{#  Store noise if mixer has it enabled                                                                                     #}
{# !!! dx famistudio_epsm_square_env_table,y                                                                                    !!! #}
{# !!! da famistudio_env_value+FAMISTUDIO_ENV_MIXER_IDX_OFF,x                                                                   !!! #}
{# !!! nd famistudio_epsm_square_noise_mask,y                                                                                   !!! #}
{# !!! ne @nonoise                                                                                                              !!! #}
{# !!! da famistudio_env_value+FAMISTUDIO_ENV_NOISE_IDX_OFF,x                                                                   !!! #}
{# !!! ta noise_freq                                                                                                            !!! #}

{# !!! nonoise:                                                                                                                 !!! #}
{# !!! da famistudio_chn_note+FAMISTUDIO_EPSM_CH0_IDX,y                                                                         !!! #}
{#  Read note, apply arpeggio                                                                                               #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dx famistudio_epsm_square_env_table,y                                                                                    !!! #}
{# !!! dc famistudio_env_value+FAMISTUDIO_ENV_NOTE_OFF,x                                                                        !!! #}
{# !!! ax                                                                                                                       !!! #}

{#  Apply pitch envelope, fine pitch & slides                                                                               #}
{# !!! amistudio_get_note_pitch_macro FAMISTUDIO_EPSM_CH0_PITCH_ENV_IDX, 0, famistudio_epsm_s_note_table_lsb, famistudio_epsm_s_note_table_msb !!! #}

{#  Write pitch                                                                                                             #}
{# !!! da famistudio_epsm_sqr_reg_table_lo,y                                                                                    !!! #}
{# !!! ta FAMISTUDIO_EPSM_ADDR                                                                                                  !!! #}
{# !!! da pitch+0                                                                                                               !!! #}
{# !!! ta FAMISTUDIO_EPSM_DATA                                                                                                  !!! #}
{# !!! da famistudio_epsm_sqr_reg_table_hi,y                                                                                    !!! #}
{# !!! ta FAMISTUDIO_EPSM_ADDR                                                                                                  !!! #}
{# !!! da pitch+1                                                                                                               !!! #}
{# !!! ta FAMISTUDIO_EPSM_DATA                                                                                                  !!! #}

{#  Store env shape + period if active.                                                                                     #}
{# !!! da famistudio_epsm_chn_env_shape,y                                                                                       !!! #}
{# !!! nd #$0f                                                                                                                  !!! #}
{# !!! eq @noenv                                                                                                                !!! #}
{# !!! ta env_shape                                                                                                             !!! #}

{#  If bit 7 of any channel is on, well reset the envelope.                                                                 #}
{# !!! da famistudio_epsm_chn_env_shape,y                                                                                       !!! #}
{# !!! ra attack                                                                                                                !!! #}
{# !!! ta attack                                                                                                                !!! #}
{# !!! da famistudio_epsm_chn_env_shape,y                                                                                       !!! #}
{# !!! nd #$0f                                                                                                                  !!! #}
{# !!! ta famistudio_epsm_chn_env_shape,y                                                                                       !!! #}

{#  Store auto-period settings                                                                                              #}
{# !!! da famistudio_epsm_chn_env_octave,y                                                                                      !!! #}
{# !!! ta env_octave                                                                                                            !!! #}
{# !!! mp #$80 ; This mean 'manual pitch'                                                                                       !!! #}
{# !!! eq @manual_period                                                                                                        !!! #}

{# !!! auto_period:                                                                                                             !!! #}
{# !!! da pitch+0                                                                                                               !!! #}
{# !!! ta env_period+0                                                                                                          !!! #}
{# !!! da pitch+1                                                                                                               !!! #}
{# !!! ta env_period+1                                                                                                          !!! #}
{# !!! mp @set_envelope_volume_flag                                                                                             !!! #}

{# !!! manual_period:                                                                                                           !!! #}
{# !!! da famistudio_epsm_env_period_lo                                                                                         !!! #}
{# !!! ta env_period+0                                                                                                          !!! #}
{# !!! da famistudio_epsm_env_period_hi                                                                                         !!! #}
{# !!! ta env_period+1                                                                                                          !!! #}

{# !!! set_envelope_volume_flag:                                                                                                !!! #}
{# !!! da #$10                                                                                                                  !!! #}

{# !!! noenv:                                                                                                                   !!! #}
{# !!! ta env_bit                                                                                                               !!! #}

{#  Read/multiply volume                                                                                                    #}
{# !!! dx famistudio_epsm_square_env_table,y                                                                                    !!! #}
    {% if FAMISTUDIO_USE_VOLUME_TRACK                                                                                              %}
{# !!! da famistudio_chn_volume_track+FAMISTUDIO_EPSM_CH0_IDX, y                                                                !!! #}
        {% if FAMISTUDIO_USE_VOLUME_SLIDES                                                                                             %}
{#  During a slide, the lower 4 bits are fraction.                                                                          #}
{# !!! nd #$f0                                                                                                                  !!! #}
        {% endif 120 %}
{# !!! ra famistudio_env_value+FAMISTUDIO_ENV_VOLUME_OFF,x                                                                      !!! #}
    {% else 120 %}
{# !!! da famistudio_env_value+FAMISTUDIO_ENV_VOLUME_OFF,x                                                                      !!! #}
    {% endif 120 %}
{# !!! ax                                                                                                                       !!! #}

{# !!! update_volume:                                                                                                           !!! #}
{#  Write volume                                                                                                            #}
{# !!! da famistudio_epsm_square_vol_table,y                                                                                    !!! #}
{# !!! ta FAMISTUDIO_EPSM_ADDR                                                                                                  !!! #}
    {% if FAMISTUDIO_USE_VOLUME_TRACK                                                                                              %}
{# !!! da famistudio_volume_table,x                                                                                             !!! #}
{# !!! ra env_bit                                                                                                               !!! #}
    {% else 120 %}
{# !!! xa                                                                                                                       !!! #}
{# !!! ra env_bit                                                                                                               !!! #}
    {% endif 120 %}
{# !!! ta FAMISTUDIO_EPSM_DATA                                                                                                  !!! #}

{# !!! write_shared_registers:                                                                                                  !!! #}
{#  Channel 2 writes all 5 shared registers.                                                                                #}
{# !!! py #(FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT - 1)                                                                                !!! #}
{# !!! ne @done                                                                                                                 !!! #}
{# !!! da env_shape                                                                                                             !!! #}
{# !!! eq @write_shared_noise                                                                                                   !!! #}
{# !!! dx env_octave                                                                                                            !!! #}
{# !!! px #$80                                                                                                                  !!! #}
{# !!! eq @write_shared_env_register                                                                                            !!! #}

{# !!! compute_auto_period:                                                                                                     !!! #}
{# !!! px #0                                                                                                                    !!! #}
{# !!! eq @write_shared_env_register                                                                                            !!! #}
{# !!! pl @positive_octave_loop                                                                                                 !!! #}

{# !!! negative_octave_loop:                                                                                                    !!! #}
{# !!! sl env_period+0                                                                                                          !!! #}
{# !!! ol env_period+1                                                                                                          !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! ne @negative_octave_loop                                                                                                 !!! #}
{# !!! eq @write_shared_env_register                                                                                            !!! #}

{# !!! positive_octave_loop:                                                                                                    !!! #}
{# !!! px #1                                                                                                                    !!! #}
{# !!! ne @do_shift                                                                                                             !!! #}
{# !!! rounding:                                                                                                                !!! #}
{# !!! da env_period+0                                                                                                          !!! #}
{# !!! nd #1                                                                                                                    !!! #}
{# !!! eq @do_shift                                                                                                             !!! #}
{# !!! da env_period+0                                                                                                          !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc #1                                                                                                                    !!! #}
{# !!! ta env_period+0                                                                                                          !!! #}
{# !!! cc @do_shift                                                                                                             !!! #}
{# !!! nc env_period+1                                                                                                          !!! #}
{# !!! do_shift:                                                                                                                !!! #}
{# !!! sr env_period+1                                                                                                          !!! #}
{# !!! or env_period+0                                                                                                          !!! #}
{# !!! ex                                                                                                                       !!! #}
{# !!! ne @positive_octave_loop                                                                                                 !!! #}

{# !!! write_shared_env_register:                                                                                               !!! #}

{#  Envelope period.                                                                                                        #}
{# !!! da #FAMISTUDIO_EPSM_REG_ENV_LO                                                                                           !!! #}
{# !!! ta FAMISTUDIO_EPSM_ADDR                                                                                                  !!! #}
{# !!! da env_period+0                                                                                                          !!! #}
{# !!! ta FAMISTUDIO_EPSM_DATA                                                                                                  !!! #}
{# !!! da #FAMISTUDIO_EPSM_REG_ENV_HI                                                                                           !!! #}
{# !!! ta FAMISTUDIO_EPSM_ADDR                                                                                                  !!! #}
{# !!! da env_period+1                                                                                                          !!! #}
{# !!! ta FAMISTUDIO_EPSM_DATA                                                                                                  !!! #}

{#  Reset envelope if there was an attack.                                                                                  #}
{# !!! da attack                                                                                                                !!! #}
{# !!! pl @write_shared_noise                                                                                                   !!! #}
{# !!! da #FAMISTUDIO_EPSM_REG_SHAPE                                                                                            !!! #}
{# !!! ta FAMISTUDIO_EPSM_ADDR                                                                                                  !!! #}
{# !!! da env_shape                                                                                                             !!! #}
{# !!! ta FAMISTUDIO_EPSM_DATA                                                                                                  !!! #}

{# !!! write_shared_noise:                                                                                                      !!! #}

{#  Tone/noise enabled.                                                                                                     #}
{# !!! da #FAMISTUDIO_EPSM_REG_TONE                                                                                             !!! #}
{# !!! ta FAMISTUDIO_EPSM_ADDR                                                                                                  !!! #}
{% if FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT = 3                                                                                      %}
{# !!! da famistudio_env_value+FAMISTUDIO_EPSM_CH2_ENVS+FAMISTUDIO_ENV_MIXER_IDX_OFF                                            !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ra famistudio_env_value+FAMISTUDIO_EPSM_CH1_ENVS+FAMISTUDIO_ENV_MIXER_IDX_OFF                                            !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ra famistudio_env_value+FAMISTUDIO_EPSM_CH0_ENVS+FAMISTUDIO_ENV_MIXER_IDX_OFF                                            !!! #}
{% elif FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT = 2                                                                                      %}
{# !!! da famistudio_env_value+FAMISTUDIO_EPSM_CH1_ENVS+FAMISTUDIO_ENV_MIXER_IDX_OFF                                            !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ra famistudio_env_value+FAMISTUDIO_EPSM_CH0_ENVS+FAMISTUDIO_ENV_MIXER_IDX_OFF                                            !!! #}
{% else 120 %}
{# !!! da famistudio_env_value+FAMISTUDIO_EPSM_CH0_ENVS+FAMISTUDIO_ENV_MIXER_IDX_OFF                                            !!! #}
{% endif 120 %}
{# !!! ta FAMISTUDIO_EPSM_DATA                                                                                                  !!! #}

{#  Noise freq                                                                                                              #}
{# !!! da #FAMISTUDIO_EPSM_REG_NOISE                                                                                            !!! #}
{# !!! ta FAMISTUDIO_EPSM_ADDR                                                                                                  !!! #}
{# !!! da noise_freq                                                                                                            !!! #}
{# !!! ta FAMISTUDIO_EPSM_DATA                                                                                                  !!! #}

{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_epsm_env_override                                                                                          !!! #}

{# !!! done:                                                                                                                    !!! #}
{# !!! ts                                                                                                                       !!! #}

{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_FM_CHN_CNT > 0                                                                                       %}
{# ======================================================================================================================   #}
{#  FAMISTUDIO_UPDATE_EPSM_FM_CHANNEL_SOUND (internal)                                                                      #}
{#                                                                                                                          #}
{#  Updates the EPSM audio registers for a given channel.                                                                   #}
{#                                                                                                                          #}
{#  [in] y: EPSM channel idx (0,1,2,3,4,5)                                                                                  #}
{# ======================================================================================================================   #}
{# !!! amistudio_update_epsm_fm_channel_sound:                                                                                  !!! #}

{# !!! itch      = famistudio_ptr1                                                                                              !!! #}
{# !!! eg_offset = famistudio_r1                                                                                                !!! #}
{# !!! ol_offset = famistudio_r0                                                                                                !!! #}
{# !!! han_idx   = famistudio_r2                                                                                                !!! #}

{# !!! ty chan_idx                                                                                                              !!! #}
{#  If the writes are done to channels 0-2, use FAMISTUDIO_EPSM_REG_SEL0 if 3-5 use FAMISTUDIO_EPSM_REG_SEL1                #}
{#  This reg_offset stores the difference so we can later load it into x and do sta FAMISTUDIO_EPSM_REG_SEL0, x             #}
{#  to account for the difference                                                                                           #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! py #3                                                                                                                    !!! #}
{# !!! cc @fm_0_2                                                                                                               !!! #}
{# !!! da #2                                                                                                                    !!! #}
{# !!! fm_0_2:                                                                                                                  !!! #}
{# !!! ta reg_offset                                                                                                            !!! #}

{# !!! check_cut:                                                                                                               !!! #}

{# !!! da famistudio_chn_note+FAMISTUDIO_EPSM_CHAN_FM_START,y                                                                   !!! #}
{# !!! ne @nocut                                                                                                                !!! #}

{# !!! cut:                                                                                                                     !!! #}
{#  Untrigger note.                                                                                                         #}
{# !!! da #FAMISTUDIO_EPSM_REG_KEY                                                                                              !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_SEL0                                                                                              !!! #}

{# !!! da famistudio_epsm_channel_key_table, y                                                                                  !!! #}
{# !!! nd #$0f ; remove trigger                                                                                                 !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_WRITE0                                                                                            !!! #}

{# Mute channel                                                                                                             #}
{# !!! dx reg_offset                                                                                                            !!! #}
{# !!! da famistudio_epsm_fm_stereo_reg_table,y                                                                                 !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_SEL0,x                                                                                            !!! #}
{# !!! da #$00                                                                                                                  !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_WRITE0,x                                                                                          !!! #}
{# !!! ts                                                                                                                       !!! #}

{# !!! nocut:                                                                                                                   !!! #}

{#  Check if the channel needs to stop the note                                                                             #}

{#  Un-trigger previous note if needed.                                                                                     #}
{# !!! da famistudio_chn_epsm_trigger,y                                                                                         !!! #}
{# !!! eq @update_instrument_check                                                                                              !!! #}
{# !!! untrigger_prev_note:                                                                                                     !!! #}
{#  Untrigger note.                                                                                                         #}
{# !!! da #FAMISTUDIO_EPSM_REG_KEY                                                                                              !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_SEL0                                                                                              !!! #}

{# !!! da famistudio_epsm_channel_key_table, y                                                                                  !!! #}
{# !!! nd #$0f ; remove trigger                                                                                                 !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_WRITE0                                                                                            !!! #}
{#         nop                                                                                                              #}
{#         nop                                                                                                              #}
{#         nop                                                                                                              #}
{# !!! op                                                                                                                       !!! #}
{# !!! op                                                                                                                       !!! #}
{# !!! op                                                                                                                       !!! #}
{#         rts                                                                                                              #}
{# !!! update_instrument_check:                                                                                                 !!! #}
{# !!! da famistudio_chn_epsm_fm_instrument,y                                                                                   !!! #}
{# !!! mp #$ff                                                                                                                  !!! #}
{# !!! eq @no_instrument_update                                                                                                 !!! #}
{# !!! sr update_fm_instrument                                                                                                  !!! #}
{# !!! dy chan_idx                                                                                                              !!! #}
{# !!! da #$ff                                                                                                                  !!! #}
{# !!! ta famistudio_chn_epsm_fm_instrument,y                                                                                   !!! #}
{# !!! no_instrument_update:                                                                                                    !!! #}

{# !!! dx reg_offset                                                                                                            !!! #}
{# !!! da famistudio_epsm_fm_stereo_reg_table,y                                                                                 !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_SEL0,x                                                                                            !!! #}
{# !!! da famistudio_chn_epsm_fm_stereo,y                                                                                       !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_WRITE0,x                                                                                          !!! #}
{# !!! da famistudio_chn_note+FAMISTUDIO_EPSM_CHAN_FM_START,y                                                                   !!! #}
{#  Read note, apply arpeggio                                                                                               #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dx famistudio_epsm_fm_env_table,y                                                                                        !!! #}
{# !!! dc famistudio_env_value+FAMISTUDIO_ENV_NOTE_OFF,x                                                                        !!! #}
{# !!! ax                                                                                                                       !!! #}

{#  Apply pitch envelope, fine pitch & slides                                                                               #}
{# !!! amistudio_get_note_pitch_macro (FAMISTUDIO_EPSM_CH0_PITCH_ENV_IDX + FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT), FAMISTUDIO_EPSM_PITCH_SHIFT, famistudio_epsm_note_table_lsb, famistudio_epsm_note_table_msb !!! #}

{#  Compute octave by dividing by 2 until we are <= 512 (0x100).                                                            #}
{# !!! dx #0                                                                                                                    !!! #}

{# !!! da pitch+1                                                                                                               !!! #}
{# !!! mp #$02 ; check if shifted the pitch to a 9 bit number yet.                                                              !!! #}
{# !!! cc @octave_done                                                                                                          !!! #}
{# !!! compute_octave_loop:                                                                                                     !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! sr                                                                                                                       !!! #}
{# !!! or pitch+0                                                                                                               !!! #}
{# !!! mp #$02                                                                                                                  !!! #}
{# !!! cc @octave_done                                                                                                          !!! #}
{# !!! cs @compute_octave_loop ;unconditional                                                                                   !!! #}
{# !!! octave_done:                                                                                                             !!! #}
{# !!! ta pitch+1                                                                                                               !!! #}

{#  9 bit pitch * 4 to get the pitch back to an 11 bit number                                                               #}
{#  the final 16 bit pitch will look like 00ooohhh llllllll where o = octave, h = pitch bits 8-11, l = pitch bits 0-8       #}
{# !!! sl pitch+0                                                                                                               !!! #}
{# !!! ol pitch+1                                                                                                               !!! #}
{# !!! sl pitch+0                                                                                                               !!! #}
{# !!! ol pitch+1                                                                                                               !!! #}

{# !!! xa ; x holds the 3 bit octave information. octave = log2(pitch_hi)                                                       !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ra pitch+1                                                                                                               !!! #}
{# !!! ta pitch+1                                                                                                               !!! #}

{# !!! write_hi_period:                                                                                                         !!! #}

{#  Write pitch (hi)                                                                                                        #}
{# !!! dx reg_offset                                                                                                            !!! #}
{# !!! da famistudio_epsm_reg_table_hi,y                                                                                        !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_SEL0,x                                                                                            !!! #}
{# !!! da pitch+1                                                                                                               !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_WRITE0,x                                                                                          !!! #}

{#  Write pitch (lo)                                                                                                        #}
{# !!! da famistudio_epsm_reg_table_lo,y                                                                                        !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_SEL0,x                                                                                            !!! #}
{# !!! da pitch+0                                                                                                               !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_WRITE0,x                                                                                          !!! #}

{#  Read/multiply volume                                                                                                    #}
{# !!! dx famistudio_epsm_fm_env_table,y                                                                                        !!! #}
    {% if FAMISTUDIO_USE_VOLUME_TRACK                                                                                              %}
{# !!! da famistudio_chn_volume_track+FAMISTUDIO_EPSM_CHAN_FM_START, y                                                          !!! #}
        {% if FAMISTUDIO_USE_VOLUME_SLIDES                                                                                             %}
{#  During a slide, the lower 4 bits are fraction.                                                                          #}
{# !!! nd #$f0                                                                                                                  !!! #}
        {% endif 120 %}
{# !!! ra famistudio_env_value+FAMISTUDIO_ENV_VOLUME_OFF,x                                                                      !!! #}
    {% else 120 %}
{# !!! da famistudio_env_value+FAMISTUDIO_ENV_VOLUME_OFF,x                                                                      !!! #}
    {% endif 120 %}

    {% if FAMISTUDIO_USE_VOLUME_TRACK                                                                                              %}
{# !!! ax                                                                                                                       !!! #}
{# !!! da famistudio_volume_table,x                                                                                             !!! #}
    {% endif 120 %}
{# !!! ta vol_offset                                                                                                            !!! #}

{# !!! update_volume:                                                                                                           !!! #}
{# !!! dx vol_offset                                                                                                            !!! #}
{# !!! da famistudio_epsm_fm_vol_table,x                                                                                        !!! #}
{# !!! ta vol_offset ; store volume level here                                                                                  !!! #}

{# !!! dx reg_offset                                                                                                            !!! #}
{# !!! da famistudio_chn_epsm_alg,y                                                                                             !!! #}
{# !!! mp #4                                                                                                                    !!! #}
{# !!! cc @op_4 ; 0-1-2-3                                                                                                       !!! #}
{# !!! eq @op_2_4 ; 4                                                                                                           !!! #}
{# !!! mp #7 ; 5                                                                                                                !!! #}
{# !!! cc @op_2_3_4 ; 6                                                                                                         !!! #}
{#  7                                                                                                                       #}
{# !!! op_1_2_3_4:                                                                                                              !!! #}
{# !!! da famistudio_epsm_vol_table_op1,y                                                                                       !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_SEL0,x                                                                                            !!! #}
{# !!! da famistudio_chn_epsm_vol_op1,y                                                                                         !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc vol_offset                                                                                                            !!! #}
{# !!! pl @save_op1                                                                                                             !!! #}
{# !!! da #127                                                                                                                  !!! #}
{# !!! save_op1:                                                                                                                !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_WRITE0,x                                                                                          !!! #}
{# !!! op_2_3_4:                                                                                                                !!! #}
{# !!! da famistudio_epsm_vol_table_op3,y                                                                                       !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_SEL0,x                                                                                            !!! #}
{# !!! da famistudio_chn_epsm_vol_op3,y                                                                                         !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc vol_offset                                                                                                            !!! #}
{# !!! pl @save_op3                                                                                                             !!! #}
{# !!! da #127                                                                                                                  !!! #}
{# !!! save_op3:                                                                                                                !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_WRITE0,x                                                                                          !!! #}
{# !!! op_2_4:                                                                                                                  !!! #}
{# !!! da famistudio_epsm_vol_table_op2,y                                                                                       !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_SEL0,x                                                                                            !!! #}
{# !!! da famistudio_chn_epsm_vol_op2,y                                                                                         !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc vol_offset                                                                                                            !!! #}
{# !!! pl @save_op2                                                                                                             !!! #}
{# !!! da #127                                                                                                                  !!! #}
{# !!! save_op2:                                                                                                                !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_WRITE0,x                                                                                          !!! #}
{# !!! op_4:                                                                                                                    !!! #}
{#  Write volume                                                                                                            #}
{# !!! da famistudio_epsm_vol_table_op4,y ; 4                                                                                   !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_SEL0,x ; 5                                                                                        !!! #}
{# !!! da famistudio_chn_epsm_vol_op4,y ; 4                                                                                     !!! #}
{# !!! lc ; 2                                                                                                                   !!! #}
{# !!! dc vol_offset ; 3                                                                                                        !!! #}
{# !!! pl @save_op4 ; 2/3                                                                                                       !!! #}
{# !!! da #127 ; 2                                                                                                              !!! #}
{# !!! save_op4:                                                                                                                !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_WRITE0,x ; 5  = 26/27                                                                             !!! #}

{# !!! op                                                                                                                       !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! da famistudio_chn_epsm_trigger,y                                                                                         !!! #}
{# !!! pl @no_release                                                                                                           !!! #}

{# !!! release:                                                                                                                 !!! #}
{#  Untrigger note.                                                                                                         #}
{# !!! da #FAMISTUDIO_EPSM_REG_KEY                                                                                              !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_SEL0                                                                                              !!! #}

{# !!! da famistudio_epsm_channel_key_table, y                                                                                  !!! #}
{# !!! nd #$0f ; remove trigger                                                                                                 !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_WRITE0                                                                                            !!! #}

{# !!! ts                                                                                                                       !!! #}
{# !!! no_release:                                                                                                              !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_chn_epsm_trigger,y                                                                                         !!! #}
{# !!! da #FAMISTUDIO_EPSM_REG_KEY                                                                                              !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_SEL0                                                                                              !!! #}
{# !!! da famistudio_epsm_channel_key_table, y                                                                                  !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_WRITE0                                                                                            !!! #}

{# !!! ts                                                                                                                       !!! #}


{# ======================================================================================================================   #}
{#  FAMISTUDIO_EPSM_WRITE_PATCH_REGISTER (internal)                                                                         #}
{#                                                                                                                          #}
{#  Internal function to set a EPSM instrument for a given channel                                                          #}
{#                                                                                                                          #}
{#  [in] y/r0: channel index                                                                                                #}
{#  [in] x:    index of first envelope of instrument                                                                        #}
{#  [in] a:    instrument index.                                                                                            #}
{# ======================================================================================================================   #}
{# !!! macro famistudio_epsm_write_patch_registers select, write                                                                !!! #}
{# !!! dy #30-5 ; we skip updating the 4 operators                                                                              !!! #}
{# !!! dx reg_offset                                                                                                            !!! #}
{# !!! loop_extra_patch:                                                                                                        !!! #}
{# !!! xa    ; 2                                                                                                                !!! #}
{# !!! ra famistudio_epsm_register_order,y ; 4                                                                                  !!! #}
{# !!! ta select ; 4                                                                                                            !!! #}
{# !!! da (ex_patch),y ; 5                                                                                                      !!! #}
{# !!! ta write ; 4                                                                                                             !!! #}
{# !!! ey    ; 2                                                                                                                !!! #}
{# !!! op    ; 2 DELAY FOR MESEN-X                                                                                              !!! #}
{# !!! pl @loop_extra_patch ; 3  ; =26                                                                                          !!! #}

{# !!! dx chan_idx2                                                                                                             !!! #}
{# !!! da famistudio_chn_epsm_alg,x                                                                                             !!! #}
{# !!! mp #4                                                                                                                    !!! #}
{# !!! cc @alg_0_1_2_3 ; 0-1-2-3                                                                                                !!! #}
{# !!! eq @alg_4 ; 4                                                                                                            !!! #}
{# !!! mp @alg_5_6 ; 5                                                                                                          !!! #}
{# !!! alg_0_1_2_3:                                                                                                             !!! #}
{# 3+2+1                                                                                                                    #}
{# !!! dy #27                                                                                                                   !!! #}
{# !!! dx reg_offset                                                                                                            !!! #}
{# !!! xa    ; 2                                                                                                                !!! #}
{# !!! ra famistudio_epsm_register_order,y ; 4                                                                                  !!! #}
{# !!! ta select ; 4                                                                                                            !!! #}
{# !!! da (ex_patch),y ; 5                                                                                                      !!! #}
{# !!! ta write ; 4                                                                                                             !!! #}
{# !!! op    ; 2 DELAY FOR MESEN-X                                                                                              !!! #}
{# !!! alg_4:                                                                                                                   !!! #}
{# 3+1                                                                                                                      #}
{# !!! dy #28                                                                                                                   !!! #}
{# !!! dx reg_offset                                                                                                            !!! #}
{# !!! xa    ; 2                                                                                                                !!! #}
{# !!! ra famistudio_epsm_register_order,y ; 4                                                                                  !!! #}
{# !!! ta select ; 4                                                                                                            !!! #}
{# !!! da (ex_patch),y ; 5                                                                                                      !!! #}
{# !!! ta write ; 4                                                                                                             !!! #}
{# !!! op    ; 2 DELAY FOR MESEN-X                                                                                              !!! #}
{# !!! alg_5_6:                                                                                                                 !!! #}
{# 1                                                                                                                        #}
{# !!! dy #26                                                                                                                   !!! #}
{# !!! dx reg_offset                                                                                                            !!! #}
{# !!! xa    ; 2                                                                                                                !!! #}
{# !!! ra famistudio_epsm_register_order,y ; 4                                                                                  !!! #}
{# !!! ta select ; 4                                                                                                            !!! #}
{# !!! da (ex_patch),y ; 5                                                                                                      !!! #}
{# !!! ta write ; 4                                                                                                             !!! #}
{# !!! op    ; 2 DELAY FOR MESEN-X                                                                                              !!! #}
{# !!! endm                                                                                                                     !!! #}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_UPDATE_EPSM_FM_INSTRUMENT (internal)                                                                         #}
{#                                                                                                                          #}
{#  Updates the EPSM audio registers for a given channel.                                                                   #}
{#                                                                                                                          #}
{#  [in] y: EPSM channel idx (0,1,2,3,4,5)                                                                                  #}
{# ======================================================================================================================   #}
{#  Now we are dealing with either a FM or Rhythm instrument. a = channel index                                             #}
{#  if we are an FM instrument then there is a offset we need to apply to the register select                               #}

{#  Skip over the two SSG specific envelopes by jumping up 4 bytes                                                          #}
{# !!! pdate_fm_instrument:                                                                                                     !!! #}
{# !!! tr          = famistudio_ptr1                                                                                            !!! #}
{# !!! nv_ptr      = famistudio_ptr2                                                                                            !!! #}
{# !!! x_patch     = famistudio_ptr2                                                                                            !!! #}
{# !!! han_idx     = famistudio_r0                                                                                              !!! #}
{# !!! han_idx2    = famistudio_r2                                                                                              !!! #}
{# !!! pdate_flags = famistudio_r1 ; bit 7 = no attack, bit 6 = has set delayed cut                                             !!! #}
{# !!! eg_offset   = famistudio_r3                                                                                              !!! #}
{# !!! sr famistudio_get_exp_inst_ptr                                                                                           !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! ya                                                                                                                       !!! #}
{# !!! dc #14 ; skip over envelopes + square stuff.                                                                             !!! #}
{# !!! ay                                                                                                                       !!! #}
{#  And then read the pointer to the extended instrument patch data                                                         #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta ex_patch                                                                                                              !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta ex_patch+1                                                                                                            !!! #}

{# !!! fm_channel:                                                                                                              !!! #}
{# !!! dx chan_idx2                                                                                                             !!! #}
{#  FM channel 1-6, we need to look up the register select offset from the table                                            #}
{# !!! da famistudio_channel_epsm_chan_table,x                                                                                  !!! #}
{# !!! ta reg_offset                                                                                                            !!! #}
{# !!! dy #0                                                                                                                    !!! #}
{#  Now we need to store the algorithm and stereo for later use                                                             #}
{# !!! da (ex_patch),y                                                                                                          !!! #}
{# !!! nd #$07                                                                                                                  !!! #}
{# !!! ta famistudio_chn_epsm_alg,x ;store algorithm                                                                            !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ex_patch),y                                                                                                          !!! #}
{# !!! ta famistudio_chn_epsm_fm_stereo ,x                                                                                      !!! #}
{# !!! ey                                                                                                                       !!! #}

{#  Now if we are channels 1-3 then we use @reg_set_0, otherwise for 4-6 its reg set 1                                      #}
{# !!! da chan_idx2                                                                                                             !!! #}
{# !!! mp #3                                                                                                                    !!! #}
{# !!! pl @reg_set_1                                                                                                            !!! #}

{# !!! reg_set_0:                                                                                                               !!! #}
{# !!! amistudio_epsm_write_patch_registers FAMISTUDIO_EPSM_REG_SEL0, FAMISTUDIO_EPSM_REG_WRITE0                                !!! #}
{# !!! mp @last_reg                                                                                                             !!! #}

{# !!! reg_set_1:                                                                                                               !!! #}
{# !!! amistudio_epsm_write_patch_registers FAMISTUDIO_EPSM_REG_SEL1, FAMISTUDIO_EPSM_REG_WRITE1                                !!! #}
{# !!! op                                                                                                                       !!! #}

{# !!! last_reg:                                                                                                                !!! #}
{# !!! dy #30 ; last reg patch ptr                                                                                              !!! #}
{# !!! da #$22 ; famistudio_epsm_register_order,x                                                                               !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc reg_offset                                                                                                            !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_SEL0                                                                                              !!! #}
{# !!! da (ex_patch),y                                                                                                          !!! #}
{# !!! ta FAMISTUDIO_EPSM_REG_WRITE0                                                                                            !!! #}
{# !!! da chan_idx2                                                                                                             !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! dy #26                                                                                                                   !!! #}
{# !!! da (ex_patch),y                                                                                                          !!! #}
{# !!! ta famistudio_chn_epsm_vol_op1,x                                                                                         !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ex_patch),y                                                                                                          !!! #}
{# !!! ta famistudio_chn_epsm_vol_op2,x                                                                                         !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ex_patch),y                                                                                                          !!! #}
{# !!! ta famistudio_chn_epsm_vol_op3,x                                                                                         !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ex_patch),y                                                                                                          !!! #}
{# !!! ta famistudio_chn_epsm_vol_op4,x                                                                                         !!! #}
{# !!! done:                                                                                                                    !!! #}
{# !!! ts                                                                                                                       !!! #}
{% endif 120 %}
{# ======================================================================================================================   #}
{#  FAMISTUDIO_UPDATE_EPSM_RHYTHM_CHANNEL_SOUND (internal)                                                                  #}
{#                                                                                                                          #}
{#  Updates the EPSM audio registers for a given channel.                                                                   #}
{#                                                                                                                          #}
{#  [in] y: EPSM channel idx (0,1,2,3,4,5)                                                                                  #}
{# ======================================================================================================================   #}

{% if FAMISTUDIO_EXP_EPSM_RHYTHM_CNT > 0                                                                                       %}
{# !!! amistudio_update_epsm_rhythm_channel_sound:                                                                              !!! #}

{# !!! itch = famistudio_ptr1                                                                                                   !!! #}

{# !!! da famistudio_chn_note+FAMISTUDIO_EPSM_CHAN_RHYTHM_START,y                                                               !!! #}
{# !!! ne @nocut                                                                                                                !!! #}
{# !!! ta famistudio_chn_epsm_trigger+FAMISTUDIO_EXP_EPSM_FM_CHN_CNT,y                                                          !!! #}
{# !!! dx #0 ; This will fetch volume 0.                                                                                        !!! #}
{# !!! eq @noupdate                                                                                                             !!! #}

{# !!! nocut:                                                                                                                   !!! #}

{# !!! da famistudio_chn_epsm_trigger+FAMISTUDIO_EXP_EPSM_FM_CHN_CNT,y                                                          !!! #}
{# !!! mp #$10                                                                                                                  !!! #}
{# !!! eq @noupdate                                                                                                             !!! #}

{#  Read/multiply volume                                                                                                    #}
{# !!! dx famistudio_chn_epsm_rhythm_volume,y                                                                                   !!! #}
    {% if FAMISTUDIO_USE_VOLUME_TRACK                                                                                              %}
{# !!! da famistudio_chn_volume_track+FAMISTUDIO_EPSM_CHAN_RHYTHM_START, y                                                      !!! #}
        {% if FAMISTUDIO_USE_VOLUME_SLIDES                                                                                             %}
{#  During a slide, the lower 4 bits are fraction.                                                                          #}
{# !!! nd #$f0                                                                                                                  !!! #}
        {% endif 120 %}
{# !!! ra famistudio_chn_epsm_rhythm_volume,y                                                                                   !!! #}
    {% else 120 %}
{# !!! da famistudio_chn_epsm_rhythm_volume,y                                                                                   !!! #}
    {% endif 120 %}
{# !!! ax                                                                                                                       !!! #}

{# !!! update_volume:                                                                                                           !!! #}
{#  Write volume                                                                                                            #}
{# !!! da famistudio_epsm_rhythm_reg_table,y                                                                                    !!! #}
{# !!! ta FAMISTUDIO_EPSM_ADDR                                                                                                  !!! #}
    {% if FAMISTUDIO_USE_VOLUME_TRACK                                                                                              %}
{# !!! da famistudio_volume_table,x                                                                                             !!! #}
    {% else 120 %}
{# !!! xa                                                                                                                       !!! #}
    {% endif 120 %}
{# !!! ol                                                                                                                       !!! #}
{# !!! dc famistudio_chn_epsm_rhythm_stereo,y                                                                                   !!! #}
{# !!! ta FAMISTUDIO_EPSM_DATA                                                                                                  !!! #}

{# !!! da #$10 ;FAMISTUDIO_EPSM_REG_RHY_KY                                                                                      !!! #}
{# !!! ta famistudio_chn_epsm_trigger+FAMISTUDIO_EXP_EPSM_FM_CHN_CNT,y                                                          !!! #}
{# !!! ta FAMISTUDIO_EPSM_ADDR                                                                                                  !!! #}
{# !!! op ;Some delay needed before writing the rhythm key                                                                      !!! #}
{# !!! op                                                                                                                       !!! #}
{# !!! da famistudio_epsm_rhythm_key_table,y                                                                                    !!! #}
{# !!! ta FAMISTUDIO_EPSM_DATA                                                                                                  !!! #}

{# !!! noupdate:                                                                                                                !!! #}
{# !!! ts                                                                                                                       !!! #}

{% endif 120 %}
{% endif 120 %}

{% if FAMISTUDIO_EXP_N163                                                                                                      %}

{#  This is getting out of hand. Maybe we should compute those on the fly.                                                  #}
{# !!! amistudio_n163_freq_table_lo:                                                                                            !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_LO - $00                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_LO - $08                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_LO - $10                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_LO - $18                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_LO - $20                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_LO - $28                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_LO - $30                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_LO - $38                                                                                   !!! #}
{# !!! amistudio_n163_freq_table_mid:                                                                                           !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_MID - $00                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_MID - $08                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_MID - $10                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_MID - $18                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_MID - $20                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_MID - $28                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_MID - $30                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_MID - $38                                                                                  !!! #}
{# !!! amistudio_n163_freq_table_hi:                                                                                            !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_HI - $00                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_HI - $08                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_HI - $10                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_HI - $18                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_HI - $20                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_HI - $28                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_HI - $30                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_REG_FREQ_HI - $38                                                                                   !!! #}
{# !!! amistudio_n163_vol_table:                                                                                                !!! #}
{# !!! byte FAMISTUDIO_N163_REG_VOLUME - $00                                                                                    !!! #}
{# !!! byte FAMISTUDIO_N163_REG_VOLUME - $08                                                                                    !!! #}
{# !!! byte FAMISTUDIO_N163_REG_VOLUME - $10                                                                                    !!! #}
{# !!! byte FAMISTUDIO_N163_REG_VOLUME - $18                                                                                    !!! #}
{# !!! byte FAMISTUDIO_N163_REG_VOLUME - $20                                                                                    !!! #}
{# !!! byte FAMISTUDIO_N163_REG_VOLUME - $28                                                                                    !!! #}
{# !!! byte FAMISTUDIO_N163_REG_VOLUME - $30                                                                                    !!! #}
{# !!! byte FAMISTUDIO_N163_REG_VOLUME - $38                                                                                    !!! #}
{# !!! amistudio_n163_env_table:                                                                                                !!! #}
{# !!! byte FAMISTUDIO_N163_CH0_ENVS                                                                                            !!! #}
{# !!! byte FAMISTUDIO_N163_CH1_ENVS                                                                                            !!! #}
{# !!! byte FAMISTUDIO_N163_CH2_ENVS                                                                                            !!! #}
{# !!! byte FAMISTUDIO_N163_CH3_ENVS                                                                                            !!! #}
{# !!! byte FAMISTUDIO_N163_CH4_ENVS                                                                                            !!! #}
{# !!! byte FAMISTUDIO_N163_CH5_ENVS                                                                                            !!! #}
{# !!! byte FAMISTUDIO_N163_CH6_ENVS                                                                                            !!! #}
{# !!! byte FAMISTUDIO_N163_CH7_ENVS                                                                                            !!! #}
{% if FAMISTUDIO_USE_PHASE_RESET                                                                                               %}
{# !!! amistudio_n163_phase_table_lo:                                                                                           !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_LO - $00                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_LO - $08                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_LO - $10                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_LO - $18                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_LO - $20                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_LO - $28                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_LO - $30                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_LO - $38                                                                                  !!! #}
{# !!! amistudio_n163_phase_table_mid:                                                                                          !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_MID - $00                                                                                 !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_MID - $08                                                                                 !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_MID - $10                                                                                 !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_MID - $18                                                                                 !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_MID - $20                                                                                 !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_MID - $28                                                                                 !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_MID - $30                                                                                 !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_MID - $38                                                                                 !!! #}
{# !!! amistudio_n163_phase_table_hi:                                                                                           !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_HI - $00                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_HI - $08                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_HI - $10                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_HI - $18                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_HI - $20                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_HI - $28                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_HI - $30                                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_REG_PHASE_HI - $38                                                                                  !!! #}
{% endif 120 %}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_UPDATE_N163_CHANNEL_SOUND (internal)                                                                         #}
{#                                                                                                                          #}
{#  Updates the N163 audio registers for a given channel.                                                                   #}
{#                                                                                                                          #}
{#  [in] y: N163 channel idx (0,1,2,3,4,5,6,7)                                                                              #}
{# ======================================================================================================================   #}

{# !!! amistudio_update_n163_channel_sound:                                                                                     !!! #}

{# !!! itch    = famistudio_ptr1                                                                                                !!! #}
{# !!! itch_hi = famistudio_r2                                                                                                  !!! #}

{# !!! da famistudio_chn_note+FAMISTUDIO_N163_CH0_IDX,y                                                                         !!! #}
{# !!! ne @nocut                                                                                                                !!! #}
{# !!! dx #0 ; This will fetch volume 0.                                                                                        !!! #}
{# !!! mp @update_volume                                                                                                        !!! #}

{# !!! nocut:                                                                                                                   !!! #}

{# !!! sr famistudio_update_n163_wave                                                                                           !!! #}

{#  Read note, apply arpeggio                                                                                               #}
{# !!! da famistudio_chn_note+FAMISTUDIO_N163_CH0_IDX,y                                                                         !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dx famistudio_n163_env_table,y                                                                                           !!! #}
{# !!! dc famistudio_env_value+FAMISTUDIO_ENV_NOTE_OFF,x                                                                        !!! #}
    {% if FAMISTUDIO_DUAL_SUPPORT                                                                                                  %}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc famistudio_pal_adjust                                                                                                 !!! #}
    {% endif 120 %}
{# !!! ax                                                                                                                       !!! #}

{#  Apply pitch envelope, fine pitch & slides                                                                               #}
{# !!! amistudio_get_note_pitch_macro FAMISTUDIO_N163_CH0_PITCH_ENV_IDX, FAMISTUDIO_N163_PITCH_SHIFT, famistudio_n163_note_table_lsb, famistudio_n163_note_table_msb !!! #}

{#  Convert 16-bit -> 18-bit.                                                                                               #}
{# !!! sl pitch+0                                                                                                               !!! #}
{# !!! ol pitch+1                                                                                                               !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! dc #0                                                                                                                    !!! #}
{# !!! ta pitch_hi                                                                                                              !!! #}
{# !!! sl pitch+0                                                                                                               !!! #}
{# !!! ol pitch+1                                                                                                               !!! #}
{# !!! ol pitch_hi                                                                                                              !!! #}

{#  Write pitch                                                                                                             #}
{# !!! da famistudio_n163_freq_table_lo,y                                                                                       !!! #}
{# !!! ta FAMISTUDIO_N163_ADDR                                                                                                  !!! #}
{# !!! da pitch+0                                                                                                               !!! #}
{# !!! ta FAMISTUDIO_N163_DATA                                                                                                  !!! #}
{# !!! da famistudio_n163_freq_table_mid,y                                                                                      !!! #}
{# !!! ta FAMISTUDIO_N163_ADDR                                                                                                  !!! #}
{# !!! da pitch+1                                                                                                               !!! #}
{# !!! ta FAMISTUDIO_N163_DATA                                                                                                  !!! #}
{# !!! da famistudio_n163_freq_table_hi,y                                                                                       !!! #}
{# !!! ta FAMISTUDIO_N163_ADDR                                                                                                  !!! #}
{# !!! da famistudio_chn_n163_wave_len,y                                                                                        !!! #}
{# !!! ra pitch_hi                                                                                                              !!! #}
{# !!! ta FAMISTUDIO_N163_DATA                                                                                                  !!! #}

{#  Read/multiply volume                                                                                                    #}
{# !!! dx famistudio_n163_env_table,y                                                                                           !!! #}
    {% if FAMISTUDIO_USE_VOLUME_TRACK                                                                                              %}
{# !!! da famistudio_chn_volume_track+FAMISTUDIO_N163_CH0_IDX, y                                                                !!! #}
        {% if FAMISTUDIO_USE_VOLUME_SLIDES                                                                                             %}
{#  During a slide, the lower 4 bits are fraction.                                                                          #}
{# !!! nd #$f0                                                                                                                  !!! #}
        {% endif 120 %}
{# !!! ra famistudio_env_value+FAMISTUDIO_ENV_VOLUME_OFF,x                                                                      !!! #}
    {% else 120 %}
{# !!! da famistudio_env_value+FAMISTUDIO_ENV_VOLUME_OFF,x                                                                      !!! #}
    {% endif 120 %}
{# !!! ax                                                                                                                       !!! #}

{# !!! update_volume:                                                                                                           !!! #}
{#  Write volume                                                                                                            #}
{# !!! da famistudio_n163_vol_table,y                                                                                           !!! #}
{# !!! ta FAMISTUDIO_N163_ADDR                                                                                                  !!! #}
    {% if FAMISTUDIO_USE_VOLUME_TRACK                                                                                              %}
{# !!! da famistudio_volume_table,x                                                                                             !!! #}
    {% else 120 %}
{# !!! xa                                                                                                                       !!! #}
    {% endif 120 %}
{# !!! ra #FAMISTUDIO_N163_CHN_MASK                                                                                             !!! #}
{# !!! ta FAMISTUDIO_N163_DATA                                                                                                  !!! #}

{# !!! done:                                                                                                                    !!! #}
{# !!! ts                                                                                                                       !!! #}

{% endif 120 %}

{% if FAMISTUDIO_EXP_S5B                                                                                                       %}

{# !!! amistudio_s5b_reg_table_lo:                                                                                              !!! #}
{# !!! byte FAMISTUDIO_S5B_REG_LO_A, FAMISTUDIO_S5B_REG_LO_B, FAMISTUDIO_S5B_REG_LO_C                                           !!! #}
{# !!! amistudio_s5b_reg_table_hi:                                                                                              !!! #}
{# !!! byte FAMISTUDIO_S5B_REG_HI_A, FAMISTUDIO_S5B_REG_HI_B, FAMISTUDIO_S5B_REG_HI_C                                           !!! #}
{# !!! amistudio_s5b_vol_table:                                                                                                 !!! #}
{# !!! byte FAMISTUDIO_S5B_REG_VOL_A, FAMISTUDIO_S5B_REG_VOL_B, FAMISTUDIO_S5B_REG_VOL_C                                        !!! #}
{# !!! amistudio_s5b_env_table:                                                                                                 !!! #}
{# !!! byte FAMISTUDIO_S5B_CH0_ENVS, FAMISTUDIO_S5B_CH1_ENVS, FAMISTUDIO_S5B_CH2_ENVS                                           !!! #}
{# !!! amistudio_s5b_noise_mask:                                                                                                !!! #}
{# !!! byte $08, $10, $20                                                                                                       !!! #}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_UPDATE_S5B_CHANNEL_SOUND (internal)                                                                          #}
{#                                                                                                                          #}
{#  Updates the S5B audio registers for a given channel.                                                                    #}
{#                                                                                                                          #}
{#  [in] y: S5B channel idx (0,1,2)                                                                                         #}
{# ======================================================================================================================   #}

{# !!! amistudio_update_s5b_channel_sound:                                                                                      !!! #}

{# !!! itch   = famistudio_ptr1                                                                                                 !!! #}
{# !!! nv_bit = famistudio_ptr1_lo                                                                                              !!! #}

{#  These are shared by all 3 channels.                                                                                     #}
{# !!! nv_period = famistudio_ptr0                                                                                              !!! #}
{# !!! ttack     = famistudio_ptr2                                                                                              !!! #}
{# !!! nv_shape  = famistudio_r1                                                                                                !!! #}
{# !!! nv_octave = famistudio_r2                                                                                                !!! #}
{# !!! oise_freq = famistudio_r3                                                                                                !!! #}

{#  First channel will clear these, last channel will write the registers.                                                  #}
{# !!! py #0                                                                                                                    !!! #}
{# !!! ne @not_first_channel                                                                                                    !!! #}
{# !!! ty env_shape                                                                                                             !!! #}
{# !!! ty noise_freq                                                                                                            !!! #}
{# !!! ty attack                                                                                                                !!! #}
{# !!! da #$80 ; This mean 'manual pitch'                                                                                       !!! #}
{# !!! ty env_octave                                                                                                            !!! #}

{# !!! not_first_channel:                                                                                                       !!! #}
{# !!! dx #0 ; This will fetch volume 0.                                                                                        !!! #}
{# !!! tx env_bit                                                                                                               !!! #}
{# !!! da famistudio_chn_note+FAMISTUDIO_S5B_CH0_IDX,y                                                                          !!! #}
{# !!! ne @nocut                                                                                                                !!! #}
{# !!! mp @update_volume                                                                                                        !!! #}

{# !!! nocut:                                                                                                                   !!! #}
{#  Store noise if mixer has it enabled                                                                                     #}
{# !!! dx famistudio_s5b_env_table,y                                                                                            !!! #}
{# !!! da famistudio_env_value+FAMISTUDIO_ENV_MIXER_IDX_OFF,x                                                                   !!! #}
{# !!! nd famistudio_s5b_noise_mask,y                                                                                           !!! #}
{# !!! ne @nonoise                                                                                                              !!! #}
{# !!! da famistudio_env_value+FAMISTUDIO_ENV_NOISE_IDX_OFF,x                                                                   !!! #}
{# !!! ta noise_freq                                                                                                            !!! #}

{# !!! nonoise:                                                                                                                 !!! #}
{# !!! da famistudio_chn_note+FAMISTUDIO_S5B_CH0_IDX,y                                                                          !!! #}
{#  Read note, apply arpeggio                                                                                               #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dx famistudio_s5b_env_table,y                                                                                            !!! #}
{# !!! dc famistudio_env_value+FAMISTUDIO_ENV_NOTE_OFF,x                                                                        !!! #}
    {% if FAMISTUDIO_DUAL_SUPPORT                                                                                                  %}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc famistudio_pal_adjust                                                                                                 !!! #}
    {% endif 120 %}
{# !!! ax                                                                                                                       !!! #}

{#  Apply pitch envelope, fine pitch & slides                                                                               #}
{# !!! amistudio_get_note_pitch_macro FAMISTUDIO_S5B_CH0_PITCH_ENV_IDX, 0, famistudio_note_table_lsb, famistudio_note_table_msb !!! #}

{#  Write pitch + 1 (pitches on S5B are off by one compared to regular note table)                                          #}
{# !!! da famistudio_s5b_reg_table_lo,y                                                                                         !!! #}
{# !!! ta FAMISTUDIO_S5B_ADDR                                                                                                   !!! #}
{# !!! da pitch+0                                                                                                               !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc #1                                                                                                                    !!! #}
{# !!! ta FAMISTUDIO_S5B_DATA                                                                                                   !!! #}
{# !!! ta pitch+0                                                                                                               !!! #}
{# !!! da famistudio_s5b_reg_table_hi,y                                                                                         !!! #}
{# !!! ta FAMISTUDIO_S5B_ADDR                                                                                                   !!! #}
{# !!! da pitch+1                                                                                                               !!! #}
{# !!! dc #0                                                                                                                    !!! #}
{# !!! ta FAMISTUDIO_S5B_DATA                                                                                                   !!! #}
{# !!! ta pitch+1                                                                                                               !!! #}

{#  Store env shape + period if active.                                                                                     #}
{# !!! da famistudio_s5b_chn_env_shape,y                                                                                        !!! #}
{# !!! nd #$0f                                                                                                                  !!! #}
{# !!! eq @noenv                                                                                                                !!! #}
{# !!! ta env_shape                                                                                                             !!! #}

{#  If bit 7 of any channel is on, well reset the envelope.                                                                 #}
{# !!! da famistudio_s5b_chn_env_shape,y                                                                                        !!! #}
{# !!! ra attack                                                                                                                !!! #}
{# !!! ta attack                                                                                                                !!! #}
{# !!! da famistudio_s5b_chn_env_shape,y                                                                                        !!! #}
{# !!! nd #$0f                                                                                                                  !!! #}
{# !!! ta famistudio_s5b_chn_env_shape,y                                                                                        !!! #}

{#  Store auto-period settings                                                                                              #}
{# !!! da famistudio_s5b_chn_env_octave,y                                                                                       !!! #}
{# !!! ta env_octave                                                                                                            !!! #}
{# !!! mp #$80 ; This mean 'manual pitch'                                                                                       !!! #}
{# !!! eq @manual_period                                                                                                        !!! #}

{# !!! auto_period:                                                                                                             !!! #}
{# !!! da pitch+0                                                                                                               !!! #}
{# !!! ta env_period+0                                                                                                          !!! #}
{# !!! da pitch+1                                                                                                               !!! #}
{# !!! ta env_period+1                                                                                                          !!! #}
{# !!! mp @set_envelope_volume_flag                                                                                             !!! #}

{# !!! manual_period:                                                                                                           !!! #}
{# !!! da famistudio_s5b_env_period_lo                                                                                          !!! #}
{# !!! ta env_period+0                                                                                                          !!! #}
{# !!! da famistudio_s5b_env_period_hi                                                                                          !!! #}
{# !!! ta env_period+1                                                                                                          !!! #}

{# !!! set_envelope_volume_flag:                                                                                                !!! #}
{# !!! da #$10                                                                                                                  !!! #}

{# !!! noenv:                                                                                                                   !!! #}
{# !!! ta env_bit                                                                                                               !!! #}

{#  Read/multiply volume                                                                                                    #}
{# !!! dx famistudio_s5b_env_table,y                                                                                            !!! #}
    {% if FAMISTUDIO_USE_VOLUME_TRACK                                                                                              %}
{# !!! da famistudio_chn_volume_track+FAMISTUDIO_S5B_CH0_IDX, y                                                                 !!! #}
        {% if FAMISTUDIO_USE_VOLUME_SLIDES                                                                                             %}
{#  During a slide, the lower 4 bits are fraction.                                                                          #}
{# !!! nd #$f0                                                                                                                  !!! #}
        {% endif 120 %}
{# !!! ra famistudio_env_value+FAMISTUDIO_ENV_VOLUME_OFF,x                                                                      !!! #}
    {% else 120 %}
{# !!! da famistudio_env_value+FAMISTUDIO_ENV_VOLUME_OFF,x                                                                      !!! #}
    {% endif 120 %}
{# !!! ax                                                                                                                       !!! #}

{# !!! update_volume:                                                                                                           !!! #}
{#  Write volume                                                                                                            #}
{# !!! da famistudio_s5b_vol_table,y                                                                                            !!! #}
{# !!! ta FAMISTUDIO_S5B_ADDR                                                                                                   !!! #}
    {% if FAMISTUDIO_USE_VOLUME_TRACK                                                                                              %}
{# !!! da famistudio_volume_table,x                                                                                             !!! #}
{# !!! ra env_bit                                                                                                               !!! #}
    {% else 120 %}
{# !!! xa                                                                                                                       !!! #}
{# !!! ra env_bit                                                                                                               !!! #}
    {% endif 120 %}
{# !!! ta FAMISTUDIO_S5B_DATA                                                                                                   !!! #}

{# !!! write_shared_registers:                                                                                                  !!! #}
{#  Channel 2 writes all 5 shared registers.                                                                                #}
{# !!! py #2                                                                                                                    !!! #}
{# !!! ne @done                                                                                                                 !!! #}
{# !!! da env_shape                                                                                                             !!! #}
{# !!! eq @write_shared_noise                                                                                                   !!! #}
{# !!! dx env_octave                                                                                                            !!! #}
{# !!! px #$80                                                                                                                  !!! #}
{# !!! eq @write_shared_env_register                                                                                            !!! #}

{# !!! compute_auto_period:                                                                                                     !!! #}
{# !!! px #0                                                                                                                    !!! #}
{# !!! eq @write_shared_env_register                                                                                            !!! #}
{# !!! pl @positive_octave_loop                                                                                                 !!! #}

{# !!! negative_octave_loop:                                                                                                    !!! #}
{# !!! sl env_period+0                                                                                                          !!! #}
{# !!! ol env_period+1                                                                                                          !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! ne @negative_octave_loop                                                                                                 !!! #}
{# !!! eq @write_shared_env_register                                                                                            !!! #}

{# !!! positive_octave_loop:                                                                                                    !!! #}
{# !!! px #1                                                                                                                    !!! #}
{# !!! ne @do_shift                                                                                                             !!! #}
{# !!! rounding:                                                                                                                !!! #}
{# !!! da env_period+0                                                                                                          !!! #}
{# !!! nd #1                                                                                                                    !!! #}
{# !!! eq @do_shift                                                                                                             !!! #}
{# !!! da env_period+0                                                                                                          !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc #1                                                                                                                    !!! #}
{# !!! ta env_period+0                                                                                                          !!! #}
{# !!! cc @do_shift                                                                                                             !!! #}
{# !!! nc env_period+1                                                                                                          !!! #}
{# !!! do_shift:                                                                                                                !!! #}
{# !!! sr env_period+1                                                                                                          !!! #}
{# !!! or env_period+0                                                                                                          !!! #}
{# !!! ex                                                                                                                       !!! #}
{# !!! ne @positive_octave_loop                                                                                                 !!! #}

{# !!! write_shared_env_register:                                                                                               !!! #}

{#  Envelope period.                                                                                                        #}
{# !!! da #FAMISTUDIO_S5B_REG_ENV_LO                                                                                            !!! #}
{# !!! ta FAMISTUDIO_S5B_ADDR                                                                                                   !!! #}
{# !!! da env_period+0                                                                                                          !!! #}
{# !!! ta FAMISTUDIO_S5B_DATA                                                                                                   !!! #}
{# !!! da #FAMISTUDIO_S5B_REG_ENV_HI                                                                                            !!! #}
{# !!! ta FAMISTUDIO_S5B_ADDR                                                                                                   !!! #}
{# !!! da env_period+1                                                                                                          !!! #}
{# !!! ta FAMISTUDIO_S5B_DATA                                                                                                   !!! #}

{#  Reset envelope if there was an attack.                                                                                  #}
{# !!! da attack                                                                                                                !!! #}
{# !!! pl @write_shared_noise                                                                                                   !!! #}
{# !!! da #FAMISTUDIO_S5B_REG_SHAPE                                                                                             !!! #}
{# !!! ta FAMISTUDIO_S5B_ADDR                                                                                                   !!! #}
{# !!! da env_shape                                                                                                             !!! #}
{# !!! ta FAMISTUDIO_S5B_DATA                                                                                                   !!! #}

{# !!! write_shared_noise:                                                                                                      !!! #}

{#  Tone/noise enabled.                                                                                                     #}
{# !!! da #FAMISTUDIO_S5B_REG_TONE                                                                                              !!! #}
{# !!! ta FAMISTUDIO_S5B_ADDR                                                                                                   !!! #}
{# !!! da famistudio_env_value+FAMISTUDIO_S5B_CH2_ENVS+FAMISTUDIO_ENV_MIXER_IDX_OFF                                             !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ra famistudio_env_value+FAMISTUDIO_S5B_CH1_ENVS+FAMISTUDIO_ENV_MIXER_IDX_OFF                                             !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ra famistudio_env_value+FAMISTUDIO_S5B_CH0_ENVS+FAMISTUDIO_ENV_MIXER_IDX_OFF                                             !!! #}
{# !!! ta FAMISTUDIO_S5B_DATA                                                                                                   !!! #}

{#  Noise freq                                                                                                              #}
{# !!! da #FAMISTUDIO_S5B_REG_NOISE                                                                                             !!! #}
{# !!! ta FAMISTUDIO_S5B_ADDR                                                                                                   !!! #}
{# !!! da noise_freq                                                                                                            !!! #}
{# !!! ta FAMISTUDIO_S5B_DATA                                                                                                   !!! #}

{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_s5b_env_override                                                                                           !!! #}

{# !!! done:                                                                                                                    !!! #}
{# !!! ts                                                                                                                       !!! #}

{% endif 120 %}

{% if FAMISTUDIO_USE_PHASE_RESET                                                                                               %}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_PROCESS_PHASE_RESETS (internal)                                                                              #}
{#                                                                                                                          #}
{#  Reset phases for channels that requested it this frame.                                                                 #}
{# ======================================================================================================================   #}

{# !!! macro conditional_phase_reset_regular prev_hi, reg_hi                                                                    !!! #}
{# !!! sr                                                                                                                       !!! #}
{# !!! cc @done                                                                                                                 !!! #}
{# !!! dy prev_hi                                                                                                               !!! #}
{# !!! ty reg_hi                                                                                                                !!! #}
{# !!! done:                                                                                                                    !!! #}
{# !!! endm                                                                                                                     !!! #}

{# !!! macro conditional_phase_reset_vrc6 prev_hi, reg_hi                                                                       !!! #}
{# !!! sr                                                                                                                       !!! #}
{# !!! cc @done                                                                                                                 !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! da prev_hi                                                                                                               !!! #}
{# !!! ta reg_hi                                                                                                                !!! #}
{# !!! ra #$80                                                                                                                  !!! #}
{# !!! ta reg_hi                                                                                                                !!! #}
{# !!! xa                                                                                                                       !!! #}
{# !!! done:                                                                                                                    !!! #}
{# !!! endm                                                                                                                     !!! #}

{# !!! macro conditional_phase_reset_fds prev_hi, reg_hi                                                                        !!! #}
{# !!! sr                                                                                                                       !!! #}
{# !!! cc @done                                                                                                                 !!! #}
{# !!! da prev_hi                                                                                                               !!! #}
{# !!! ra #$80                                                                                                                  !!! #}
{# !!! ta reg_hi                                                                                                                !!! #}
{# !!! nd #$7f                                                                                                                  !!! #}
{# !!! ta reg_hi                                                                                                                !!! #}
{# !!! done:                                                                                                                    !!! #}
{# !!! endm                                                                                                                     !!! #}

{# !!! amistudio_process_phase_resets:                                                                                          !!! #}

{#  We group all the phase resets here at the end of the frame to make it easier to replicate in the main app since         #}
{#  this routine will have very predictable # of cycle between channels, and having channels closers mean its easier        #}
{#  to sync 2 channels together. The downside is that we need to keep the previous hi-period for VRC6 (3-bytes) and         #}
{#  FDS (1-byte).                                                                                                           #}

{# !!! da famistudio_phase_reset                                                                                                !!! #}

{#  TODO : What about SFX here? A phase reset here will reset the SFX? Or will it?                                          #}
{# !!! onditional_phase_reset_regular famistudio_pulse1_prev, FAMISTUDIO_APU_PL1_HI                                             !!! #}
{# !!! onditional_phase_reset_regular famistudio_pulse2_prev, FAMISTUDIO_APU_PL2_HI                                             !!! #}

    {% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! onditional_phase_reset_vrc6 famistudio_vrc6_pulse1_prev_hi, FAMISTUDIO_VRC6_PL1_HI                                       !!! #}
{# !!! onditional_phase_reset_vrc6 famistudio_vrc6_pulse2_prev_hi, FAMISTUDIO_VRC6_PL2_HI                                       !!! #}
{# !!! onditional_phase_reset_vrc6 famistudio_vrc6_saw_prev_hi, FAMISTUDIO_VRC6_SAW_HI                                          !!! #}
    {% else 120 %}
{# !!! sr                                                                                                                       !!! #}
{# !!! sr                                                                                                                       !!! #}
{# !!! sr                                                                                                                       !!! #}
    {% endif 120 %}

    {% if FAMISTUDIO_EXP_MMC5                                                                                                      %}
{# !!! onditional_phase_reset_regular famistudio_mmc5_pulse1_prev, FAMISTUDIO_MMC5_PL1_HI                                       !!! #}
{# !!! onditional_phase_reset_regular famistudio_mmc5_pulse2_prev, FAMISTUDIO_MMC5_PL2_HI                                       !!! #}
    {% else 120 %}
{# !!! sr                                                                                                                       !!! #}
{# !!! sr                                                                                                                       !!! #}
    {% endif 120 %}

    {% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! onditional_phase_reset_fds famistudio_fds_prev_hi, FAMISTUDIO_FDS_FREQ_HI                                                !!! #}
    {% endif 120 %}

    {% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! dx #0                                                                                                                    !!! #}
{# !!! n163_phase_reset_loop:                                                                                                   !!! #}
{# !!! da famistudio_channel_to_phase_reset_mask+FAMISTUDIO_N163_CH0_IDX, x                                                     !!! #}
{# !!! nd famistudio_phase_reset_n163                                                                                           !!! #}
{# !!! eq @next_n163_channel                                                                                                    !!! #}
{# !!! dy #0                                                                                                                    !!! #}
{# !!! da famistudio_n163_phase_table_lo,x                                                                                      !!! #}
{# !!! ta FAMISTUDIO_N163_ADDR                                                                                                  !!! #}
{# !!! ty FAMISTUDIO_N163_DATA                                                                                                  !!! #}
{# !!! da famistudio_n163_phase_table_mid,x                                                                                     !!! #}
{# !!! ta FAMISTUDIO_N163_ADDR                                                                                                  !!! #}
{# !!! ty FAMISTUDIO_N163_DATA                                                                                                  !!! #}
{# !!! da famistudio_n163_phase_table_hi,x                                                                                      !!! #}
{# !!! ta FAMISTUDIO_N163_ADDR                                                                                                  !!! #}
{# !!! ty FAMISTUDIO_N163_DATA                                                                                                  !!! #}
{# !!! next_n163_channel:                                                                                                       !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! px #FAMISTUDIO_EXP_N163_CHN_CNT                                                                                          !!! #}
{# !!! ne @n163_phase_reset_loop                                                                                                !!! #}
    {% endif 120 %}

{# !!! clear_phase_reset_flags:                                                                                                 !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_phase_reset                                                                                                !!! #}
        {% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! ta famistudio_phase_reset_n163                                                                                           !!! #}
        {% endif 120 %}
{# !!! ts                                                                                                                       !!! #}

{% endif 120 %}

{% if FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS                                                                         %}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_UPDATE_ROW_WITH_DELAYS (internal)                                                                            #}
{#                                                                                                                          #}
{#  Advance the song for a given channel, but while managing notes/cuts delays.                                             #}
{#                                                                                                                          #}
{#  [in] x: channel index (also true when leaving the function)                                                             #}
{# ======================================================================================================================   #}

{# !!! amistudio_advance_channel_with_delays:                                                                                   !!! #}

{#  Is the tempo telling us to advance by 1 row?                                                                            #}
{# !!! da famistudio_tempo_advance_row                                                                                          !!! #}
{# !!! eq @check_delayed_note                                                                                                   !!! #}

{#  Tempo says we need to advance, was there a delayed note wairing?                                                        #}
{# !!! da famistudio_chn_note_delay,x                                                                                           !!! #}
{# !!! mi @advance                                                                                                              !!! #}

{#  Need to clear any pending delayed note before advancing (will be inaudible).                                            #}
{# !!! clear_delayed_note:                                                                                                      !!! #}
{# !!! da #$ff                                                                                                                  !!! #}
{# !!! ta famistudio_chn_note_delay,x                                                                                           !!! #}
{# !!! sr famistudio_advance_channel ; This is the update for the de delayed note.                                              !!! #}
{# !!! mp @advance                                                                                                              !!! #}

{#  Tempo said we didnt need to advance, see if there is delayed note with a counter that reached zero.                     #}
{# !!! check_delayed_note:                                                                                                      !!! #}
{# !!! da famistudio_chn_note_delay,x                                                                                           !!! #}
{# !!! mi @check_delayed_cut                                                                                                    !!! #}
{# !!! ec                                                                                                                       !!! #}
{# !!! bc #1                                                                                                                    !!! #}
{# !!! ta famistudio_chn_note_delay,x                                                                                           !!! #}
{# !!! pl @check_delayed_cut ; When wrapping from 0 -> 0xff, we play the note.                                                  !!! #}

{#  Finally, advance by 1 row.                                                                                              #}
{# !!! advance:                                                                                                                 !!! #}
{# !!! sr famistudio_advance_channel                                                                                            !!! #}

{#  Handle delayed cuts.                                                                                                    #}
{# !!! check_delayed_cut:                                                                                                       !!! #}
{# !!! da famistudio_chn_cut_delay,x                                                                                            !!! #}
{# !!! mi @done                                                                                                                 !!! #}
{# !!! ec                                                                                                                       !!! #}
{# !!! bc #1                                                                                                                    !!! #}
{# !!! ta famistudio_chn_cut_delay,x                                                                                            !!! #}
{# !!! pl @done ; When wrapping from 0 -> 0xff, we play the note.                                                               !!! #}

{#  Write a stop note.                                                                                                      #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_chn_note,x                                                                                                 !!! #}

{#  Special case for DPCM, need to stop it manually.                                                                        #}
{# !!! px #4                                                                                                                    !!! #}
{# !!! ne @done                                                                                                                 !!! #}
{# !!! sr famistudio_sample_stop                                                                                                !!! #}

{# !!! done:                                                                                                                    !!! #}
{# !!! ts                                                                                                                       !!! #}

{% endif 120 %}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_UPDATE (public)                                                                                              #}
{#                                                                                                                          #}
{#  Main update function, should be called once per frame, ideally at the end of NMI. Will update the tempo, advance        #}
{#  the song if needed, update instrument and apply any change to the APU registers.                                        #}
{#                                                                                                                          #}
{#  [in] no input params.                                                                                                   #}
{# ======================================================================================================================   #}

{# !!! amistudio_update:                                                                                                        !!! #}

{# !!! itch_env_type = famistudio_r0                                                                                            !!! #}
{# !!! emp_pitch     = famistudio_r1                                                                                            !!! #}
{# !!! empo_env_ptr  = famistudio_ptr0                                                                                          !!! #}
{# !!! nv_ptr        = famistudio_ptr0                                                                                          !!! #}
{# !!! itch_env_ptr  = famistudio_ptr0                                                                                          !!! #}

{% if FAMISTUDIO_CFG_THREAD                                                                                                    %}
{# !!! da famistudio_ptr0_lo                                                                                                    !!! #}
{# !!! ha                                                                                                                       !!! #}
{# !!! da famistudio_ptr0_hi                                                                                                    !!! #}
{# !!! ha                                                                                                                       !!! #}
{% endif 120 %}

{# !!! da famistudio_song_speed ; Speed 0 means that no music is playing currently                                              !!! #}
{# !!! mi @pause ; Bit 7 set is the pause flag                                                                                  !!! #}
{# !!! ne @update                                                                                                               !!! #}
{# !!! pause:                                                                                                                   !!! #}
{% if !FAMISTUDIO_USE_FAMITRACKER_TEMPO                                                                                        %}
{# !!! da #1                                                                                                                    !!! #}
{# !!! ta famistudio_tempo_frame_cnt                                                                                            !!! #}
{% endif 120 %}
{# !!! mp @update_sound                                                                                                         !!! #}

{# ----------------------------------------------------------------------------------------------------------------------   #}
{# !!! update:                                                                                                                  !!! #}

{% if FAMISTUDIO_USE_FAMITRACKER_TEMPO                                                                                         %}

{# !!! da famistudio_tempo_acc_hi                                                                                               !!! #}
{# !!! mp famistudio_song_speed                                                                                                 !!! #}
    {% if FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS                                                                         %}
{# !!! dx #0                                                                                                                    !!! #}
{# !!! tx famistudio_tempo_advance_row                                                                                          !!! #}
{# !!! cc @advance_song                                                                                                         !!! #}
    {% else 120 %}
{# !!! cc @update_envelopes                                                                                                     !!! #}
    {% endif 120 %}
{# !!! bc famistudio_song_speed ; Carry is set.                                                                                 !!! #}
{# !!! ta famistudio_tempo_acc_hi                                                                                               !!! #}
    {% if FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS                                                                         %}
{# !!! dx #1                                                                                                                    !!! #}
{# !!! tx famistudio_tempo_advance_row                                                                                          !!! #}
    {% endif 120 %}

{% else 120 %} {#  FamiStudio tempo #}

{#  Decrement envelope counter, see if we need to advance.                                                                  #}
{# !!! ec famistudio_tempo_env_counter                                                                                          !!! #}
{# !!! eq @advance_tempo_envelope                                                                                               !!! #}
{# !!! da #1                                                                                                                    !!! #}
{# !!! mp @store_frame_count                                                                                                    !!! #}

{# !!! advance_tempo_envelope:                                                                                                  !!! #}
{#  Advance the envelope by one step.                                                                                       #}
{# !!! da famistudio_tempo_env_ptr_lo                                                                                           !!! #}
{# !!! ta tempo_env_ptr+0                                                                                                       !!! #}
{# !!! da famistudio_tempo_env_ptr_hi                                                                                           !!! #}
{# !!! ta tempo_env_ptr+1                                                                                                       !!! #}

{# !!! nc famistudio_tempo_env_idx                                                                                              !!! #}
{# !!! dy famistudio_tempo_env_idx                                                                                              !!! #}
{# !!! da (tempo_env_ptr),y                                                                                                     !!! #}
{# !!! pl @store_counter ; Negative value means we loop back to to index 1.                                                     !!! #}

{# !!! tempo_envelope_end:                                                                                                      !!! #}
{# !!! dy #1                                                                                                                    !!! #}
{# !!! ty famistudio_tempo_env_idx                                                                                              !!! #}
{# !!! da (tempo_env_ptr),y                                                                                                     !!! #}

{# !!! store_counter:                                                                                                           !!! #}
{#  Reset the counter                                                                                                       #}
{# !!! ta famistudio_tempo_env_counter                                                                                          !!! #}
{# !!! da famistudio_tempo_frame_num                                                                                            !!! #}
{# !!! ne @store_frame_count                                                                                                    !!! #}
{# !!! mp @skip_frame                                                                                                           !!! #}

{# !!! store_frame_count:                                                                                                       !!! #}
{# !!! ta famistudio_tempo_frame_cnt                                                                                            !!! #}

{% endif 120 %}

{# ----------------------------------------------------------------------------------------------------------------------   #}
{# !!! advance_song:                                                                                                            !!! #}
{# !!! dx #0                                                                                                                    !!! #}
{# !!! channel_loop:                                                                                                            !!! #}
        {% if !FAMISTUDIO_CFG_DPCM_SUPPORT                                                                                             %}
{# !!! px #4                                                                                                                    !!! #}
{# !!! eq @channel_loop_end                                                                                                     !!! #}
        {% endif 120 %}
        {% if FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS                                                                         %}
{# !!! sr famistudio_advance_channel_with_delays                                                                                !!! #}
        {% else 120 %}
{# !!! sr famistudio_advance_channel                                                                                            !!! #}
        {% endif 120 %}
{# !!! channel_loop_end:                                                                                                        !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! px #FAMISTUDIO_NUM_CHANNELS                                                                                              !!! #}
{# !!! ne @channel_loop                                                                                                         !!! #}

{# ----------------------------------------------------------------------------------------------------------------------   #}
{# !!! update_envelopes:                                                                                                        !!! #}
{# !!! dx #0                                                                                                                    !!! #}

{# !!! env_process:                                                                                                             !!! #}
{# !!! da famistudio_env_repeat,x                                                                                               !!! #}
{# !!! eq @env_read                                                                                                             !!! #}
{# !!! ec famistudio_env_repeat,x                                                                                               !!! #}
{# !!! ne @env_next                                                                                                             !!! #}

{# !!! env_read:                                                                                                                !!! #}
{# !!! da famistudio_env_addr_lo,x                                                                                              !!! #}
{# !!! ta env_ptr+0                                                                                                             !!! #}
{# !!! da famistudio_env_addr_hi,x                                                                                              !!! #}
{# !!! ta env_ptr+1                                                                                                             !!! #}
{# !!! dy famistudio_env_ptr,x                                                                                                  !!! #}

{# !!! env_read_value:                                                                                                          !!! #}
{# !!! da (env_ptr),y                                                                                                           !!! #}
{# !!! pl @env_special ; Values below 128 used as a special code, loop or repeat                                                !!! #}
{# !!! lc              ; Values above 128 are output value+192 (output values are signed -63..64)                               !!! #}
{# !!! dc #256-192                                                                                                              !!! #}
{# !!! ta famistudio_env_value,x                                                                                                !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ne @env_next_store_ptr                                                                                                   !!! #}

{# !!! env_special:                                                                                                             !!! #}
{# !!! ne @env_set_repeat  ; Zero is the loop point, non-zero values used for the repeat counter                                !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (env_ptr),y     ; Read loop position                                                                                  !!! #}
{# !!! ay                                                                                                                       !!! #}
{# !!! mp @env_read_value                                                                                                       !!! #}

{# !!! env_set_repeat:                                                                                                          !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_env_repeat,x ; Store the repeat counter value                                                              !!! #}

{# !!! env_next_store_ptr:                                                                                                      !!! #}
{# !!! ya                                                                                                                       !!! #}
{# !!! ta famistudio_env_ptr,x                                                                                                  !!! #}

{# !!! env_next:                                                                                                                !!! #}
{# !!! nx                                                                                                                       !!! #}

{# !!! px #FAMISTUDIO_NUM_ENVELOPES                                                                                             !!! #}
{# !!! ne @env_process                                                                                                          !!! #}

{# ----------------------------------------------------------------------------------------------------------------------   #}
{# !!! update_pitch_envelopes:                                                                                                  !!! #}
{# !!! dx #0                                                                                                                    !!! #}
{# !!! mp @pitch_env_process                                                                                                    !!! #}

{# !!! pitch_env_process:                                                                                                       !!! #}
{# !!! da famistudio_pitch_env_repeat,x                                                                                         !!! #}
{# !!! eq @pitch_env_read                                                                                                       !!! #}
{# !!! ec famistudio_pitch_env_repeat,x                                                                                         !!! #}
{# !!! ne @pitch_env_next                                                                                                       !!! #}

{# !!! pitch_env_read:                                                                                                          !!! #}
{# !!! da famistudio_pitch_env_addr_lo,x                                                                                        !!! #}
{# !!! ta pitch_env_ptr+0                                                                                                       !!! #}
{# !!! da famistudio_pitch_env_addr_hi,x                                                                                        !!! #}
{# !!! ta pitch_env_ptr+1                                                                                                       !!! #}
{# !!! dy #0                                                                                                                    !!! #}
{# !!! da (pitch_env_ptr),y                                                                                                     !!! #}
{# !!! ta pitch_env_type ; First value is 0 for absolute envelope, 0x80 for relative.                                           !!! #}
{# !!! dy famistudio_pitch_env_ptr,x                                                                                            !!! #}

{# !!! pitch_env_read_value:                                                                                                    !!! #}
{# !!! da (pitch_env_ptr),y                                                                                                     !!! #}
{# !!! pl @pitch_env_special                                                                                                    !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc #256-192                                                                                                              !!! #}
{# !!! it pitch_env_type                                                                                                        !!! #}
{# !!! mi @pitch_relative                                                                                                       !!! #}

{# !!! pitch_absolute:                                                                                                          !!! #}
{# !!! ta famistudio_pitch_env_value_lo,x                                                                                       !!! #}
{# !!! ra #0                                                                                                                    !!! #}
{# !!! mi @pitch_absolute_neg                                                                                                   !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! mp @pitch_absolute_set_value_hi                                                                                          !!! #}
{# !!! pitch_absolute_neg:                                                                                                      !!! #}
{# !!! da #$ff                                                                                                                  !!! #}
{# !!! pitch_absolute_set_value_hi:                                                                                             !!! #}
{# !!! ta famistudio_pitch_env_value_hi,x                                                                                       !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! mp @pitch_env_next_store_ptr                                                                                             !!! #}

{# !!! pitch_relative:                                                                                                          !!! #}
{# !!! ta temp_pitch                                                                                                            !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc famistudio_pitch_env_value_lo,x                                                                                       !!! #}
{# !!! ta famistudio_pitch_env_value_lo,x                                                                                       !!! #}
{# !!! da temp_pitch                                                                                                            !!! #}
{# !!! nd #$80                                                                                                                  !!! #}
{# !!! pl @pitch_relative_pos                                                                                                   !!! #}
{# !!! da #$ff                                                                                                                  !!! #}
{# !!! pitch_relative_pos:                                                                                                      !!! #}
{# !!! dc famistudio_pitch_env_value_hi,x                                                                                       !!! #}
{# !!! ta famistudio_pitch_env_value_hi,x                                                                                       !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! mp @pitch_env_next_store_ptr                                                                                             !!! #}

{# !!! pitch_env_special:                                                                                                       !!! #}
{# !!! ne @pitch_env_set_repeat                                                                                                 !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (pitch_env_ptr),y                                                                                                     !!! #}
{# !!! ay                                                                                                                       !!! #}
{# !!! mp @pitch_env_read_value                                                                                                 !!! #}

{# !!! pitch_env_set_repeat:                                                                                                    !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ra pitch_env_type ; This is going to set the relative flag in the hi-bit.                                                !!! #}
{# !!! ta famistudio_pitch_env_repeat,x                                                                                         !!! #}

{# !!! pitch_env_next_store_ptr:                                                                                                !!! #}
{# !!! ya                                                                                                                       !!! #}
{# !!! ta famistudio_pitch_env_ptr,x                                                                                            !!! #}

{# !!! pitch_env_next:                                                                                                          !!! #}
{# !!! nx                                                                                                                       !!! #}

{# !!! px #FAMISTUDIO_NUM_PITCH_ENVELOPES                                                                                       !!! #}
{# !!! ne @pitch_env_process                                                                                                    !!! #}

{% if FAMISTUDIO_USE_SLIDE_NOTES                                                                                               %}
{# ----------------------------------------------------------------------------------------------------------------------   #}
{# !!! update_slides:                                                                                                           !!! #}
{# !!! dx #0                                                                                                                    !!! #}

{# !!! slide_process:                                                                                                           !!! #}
{# !!! da famistudio_slide_step,x ; Zero repeat means no active slide.                                                          !!! #}
{# !!! eq @slide_next                                                                                                           !!! #}
{# !!! lc ; Add step to slide pitch (16bit + 8bit signed).                                                                      !!! #}
{# !!! da famistudio_slide_step,x                                                                                               !!! #}
{# !!! dc famistudio_slide_pitch_lo,x                                                                                           !!! #}
{# !!! ta famistudio_slide_pitch_lo,x                                                                                           !!! #}
{# !!! da famistudio_slide_step,x                                                                                               !!! #}
{# !!! nd #$80                                                                                                                  !!! #}
{# !!! eq @positive_slide                                                                                                       !!! #}

{# !!! negative_slide:                                                                                                          !!! #}
{# !!! da #$ff                                                                                                                  !!! #}
{# !!! dc famistudio_slide_pitch_hi,x                                                                                           !!! #}
{# !!! ta famistudio_slide_pitch_hi,x                                                                                           !!! #}
{# !!! pl @slide_next                                                                                                           !!! #}
{# !!! mp @clear_slide                                                                                                          !!! #}

{# !!! positive_slide:                                                                                                          !!! #}
{# !!! dc famistudio_slide_pitch_hi,x                                                                                           !!! #}
{# !!! ta famistudio_slide_pitch_hi,x                                                                                           !!! #}
{# !!! mi @slide_next                                                                                                           !!! #}

{# !!! clear_slide:                                                                                                             !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_slide_step,x                                                                                               !!! #}

{# !!! slide_next:                                                                                                              !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! px #FAMISTUDIO_NUM_SLIDES                                                                                                !!! #}
{# !!! ne @slide_process                                                                                                        !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_VOLUME_SLIDES                                                                                             %}

{#  FIXME : This seem wayyyy more complicated than it should.                                                               #}
{#  - The track volume has 4 bits of fraction : VVVVFFFF                                                                    #}
{#  - The slide step is signed : SVVVFFFF                                                                                   #}
{#  - The slide target (end volume) is simply : VVVV0000                                                                    #}
{#                                                                                                                          #}
{#  foreach slides                                                                                                          #}
{#      if step != 0                                                                                                        #}
{#          volume += step                                                                                                  #}
{#          if step > 0 && volume >= target || step < 0 && volume <= target                                                 #}
{#              volume = target                                                                                             #}
{#              step = 0                                                                                                    #}

{# !!! update_volume_slides:                                                                                                    !!! #}
{# !!! dx #0                                                                                                                    !!! #}

{# !!! volume_side_process:                                                                                                     !!! #}
{# !!! da famistudio_chn_volume_slide_step,x                                                                                    !!! #}
{# !!! eq @volume_slide_next                                                                                                    !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! mi @negative_volume_slide                                                                                                !!! #}

{# !!! positive_volume_slide:                                                                                                   !!! #}
{#  If the slide goes up, stop if we hit the target or go over it, over 15 (carry will be set)                              #}
{# !!! dc famistudio_chn_volume_track,x                                                                                         !!! #}
{# !!! cs @clear_volume_slide                                                                                                   !!! #}
{# !!! ta famistudio_chn_volume_track,x                                                                                         !!! #}
{# !!! mp famistudio_chn_volume_slide_target,x                                                                                  !!! #}
{# !!! cc @volume_slide_next                                                                                                    !!! #}
{# !!! cs @clear_volume_slide                                                                                                   !!! #}

{# !!! negative_volume_slide:                                                                                                   !!! #}
{#  If the slide goes do, stop if we hit the target or go below it, or below zero.                                          #}
{#  This is a bit trickier since we cant rely on the carry or any flag to                                                   #}
{#  tell us if we wrapped around.                                                                                           #}
{# !!! dc famistudio_chn_volume_track,x                                                                                         !!! #}
{# !!! dy famistudio_chn_volume_track,x                                                                                         !!! #}
{# !!! mi @slide_upper_half                                                                                                     !!! #}

{# !!! slide_lower_half:                                                                                                        !!! #}
{# !!! ta famistudio_chn_volume_track,x                                                                                         !!! #}
{# !!! mp famistudio_chn_volume_slide_target,x                                                                                  !!! #}
{# !!! eq @clear_volume_slide                                                                                                   !!! #}
{# !!! mi @clear_volume_slide                                                                                                   !!! #}
{# !!! pl @volume_slide_next                                                                                                    !!! #}

{# !!! slide_upper_half:                                                                                                        !!! #}
{# !!! ta famistudio_chn_volume_track,x                                                                                         !!! #}
{# !!! mp famistudio_chn_volume_slide_target,x                                                                                  !!! #}
{# !!! eq @clear_volume_slide                                                                                                   !!! #}
{# !!! cs @volume_slide_next                                                                                                    !!! #}

{# !!! clear_volume_slide:                                                                                                      !!! #}
{# !!! da famistudio_chn_volume_slide_target,x                                                                                  !!! #}
{# !!! ta famistudio_chn_volume_track,x                                                                                         !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_chn_volume_slide_step,x                                                                                    !!! #}

{# !!! volume_slide_next:                                                                                                       !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! px #FAMISTUDIO_NUM_VOLUME_SLIDES                                                                                         !!! #}
{# !!! ne @volume_side_process                                                                                                  !!! #}
{% endif 120 %}

{% if FAMISTUDIO_CFG_EQUALIZER                                                                                                 %}
{# !!! update_equalizer:                                                                                                        !!! #}
{# !!! dx #0                                                                                                                    !!! #}
{# !!! eq_channel_loop:                                                                                                         !!! #}
{# !!! da famistudio_chn_note_counter, x                                                                                        !!! #}
{# !!! eq @no_note                                                                                                              !!! #}
{# !!! ec famistudio_chn_note_counter, x                                                                                        !!! #}
{# !!! no_note:                                                                                                                 !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! px #FAMISTUDIO_NUM_CHANNELS                                                                                              !!! #}
{# !!! ne @eq_channel_loop                                                                                                      !!! #}
{% endif 120 %}

{# ----------------------------------------------------------------------------------------------------------------------   #}
{# !!! update_sound:                                                                                                            !!! #}

{# !!! amistudio_update_channel_sound 0, FAMISTUDIO_CH0_ENVS, famistudio_pulse1_prev, FAMISTUDIO_ALIAS_PL1_HI, FAMISTUDIO_ALIAS_PL1_LO, FAMISTUDIO_ALIAS_PL1_VOL, FAMISTUDIO_APU_PL1_SWEEP !!! #}
{# !!! amistudio_update_channel_sound 1, FAMISTUDIO_CH1_ENVS, famistudio_pulse2_prev, FAMISTUDIO_ALIAS_PL2_HI, FAMISTUDIO_ALIAS_PL2_LO, FAMISTUDIO_ALIAS_PL2_VOL, FAMISTUDIO_APU_PL2_SWEEP !!! #}
{# !!! amistudio_update_channel_sound 2, FAMISTUDIO_CH2_ENVS, 0, FAMISTUDIO_ALIAS_TRI_HI, FAMISTUDIO_ALIAS_TRI_LO, FAMISTUDIO_ALIAS_TRI_LINEAR, 0 !!! #}
{# !!! amistudio_update_channel_sound 3, FAMISTUDIO_CH3_ENVS, 0, FAMISTUDIO_ALIAS_NOISE_LO, 0, FAMISTUDIO_ALIAS_NOISE_VOL, 0    !!! #}

{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! update_vrc6_sound:                                                                                                       !!! #}
{# !!! amistudio_update_channel_sound FAMISTUDIO_VRC6_CH0_IDX, FAMISTUDIO_VRC6_CH0_ENVS, famistudio_vrc6_pulse1_prev_hi, FAMISTUDIO_VRC6_PL1_HI, FAMISTUDIO_VRC6_PL1_LO, FAMISTUDIO_VRC6_PL1_VOL, 0 !!! #}
{# !!! amistudio_update_channel_sound FAMISTUDIO_VRC6_CH1_IDX, FAMISTUDIO_VRC6_CH1_ENVS, famistudio_vrc6_pulse2_prev_hi, FAMISTUDIO_VRC6_PL2_HI, FAMISTUDIO_VRC6_PL2_LO, FAMISTUDIO_VRC6_PL2_VOL, 0 !!! #}
{# !!! amistudio_update_channel_sound FAMISTUDIO_VRC6_CH2_IDX, FAMISTUDIO_VRC6_CH2_ENVS, famistudio_vrc6_saw_prev_hi, FAMISTUDIO_VRC6_SAW_HI, FAMISTUDIO_VRC6_SAW_LO, FAMISTUDIO_VRC6_SAW_VOL, 0 !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_MMC5                                                                                                      %}
{# !!! update_mmc5_sound:                                                                                                       !!! #}
{# !!! amistudio_update_channel_sound FAMISTUDIO_MMC5_CH0_IDX, FAMISTUDIO_MMC5_CH0_ENVS, famistudio_mmc5_pulse1_prev, FAMISTUDIO_MMC5_PL1_HI, FAMISTUDIO_MMC5_PL1_LO, FAMISTUDIO_MMC5_PL1_VOL, 0 !!! #}
{# !!! amistudio_update_channel_sound FAMISTUDIO_MMC5_CH1_IDX, FAMISTUDIO_MMC5_CH1_ENVS, famistudio_mmc5_pulse2_prev, FAMISTUDIO_MMC5_PL2_HI, FAMISTUDIO_MMC5_PL2_LO, FAMISTUDIO_MMC5_PL2_VOL, 0 !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! update_fds_sound:                                                                                                        !!! #}
{# !!! sr famistudio_update_fds_channel_sound                                                                                   !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_VRC7                                                                                                      %}
{# !!! update_vrc7_sound:                                                                                                       !!! #}
{# !!! dy #0                                                                                                                    !!! #}
{# !!! vrc7_channel_loop:                                                                                                       !!! #}
{# !!! sr famistudio_update_vrc7_channel_sound                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! py #6                                                                                                                    !!! #}
{# !!! ne @vrc7_channel_loop                                                                                                    !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! update_n163_sound:                                                                                                       !!! #}
{# !!! dy #0                                                                                                                    !!! #}
{# !!! n163_channel_loop:                                                                                                       !!! #}
{# !!! sr famistudio_update_n163_channel_sound                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! py #FAMISTUDIO_EXP_N163_CHN_CNT                                                                                          !!! #}
{# !!! ne @n163_channel_loop                                                                                                    !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_S5B                                                                                                       %}
{# !!! update_s5b_sound:                                                                                                        !!! #}
{# !!! dy #0                                                                                                                    !!! #}
{# !!! s5b_channel_loop:                                                                                                        !!! #}
{# !!! sr famistudio_update_s5b_channel_sound                                                                                   !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! py #3                                                                                                                    !!! #}
{# !!! ne @s5b_channel_loop                                                                                                     !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{# !!! update_epsm_sound:                                                                                                       !!! #}
{% if FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0                                                                                      %}
{# !!! dy #0                                                                                                                    !!! #}
{# !!! epsm_square_channel_loop:                                                                                                !!! #}
{# !!! sr famistudio_update_epsm_square_channel_sound                                                                           !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! py #FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT                                                                                      !!! #}
{# !!! ne @epsm_square_channel_loop                                                                                             !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_FM_CHN_CNT > 0                                                                                       %}
{# !!! dy #FAMISTUDIO_EXP_EPSM_FM_CHN_CNT - 1                                                                                   !!! #}
{# !!! epsm_fm_channel_loop:                                                                                                    !!! #}
{# !!! sr famistudio_update_epsm_fm_channel_sound                                                                               !!! #}
{# !!! ey                                                                                                                       !!! #}
{# !!! pl @epsm_fm_channel_loop                                                                                                 !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_RHYTHM_CNT > 0                                                                                       %}
{# !!! loop_cnt = famistudio_r2                                                                                                 !!! #}
{# !!! da #5                                                                                                                    !!! #}
{# !!! ta @loop_cnt                                                                                                             !!! #}
{# !!! epsm_rhythm_channel_loop:                                                                                                !!! #}
{# !!! dx @loop_cnt                                                                                                             !!! #}
{# !!! dy famistudio_rhythm_lut,x                                                                                               !!! #}
{# !!! mi @skip_epsm_rhythm_update ; if the value we load is $ff then                                                           !!! #}
{# !!! sr famistudio_update_epsm_rhythm_channel_sound                                                                           !!! #}
{# !!! skip_epsm_rhythm_update:                                                                                                 !!! #}
{# !!! ec @loop_cnt                                                                                                             !!! #}
{# !!! pl @epsm_rhythm_channel_loop                                                                                             !!! #}
{% endif 120 %}
{% endif 120 %}

{% if FAMISTUDIO_USE_PHASE_RESET                                                                                               %}
{# !!! sr famistudio_process_phase_resets                                                                                       !!! #}
{% endif 120 %}

{# !!! update_sound_done:                                                                                                       !!! #}
{% if FAMISTUDIO_USE_FAMITRACKER_TEMPO                                                                                         %}
{# !!! da famistudio_song_speed                                                                                                 !!! #}
{# !!! mi @skip_famitracker_tempo_update ; bit 7 = paused                                                                       !!! #}
{# !!! lc  ; Update frame counter that considers speed, tempo, and PAL/NTSC                                                     !!! #}
{# !!! da famistudio_tempo_acc_lo                                                                                               !!! #}
{# !!! dc famistudio_tempo_step_lo                                                                                              !!! #}
{# !!! ta famistudio_tempo_acc_lo                                                                                               !!! #}
{# !!! da famistudio_tempo_acc_hi                                                                                               !!! #}
{# !!! dc famistudio_tempo_step_hi                                                                                              !!! #}
{# !!! ta famistudio_tempo_acc_hi                                                                                               !!! #}
{# !!! skip_famitracker_tempo_update:                                                                                           !!! #}
{% else 120 %}
{#  See if we need to run a double frame (playing NTSC song on PAL)                                                         #}
{# !!! ec famistudio_tempo_frame_cnt                                                                                            !!! #}
{# !!! eq @skip_frame                                                                                                           !!! #}
{# !!! mp @advance_song                                                                                                         !!! #}
{% endif 120 %}

{# !!! skip_frame:                                                                                                              !!! #}

{# ----------------------------------------------------------------------------------------------------------------------   #}
{% if FAMISTUDIO_CFG_SFX_SUPPORT                                                                                               %}

{#  Process all sound effect streams                                                                                        #}
    {% if FAMISTUDIO_CFG_SFX_STREAMS > 0                                                                                           %}
{# !!! dx #FAMISTUDIO_SFX_CH0                                                                                                   !!! #}
{# !!! sr famistudio_sfx_update                                                                                                 !!! #}
    {% endif 120 %}
    {% if FAMISTUDIO_CFG_SFX_STREAMS > 1                                                                                           %}
{# !!! dx #FAMISTUDIO_SFX_CH1                                                                                                   !!! #}
{# !!! sr famistudio_sfx_update                                                                                                 !!! #}
    {% endif 120 %}
    {% if FAMISTUDIO_CFG_SFX_STREAMS > 2                                                                                           %}
{# !!! dx #FAMISTUDIO_SFX_CH2                                                                                                   !!! #}
{# !!! sr famistudio_sfx_update                                                                                                 !!! #}
    {% endif 120 %}
    {% if FAMISTUDIO_CFG_SFX_STREAMS > 3                                                                                           %}
{# !!! dx #FAMISTUDIO_SFX_CH3                                                                                                   !!! #}
{# !!! sr famistudio_sfx_update                                                                                                 !!! #}
    {% endif 120 %}

{#  Send data from the output buffer to the APU                                                                             #}

{# !!! da famistudio_output_buf      ; Pulse 1 volume                                                                           !!! #}
{# !!! ta FAMISTUDIO_APU_PL1_VOL                                                                                                !!! #}
{# !!! da famistudio_output_buf+1    ; Pulse 1 period LSB                                                                       !!! #}
{# !!! ta FAMISTUDIO_APU_PL1_LO                                                                                                 !!! #}
{# !!! da famistudio_output_buf+2    ; Pulse 1 period MSB, only applied when changed                                            !!! #}

    {% if FAMISTUDIO_CFG_SMOOTH_VIBRATO                                                                                            %}
{# !!! amistudio_smooth_vibrato famistudio_output_buf+1, famistudio_pulse1_prev, FAMISTUDIO_APU_PL1_HI, FAMISTUDIO_APU_PL1_LO, FAMISTUDIO_APU_PL1_SWEEP !!! #}
    {% else 120 %}
{# !!! mp famistudio_pulse1_prev                                                                                                !!! #}
{# !!! eq @no_pulse1_upd                                                                                                        !!! #}
{# !!! ta famistudio_pulse1_prev                                                                                                !!! #}
{# !!! ta FAMISTUDIO_APU_PL1_HI                                                                                                 !!! #}
    {% endif 120 %}

{# !!! no_pulse1_upd:                                                                                                           !!! #}
{# !!! da famistudio_output_buf+3    ; Pulse 2 volume                                                                           !!! #}
{# !!! ta FAMISTUDIO_APU_PL2_VOL                                                                                                !!! #}
{# !!! da famistudio_output_buf+4    ; Pulse 2 period LSB                                                                       !!! #}
{# !!! ta FAMISTUDIO_APU_PL2_LO                                                                                                 !!! #}
{# !!! da famistudio_output_buf+5    ; Pulse 2 period MSB, only applied when changed                                            !!! #}

    {% if FAMISTUDIO_CFG_SMOOTH_VIBRATO                                                                                            %}
{# !!! amistudio_smooth_vibrato famistudio_output_buf+4, famistudio_pulse2_prev, FAMISTUDIO_APU_PL2_HI, FAMISTUDIO_APU_PL2_LO, FAMISTUDIO_APU_PL2_SWEEP !!! #}
    {% else 120 %}
{# !!! mp famistudio_pulse2_prev                                                                                                !!! #}
{# !!! eq @no_pulse2_upd                                                                                                        !!! #}
{# !!! ta famistudio_pulse2_prev                                                                                                !!! #}
{# !!! ta FAMISTUDIO_APU_PL2_HI                                                                                                 !!! #}
    {% endif 120 %}

{# !!! no_pulse2_upd:                                                                                                           !!! #}
{# !!! da famistudio_output_buf+6    ; Triangle volume (plays or not)                                                           !!! #}
{# !!! ta FAMISTUDIO_APU_TRI_LINEAR                                                                                             !!! #}
{# !!! da famistudio_output_buf+7    ; Triangle period LSB                                                                      !!! #}
{# !!! ta FAMISTUDIO_APU_TRI_LO                                                                                                 !!! #}
{# !!! da famistudio_output_buf+8    ; Triangle period MSB                                                                      !!! #}
{# !!! ta FAMISTUDIO_APU_TRI_HI                                                                                                 !!! #}

{# !!! da famistudio_output_buf+9    ; Noise volume                                                                             !!! #}
{# !!! ta FAMISTUDIO_APU_NOISE_VOL                                                                                              !!! #}
{# !!! da famistudio_output_buf+10   ; Noise period                                                                             !!! #}
{# !!! ta FAMISTUDIO_APU_NOISE_LO                                                                                               !!! #}

{% endif 120 %}

{% if FAMISTUDIO_CFG_THREAD                                                                                                    %}
{# !!! la                                                                                                                       !!! #}
{# !!! ta famistudio_ptr0_hi                                                                                                    !!! #}
{# !!! la                                                                                                                       !!! #}
{# !!! ta famistudio_ptr0_lo                                                                                                    !!! #}
{% endif 120 %}

{# !!! ts                                                                                                                       !!! #}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_DO_NOTE_ATTACK + EXP VARIANTS (internal)                                                                     #}
{#                                                                                                                          #}
{#  Internal function to reset all the envelopes of a channnel (note attack).                                               #}
{#                                                                                                                          #}
{#  [in] x/r0 : channel index                                                                                               #}
{# ======================================================================================================================   #}

{% if FAMISTUDIO_EXP_VRC7                                                                                                      %}

{# !!! amistudio_do_vrc7_note_attack:                                                                                           !!! #}

{# !!! han_idx = famistudio_r0                                                                                                  !!! #}

{#  Set trigger flag for VRC7                                                                                               #}
{# !!! da #1                                                                                                                    !!! #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! ta famistudio_chn_vrc7_trigger-FAMISTUDIO_VRC7_CH0_IDX,x                                                                 !!! #}
{# !!! ts                                                                                                                       !!! #}

{% endif 120 %}

{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}

{# !!! amistudio_do_epsm_note_attack:                                                                                           !!! #}

{# !!! han_idx = famistudio_r0                                                                                                  !!! #}
{# !!! mp_y    = famistudio_r1                                                                                                  !!! #}

{% if FAMISTUDIO_EXP_EPSM_FM_CHN_CNT+FAMISTUDIO_EXP_EPSM_RHYTHM_CNT > 0                                                        %}
{# !!! ty tmp_y                                                                                                                 !!! #}
{# !!! dy chan_idx                                                                                                              !!! #}
{# !!! py #FAMISTUDIO_EPSM_CHAN_FM_START                                                                                        !!! #}
{# !!! cs @fm_or_rhythm_channel                                                                                                 !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0                                                                                      %}
{# !!! square_channel:                                                                                                          !!! #}

{#  Reset mixer/noise envelopes.                                                                                            #}
{# !!! dx famistudio_channel_env,y                                                                                              !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_env_repeat+FAMISTUDIO_ENV_MIXER_IDX_OFF,x                                                                  !!! #}
{# !!! ta famistudio_env_ptr+FAMISTUDIO_ENV_MIXER_IDX_OFF,x                                                                     !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_ENV_MIXER_IDX_OFF,x                                                                   !!! #}
{# !!! ta famistudio_env_repeat+FAMISTUDIO_ENV_NOISE_IDX_OFF,x                                                                  !!! #}
{# !!! ta famistudio_env_ptr+FAMISTUDIO_ENV_NOISE_IDX_OFF,x                                                                     !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_ENV_NOISE_IDX_OFF,x                                                                   !!! #}

{#  Set hi-bit of envelope shape to remember to reset it.                                                                   #}
{# !!! da #$80                                                                                                                  !!! #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! ra famistudio_epsm_chn_env_shape-FAMISTUDIO_EPSM_CH0_IDX,x                                                               !!! #}
{# !!! ta famistudio_epsm_chn_env_shape-FAMISTUDIO_EPSM_CH0_IDX,x                                                               !!! #}

{# !!! eq @done                                                                                                                 !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_EPSM_FM_CHN_CNT+FAMISTUDIO_EXP_EPSM_RHYTHM_CNT > 0                                                        %}
{# !!! fm_or_rhythm_channel:                                                                                                    !!! #}

{#  Set trigger flag for FM/rhythm. For rhythm we'll actually write                                                         #}
{#  out of bounds here, but the rhtyhm key array is immediately after.                                                      #}
{# !!! da #1                                                                                                                    !!! #}
{# !!! ta famistudio_chn_epsm_trigger-FAMISTUDIO_EPSM_CHAN_FM_START,y                                                           !!! #}
{% endif 120 %}

{# !!! done:                                                                                                                    !!! #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! dy tmp_y                                                                                                                 !!! #}
{# !!! ts                                                                                                                       !!! #}

{% endif 120 %}

{% if FAMISTUDIO_EXP_N163                                                                                                      %}

{# !!! amistudio_do_n163_note_attack:                                                                                           !!! #}

{# !!! han_idx = famistudio_r0                                                                                                  !!! #}
{# !!! mp_y    = famistudio_r1                                                                                                  !!! #}

{#  Reset wave envelope.                                                                                                    #}
{# !!! ty tmp_y                                                                                                                 !!! #}
{# !!! dy chan_idx                                                                                                              !!! #}
{# !!! dx famistudio_channel_env,y                                                                                              !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_env_repeat+FAMISTUDIO_ENV_N163_WAVE_IDX_OFF,x                                                              !!! #}
{# !!! da #1 ; Index 0 is release point, so envelope starts at 1.                                                               !!! #}
{# !!! ta famistudio_env_ptr+FAMISTUDIO_ENV_N163_WAVE_IDX_OFF,x                                                                 !!! #}

{#  Clear wave index to -1 to force reload.                                                                                 #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! da #$ff                                                                                                                  !!! #}
{# !!! ta famistudio_chn_n163_wave_index-FAMISTUDIO_N163_CH0_IDX, x                                                             !!! #}
{# !!! dy tmp_y                                                                                                                 !!! #}
{# !!! ts                                                                                                                       !!! #}

{% endif 120 %}

{% if FAMISTUDIO_EXP_S5B                                                                                                       %}

{# !!! amistudio_do_s5b_note_attack:                                                                                            !!! #}

{# !!! han_idx = famistudio_r0                                                                                                  !!! #}
{# !!! mp_y    = famistudio_r1                                                                                                  !!! #}

{#  Reset mixer/noise envelopes.                                                                                            #}
{# !!! ty tmp_y                                                                                                                 !!! #}
{# !!! dy chan_idx                                                                                                              !!! #}
{# !!! dx famistudio_channel_env,y                                                                                              !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_env_repeat+FAMISTUDIO_ENV_MIXER_IDX_OFF,x                                                                  !!! #}
{# !!! ta famistudio_env_ptr+FAMISTUDIO_ENV_MIXER_IDX_OFF,x                                                                     !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_ENV_MIXER_IDX_OFF,x                                                                   !!! #}
{# !!! ta famistudio_env_repeat+FAMISTUDIO_ENV_NOISE_IDX_OFF,x                                                                  !!! #}
{# !!! ta famistudio_env_ptr+FAMISTUDIO_ENV_NOISE_IDX_OFF,x                                                                     !!! #}
{# !!! ta famistudio_env_value+FAMISTUDIO_ENV_NOISE_IDX_OFF,x                                                                   !!! #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! dy tmp_y                                                                                                                 !!! #}

{#  Set hi-bit of envelope shape to remember to reset it.                                                                   #}
{# !!! da #$80                                                                                                                  !!! #}
{# !!! ra famistudio_s5b_chn_env_shape-FAMISTUDIO_S5B_CH0_IDX,x                                                                 !!! #}
{# !!! ta famistudio_s5b_chn_env_shape-FAMISTUDIO_S5B_CH0_IDX,x                                                                 !!! #}
{# !!! ts                                                                                                                       !!! #}

{% endif 120 %}

{% if FAMISTUDIO_EXP_FDS                                                                                                       %}

{# !!! amistudio_do_fds_note_attack:                                                                                            !!! #}

{# !!! han_idx = famistudio_r0                                                                                                  !!! #}

{#  TODO : We used to set the modulation value here, but that's bad.                                                        #}
{#  https://www.nesdev.org/wiki/FDS_audio#Mod_frequency_high_($4087)                                                        #}
{#  lda #$80                                                                                                                #}
{#  sta FAMISTUDIO_FDS_MOD_HI                                                                                               #}
{#  lda #0                                                                                                                  #}
{#  sta FAMISTUDIO_FDS_SWEEP_BIAS                                                                                           #}

{# !!! da famistudio_fds_mod_delay                                                                                              !!! #}
{# !!! ta famistudio_fds_mod_delay_counter                                                                                      !!! #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! ts                                                                                                                       !!! #}

{% endif 120 %}

{# !!! amistudio_do_note_attack:                                                                                                !!! #}

{# !!! han_idx = famistudio_r0                                                                                                  !!! #}
{# !!! mp_x    = famistudio_r2                                                                                                  !!! #}

{% if FAMISTUDIO_CFG_EQUALIZER                                                                                                 %}
{# !!! da #9                                                                                                                    !!! #}
{# !!! ta famistudio_chn_note_counter,x                                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_RHYTHM_CNT > 0                                                                                       %}
{# !!! da chan_idx                                                                                                              !!! #}
{# !!! mp #FAMISTUDIO_EPSM_CHAN_RHYTHM_START                                                                                    !!! #}
{# !!! cs @epsm_instrument                                                                                                      !!! #}
{% endif 120 %}
{# !!! da famistudio_channel_env,x                                                                                              !!! #}
{# !!! ax                                                                                                                       !!! #}

{#  Volume envelope.                                                                                                        #}
{# !!! da #1                                                                                                                    !!! #}
{# !!! ta famistudio_env_ptr,x ; Reset volume envelope pointer to 1 (volume have releases point in index 0)                     !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_env_repeat,x                                                                                               !!! #}

{#  Arpeggio envelope                                                                                                       #}
{# !!! ta famistudio_env_repeat+FAMISTUDIO_ENV_NOTE_OFF,x                                                                       !!! #}
{# !!! ta famistudio_env_ptr+FAMISTUDIO_ENV_NOTE_OFF,x                                                                          !!! #}

{#  Duty envelope (optional)                                                                                                #}
{# !!! da chan_idx                                                                                                              !!! #}
{# !!! mp #2 ; Triangle has no duty.                                                                                            !!! #}
{# !!! eq @no_duty                                                                                                              !!! #}
{% if FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_S5B || FAMISTUDIO_EXP_FDS || FAMISTUDIO_EXP_N163 || FAMISTUDIO_EXP_EPSM            %}
{# !!! mp #5                                                                                                                    !!! #}
{# !!! cs @no_duty                                                                                                              !!! #}
{% endif 120 %}
{# !!! duty:                                                                                                                    !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_env_repeat+FAMISTUDIO_ENV_DUTY_OFF,x                                                                       !!! #}
{# !!! ta famistudio_env_ptr+FAMISTUDIO_ENV_DUTY_OFF,x                                                                          !!! #}
    {% if FAMISTUDIO_USE_DUTYCYCLE_EFFECT                                                                                          %}
{# !!! tx tmp_x                                                                                                                 !!! #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! da famistudio_channel_to_dutycycle,x                                                                                     !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! da famistudio_duty_cycle,x                                                                                               !!! #}
{# !!! dx tmp_x                                                                                                                 !!! #}
    {% endif 120 %}
{# !!! ta famistudio_env_value+FAMISTUDIO_ENV_DUTY_OFF,x                                                                        !!! #}

{# !!! no_duty:                                                                                                                 !!! #}
{#  Pitch envelope                                                                                                          #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! da famistudio_channel_to_pitch_env, x                                                                                    !!! #}
{# !!! mi @no_pitch                                                                                                             !!! #}
{# !!! ax                                                                                                                       !!! #}

{# !!! reset_pitch_env:                                                                                                         !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_pitch_env_value_lo,x                                                                                       !!! #}
{# !!! ta famistudio_pitch_env_value_hi,x                                                                                       !!! #}
{# !!! ta famistudio_pitch_env_repeat,x                                                                                         !!! #}
{# !!! da #1                                                                                                                    !!! #}
{# !!! ta famistudio_pitch_env_ptr,x     ; Reset pitch envelope pointer to 1 (pitch envelope have relative/absolute flag in the first byte) !!! #}

{# !!! no_pitch:                                                                                                                !!! #}

{% if FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_N163 || FAMISTUDIO_EXP_EPSM || FAMISTUDIO_EXP_S5B || FAMISTUDIO_EXP_FDS            %}
{# !!! da chan_idx                                                                                                              !!! #}
{# !!! mp #5                                                                                                                    !!! #}
{# !!! cc @done                                                                                                                 !!! #}
{# !!! vrc7_instrument:                                                                                                         !!! #}
    {% if FAMISTUDIO_EXP_VRC7                                                                                                      %}
{# !!! mp famistudio_do_vrc7_note_attack                                                                                        !!! #}
    {% endif 120 %}
{# !!! n163_instrument:                                                                                                         !!! #}
    {% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! mp famistudio_do_n163_note_attack                                                                                        !!! #}
    {% endif 120 %}
{# !!! s5b_instrument:                                                                                                          !!! #}
    {% if FAMISTUDIO_EXP_S5B                                                                                                       %}
{# !!! mp famistudio_do_s5b_note_attack                                                                                         !!! #}
    {% endif 120 %}
{# !!! fds_instrument:                                                                                                          !!! #}
    {% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! mp famistudio_do_fds_note_attack                                                                                         !!! #}
    {% endif 120 %}
{# !!! epsm_instrument:                                                                                                         !!! #}
    {% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{# !!! mp famistudio_do_epsm_note_attack                                                                                        !!! #}
    {% endif 120 %}
{% endif 120 %}

{# !!! done:                                                                                                                    !!! #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! ts                                                                                                                       !!! #}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_LOAD_BASIC_ENVELOPES (internal)                                                                              #}
{#                                                                                                                          #}
{#  Internal function to load the most common envelopes (volume, arp, duty (optional) and pitch) for an instrument.         #}
{#                                                                                                                          #}
{#  [in] x:      first envelope index.                                                                                      #}
{#  [in] r0:     instrument index.                                                                                          #}
{#  [in] ptr1/y: point to instrument data to load.                                                                          #}
{# ======================================================================================================================   #}

{# !!! amistudio_load_basic_envelopes:                                                                                          !!! #}

{# !!! nstrument_ptr = famistudio_ptr1                                                                                          !!! #}
{# !!! han_idx      = famistudio_r0                                                                                             !!! #}
{# !!! mp_x         = famistudio_r3                                                                                             !!! #}

{#  Volume envelope                                                                                                         #}
{# !!! da (instrument_ptr),y                                                                                                    !!! #}
{# !!! ta famistudio_env_addr_lo,x                                                                                              !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (instrument_ptr),y                                                                                                    !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_env_addr_hi,x                                                                                              !!! #}
{# !!! nx                                                                                                                       !!! #}

{#  Arpeggio envelope                                                                                                       #}
{% if FAMISTUDIO_USE_ARPEGGIO                                                                                                  %}
{# !!! tx tmp_x                                                                                                                 !!! #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! da famistudio_chn_env_override,x ; Check if its overriden by arpeggio.                                                   !!! #}
{# !!! sr                                                                                                                       !!! #}
{# !!! dx tmp_x                                                                                                                 !!! #}
{# !!! cc @arpeggio_envelope                                                                                                    !!! #}
{# !!! ny ; Instrument arpeggio is overriden by arpeggio, dont touch!                                                           !!! #}
{# !!! mp @duty_envelope                                                                                                        !!! #}
{% endif 120 %}

{# !!! arpeggio_envelope:                                                                                                       !!! #}
{# !!! da (instrument_ptr),y                                                                                                    !!! #}
{# !!! ta famistudio_env_addr_lo,x                                                                                              !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (instrument_ptr),y                                                                                                    !!! #}
{# !!! ta famistudio_env_addr_hi,x                                                                                              !!! #}

{# !!! duty_envelope:                                                                                                           !!! #}
{#  Duty cycle envelope                                                                                                     #}
{# !!! da chan_idx                                                                                                              !!! #}
{# !!! mp #2 ; Triangle has no duty.                                                                                            !!! #}
{# !!! eq @no_duty                                                                                                              !!! #}
{% if FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_S5B || FAMISTUDIO_EXP_FDS || FAMISTUDIO_EXP_N163 || FAMISTUDIO_EXP_EPSM            %}
{# !!! mp #5                                                                                                                    !!! #}
{# !!! cs @pitch_envelope                                                                                                       !!! #}
{% endif 120 %}
{# !!! duty:                                                                                                                    !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (instrument_ptr),y                                                                                                    !!! #}
{# !!! ta famistudio_env_addr_lo,x                                                                                              !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (instrument_ptr),y                                                                                                    !!! #}
{# !!! ta famistudio_env_addr_hi,x                                                                                              !!! #}
{# !!! mp @pitch_envelope                                                                                                       !!! #}
{# !!! no_duty:                                                                                                                 !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ny                                                                                                                       !!! #}

{# !!! pitch_envelope:                                                                                                          !!! #}
{#  Pitch envelopes.                                                                                                        #}
{% if !FAMISTUDIO_EXP_NONE                                                                                                     %}
{# !!! tx tmp_x                                                                                                                 !!! #}
{% endif 120 %}
{# !!! dx chan_idx                                                                                                              !!! #}
{% if FAMISTUDIO_USE_VIBRATO                                                                                                   %}
{# !!! da famistudio_chn_env_override,x                                                                                         !!! #}
{# !!! sl ; Bit-7 tells us if the pitch env is overriden, temporarely store in carry.                                           !!! #}
{% endif 120 %}
{# !!! da famistudio_channel_to_pitch_env, x                                                                                    !!! #}
{# !!! mi @done                                                                                                                 !!! #}
{# !!! ax                                                                                                                       !!! #}
{% if FAMISTUDIO_USE_VIBRATO                                                                                                   %}
{# !!! or ; Bring back our bit-7 from above.                                                                                    !!! #}
{# !!! pl @no_vibrato ; In bit 7 is set, instrument pitch is overriden by vibrato, dont touch pitch envelope!                   !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ne @done                                                                                                                 !!! #}
{# !!! no_vibrato:                                                                                                              !!! #}
{% endif 120 %}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (instrument_ptr),y                                                                                                    !!! #}
{# !!! ta famistudio_pitch_env_addr_lo,x                                                                                        !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (instrument_ptr),y                                                                                                    !!! #}
{# !!! ta famistudio_pitch_env_addr_hi,x                                                                                        !!! #}
{# !!! done:                                                                                                                    !!! #}
{% if !FAMISTUDIO_EXP_NONE                                                                                                     %}
{#  For expansion, preserve X (envelope index) and Y (pointer in instrument data)                                           #}
{#  as they may want to load more after.                                                                                    #}
{# !!! dx tmp_x                                                                                                                 !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! ny                                                                                                                       !!! #}
{% endif 120 %}
{# !!! ts                                                                                                                       !!! #}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_SET_INSTRUMENT (internal)                                                                                    #}
{#                                                                                                                          #}
{#  Internal function to set an instrument for a given channel. Will initialize all instrument envelopes.                   #}
{#                                                                                                                          #}
{#  [in] x/r0: channel index                                                                                                #}
{#  [in] a:    instrument index.                                                                                            #}
{# ======================================================================================================================   #}

{# !!! amistudio_set_instrument:                                                                                                !!! #}

{# !!! nstrument_ptr = famistudio_ptr1                                                                                          !!! #}
{# !!! han_idx      = famistudio_r0                                                                                             !!! #}

{#  Pre-multiply by 4 if not using extended range, faster pointer arithmetic.                                               #}
    {% if !FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE                                                                                %}
{# !!! sl a                                                                                                                     !!! #}
{# !!! sl a                                                                                                                     !!! #}
    {% endif 120 %}

{# !!! dy chan_idx                                                                                                              !!! #}
{# !!! dx famistudio_channel_env,y                                                                                              !!! #}

{% if FAMISTUDIO_EXP_FDS || FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_N163 || FAMISTUDIO_EXP_EPSM || FAMISTUDIO_EXP_S5B            %}
{# !!! py #5                                                                                                                    !!! #}
{# !!! cc @base_instrument                                                                                                      !!! #}
    {% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! fds_instrument:                                                                                                          !!! #}
{# !!! mp famistudio_set_fds_instrument                                                                                         !!! #}
    {% endif 120 %}
    {% if FAMISTUDIO_EXP_VRC7                                                                                                      %}
{# !!! vrc7_instrument:                                                                                                         !!! #}
{# !!! mp famistudio_set_vrc7_instrument                                                                                        !!! #}
    {% endif 120 %}
    {% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! n163_instrument:                                                                                                         !!! #}
{# !!! mp famistudio_set_n163_instrument                                                                                        !!! #}
    {% endif 120 %}
    {% if FAMISTUDIO_EXP_S5B                                                                                                       %}
{# !!! s5b_instrument:                                                                                                          !!! #}
{# !!! mp famistudio_set_s5b_instrument                                                                                         !!! #}
    {% endif 120 %}
    {% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{# !!! epsm_instrument:                                                                                                         !!! #}
{# !!! mp famistudio_set_epsm_instrument                                                                                        !!! #}
    {% endif 120 %}
{% endif 120 %}

{# !!! base_instrument:                                                                                                         !!! #}

    {% if !FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE                                                                                %}
{# !!! sl ; Instrument number is pre multiplied by 4                                                                            !!! #}
{# !!! ay                                                                                                                       !!! #}
{# !!! da famistudio_instrument_hi                                                                                              !!! #}
{# !!! dc #0 ; Use carry to extend range for 64 instruments                                                                     !!! #}
{# !!! ta instrument_ptr+1                                                                                                      !!! #}
{# !!! da famistudio_instrument_lo                                                                                              !!! #}
{# !!! ta instrument_ptr+0                                                                                                      !!! #}
    {% else 120 %}
{#  Multiply by instrument stride of 8.                                                                                     #}
{# !!! dy #0                                                                                                                    !!! #}
{# !!! ty instrument_ptr+1                                                                                                      !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ol instrument_ptr+1                                                                                                      !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ol instrument_ptr+1                                                                                                      !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ol instrument_ptr+1                                                                                                      !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc famistudio_instrument_lo                                                                                              !!! #}
{# !!! ta instrument_ptr+0                                                                                                      !!! #}
{# !!! da instrument_ptr+1                                                                                                      !!! #}
{# !!! dc famistudio_instrument_hi                                                                                              !!! #}
{# !!! ta instrument_ptr+1                                                                                                      !!! #}
    {% endif 120 %}

{# !!! mp famistudio_load_basic_envelopes ; Will 'rts'                                                                          !!! #}

{% if FAMISTUDIO_EXP_FDS || FAMISTUDIO_EXP_N163 || FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_EPSM || FAMISTUDIO_EXP_S5B            %}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_GET_EXP_INST_PTR (internal)                                                                                  #}
{#                                                                                                                          #}
{#  Retrives the expansion instrument pointer for a given index.                                                            #}
{#                                                                                                                          #}
{#  [in]  a:      instrument index.                                                                                         #}
{#  [out] ptr1/y: the instrument pointer + offset                                                                           #}
{# ======================================================================================================================   #}

{# !!! amistudio_get_exp_inst_ptr:                                                                                              !!! #}

{# !!! nstrument_ptr = famistudio_ptr1                                                                                          !!! #}

 {% if !FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE                                                                                %}
{# !!! sl ; Instrument number is pre multiplied by 4                                                                            !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ay                                                                                                                       !!! #}
{# !!! da famistudio_exp_instrument_hi                                                                                          !!! #}
{# !!! dc #0  ; Use carry to extend range for 32 expansion instruments                                                          !!! #}
{# !!! ta instrument_ptr+1                                                                                                      !!! #}
{# !!! da famistudio_exp_instrument_lo                                                                                          !!! #}
{# !!! ta instrument_ptr+0                                                                                                      !!! #}
{% else 120 %}
{#  Multiply by expansion instrument stride of 16.                                                                          #}
{# !!! dy #0                                                                                                                    !!! #}
{# !!! ty instrument_ptr+1                                                                                                      !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ol instrument_ptr+1                                                                                                      !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ol instrument_ptr+1                                                                                                      !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ol instrument_ptr+1                                                                                                      !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ol instrument_ptr+1                                                                                                      !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc famistudio_exp_instrument_lo                                                                                          !!! #}
{# !!! ta instrument_ptr+0                                                                                                      !!! #}
{# !!! da instrument_ptr+1                                                                                                      !!! #}
{# !!! dc famistudio_exp_instrument_hi                                                                                          !!! #}
{# !!! ta instrument_ptr+1                                                                                                      !!! #}
{% endif 120 %}

{# !!! ts                                                                                                                       !!! #}

{% endif 120 %}

{% if FAMISTUDIO_EXP_FDS || FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_EPSM                                                         %}

{# !!! macro skip_exp_basic_envelopes                                                                                           !!! #}
{% if FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE                                                                                 %}
{# !!! dy #6                                                                                                                    !!! #}
{% else 120 %}
{# !!! ny                                                                                                                       !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ny                                                                                                                       !!! #}
{% endif 120 %}
{# !!! endm                                                                                                                     !!! #}

{% endif 120 %}

{% if FAMISTUDIO_EXP_VRC7                                                                                                      %}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_SET_VRC7_INSTRUMENT (internal)                                                                               #}
{#                                                                                                                          #}
{#  Internal function to set a VRC7 instrument for a given channel. Will load custom patch if needed.                       #}
{#                                                                                                                          #}
{#  [in] y/r0: channel index                                                                                                #}
{#  [in] x:    index of first envelope of instrument                                                                        #}
{#  [in] a:    instrument index.                                                                                            #}
{# ======================================================================================================================   #}

{# !!! amistudio_set_vrc7_instrument:                                                                                           !!! #}

{# !!! tr          = famistudio_ptr1                                                                                            !!! #}
{# !!! han_idx     = famistudio_r0                                                                                              !!! #}
{# !!! pdate_flags = famistudio_r1 ; bit 7 = no attack, bit 6 = has set delayed cut                                             !!! #}

{# !!! sr famistudio_get_exp_inst_ptr                                                                                           !!! #}
{# !!! it update_flags                                                                                                          !!! #}
{# !!! pl @load_envelopes                                                                                                       !!! #}

{# !!! skip_envelopes:                                                                                                          !!! #}
{# !!! kip_exp_basic_envelopes                                                                                                  !!! #}
{# !!! mp @load_patch                                                                                                           !!! #}
{# !!! load_envelopes:                                                                                                          !!! #}
{# !!! sr famistudio_load_basic_envelopes                                                                                       !!! #}

{# !!! load_patch:                                                                                                              !!! #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_chn_vrc7_patch-FAMISTUDIO_VRC7_CH0_IDX,x                                                                   !!! #}
{# !!! ne @done                                                                                                                 !!! #}

{# !!! read_custom_patch:                                                                                                       !!! #}
{# !!! dx #0                                                                                                                    !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! read_patch_loop:                                                                                                         !!! #}
{# !!! tx FAMISTUDIO_VRC7_REG_SEL                                                                                               !!! #}
{# !!! sr famistudio_vrc7_wait_reg_select                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta FAMISTUDIO_VRC7_REG_WRITE                                                                                             !!! #}
{# !!! sr famistudio_vrc7_wait_reg_write                                                                                        !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! px #8                                                                                                                    !!! #}
{# !!! ne @read_patch_loop                                                                                                      !!! #}

{# !!! done:                                                                                                                    !!! #}
{# !!! ts                                                                                                                       !!! #}

{% endif 120 %}

{% if FAMISTUDIO_EXP_S5B                                                                                                       %}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_SET_S5B_INSTRUMENT (internal)                                                                                #}
{#                                                                                                                          #}
{#  Internal function to set a S5B instrument.                                                                              #}
{#                                                                                                                          #}
{#  [in] y/r0: channel index                                                                                                #}
{#  [in] x:    index of first envelope of instrument                                                                        #}
{#  [in] a:    instrument index.                                                                                            #}
{# ======================================================================================================================   #}

{# !!! amistudio_set_s5b_instrument:                                                                                            !!! #}

{# !!! han_idx = famistudio_r0                                                                                                  !!! #}
{# !!! tr      = famistudio_ptr1                                                                                                !!! #}

{# !!! sr famistudio_get_exp_inst_ptr                                                                                           !!! #}
{# !!! sr famistudio_load_basic_envelopes                                                                                       !!! #}

{# !!! mixer:                                                                                                                   !!! #}
{# !!! ec                                                                                                                       !!! #}

{#  After 'famistudio_load_basic_envelopes' x should point to the correct envelope.                                         #}
{# !!! loop:                                                                                                                    !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_env_addr_lo,x                                                                                              !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_env_addr_hi,x                                                                                              !!! #}
{# !!! cc @load_env_params                                                                                                      !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! cc @loop                                                                                                                 !!! #}

{# !!! load_env_params:                                                                                                         !!! #}

{#  Envelope shape + auto-pitch octave                                                                                      #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_s5b_chn_env_shape-FAMISTUDIO_S5B_CH0_IDX,x                                                                 !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_s5b_chn_env_octave-FAMISTUDIO_S5B_CH0_IDX,x                                                                !!! #}

{#  Skip if using auto-period                                                                                               #}
{# !!! mp #$80                                                                                                                  !!! #}
{# !!! ne @done                                                                                                                 !!! #}

{#  Skip if effect set manual period this frame.                                                                            #}
{# !!! da famistudio_s5b_env_override                                                                                           !!! #}
{# !!! ne @done                                                                                                                 !!! #}

{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_s5b_env_period_lo                                                                                          !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_s5b_env_period_hi                                                                                          !!! #}

{# !!! done:                                                                                                                    !!! #}
{# !!! ts                                                                                                                       !!! #}

{% endif 120 %}

{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_SET_EPSM_INSTRUMENT (internal)                                                                               #}
{#                                                                                                                          #}
{#  Internal function to set a EPSM instrument.                                                                             #}
{#                                                                                                                          #}
{#  [in] x/r0: channel index                                                                                                #}
{#  [in] a:    instrument index.                                                                                            #}
{# ======================================================================================================================   #}

{# !!! amistudio_set_epsm_instrument:                                                                                           !!! #}

{# !!! tr          = famistudio_ptr1                                                                                            !!! #}
{# !!! nv_ptr      = famistudio_ptr2                                                                                            !!! #}
{# !!! x_patch     = famistudio_ptr2                                                                                            !!! #}
{# !!! han_idx     = famistudio_r0                                                                                              !!! #}
{# !!! han_idx2    = famistudio_r0                                                                                              !!! #}
{# !!! pdate_flags = famistudio_r1 ; bit 7 = no attack, bit 6 = has set delayed cut                                             !!! #}
{# !!! eg_offset   = famistudio_r3                                                                                              !!! #}

{% if FAMISTUDIO_EXP_EPSM_RHYTHM_CNT > 0                                                                                       %}
{# !!! py #FAMISTUDIO_EPSM_CHAN_RHYTHM_START                                                                                    !!! #}
{# !!! cc @process_regular_instrument                                                                                           !!! #}
{#  We are processing a rhythm instrument, so skip all the fluff.                                                           #}
{#  We only need to load the volume of the instrument and store it in the attack.                                           #}
{#  load the instrument                                                                                                     #}
{# sty chan_idx                                                                                                             #}
{# !!! sr famistudio_get_exp_inst_ptr                                                                                           !!! #}

{#  Load the offset for the rhythm track and keep it in x                                                                   #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! da famistudio_rhythm_lut-FAMISTUDIO_EPSM_CHAN_RHYTHM_START, x                                                            !!! #}
{# !!! ax                                                                                                                       !!! #}

{#  Read the first envelope pointer for the volume, we'll use this to get the volume later                                  #}
{# !!! ty reg_offset                                                                                                            !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta env_ptr                                                                                                               !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta env_ptr+1                                                                                                             !!! #}
{#  the first value is the release point, so load the second offset which is the volume                                     #}
{# !!! dy #1                                                                                                                    !!! #}
{# !!! da (env_ptr),y                                                                                                           !!! #}
{# !!! nd #$0F                                                                                                                  !!! #}
{# !!! ta famistudio_chn_epsm_rhythm_volume,x                                                                                   !!! #}
{# !!! da reg_offset                                                                                                            !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc #14 ; skip over envelopes + square stuff.                                                                             !!! #}
{# !!! ay                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta ex_patch                                                                                                              !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta ex_patch+1                                                                                                            !!! #}
{# !!! dy #1                                                                                                                    !!! #}
{# !!! da (ex_patch),y                                                                                                          !!! #}
{# !!! nd #$c0                                                                                                                  !!! #}
{# !!! ta famistudio_chn_epsm_rhythm_stereo,x                                                                                   !!! #}

{# !!! ts                                                                                                                       !!! #}
{% endif 120 %}
{# !!! process_regular_instrument:                                                                                              !!! #}
{% if FAMISTUDIO_EXP_EPSM_FM_CHN_CNT > 0                                                                                       %}
{# !!! py #FAMISTUDIO_EPSM_CHAN_FM_START                                                                                        !!! #}
{# !!! cc @skip_fm_instrument                                                                                                   !!! #}
{# !!! ta famistudio_chn_epsm_fm_instrument-FAMISTUDIO_EPSM_CHAN_FM_START,y                                                     !!! #}
{# !!! skip_fm_instrument:                                                                                                      !!! #}
{% endif 120 %}
{# !!! sr famistudio_get_exp_inst_ptr                                                                                           !!! #}
{# !!! it update_flags                                                                                                          !!! #}
{# !!! pl @load_envelopes                                                                                                       !!! #}

{#  The exporter will ensure this only happens on FM channels.                                                              #}
{# !!! skip_envelopes:                                                                                                          !!! #}
{# !!! kip_exp_basic_envelopes                                                                                                  !!! #}
{# !!! mp @check_square_channel                                                                                                 !!! #}
{# !!! load_envelopes:                                                                                                          !!! #}
{# !!! sr famistudio_load_basic_envelopes                                                                                       !!! #}

{# !!! check_square_channel:                                                                                                    !!! #}
{% if FAMISTUDIO_EXP_EPSM_FM_CHN_CNT > 0                                                                                       %}
{#  channels 0-2 (square) do not need any further handling since they do not support patches                                #}
{# !!! da chan_idx                                                                                                              !!! #}
{# !!! mp #FAMISTUDIO_EPSM_CHAN_FM_START                                                                                        !!! #}
{# !!! cs @not_square_channel                                                                                                   !!! #}
{# lda famistudio_channel_env,x                                                                                             #}
{# tax                                                                                                                      #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0                                                                                      %}
{# !!! noise:                                                                                                                   !!! #}
{# !!! ec                                                                                                                       !!! #}

{# !!! loop:                                                                                                                    !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_env_addr_lo,x                                                                                              !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_env_addr_hi,x                                                                                              !!! #}
{# !!! cc @load_env_params                                                                                                      !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! cc @loop                                                                                                                 !!! #}

{# !!! load_env_params:                                                                                                         !!! #}

{#  Envelope shape + auto-pitch octave                                                                                      #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_epsm_chn_env_shape-FAMISTUDIO_EPSM_CH0_IDX,x                                                               !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_epsm_chn_env_octave-FAMISTUDIO_EPSM_CH0_IDX,x                                                              !!! #}

{#  Skip if using auto-period                                                                                               #}
{# !!! mp #$80                                                                                                                  !!! #}
{# !!! ne @done                                                                                                                 !!! #}

{#  Skip if effect set manual period this frame.                                                                            #}
{# !!! da famistudio_epsm_env_override                                                                                          !!! #}
{# !!! ne @done                                                                                                                 !!! #}

{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_epsm_env_period_lo                                                                                         !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_epsm_env_period_hi                                                                                         !!! #}

{# !!! done:                                                                                                                    !!! #}

{% endif 120 %}
{# !!! ts                                                                                                                       !!! #}

{# !!! not_square_channel:                                                                                                      !!! #}
{# !!! ts                                                                                                                       !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_FDS                                                                                                       %}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_SET_FDS_INSTRUMENT (internal)                                                                                #}
{#                                                                                                                          #}
{#  Internal function to set a FDS instrument. Will upload the wave and modulation envelope if needed.                      #}
{#                                                                                                                          #}
{#  [in] y/r0: channel index                                                                                                #}
{#  [in] x:    index of first envelope of instrument                                                                        #}
{#  [in] a:    instrument index.                                                                                            #}
{# ======================================================================================================================   #}

{# !!! amistudio_set_fds_instrument:                                                                                            !!! #}

{# !!! tr          = famistudio_ptr1                                                                                            !!! #}
{# !!! ave_ptr     = famistudio_ptr2                                                                                            !!! #}
{# !!! mp_y        = famistudio_r3                                                                                              !!! #}

{# !!! sr famistudio_get_exp_inst_ptr                                                                                           !!! #}
{# !!! sr famistudio_load_basic_envelopes                                                                                       !!! #}

{# !!! write_fds_wave:                                                                                                          !!! #}

{# !!! ra #$80                                                                                                                  !!! #}
{# !!! ta FAMISTUDIO_FDS_VOL ; Enable wave RAM write                                                                            !!! #}

{#  FDS Waveform                                                                                                            #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta wave_ptr+0                                                                                                            !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta wave_ptr+1                                                                                                            !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ty tmp_y                                                                                                                 !!! #}

{# !!! dy #0                                                                                                                    !!! #}
{# !!! wave_loop:                                                                                                               !!! #}
{# !!! da (wave_ptr),y                                                                                                          !!! #}
{# !!! ta FAMISTUDIO_FDS_WAV_START,y                                                                                            !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! py #64                                                                                                                   !!! #}
{# !!! ne @wave_loop                                                                                                            !!! #}

{# !!! dy tmp_y                                                                                                                 !!! #}
{# !!! da #$80                                                                                                                  !!! #}
{# !!! ta FAMISTUDIO_FDS_MOD_HI ; Need to disable modulation before writing.                                                    !!! #}
{# !!! da (ptr),y ; Read master volume                                                                                          !!! #}
{# !!! ta FAMISTUDIO_FDS_VOL ; Disable RAM write.                                                                               !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta FAMISTUDIO_FDS_SWEEP_BIAS                                                                                             !!! #}
{# !!! ny                                                                                                                       !!! #}

{#  FDS Modulation                                                                                                          #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta wave_ptr+0                                                                                                            !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta wave_ptr+1                                                                                                            !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ty tmp_y                                                                                                                 !!! #}

{# !!! dy #0                                                                                                                    !!! #}
{# !!! mod_loop:                                                                                                                !!! #}
{# !!! da (wave_ptr),y                                                                                                          !!! #}
{# !!! ta FAMISTUDIO_FDS_MOD_TABLE                                                                                              !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! py #32                                                                                                                   !!! #}
{# !!! ne @mod_loop                                                                                                             !!! #}

{# !!! dy tmp_y                                                                                                                 !!! #}

{# !!! load_mod_param:                                                                                                          !!! #}

    {% if FAMISTUDIO_USE_FDS_AUTOMOD                                                                                               %}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! eq @check_mod_speed                                                                                                      !!! #}

{# !!! auto_mod:                                                                                                                !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_fds_automod_numer                                                                                          !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_fds_automod_denom                                                                                          !!! #}
{# !!! ne @check_mod_depth                                                                                                      !!! #}
    {% else 120 %}
{# !!! ny                                                                                                                       !!! #}
{# !!! ny                                                                                                                       !!! #}
    {% endif 120 %}

{# !!! check_mod_speed:                                                                                                         !!! #}
{# !!! ny                                                                                                                       !!! #}
            {% if FAMISTUDIO_USE_FDS_AUTOMOD                                                                                               %}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_fds_automod_numer                                                                                          !!! #}
            {% endif 120 %}
{# !!! it famistudio_fds_override_flags                                                                                         !!! #}
{# !!! mi @mod_speed_overriden                                                                                                  !!! #}

{# !!! load_mod_speed:                                                                                                          !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_fds_mod_speed+0                                                                                            !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_fds_mod_speed+1                                                                                            !!! #}
{# !!! mp @check_mod_depth                                                                                                      !!! #}

{# !!! mod_speed_overriden:                                                                                                     !!! #}
{# !!! ny                                                                                                                       !!! #}

{# !!! check_mod_depth:                                                                                                         !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! it famistudio_fds_override_flags                                                                                         !!! #}
{# !!! vs @mod_depth_overriden                                                                                                  !!! #}

{# !!! load_mod_depth:                                                                                                          !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_fds_mod_depth                                                                                              !!! #}

{# !!! mod_depth_overriden:                                                                                                     !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_fds_mod_delay                                                                                              !!! #}
{# !!! ts                                                                                                                       !!! #}

{% endif 120 %}

{% if FAMISTUDIO_EXP_N163                                                                                                      %}

{# !!! amistudio_n163_wave_table:                                                                                               !!! #}
{# !!! byte FAMISTUDIO_N163_REG_WAVE - $00                                                                                      !!! #}
{# !!! byte FAMISTUDIO_N163_REG_WAVE - $08                                                                                      !!! #}
{# !!! byte FAMISTUDIO_N163_REG_WAVE - $10                                                                                      !!! #}
{# !!! byte FAMISTUDIO_N163_REG_WAVE - $18                                                                                      !!! #}
{# !!! byte FAMISTUDIO_N163_REG_WAVE - $20                                                                                      !!! #}
{# !!! byte FAMISTUDIO_N163_REG_WAVE - $28                                                                                      !!! #}
{# !!! byte FAMISTUDIO_N163_REG_WAVE - $30                                                                                      !!! #}
{# !!! byte FAMISTUDIO_N163_REG_WAVE - $38                                                                                      !!! #}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_UPDATE_N163_WAVE (internal)                                                                                  #}
{#                                                                                                                          #}
{#  Internal function to upload the waveform (if needed) of an N163 instrument.                                             #}
{#                                                                                                                          #}
{#  [in] y: N163 channel idx (0,1,2,3,4,5,6,7)                                                                              #}
{# ======================================================================================================================   #}

{# !!! amistudio_update_n163_wave:                                                                                              !!! #}

{# !!! tr           = famistudio_ptr1                                                                                           !!! #}
{# !!! ave_ptr      = famistudio_ptr0                                                                                           !!! #}
{# !!! ave_pos      = famistudio_r1                                                                                             !!! #}
{# !!! ave_len      = famistudio_r2                                                                                             !!! #}

{# !!! da famistudio_n163_env_table, y                                                                                          !!! #}
{# !!! ax                                                                                                                       !!! #}

{#  See if the wave index has changed.                                                                                      #}
{# !!! da famistudio_env_value+FAMISTUDIO_ENV_N163_WAVE_IDX_OFF,x                                                               !!! #}
{# !!! mp famistudio_chn_n163_wave_index,y                                                                                      !!! #}
{# !!! eq @done                                                                                                                 !!! #}

{#  Retrieve the instrument pointer.                                                                                        #}
{# !!! ta famistudio_chn_n163_wave_index,y                                                                                      !!! #}
{# !!! ya                                                                                                                       !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! da famistudio_chn_n163_instrument,y                                                                                      !!! #}
{# !!! sr famistudio_get_exp_inst_ptr                                                                                           !!! #}

{# !!! da famistudio_n163_wave_table, x                                                                                         !!! #}
{# !!! ta FAMISTUDIO_N163_ADDR                                                                                                  !!! #}

{#  Wave position                                                                                                           #}
{# !!! ya                                                                                                                       !!! #}
{# !!! dc #8 ; Carry is clear here.                                                                                             !!! #}
{# !!! ay                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta wave_pos                                                                                                              !!! #}
{# !!! ta FAMISTUDIO_N163_DATA                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}

{#  Wave length                                                                                                             #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! sr                                                                                                                       !!! #}
{# !!! ta wave_len                                                                                                              !!! #}
{# !!! da #$80 ; (128 - wave length / 2) * 2 == 256 - wave length                                                               !!! #}
{# !!! ec                                                                                                                       !!! #}
{# !!! bc wave_len                                                                                                              !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ta famistudio_chn_n163_wave_len, x                                                                                       !!! #}
{# !!! ny                                                                                                                       !!! #}

{#  Load the wave table pointer.                                                                                            #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta wave_ptr+0                                                                                                            !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta wave_ptr+1                                                                                                            !!! #}

{#  Load the pointer for the current wave in the table.                                                                     #}
{# !!! da famistudio_chn_n163_wave_index,x                                                                                      !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ay                                                                                                                       !!! #}
{# !!! da (wave_ptr),y                                                                                                          !!! #}
{# !!! ta ptr+0                                                                                                                 !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (wave_ptr),y                                                                                                          !!! #}
{# !!! ta ptr+1                                                                                                                 !!! #}

{#  Upload to N163                                                                                                          #}
{# !!! dy #0                                                                                                                    !!! #}
{# !!! da wave_pos                                                                                                              !!! #}
{# !!! sr                                                                                                                       !!! #}
{# !!! ra #$80                                                                                                                  !!! #}
{# !!! ta FAMISTUDIO_N163_ADDR                                                                                                  !!! #}
{# !!! dy #0                                                                                                                    !!! #}
{# !!! wave_loop:                                                                                                               !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta FAMISTUDIO_N163_DATA                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! py wave_len                                                                                                              !!! #}
{# !!! ne @wave_loop                                                                                                            !!! #}

{# !!! xa                                                                                                                       !!! #}
{# !!! ay                                                                                                                       !!! #}

{# !!! done:                                                                                                                    !!! #}
{# !!! ts                                                                                                                       !!! #}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_SET_N163_INSTRUMENT (internal)                                                                               #}
{#                                                                                                                          #}
{#  Internal function to set a N163 instrument.                                                                             #}
{#                                                                                                                          #}
{#  [in] y/r0: channel index                                                                                                #}
{#  [in] x:    index of first envelope of instrument                                                                        #}
{#  [in] a:    instrument index.                                                                                            #}
{# ======================================================================================================================   #}

{# !!! amistudio_set_n163_instrument:                                                                                           !!! #}

{# !!! tr      = famistudio_ptr1                                                                                                !!! #}
{# !!! han_idx = famistudio_r0                                                                                                  !!! #}

{#  Store instrument number (premultipled by 4 if not using extended range)                                                 #}
{# !!! ta famistudio_chn_n163_instrument-FAMISTUDIO_N163_CH0_IDX,y                                                              !!! #}

{# !!! sr famistudio_get_exp_inst_ptr                                                                                           !!! #}
{# !!! sr famistudio_load_basic_envelopes                                                                                       !!! #}

{#  Load the wave index envelope, x will point to the correct envelope.                                                     #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_env_addr_lo,x                                                                                              !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (ptr),y                                                                                                               !!! #}
{# !!! ta famistudio_env_addr_hi,x                                                                                              !!! #}

{# !!! ts                                                                                                                       !!! #}

{% endif 120 %}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_UPDATE_CHANNEL (internal)                                                                                    #}
{#                                                                                                                          #}
{#  Advances the song by one frame for a given channel. If a new note or effect(s) are found, they will be processed.       #}
{#                                                                                                                          #}
{#  [in]  x: channel index                                                                                                  #}
{#  [out] z: non-zero if we triggered a new note.                                                                           #}
{# ======================================================================================================================   #}

{# !!! amistudio_advance_channel:                                                                                               !!! #}

{# !!! han_idx         = famistudio_r0                                                                                          !!! #}
{# !!! pdate_flags     = famistudio_r1 ; bit 7 = no attack, bit 6 = has set delayed cut                                         !!! #}
{# !!! emp_ptr_y       = famistudio_r2                                                                                          !!! #}
{# !!! mp_slide_from   = famistudio_r2                                                                                          !!! #}
{# !!! mp_slide_idx    = famistudio_r2                                                                                          !!! #}
{# !!! mp_duty_cycle   = famistudio_r2                                                                                          !!! #}
{# !!! mp_ptr_lo       = famistudio_r2                                                                                          !!! #}
{# !!! mp_y1           = famistudio_r2                                                                                          !!! #}
{# !!! lide_delta_lo   = famistudio_ptr1_hi                                                                                     !!! #}
{# !!! mp_y2           = famistudio_ptr1_lo                                                                                     !!! #}
{# !!! hannel_data_ptr = famistudio_ptr0                                                                                        !!! #}
{# !!! pcode_jmp_ptr   = famistudio_ptr1                                                                                        !!! #}
{# !!! empo_env_ptr    = famistudio_ptr1                                                                                        !!! #}
{# !!! nv_ptr          = famistudio_ptr1                                                                                        !!! #}

{# !!! da famistudio_chn_repeat,x                                                                                               !!! #}
{# !!! eq @no_repeat                                                                                                            !!! #}
{# !!! ec famistudio_chn_repeat,x                                                                                               !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ts                                                                                                                       !!! #}

{# !!! no_repeat:                                                                                                               !!! #}
{# !!! da famistudio_chn_ptr_lo,x                                                                                               !!! #}
{# !!! ta channel_data_ptr+0                                                                                                    !!! #}
{# !!! da famistudio_chn_ptr_hi,x                                                                                               !!! #}
{# !!! ta channel_data_ptr+1                                                                                                    !!! #}
{# !!! dy #0                                                                                                                    !!! #}
{# !!! ty update_flags                                                                                                          !!! #}
{# !!! tx chan_idx                                                                                                              !!! #}

{# !!! read_byte:                                                                                                               !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}

{#  $80 to $ff = sequence of empty notes (up to 64) or instrument changes (up to 64)                                        #}
{# !!! check_negative:                                                                                                          !!! #}
{# !!! ra #0                                                                                                                    !!! #}
{# !!! mi @empty_notes_or_instrument_change                                                                                     !!! #}

{#  $00 to $3f = notes from C1 to D6 (most common notes, same as FT2 range)                                                 #}
{#  $40 to $6f = opcodes for various things.                                                                                #}
{# !!! check_regular_note:                                                                                                      !!! #}
{# !!! mp #$40                                                                                                                  !!! #}
{# !!! cc @common_note                                                                                                          !!! #}

{% if FAMISTUDIO_USE_VOLUME_TRACK                                                                                              %}
{#  $70 to $7f = volume change                                                                                              #}
{# !!! check_volume_track:                                                                                                      !!! #}
{# !!! mp #$70                                                                                                                  !!! #}
{# !!! cc @jmp_to_opcode                                                                                                        !!! #}

{# !!! volume_track:                                                                                                            !!! #}
{# !!! nd #$0f                                                                                                                  !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ta famistudio_chn_volume_track,x                                                                                         !!! #}
{#  Clear any volume slide.                                                                                                 #}
    {% if FAMISTUDIO_USE_VOLUME_SLIDES                                                                                             %}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_chn_volume_slide_step,x                                                                                    !!! #}
    {% endif 120 %}
{# !!! cc @read_byte                                                                                                            !!! #}
{% endif 120 %}

{# !!! jmp_to_opcode:                                                                                                           !!! #}
{# !!! nd #$3f                                                                                                                  !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! da @famistudio_opcode_jmp_lo,x                                                                                           !!! #}
{# !!! ta opcode_jmp_ptr+0                                                                                                      !!! #}
{# !!! da @famistudio_opcode_jmp_hi,x                                                                                           !!! #}
{# !!! ta opcode_jmp_ptr+1                                                                                                      !!! #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! mp (opcode_jmp_ptr)                                                                                                      !!! #}

{# !!! empty_notes_or_instrument_change:                                                                                        !!! #}
{# !!! nd #$7f                                                                                                                  !!! #}
{# !!! sr a                                                                                                                     !!! #}
{# !!! cs @set_repeat                                                                                                           !!! #}

{# !!! instrument_change:                                                                                                       !!! #}
{#  Set the instrument. `famistudio_set_instrument` (or proc it calls) are not                                              #}
{#  allowed to clobber r0/r1/r2 or ptr0.                                                                                    #}
{# !!! ty temp_ptr_y                                                                                                            !!! #}
{# !!! sr famistudio_set_instrument ; Will clobber x/y, need to save/restore them.                                              !!! #}
{# !!! dy temp_ptr_y                                                                                                            !!! #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}

{# !!! set_repeat:                                                                                                              !!! #}
{# !!! ta famistudio_chn_repeat,x ; Set up repeat counter                                                                       !!! #}
{# !!! cs @done                                                                                                                 !!! #}

{# !!! common_note:                                                                                                             !!! #}
{# !!! mp #0                                                                                                                    !!! #}
{# !!! eq @play_note                                                                                                            !!! #}
{# !!! dc #11 ; Carry is set here.                                                                                              !!! #}

{# !!! play_note:                                                                                                               !!! #}
{# !!! ta famistudio_chn_note,x ; Store note code                                                                               !!! #}

{% if FAMISTUDIO_USE_SLIDE_NOTES                                                                                               %}
{# !!! clear_previous_slide:                                                                                                    !!! #}
{# !!! da famistudio_channel_to_slide,x ; Clear any previous slide on new note.                                                 !!! #}
{# !!! mi @cancel_delayed_cut                                                                                                   !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_slide_step,x                                                                                               !!! #}
{# !!! dx chan_idx                                                                                                              !!! #}
{% endif 120 %}

{# !!! cancel_delayed_cut:                                                                                                      !!! #}
{% if FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS                                                                         %}
{#  Any note with an attack clears any pending delayed cut, unless it was set during this update (flags bit 6).             #}
{# !!! it update_flags                                                                                                          !!! #}
{# !!! vs @check_dpcm_channel                                                                                                   !!! #}
{# !!! da #$ff                                                                                                                  !!! #}
{# !!! ta famistudio_chn_cut_delay,x                                                                                            !!! #}
{% endif 120 %}

{# !!! check_dpcm_channel:                                                                                                      !!! #}
{% if FAMISTUDIO_CFG_DPCM_SUPPORT                                                                                              %}
{#  We play/stop DPCM samples immediately.                                                                                  #}
{# !!! px #4                                                                                                                    !!! #}
{# !!! ne @check_attack                                                                                                         !!! #}
{# !!! da famistudio_chn_note+4                                                                                                 !!! #}
{# !!! ne @play_sample                                                                                                          !!! #}
{# !!! sr famistudio_sample_stop                                                                                                !!! #}
{# !!! dx #4                                                                                                                    !!! #}
{# !!! ne @done                                                                                                                 !!! #}
{# !!! play_sample:                                                                                                             !!! #}
{# !!! bc #12 ; Carry already set. HACK : Our "notes" for DPCM start at SingleByteNoteMin (12). Need to undo that here. See C# code. !!! #}
{# !!! ty tmp_y1                                                                                                                !!! #}
{# !!! sr famistudio_music_sample_play                                                                                          !!! #}
{# !!! dy tmp_y1                                                                                                                !!! #}
{# !!! dx #4                                                                                                                    !!! #}
            {% if FAMISTUDIO_CFG_EQUALIZER                                                                                                 %}
{# !!! da #9                                                                                                                    !!! #}
{# !!! ta famistudio_chn_note_counter,x                                                                                         !!! #}
            {% endif 120 %}
{# !!! ne @done                                                                                                                 !!! #}
{% endif 120 %}

{# !!! check_attack:                                                                                                            !!! #}
{# !!! da famistudio_chn_note,x                                                                                                 !!! #}
{# !!! eq @done                                                                                                                 !!! #}
{# !!! it update_flags                                                                                                          !!! #}
{# !!! mi @done                                                                                                                 !!! #}

{#  Note attack. `famistudio_do_note_attack` (or any proc it calls) are not                                                 #}
{#  allowed to clobber r0 or ptr0. They can clobber r1 if they are done using it.                                           #}
{# !!! sr famistudio_do_note_attack ; Note attack.                                                                              !!! #}

{# !!! done:                                                                                                                    !!! #}
{# !!! da famistudio_chn_ref_len,x ; Check reference row counter                                                                !!! #}
{# !!! eq @flush_y                 ; If it is zero, there is no reference                                                       !!! #}
{# !!! ec famistudio_chn_ref_len,x ; Decrease row counter                                                                       !!! #}
{# !!! ne @flush_y                                                                                                              !!! #}

{# !!! da famistudio_chn_return_lo,x ; End of a reference, return to previous pointer                                           !!! #}
{# !!! ta famistudio_chn_ptr_lo,x                                                                                               !!! #}
{# !!! da famistudio_chn_return_hi,x                                                                                            !!! #}
{# !!! ta famistudio_chn_ptr_hi,x                                                                                               !!! #}
{# !!! ts                                                                                                                       !!! #}

{# !!! flush_y:                                                                                                                 !!! #}

{# !!! lc                                                                                                                       !!! #}
{# !!! ya                                                                                                                       !!! #}
{# !!! dc channel_data_ptr+0                                                                                                    !!! #}
{# !!! ta famistudio_chn_ptr_lo,x                                                                                               !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! dc channel_data_ptr+1                                                                                                    !!! #}
{# !!! ta famistudio_chn_ptr_hi,x                                                                                               !!! #}
{# !!! ts                                                                                                                       !!! #}

{# !!! opcode_extended_note:                                                                                                    !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! mp @play_note                                                                                                            !!! #}

{# !!! opcode_set_reference:                                                                                                    !!! #}
{# !!! lc ; Remember return address+3                                                                                           !!! #}
{# !!! ya                                                                                                                       !!! #}
{# !!! dc #3                                                                                                                    !!! #}
{# !!! dc channel_data_ptr+0                                                                                                    !!! #}
{# !!! ta famistudio_chn_return_lo,x                                                                                            !!! #}
{# !!! da channel_data_ptr+1                                                                                                    !!! #}
{# !!! dc #0                                                                                                                    !!! #}
{# !!! ta famistudio_chn_return_hi,x                                                                                            !!! #}
{# !!! da (channel_data_ptr),y ; Read length of the reference (how many rows)                                                   !!! #}
{# !!! ta famistudio_chn_ref_len,x                                                                                              !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (channel_data_ptr),y ; Read 16-bit absolute address of the reference                                                  !!! #}
{# !!! ta tmp_ptr_lo                                                                                                            !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ta channel_data_ptr+1                                                                                                    !!! #}
{# !!! da tmp_ptr_lo                                                                                                            !!! #}
{# !!! ta channel_data_ptr+0                                                                                                    !!! #}
{# !!! dy #0                                                                                                                    !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}

{# !!! opcode_loop:                                                                                                             !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ta tmp_ptr_lo                                                                                                            !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ta channel_data_ptr+1                                                                                                    !!! #}
{# !!! da tmp_ptr_lo                                                                                                            !!! #}
{# !!! ta channel_data_ptr+0                                                                                                    !!! #}
{# !!! dy #0                                                                                                                    !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}

{# !!! opcode_disable_attack:                                                                                                   !!! #}
{# !!! da #$80                                                                                                                  !!! #}
{# !!! ra update_flags                                                                                                          !!! #}
{# !!! ta update_flags                                                                                                          !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}

{# !!! opcode_end_song:                                                                                                         !!! #}
{# !!! da #$80 ; TODO : Should we stop, or just call famistudio_music_stop here?                                                !!! #}
{# !!! ta famistudio_song_speed                                                                                                 !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}

{% if FAMISTUDIO_USE_RELEASE_NOTES                                                                                             %}
{# !!! jump_to_release_envelope:                                                                                                !!! #}
{# !!! da famistudio_env_addr_lo,x ; Load envelope data address into temp                                                       !!! #}
{# !!! ta env_ptr+0                                                                                                             !!! #}
{# !!! da famistudio_env_addr_hi,x                                                                                              !!! #}
{# !!! ta env_ptr+1                                                                                                             !!! #}

{# !!! ty tmp_y1                                                                                                                !!! #}
{# !!! dy #0                                                                                                                    !!! #}
{# !!! da (env_ptr),y ; Read first byte of the envelope data, this contains the release index.                                  !!! #}
{# !!! eq @env_has_no_release                                                                                                   !!! #}

{# !!! ta famistudio_env_ptr,x                                                                                                  !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_env_repeat,x ; Need to reset envelope repeat to force update.                                              !!! #}

{# !!! env_has_no_release:                                                                                                      !!! #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! dy tmp_y1                                                                                                                !!! #}
{# !!! ts                                                                                                                       !!! #}

{% if FAMISTUDIO_EXP_VRC7                                                                                                      %}
{# !!! opcode_vrc7_release_note:                                                                                                !!! #}
{# !!! da #$80                                                                                                                  !!! #}
{# !!! ta famistudio_chn_vrc7_trigger-FAMISTUDIO_VRC7_CH0_IDX,x ; Set release flag for VRC7                                     !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! opcode_fds_release_note:                                                                                                 !!! #}
{# !!! dx #FAMISTUDIO_FDS_CH0_ENVS                                                                                              !!! #}
{# !!! sr @jump_to_release_envelope                                                                                             !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! opcode_n163_release_note:                                                                                                !!! #}
{# !!! da famistudio_channel_env,x                                                                                              !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! nx ; +2 for FAMISTUDIO_ENV_N163_WAVE_IDX_OFF.                                                                            !!! #}
{# !!! nx                                                                                                                       !!! #}
{# !!! sr @jump_to_release_envelope                                                                                             !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{# !!! opcode_epsm_release_note:                                                                                                !!! #}
{# !!! da #$80                                                                                                                  !!! #}
    {% if FAMISTUDIO_EXP_EPSM_FM_CHN_CNT+FAMISTUDIO_EXP_EPSM_RHYTHM_CNT > 0                                                        %}
{# !!! ta famistudio_chn_epsm_trigger-FAMISTUDIO_EPSM_CHAN_FM_START,x ; Set release flag for EPSM                               !!! #}
    {% endif 120 %}
{% endif 120 %}

{# !!! opcode_release_note:                                                                                                     !!! #}
{# !!! da famistudio_channel_to_volume_env,x ; DPCM(5) will never have releases.                                                !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! sr @jump_to_release_envelope                                                                                             !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! mp @done                                                                                                                 !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_EPSM && FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0                                                               %}
{# !!! opcode_epsm_manual_env_period:                                                                                           !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_epsm_env_period_lo                                                                                         !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_epsm_env_period_hi                                                                                         !!! #}
{# !!! da #1                                                                                                                    !!! #}
{# !!! ta famistudio_epsm_env_override                                                                                          !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_S5B                                                                                                       %}
{# !!! opcode_s5b_manual_env_period:                                                                                            !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_s5b_env_period_lo                                                                                          !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_s5b_env_period_hi                                                                                          !!! #}
{# !!! da #1                                                                                                                    !!! #}
{# !!! ta famistudio_s5b_env_override                                                                                           !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_FAMITRACKER_TEMPO                                                                                         %}
{# !!! opcode_famitracker_speed:                                                                                                !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_song_speed                                                                                                 !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! opcode_fds_mod_depth:                                                                                                    !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_fds_mod_depth                                                                                              !!! #}
{# !!! da #$40                                                                                                                  !!! #}
{# !!! ra famistudio_fds_override_flags                                                                                         !!! #}
{# !!! ta famistudio_fds_override_flags                                                                                         !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}

{# !!! opcode_fds_mod_speed:                                                                                                    !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_fds_mod_speed+0                                                                                            !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_fds_mod_speed+1                                                                                            !!! #}
{# !!! da #$80                                                                                                                  !!! #}
{# !!! ra famistudio_fds_override_flags                                                                                         !!! #}
{# !!! ta famistudio_fds_override_flags                                                                                         !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}
{% endif 120 %}

{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! opcode_vrc6_saw_volume:                                                                                                  !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_vrc6_saw_volume                                                                                            !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_VOLUME_SLIDES                                                                                             %}
{# !!! opcode_volume_slide:                                                                                                     !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_chn_volume_slide_step, x                                                                                   !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_chn_volume_slide_target, x                                                                                 !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_DELTA_COUNTER                                                                                             %}
{# !!! opcode_dmc_counter:                                                                                                      !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! mi @set_immediately                                                                                                      !!! #}
{# !!! store_for_later:                                                                                                         !!! #}
{# !!! ta famistudio_dmc_delta_counter                                                                                          !!! #}
{# !!! pl @inc_and_return                                                                                                       !!! #}
{# !!! set_immediately:                                                                                                         !!! #}
{# !!! nd #$7f                                                                                                                  !!! #}
{# !!! ta FAMISTUDIO_APU_DMC_RAW                                                                                                !!! #}
{# !!! inc_and_return:                                                                                                          !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_PHASE_RESET                                                                                               %}
{# !!! opcode_phase_reset:                                                                                                      !!! #}
{# !!! da famistudio_channel_to_phase_reset_mask, x                                                                             !!! #}
{# !!! ra famistudio_phase_reset                                                                                                !!! #}
{# !!! ta famistudio_phase_reset                                                                                                !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}

{% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! opcode_n163_phase_reset:                                                                                                 !!! #}
{# !!! da famistudio_channel_to_phase_reset_mask, x                                                                             !!! #}
{# !!! ra famistudio_phase_reset_n163                                                                                           !!! #}
{# !!! ta famistudio_phase_reset_n163                                                                                           !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}
{% endif 120 %}
{% endif 120 %}

{% if FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE                                                                                 %}
{# !!! opcode_extended_instrument:                                                                                              !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! mp @instrument_change                                                                                                    !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_PITCH_TRACK                                                                                               %}
{# !!! opcode_fine_pitch:                                                                                                       !!! #}
{# !!! da famistudio_channel_to_pitch_env,x                                                                                     !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_pitch_env_fine_value,x                                                                                     !!! #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_VIBRATO                                                                                                   %}
{# !!! opcode_clear_pitch_override_flag:                                                                                        !!! #}
{# !!! da #$7f                                                                                                                  !!! #}
{# !!! nd famistudio_chn_env_override,x                                                                                         !!! #}
{# !!! ta famistudio_chn_env_override,x                                                                                         !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}

{# !!! opcode_override_pitch_envelope:                                                                                          !!! #}
{# !!! da #$80                                                                                                                  !!! #}
{# !!! ra famistudio_chn_env_override,x                                                                                         !!! #}
{# !!! ta famistudio_chn_env_override,x                                                                                         !!! #}
{# !!! da famistudio_channel_to_pitch_env,x                                                                                     !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_pitch_env_addr_lo,x                                                                                        !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_pitch_env_addr_hi,x                                                                                        !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_pitch_env_repeat,x                                                                                         !!! #}
{# !!! da #1                                                                                                                    !!! #}
{# !!! ta famistudio_pitch_env_ptr,x                                                                                            !!! #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_ARPEGGIO                                                                                                  %}
{# !!! opcode_clear_arpeggio_override_flag:                                                                                     !!! #}
{# !!! da #$fe                                                                                                                  !!! #}
{# !!! nd famistudio_chn_env_override,x                                                                                         !!! #}
{# !!! ta famistudio_chn_env_override,x                                                                                         !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}

{# !!! opcode_override_arpeggio_envelope:                                                                                       !!! #}
{# !!! da #$01                                                                                                                  !!! #}
{# !!! ra famistudio_chn_env_override,x                                                                                         !!! #}
{# !!! ta famistudio_chn_env_override,x                                                                                         !!! #}
{# !!! da famistudio_channel_to_arpeggio_env,x                                                                                  !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_env_addr_lo,x                                                                                              !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_env_addr_hi,x                                                                                              !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_env_repeat,x ; Reset the envelope since this might be a no-attack note.                                    !!! #}
{# !!! ta famistudio_env_value,x                                                                                                !!! #}
{# !!! ta famistudio_env_ptr,x                                                                                                  !!! #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}

{# !!! opcode_reset_arpeggio:                                                                                                   !!! #}
{# !!! da famistudio_channel_to_arpeggio_env,x                                                                                  !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_env_repeat,x                                                                                               !!! #}
{# !!! ta famistudio_env_value,x                                                                                                !!! #}
{# !!! ta famistudio_env_ptr,x                                                                                                  !!! #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_DUTYCYCLE_EFFECT                                                                                          %}
{# !!! opcode_duty_cycle_effect:                                                                                                !!! #}
{# !!! da famistudio_channel_to_dutycycle,x                                                                                     !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_duty_cycle,x                                                                                               !!! #}
{# !!! ta tmp_duty_cycle                                                                                                        !!! #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! da famistudio_channel_to_duty_env,x                                                                                      !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! da tmp_duty_cycle                                                                                                        !!! #}
{# !!! ta famistudio_env_value,x                                                                                                !!! #}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS                                                                         %}
{# !!! opcode_note_delay:                                                                                                       !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_chn_note_delay,x                                                                                           !!! #}
{# !!! mp @flush_y                                                                                                              !!! #}

{# !!! opcode_cut_delay:                                                                                                        !!! #}
{# !!! da #$40                                                                                                                  !!! #}
{# !!! ta update_flags                                                                                                          !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_chn_cut_delay,x                                                                                            !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}
{% elif !FAMISTUDIO_USE_FAMITRACKER_TEMPO                                                                                        %}
{# !!! opcode_set_tempo_envelope:                                                                                               !!! #}
{#  Load and reset the new tempo envelope.                                                                                  #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_tempo_env_ptr_lo                                                                                           !!! #}
{# !!! ta tempo_env_ptr+0                                                                                                       !!! #}
{# !!! da (channel_data_ptr),y                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_tempo_env_ptr_hi                                                                                           !!! #}
{# !!! ta tempo_env_ptr+1                                                                                                       !!! #}
{# !!! mp @reset_tempo_env                                                                                                      !!! #}
{# !!! opcode_reset_tempo_envelope:                                                                                             !!! #}
{# !!! da famistudio_tempo_env_ptr_lo                                                                                           !!! #}
{# !!! ta tempo_env_ptr+0                                                                                                       !!! #}
{# !!! da famistudio_tempo_env_ptr_hi                                                                                           !!! #}
{# !!! ta tempo_env_ptr+1                                                                                                       !!! #}
{# !!! reset_tempo_env:                                                                                                         !!! #}
{# !!! ty tmp_y1                                                                                                                !!! #}
{# !!! dy #0                                                                                                                    !!! #}
{# !!! ty famistudio_tempo_env_idx                                                                                              !!! #}
{# !!! da (tempo_env_ptr),y                                                                                                     !!! #}
{# !!! ta famistudio_tempo_env_counter                                                                                          !!! #}
{# !!! dy tmp_y1                                                                                                                !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_SLIDE_NOTES                                                                                               %}

{% if FAMISTUDIO_USE_NOISE_SLIDE_NOTES                                                                                         %}
{# !!! noise_slide:                                                                                                             !!! #}
{# !!! da (channel_data_ptr),y ; Read slide step size                                                                           !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_slide_step+FAMISTUDIO_NOISE_SLIDE_INDEX                                                                    !!! #}
{# !!! da (channel_data_ptr),y ; Read slide note from                                                                           !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ec                                                                                                                       !!! #}
{# !!! bc (channel_data_ptr),y ; Read slide note to                                                                             !!! #}
{# !!! ta famistudio_slide_pitch_lo+FAMISTUDIO_NOISE_SLIDE_INDEX                                                                !!! #}
{# !!! pl @positive_noise_slide                                                                                                 !!! #}
{# !!! negative_noise_slide:                                                                                                    !!! #}
{#  Sign extend.                                                                                                            #}
{# !!! da #$ff                                                                                                                  !!! #}
{# !!! mi @noise_shift                                                                                                          !!! #}
{# !!! positive_noise_slide:                                                                                                    !!! #}
{# !!! da #$00                                                                                                                  !!! #}
{# !!! noise_shift:                                                                                                             !!! #}
{#  Noise slides have 4-bits of fraction.                                                                                   #}
{# !!! sl famistudio_slide_pitch_lo+FAMISTUDIO_NOISE_SLIDE_INDEX                                                                !!! #}
{# !!! ol                                                                                                                       !!! #}
{# !!! sl famistudio_slide_pitch_lo+FAMISTUDIO_NOISE_SLIDE_INDEX                                                                !!! #}
{# !!! ol                                                                                                                       !!! #}
{# !!! sl famistudio_slide_pitch_lo+FAMISTUDIO_NOISE_SLIDE_INDEX                                                                !!! #}
{# !!! ol                                                                                                                       !!! #}
{# !!! sl famistudio_slide_pitch_lo+FAMISTUDIO_NOISE_SLIDE_INDEX                                                                !!! #}
{# !!! ol                                                                                                                       !!! #}
{# !!! ta famistudio_slide_pitch_hi+FAMISTUDIO_NOISE_SLIDE_INDEX                                                                !!! #}
{# !!! mp @slide_done_pos                                                                                                       !!! #}
{% endif 120 %}

{# !!! opcode_slide:                                                                                                            !!! #}
{% if FAMISTUDIO_USE_NOISE_SLIDE_NOTES                                                                                         %}
{# !!! px #3                                                                                                                    !!! #}
{# !!! eq @noise_slide                                                                                                          !!! #}
{% endif 120 %}
{# !!! da famistudio_channel_to_slide,x                                                                                         !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! da (channel_data_ptr),y ; Read slide step size                                                                           !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ta famistudio_slide_step,x                                                                                               !!! #}
{# !!! da (channel_data_ptr),y ; Read slide note from                                                                           !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ty tmp_y2                                                                                                                !!! #}
{% if FAMISTUDIO_DUAL_SUPPORT                                                                                                  %}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc famistudio_pal_adjust                                                                                                 !!! #}
{% endif 120 %}
{# !!! ta tmp_slide_from                                                                                                        !!! #}
{# !!! da (channel_data_ptr),y ; Read slide note to                                                                             !!! #}
{# !!! dy tmp_slide_from       ; reload note from                                                                               !!! #}
{% if FAMISTUDIO_DUAL_SUPPORT                                                                                                  %}
{# !!! dc famistudio_pal_adjust                                                                                                 !!! #}
{% endif 120 %}
{# !!! tx tmp_slide_idx ; X contained the slide index.                                                                          !!! #}
{# !!! ax                                                                                                                       !!! #}
{% if def FAMISTUDIO_EXP_NOTE_START                                                                                            %}
{# !!! da chan_idx                                                                                                              !!! #}
{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{# !!! mp #FAMISTUDIO_EPSM_CHAN_FM_START                                                                                        !!! #}
{# !!! cs @note_table_epsm                                                                                                      !!! #}
{% endif 120 %}
{# !!! mp #FAMISTUDIO_EXP_NOTE_START                                                                                            !!! #}
{# !!! cs @note_table_expansion                                                                                                 !!! #}
{% endif 120 %}
{# !!! ec ; Subtract the pitch of both notes.                                                                                   !!! #}
{# !!! da famistudio_note_table_lsb,y                                                                                           !!! #}
{# !!! bc famistudio_note_table_lsb,x                                                                                           !!! #}
{# !!! ta slide_delta_lo                                                                                                        !!! #}
{# !!! da famistudio_note_table_msb,y                                                                                           !!! #}
{# !!! bc famistudio_note_table_msb,x                                                                                           !!! #}
{% if def FAMISTUDIO_EXP_NOTE_START                                                                                            %}
{# !!! mp @note_table_done                                                                                                      !!! #}
{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{# !!! note_table_epsm:                                                                                                         !!! #}
{% if FAMISTUDIO_EXP_EPSM_FM_CHN_CNT > 0                                                                                       %}
{# !!! da famistudio_epsm_note_table_lsb,y                                                                                      !!! #}
{# !!! bc famistudio_epsm_note_table_lsb,x                                                                                      !!! #}
{# !!! ta slide_delta_lo                                                                                                        !!! #}
{# !!! da famistudio_epsm_note_table_msb,y                                                                                      !!! #}
{# !!! bc famistudio_epsm_note_table_msb,x                                                                                      !!! #}
{# !!! mp @note_table_done                                                                                                      !!! #}
{% endif 120 %}
{% endif 120 %}
{# !!! note_table_expansion:                                                                                                    !!! #}
{# !!! da famistudio_exp_note_table_lsb,y                                                                                       !!! #}
{# !!! bc famistudio_exp_note_table_lsb,x                                                                                       !!! #}
{# !!! ta slide_delta_lo                                                                                                        !!! #}
{# !!! da famistudio_exp_note_table_msb,y                                                                                       !!! #}
{# !!! bc famistudio_exp_note_table_msb,x                                                                                       !!! #}
{# !!! note_table_done:                                                                                                         !!! #}
{% endif 120 %}
{# !!! dx tmp_slide_idx ; slide index.                                                                                          !!! #}
{# !!! ta famistudio_slide_pitch_hi,x                                                                                           !!! #}
    {% if FAMISTUDIO_EXP_N163 || FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_EPSM                                                        %}
{# !!! px #FAMISTUDIO_FIRST_POSITIVE_SLIDE_CHANNEL ; Slide #3 is the first of expansion slides.                                 !!! #}
{# !!! cs @positive_shift                                                                                                       !!! #}
    {% endif 120 %}
{# !!! negative_shift:                                                                                                          !!! #}
{# !!! da slide_delta_lo                                                                                                        !!! #}
{# !!! sl ; Shift-left, we have 1 bit of fractional slide.                                                                      !!! #}
{# !!! ta famistudio_slide_pitch_lo,x                                                                                           !!! #}
{# !!! ol famistudio_slide_pitch_hi,x ; Shift-left, we have 1 bit of fractional slide.                                          !!! #}
    {% if FAMISTUDIO_EXP_N163 || FAMISTUDIO_EXP_VRC7 || FAMISTUDIO_EXP_EPSM                                                        %}
{# !!! mp @shift_done                                                                                                           !!! #}
{# !!! positive_shift:                                                                                                          !!! #}
{# !!! da slide_delta_lo                                                                                                        !!! #}
{# !!! ta famistudio_slide_pitch_lo,x                                                                                           !!! #}
{# !!! dy #FAMISTUDIO_PITCH_SHIFT                                                                                               !!! #}
{# !!! positive_shift_loop:                                                                                                     !!! #}
{# !!! da famistudio_slide_pitch_hi,x                                                                                           !!! #}
{# !!! mp #$80                                                                                                                  !!! #}
{# !!! or famistudio_slide_pitch_hi,x                                                                                           !!! #}
{# !!! or famistudio_slide_pitch_lo,x                                                                                           !!! #}
{# !!! ey                                                                                                                       !!! #}
{# !!! ne @positive_shift_loop                                                                                                  !!! #}
{# !!! shift_done:                                                                                                              !!! #}
    {% endif 120 %}
{# !!! dx chan_idx                                                                                                              !!! #}
{# !!! dy tmp_y2                                                                                                                !!! #}

{# !!! slide_done_pos:                                                                                                          !!! #}
{# !!! da (channel_data_ptr),y ; Re-read the target note (ugly...)                                                              !!! #}
{# !!! ta famistudio_chn_note,x ; Store note code                                                                               !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! mp @cancel_delayed_cut                                                                                                   !!! #}
{% endif 120 %}

{# !!! opcode_invalid:                                                                                                          !!! #}

{#  If you hit this, this mean you either:                                                                                  #}
{#  - exported a song that uses FamiStudio tempo but have defined "FAMISTUDIO_USE_FAMITRACKER_TEMPO"                        #}
{#  - use delayed notes/cuts, but didnt enable "FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS"                           #}
{#  - use vibrato effect, but didnt enable "FAMISTUDIO_USE_VIBRATO"                                                         #}
{#  - use arpeggiated chords, but didnt enable "FAMISTUDIO_USE_ARPEGGIO"                                                    #}
{#  - use fine pitches, but didnt enable "FAMISTUDIO_USE_PITCH_TRACK"                                                       #}
{#  - use a duty cycle effect, but didnt enable "FAMISTUDIO_USE_DUTYCYCLE_EFFECT"                                           #}
{#  - use slide notes, but didnt enable "FAMISTUDIO_USE_SLIDE_NOTES"                                                        #}
{#  - use volume slides, but didnt enable "FAMISTUDIO_USE_VOLUME_SLIDES"                                                    #}
{#  - use DMC counter effect, but didnt enable "FAMISTUDIO_USE_DELTA_COUNTER"                                               #}
{#  - use a Phase Reset efect, but didnt enable the "FAMISTUDIO_USE_PHASE_RESET"                                            #}
{#  - use an instrument > 63, but didnt enable "FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE"                                   #}

{# !!! rk                                                                                                                       !!! #}

{# !!! famistudio_opcode_jmp_lo:                                                                                                !!! #}
{# !!! byte <@opcode_extended_note                ; $40                                                                         !!! #}
{# !!! byte <@opcode_set_reference                ; $41                                                                         !!! #}
{# !!! byte <@opcode_loop                         ; $42                                                                         !!! #}
{# !!! byte <@opcode_disable_attack               ; $43                                                                         !!! #}
{# !!! byte <@opcode_end_song                     ; $44                                                                         !!! #}
{% if FAMISTUDIO_USE_RELEASE_NOTES                                                                                             %}
{# !!! byte <@opcode_release_note                 ; $45                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $45                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_FAMITRACKER_TEMPO                                                                                         %}
{# !!! byte <@opcode_famitracker_speed            ; $46                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $46                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS                                                                         %}
{# !!! byte <@opcode_note_delay                   ; $47                                                                         !!! #}
{# !!! byte <@opcode_cut_delay                    ; $48                                                                         !!! #}
{% elif !FAMISTUDIO_USE_FAMITRACKER_TEMPO                                                                                        %}
{# !!! byte <@opcode_set_tempo_envelope           ; $47                                                                         !!! #}
{# !!! byte <@opcode_reset_tempo_envelope         ; $48                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $47                                                                         !!! #}
{# !!! byte <@opcode_invalid                      ; $48                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_VIBRATO                                                                                                   %}
{# !!! byte <@opcode_override_pitch_envelope      ; $49                                                                         !!! #}
{# !!! byte <@opcode_clear_pitch_override_flag    ; $4a                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $49                                                                         !!! #}
{# !!! byte <@opcode_invalid                      ; $4a                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_ARPEGGIO                                                                                                  %}
{# !!! byte <@opcode_override_arpeggio_envelope   ; $4b                                                                         !!! #}
{# !!! byte <@opcode_clear_arpeggio_override_flag ; $4c                                                                         !!! #}
{# !!! byte <@opcode_reset_arpeggio               ; $4d                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $4b                                                                         !!! #}
{# !!! byte <@opcode_invalid                      ; $4c                                                                         !!! #}
{# !!! byte <@opcode_invalid                      ; $4d                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_PITCH_TRACK                                                                                               %}
{# !!! byte <@opcode_fine_pitch                   ; $4e                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $4e                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_DUTYCYCLE_EFFECT                                                                                          %}
{# !!! byte <@opcode_duty_cycle_effect            ; $4f                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $4f                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_SLIDE_NOTES                                                                                               %}
{# !!! byte <@opcode_slide                        ; $50                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $50                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_VOLUME_SLIDES                                                                                             %}
{# !!! byte <@opcode_volume_slide                 ; $51                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $51                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_DELTA_COUNTER                                                                                             %}
{# !!! byte <@opcode_dmc_counter                  ; $52                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $52                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_PHASE_RESET                                                                                               %}
{# !!! byte <@opcode_phase_reset                  ; $53                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $53                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE                                                                                 %}
{# !!! byte <@opcode_extended_instrument          ; $54                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $54                                                                         !!! #}
{% endif 120 %}
{% if !FAMISTUDIO_EXP_NONE                                                                                                     %} {#  Begin expansion-specific opcodes #}
{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! byte <@opcode_vrc6_saw_volume              ; $55                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $55                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_VRC7 && FAMISTUDIO_USE_RELEASE_NOTES                                                                      %}
{# !!! byte <@opcode_vrc7_release_note            ; $56                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $56                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! byte <@opcode_fds_mod_speed                ; $57                                                                         !!! #}
{# !!! byte <@opcode_fds_mod_depth                ; $58                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $57                                                                         !!! #}
{# !!! byte <@opcode_invalid                      ; $58                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_FDS && FAMISTUDIO_USE_RELEASE_NOTES                                                                       %}
{# !!! byte <@opcode_fds_release_note             ; $59                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $59                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_N163 && FAMISTUDIO_USE_RELEASE_NOTES                                                                      %}
{# !!! byte <@opcode_n163_release_note            ; $5a                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $5a                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_N163 && FAMISTUDIO_USE_PHASE_RESET                                                                        %}
{# !!! byte <@opcode_n163_phase_reset             ; $5b                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $5b                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM && FAMISTUDIO_USE_RELEASE_NOTES                                                                      %}
{# !!! byte <@opcode_epsm_release_note            ; $5c                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $5c                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM && FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0                                                               %}
{# !!! byte <@opcode_epsm_manual_env_period       ; $5d                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $5d                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_S5B                                                                                                       %}
{# !!! byte <@opcode_s5b_manual_env_period        ; $5e                                                                         !!! #}
{% else 120 %}
{# !!! byte <@opcode_invalid                      ; $5e                                                                         !!! #}
{% endif 120 %}
{% endif 120 %}

{# !!! famistudio_opcode_jmp_hi:                                                                                                !!! #}
{# !!! byte >@opcode_extended_note                ; $40                                                                         !!! #}
{# !!! byte >@opcode_set_reference                ; $41                                                                         !!! #}
{# !!! byte >@opcode_loop                         ; $42                                                                         !!! #}
{# !!! byte >@opcode_disable_attack               ; $43                                                                         !!! #}
{# !!! byte >@opcode_end_song                     ; $44                                                                         !!! #}
{% if FAMISTUDIO_USE_RELEASE_NOTES                                                                                             %}
{# !!! byte >@opcode_release_note                 ; $45                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $45                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_FAMITRACKER_TEMPO                                                                                         %}
{# !!! byte >@opcode_famitracker_speed            ; $46                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $46                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_FAMITRACKER_DELAYED_NOTES_OR_CUTS                                                                         %}
{# !!! byte >@opcode_note_delay                   ; $47                                                                         !!! #}
{# !!! byte >@opcode_cut_delay                    ; $48                                                                         !!! #}
{% elif !FAMISTUDIO_USE_FAMITRACKER_TEMPO                                                                                        %}
{# !!! byte >@opcode_set_tempo_envelope           ; $47                                                                         !!! #}
{# !!! byte >@opcode_reset_tempo_envelope         ; $48                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $47                                                                         !!! #}
{# !!! byte >@opcode_invalid                      ; $48                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_VIBRATO                                                                                                   %}
{# !!! byte >@opcode_override_pitch_envelope      ; $49                                                                         !!! #}
{# !!! byte >@opcode_clear_pitch_override_flag    ; $4a                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $49                                                                         !!! #}
{# !!! byte >@opcode_invalid                      ; $4a                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_ARPEGGIO                                                                                                  %}
{# !!! byte >@opcode_override_arpeggio_envelope   ; $4b                                                                         !!! #}
{# !!! byte >@opcode_clear_arpeggio_override_flag ; $4c                                                                         !!! #}
{# !!! byte >@opcode_reset_arpeggio               ; $4d                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $4b                                                                         !!! #}
{# !!! byte >@opcode_invalid                      ; $4c                                                                         !!! #}
{# !!! byte >@opcode_invalid                      ; $4d                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_PITCH_TRACK                                                                                               %}
{# !!! byte >@opcode_fine_pitch                   ; $4e                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $4e                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_DUTYCYCLE_EFFECT                                                                                          %}
{# !!! byte >@opcode_duty_cycle_effect            ; $4f                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $4f                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_SLIDE_NOTES                                                                                               %}
{# !!! byte >@opcode_slide                        ; $50                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $50                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_VOLUME_SLIDES                                                                                             %}
{# !!! byte >@opcode_volume_slide                 ; $51                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $51                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_DELTA_COUNTER                                                                                             %}
{# !!! byte >@opcode_dmc_counter                  ; $52                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $52                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_PHASE_RESET                                                                                               %}
{# !!! byte >@opcode_phase_reset                  ; $53                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $53                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_USE_INSTRUMENT_EXTENDED_RANGE                                                                                 %}
{# !!! byte >@opcode_extended_instrument          ; $54                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $54                                                                         !!! #}
{% endif 120 %}
{% if !FAMISTUDIO_EXP_NONE                                                                                                     %} {#  Begin expansion-specific opcodes #}
{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! byte >@opcode_vrc6_saw_volume              ; $55                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $55                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_VRC7 && FAMISTUDIO_USE_RELEASE_NOTES                                                                      %}
{# !!! byte >@opcode_vrc7_release_note            ; $56                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $56                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! byte >@opcode_fds_mod_speed                ; $57                                                                         !!! #}
{# !!! byte >@opcode_fds_mod_depth                ; $58                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $57                                                                         !!! #}
{# !!! byte >@opcode_invalid                      ; $58                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_FDS && FAMISTUDIO_USE_RELEASE_NOTES                                                                       %}
{# !!! byte >@opcode_fds_release_note             ; $59                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $59                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_N163 && FAMISTUDIO_USE_RELEASE_NOTES                                                                      %}
{# !!! byte >@opcode_n163_release_note            ; $5a                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $5a                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_N163 && FAMISTUDIO_USE_PHASE_RESET                                                                        %}
{# !!! byte >@opcode_n163_phase_reset             ; $5b                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $5b                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM && FAMISTUDIO_USE_RELEASE_NOTES                                                                      %}
{# !!! byte >@opcode_epsm_release_note            ; $5c                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $5c                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM && FAMISTUDIO_EXP_EPSM_SSG_CHN_CNT > 0                                                               %}
{# !!! byte >@opcode_epsm_manual_env_period       ; $5d                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $5d                                                                         !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_S5B                                                                                                       %}
{# !!! byte >@opcode_s5b_manual_env_period        ; $5e                                                                         !!! #}
{% else 120 %}
{# !!! byte >@opcode_invalid                      ; $5e                                                                         !!! #}
{% endif 120 %}
{% endif 120 %}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_SAMPLE_STOP (internal)                                                                                       #}
{#                                                                                                                          #}
{#  Stop DPCM sample if it plays                                                                                            #}
{#                                                                                                                          #}
{#  [in] no input params.                                                                                                   #}
{# ======================================================================================================================   #}

{# !!! amistudio_sample_stop:                                                                                                   !!! #}

{# !!! da #%00001111                                                                                                            !!! #}
{# !!! ta FAMISTUDIO_APU_SND_CHN                                                                                                !!! #}
{# !!! ts                                                                                                                       !!! #}


{% if FAMISTUDIO_CFG_DPCM_SUPPORT                                                                                              %}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_SAMPLE_PLAY_SFX (public)                                                                                     #}
{#                                                                                                                          #}
{#  Play DPCM sample with higher priority, for sound effects                                                                #}
{#                                                                                                                          #}
{#  [in] a: Sample index, 1...63.                                                                                           #}
{# ======================================================================================================================   #}

{# !!! amistudio_sfx_sample_play:                                                                                               !!! #}

{# !!! dx #1                                                                                                                    !!! #}
{# !!! tx famistudio_dpcm_effect                                                                                                !!! #}

{# !!! ample_play:                                                                                                              !!! #}

{# !!! mp = famistudio_r3                                                                                                       !!! #}
{# !!! ample_index = famistudio_r3                                                                                              !!! #}
{# !!! ample_data_ptr = famistudio_ptr1                                                                                         !!! #}

{% if FAMISTUDIO_USE_DPCM_BANKSWITCHING || FAMISTUDIO_USE_DPCM_EXTENDED_RANGE                                                  %}
{#  famistudio_dpcm_list + sample number * (4 or 5)                                                                         #}
{# !!! ta sample_index                                                                                                          !!! #}
{# !!! dy #0                                                                                                                    !!! #}
{# !!! ty sample_data_ptr+1                                                                                                     !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ol sample_data_ptr+1                                                                                                     !!! #}
{# !!! sl                                                                                                                       !!! #}
{# !!! ol sample_data_ptr+1 ; Will clear carry                                                                                  !!! #}
{% if FAMISTUDIO_USE_DPCM_BANKSWITCHING                                                                                        %}
{#  Multiply by 5 instead of 4.                                                                                             #}
{# !!! dc sample_index                                                                                                          !!! #}
{# !!! cc add_list_ptr                                                                                                          !!! #}
{# !!! nc sample_data_ptr+1                                                                                                     !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dd_list_ptr:                                                                                                             !!! #}
{% endif 120 %}
{# !!! dc famistudio_dpcm_list_lo                                                                                               !!! #}
{# !!! ta sample_data_ptr+0                                                                                                     !!! #}
{# !!! da sample_data_ptr+1                                                                                                     !!! #}
{# !!! dc famistudio_dpcm_list_hi                                                                                               !!! #}
{# !!! ta sample_data_ptr+1                                                                                                     !!! #}
{% else 120 %}
{# !!! sl ; Sample number * 4, offset in the sample table                                                                       !!! #}
{# !!! sl ; Carry should be clear now, we dont allow more than 63 sample mappings.                                              !!! #}
{# !!! dc famistudio_dpcm_list_lo                                                                                               !!! #}
{# !!! ta sample_data_ptr+0                                                                                                     !!! #}
{# !!! da #0                                                                                                                    !!! #}
{# !!! dc famistudio_dpcm_list_hi                                                                                               !!! #}
{# !!! ta sample_data_ptr+1                                                                                                     !!! #}
{% endif 120 %}

{# !!! top_dpcm:                                                                                                                !!! #}
{# !!! da #%00001111 ; Stop DPCM                                                                                                !!! #}
{# !!! ta FAMISTUDIO_APU_SND_CHN                                                                                                !!! #}

{# !!! dy #0                                                                                                                    !!! #}
{# !!! da (sample_data_ptr),y ; Sample offset                                                                                   !!! #}
{# !!! ta FAMISTUDIO_APU_DMC_START                                                                                              !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (sample_data_ptr),y ; Sample length                                                                                   !!! #}
{# !!! ta FAMISTUDIO_APU_DMC_LEN                                                                                                !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (sample_data_ptr),y ; Pitch and loop                                                                                  !!! #}
{# !!! ta FAMISTUDIO_APU_DMC_FREQ                                                                                               !!! #}
{# !!! ny                                                                                                                       !!! #}

{% if FAMISTUDIO_USE_DELTA_COUNTER                                                                                             %}
{# !!! da famistudio_dmc_delta_counter                                                                                          !!! #}
{# !!! mi read_dmc_initial_value                                                                                                !!! #}
{# !!! ta FAMISTUDIO_APU_DMC_RAW                                                                                                !!! #}
{# !!! da #$ff                                                                                                                  !!! #}
{# !!! ta famistudio_dmc_delta_counter                                                                                          !!! #}
{# !!! mi start_dmc                                                                                                             !!! #}
{# !!! ead_dmc_initial_value:                                                                                                   !!! #}
{% endif 120 %}

{# !!! da (sample_data_ptr),y ; Initial DMC counter                                                                             !!! #}
{# !!! ta FAMISTUDIO_APU_DMC_RAW                                                                                                !!! #}

{# !!! tart_dmc:                                                                                                                !!! #}
{% if FAMISTUDIO_USE_DPCM_BANKSWITCHING                                                                                        %}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (sample_data_ptr),y ; Bank number                                                                                     !!! #}
{# !!! sr famistudio_dpcm_bank_callback                                                                                         !!! #}
{% endif 120 %}

{# !!! da #%00011111 ; Start DMC                                                                                                !!! #}
{# !!! ta FAMISTUDIO_APU_SND_CHN                                                                                                !!! #}

{# !!! ts                                                                                                                       !!! #}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_SAMPLE_PLAY_MUSIC (internal)                                                                                 #}
{#                                                                                                                          #}
{#  Play DPCM sample, used by music player, could be used externally. Samples played for music have lower priority than     #}
{#  samples played by SFX.                                                                                                  #}
{#                                                                                                                          #}
{#  [in] a: Sample index, 1...63.                                                                                           #}
{# ======================================================================================================================   #}

{# !!! amistudio_music_sample_play:                                                                                             !!! #}

{# !!! dx famistudio_dpcm_effect                                                                                                !!! #}
{# !!! eq sample_play                                                                                                           !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! da FAMISTUDIO_APU_SND_CHN                                                                                                !!! #}
{# !!! nd #16                                                                                                                   !!! #}
{# !!! eq @not_busy                                                                                                             !!! #}
{# !!! ts                                                                                                                       !!! #}

{# !!! not_busy:                                                                                                                !!! #}
{# !!! ta famistudio_dpcm_effect                                                                                                !!! #}
{# !!! xa                                                                                                                       !!! #}
{# !!! mp sample_play                                                                                                           !!! #}

{% endif 120 %}

{% if FAMISTUDIO_CFG_SFX_SUPPORT                                                                                               %}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_SFX_INIT (public)                                                                                            #}
{#                                                                                                                          #}
{#  Initialize the sound effect player.                                                                                     #}
{#                                                                                                                          #}
{#  [in] x: Sound effect data pointer (lo)                                                                                  #}
{#  [in] y: Sound effect data pointer (hi)                                                                                  #}
{# ======================================================================================================================   #}

{# !!! amistudio_sfx_init:                                                                                                      !!! #}

{# !!! ffect_list_ptr = famistudio_ptr0                                                                                         !!! #}

{# !!! tx effect_list_ptr+0                                                                                                     !!! #}
{# !!! ty effect_list_ptr+1                                                                                                     !!! #}

{# !!! dy #0                                                                                                                    !!! #}

{% if FAMISTUDIO_DUAL_SUPPORT                                                                                                  %}
{# !!! da famistudio_pal_adjust ; Add 2 to the sound list pointer for PAL                                                       !!! #}
{# !!! ne @ntsc                                                                                                                 !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ntsc:                                                                                                                    !!! #}
{% endif 120 %}

{# !!! da (effect_list_ptr),y                                                                                                   !!! #}
{# !!! ta famistudio_sfx_addr_lo                                                                                                !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (effect_list_ptr),y                                                                                                   !!! #}
{# !!! ta famistudio_sfx_addr_hi                                                                                                !!! #}

{# !!! dx #FAMISTUDIO_SFX_CH0                                                                                                   !!! #}

{# !!! set_channels:                                                                                                            !!! #}
{# !!! sr famistudio_sfx_clear_channel                                                                                          !!! #}
{# !!! xa                                                                                                                       !!! #}
{# !!! lc                                                                                                                       !!! #}
{# !!! dc #FAMISTUDIO_SFX_STRUCT_SIZE                                                                                           !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! px #FAMISTUDIO_SFX_STRUCT_SIZE*FAMISTUDIO_CFG_SFX_STREAMS                                                                !!! #}
{# !!! ne @set_channels                                                                                                         !!! #}

{# !!! ts                                                                                                                       !!! #}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_SFX_CLEAR_CHANNEL (internal)                                                                                 #}
{#                                                                                                                          #}
{#  Clears output buffer of a sound effect.                                                                                 #}
{#                                                                                                                          #}
{#  [in] x: Offset of the sound effect stream.                                                                              #}
{# ======================================================================================================================   #}

{# !!! amistudio_sfx_clear_channel:                                                                                             !!! #}

{# !!! da #0                                                                                                                    !!! #}
{# !!! ta famistudio_sfx_ptr_hi,x   ; This stops the effect                                                                     !!! #}
{# !!! ta famistudio_sfx_repeat,x                                                                                               !!! #}
{# !!! ta famistudio_sfx_offset,x                                                                                               !!! #}
{# !!! ta famistudio_sfx_buffer+6,x ; Mute triangle                                                                             !!! #}
{# !!! da #$30                                                                                                                  !!! #}
{# !!! ta famistudio_sfx_buffer+0,x ; Mute pulse1                                                                               !!! #}
{# !!! ta famistudio_sfx_buffer+3,x ; Mute pulse2                                                                               !!! #}
{# !!! ta famistudio_sfx_buffer+9,x ; Mute noise                                                                                !!! #}
{# !!! ts                                                                                                                       !!! #}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_SFX_PLAY (public)                                                                                            #}
{#                                                                                                                          #}
{#  Plays a sound effect.                                                                                                   #}
{#                                                                                                                          #}
{#  [in] a: Sound effect index (0...127)                                                                                    #}
{#  [in] x: Offset of sound effect channel, should be FAMISTUDIO_SFX_CH0..FAMISTUDIO_SFX_CH3                                #}
{# ======================================================================================================================   #}

{# !!! amistudio_sfx_play:                                                                                                      !!! #}

{# !!! ffect_data_ptr = famistudio_ptr0                                                                                         !!! #}

{# !!! sl a                                                                                                                     !!! #}
{# !!! ay                                                                                                                       !!! #}

{# !!! sr famistudio_sfx_clear_channel ; Stops the effect if it plays                                                           !!! #}

{# !!! da famistudio_sfx_addr_lo                                                                                                !!! #}
{# !!! ta effect_data_ptr+0                                                                                                     !!! #}
{# !!! da famistudio_sfx_addr_hi                                                                                                !!! #}
{# !!! ta effect_data_ptr+1                                                                                                     !!! #}

{# !!! da (effect_data_ptr),y                                                                                                   !!! #}
{# !!! ta famistudio_sfx_ptr_lo,x                                                                                               !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! da (effect_data_ptr),y                                                                                                   !!! #}
{# !!! ta famistudio_sfx_ptr_hi,x ; This write enables the effect                                                               !!! #}

{# !!! ts                                                                                                                       !!! #}

{# ======================================================================================================================   #}
{#  FAMISTUDIO_SFX_UPDATE (internal)                                                                                        #}
{#                                                                                                                          #}
{#  Updates a single sound effect stream.                                                                                   #}
{#                                                                                                                          #}
{#  [in] x: Offset of sound effect channel, should be FAMISTUDIO_SFX_CH0..FAMISTUDIO_SFX_CH3                                #}
{# ======================================================================================================================   #}

{# !!! amistudio_sfx_update:                                                                                                    !!! #}

{# !!! mp = famistudio_r0                                                                                                       !!! #}
{# !!! mpx = famistudio_r1                                                                                                      !!! #}
{# !!! ffect_data_ptr = famistudio_ptr0                                                                                         !!! #}

{# !!! da famistudio_sfx_repeat,x ; Check if repeat counter is not zero                                                         !!! #}
{# !!! eq @no_repeat                                                                                                            !!! #}
{# !!! ec famistudio_sfx_repeat,x ; Decrement and return                                                                        !!! #}
{# !!! ne @update_buf ; Just mix with output buffer                                                                             !!! #}

{# !!! no_repeat:                                                                                                               !!! #}
{# !!! da famistudio_sfx_ptr_hi,x ; Check if MSB of the pointer is not zero                                                     !!! #}
{# !!! ne @sfx_active                                                                                                           !!! #}
{# !!! ts ; Return otherwise, no active effect                                                                                  !!! #}

{# !!! sfx_active:                                                                                                              !!! #}
{# !!! ta effect_data_ptr+1         ;load effect pointer into temp                                                              !!! #}
{# !!! da famistudio_sfx_ptr_lo,x                                                                                               !!! #}
{# !!! ta effect_data_ptr+0                                                                                                     !!! #}
{# !!! dy famistudio_sfx_offset,x                                                                                               !!! #}
{# !!! lc                                                                                                                       !!! #}

{# !!! read_byte:                                                                                                               !!! #}
{# !!! da (effect_data_ptr),y ; Read byte of effect                                                                             !!! #}
{# !!! mi @get_data ; If bit 7 is set, it is a register write                                                                   !!! #}
{# !!! eq @eof                                                                                                                  !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ne @store_repeat                                                                                                         !!! #}
{# !!! sr @inc_sfx                                                                                                              !!! #}
{# !!! store_repeat:                                                                                                            !!! #}
{# !!! ta famistudio_sfx_repeat,x ; If bit 7 is reset, it is number of repeats                                                  !!! #}
{# !!! ya                                                                                                                       !!! #}
{# !!! ta famistudio_sfx_offset,x                                                                                               !!! #}
{# !!! mp @update_buf                                                                                                           !!! #}

{# !!! get_data:                                                                                                                !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ne @get_data2                                                                                                            !!! #}
{# !!! sr @inc_sfx                                                                                                              !!! #}
{# !!! get_data2:                                                                                                               !!! #}
{# !!! tx tmp ; It is a register write                                                                                          !!! #}
{# !!! dc tmp ; Get offset in the effect output buffer                                                                          !!! #}
{# !!! ax                                                                                                                       !!! #}
{# !!! da (effect_data_ptr),y                                                                                                   !!! #}
{# !!! ny                                                                                                                       !!! #}
{# !!! ne @write_buffer                                                                                                         !!! #}
{# !!! tx tmpx                                                                                                                  !!! #}
{# !!! dx tmp                                                                                                                   !!! #}
{# !!! sr @inc_sfx                                                                                                              !!! #}
{# !!! dx tmpx                                                                                                                  !!! #}
{# !!! write_buffer:                                                                                                            !!! #}
{# !!! ta famistudio_sfx_buffer-128,x                                                                                           !!! #}
{# !!! dx tmp                                                                                                                   !!! #}
{# !!! mp @read_byte                                                                                                            !!! #}

{# !!! eof:                                                                                                                     !!! #}
{# !!! ta famistudio_sfx_ptr_hi,x ; Mark channel as inactive                                                                    !!! #}

{# !!! update_buf:                                                                                                              !!! #}
{# !!! da famistudio_output_buf ; Compare effect output buffer with main output buffer                                          !!! #}
{# !!! nd #$0f ; If volume of pulse 1 of effect is higher than that of the main buffer, overwrite the main buffer value with the new one !!! #}
{# !!! ta tmp                                                                                                                   !!! #}
{# !!! da famistudio_sfx_buffer+0,x                                                                                             !!! #}
{# !!! nd #$0f                                                                                                                  !!! #}
{# !!! mp tmp                                                                                                                   !!! #}
{# !!! cc @no_pulse1                                                                                                            !!! #}
{# !!! da famistudio_sfx_buffer+0,x                                                                                             !!! #}
{# !!! ta famistudio_output_buf+0                                                                                               !!! #}
{# !!! da famistudio_sfx_buffer+1,x                                                                                             !!! #}
{# !!! ta famistudio_output_buf+1                                                                                               !!! #}
{# !!! da famistudio_sfx_buffer+2,x                                                                                             !!! #}
{# !!! ta famistudio_output_buf+2                                                                                               !!! #}

{# !!! no_pulse1:                                                                                                               !!! #}
{# !!! da famistudio_output_buf+3                                                                                               !!! #}
{# !!! nd #$0f                                                                                                                  !!! #}
{# !!! ta tmp                                                                                                                   !!! #}
{# !!! da famistudio_sfx_buffer+3,x                                                                                             !!! #}
{# !!! nd #$0f                                                                                                                  !!! #}
{# !!! mp tmp                                                                                                                   !!! #}
{# !!! cc @no_pulse2                                                                                                            !!! #}
{# !!! da famistudio_sfx_buffer+3,x                                                                                             !!! #}
{# !!! ta famistudio_output_buf+3                                                                                               !!! #}
{# !!! da famistudio_sfx_buffer+4,x                                                                                             !!! #}
{# !!! ta famistudio_output_buf+4                                                                                               !!! #}
{# !!! da famistudio_sfx_buffer+5,x                                                                                             !!! #}
{# !!! ta famistudio_output_buf+5                                                                                               !!! #}

{# !!! no_pulse2:                                                                                                               !!! #}
{# !!! da famistudio_sfx_buffer+6,x ; Overwrite triangle of main output buffer if it is active                                  !!! #}
{# !!! eq @no_triangle                                                                                                          !!! #}
{# !!! ta famistudio_output_buf+6                                                                                               !!! #}
{# !!! da famistudio_sfx_buffer+7,x                                                                                             !!! #}
{# !!! ta famistudio_output_buf+7                                                                                               !!! #}
{# !!! da famistudio_sfx_buffer+8,x                                                                                             !!! #}
{# !!! ta famistudio_output_buf+8                                                                                               !!! #}

{# !!! no_triangle:                                                                                                             !!! #}
{# !!! da famistudio_output_buf+9                                                                                               !!! #}
{# !!! nd #$0f                                                                                                                  !!! #}
{# !!! ta tmp                                                                                                                   !!! #}
{# !!! da famistudio_sfx_buffer+9,x                                                                                             !!! #}
{# !!! nd #$0f                                                                                                                  !!! #}
{# !!! mp tmp                                                                                                                   !!! #}
{# !!! cc @no_noise                                                                                                             !!! #}
{# !!! da famistudio_sfx_buffer+9,x                                                                                             !!! #}
{# !!! ta famistudio_output_buf+9                                                                                               !!! #}
{# !!! da famistudio_sfx_buffer+10,x                                                                                            !!! #}
{# !!! ta famistudio_output_buf+10                                                                                              !!! #}

{# !!! no_noise:                                                                                                                !!! #}
{# !!! ts                                                                                                                       !!! #}

{# !!! inc_sfx:                                                                                                                 !!! #}
{# !!! nc effect_data_ptr+1                                                                                                     !!! #}
{# !!! nc famistudio_sfx_ptr_hi,x                                                                                               !!! #}
{# !!! ts                                                                                                                       !!! #}

{% endif 120 %}

{#  Dummy envelope used to initialize all channels with silence                                                             #}
{# !!! amistudio_dummy_envelope:                                                                                                !!! #}
{# !!! byte $c0,$7f,$00,$00                                                                                                     !!! #}

{# !!! amistudio_dummy_pitch_envelope:                                                                                          !!! #}
{# !!! byte $00,$c0,$7f,$00,$01                                                                                                 !!! #}

{#  Note tables                                                                                                             #}
    {% if FAMISTUDIO_EXP_S5B                                                                                                       %}
{# !!! amistudio_exp_note_table_lsb:                                                                                            !!! #}
{# !!! amistudio_s5b_note_table_lsb:                                                                                            !!! #}
    {% endif 120 %}
{# !!! amistudio_note_table_lsb:                                                                                                !!! #}
        {% if FAMISTUDIO_CFG_PAL_SUPPORT                                                                                               %}
{# !!! incbin "NoteTables/famistudio_note_table_pal_lsb.bin"                                                                    !!! #}
        {% endif 120 %}
        {% if FAMISTUDIO_CFG_NTSC_SUPPORT                                                                                              %}
{# !!! incbin "NoteTables/famistudio_note_table_lsb.bin"                                                                        !!! #}
        {% endif 120 %}

    {% if FAMISTUDIO_EXP_S5B                                                                                                       %}
{# !!! amistudio_exp_note_table_msb:                                                                                            !!! #}
{# !!! amistudio_s5b_note_table_msb:                                                                                            !!! #}
    {% endif 120 %}
{# !!! amistudio_note_table_msb:                                                                                                !!! #}
        {% if FAMISTUDIO_CFG_PAL_SUPPORT                                                                                               %}
{# !!! incbin "NoteTables/famistudio_note_table_pal_msb.bin"                                                                    !!! #}
        {% endif 120 %}
        {% if FAMISTUDIO_CFG_NTSC_SUPPORT                                                                                              %}
{# !!! incbin "NoteTables/famistudio_note_table_msb.bin"                                                                        !!! #}
        {% endif 120 %}

    {% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! amistudio_exp_note_table_lsb:                                                                                            !!! #}
{# !!! amistudio_saw_note_table_lsb:                                                                                            !!! #}
        {% if FAMISTUDIO_CFG_PAL_SUPPORT                                                                                               %}
{# !!! incbin "NoteTables/famistudio_saw_note_table_pal_lsb.bin"                                                                !!! #}
        {% endif 120 %}
        {% if FAMISTUDIO_CFG_NTSC_SUPPORT                                                                                              %}
{# !!! incbin "NoteTables/famistudio_saw_note_table_lsb.bin"                                                                    !!! #}
        {% endif 120 %}
{# !!! amistudio_exp_note_table_msb:                                                                                            !!! #}
{# !!! amistudio_saw_note_table_msb:                                                                                            !!! #}
        {% if FAMISTUDIO_CFG_PAL_SUPPORT                                                                                               %}
{# !!! incbin "NoteTables/famistudio_saw_note_table_pal_msb.bin"                                                                !!! #}
        {% endif 120 %}
        {% if FAMISTUDIO_CFG_NTSC_SUPPORT                                                                                              %}
{# !!! incbin "NoteTables/famistudio_saw_note_table_msb.bin"                                                                    !!! #}
        {% endif 120 %}
    {% endif 120 %}

    {% if FAMISTUDIO_EXP_VRC7                                                                                                      %}
{# !!! amistudio_exp_note_table_lsb:                                                                                            !!! #}
{# !!! amistudio_vrc7_note_table_lsb:                                                                                           !!! #}
{# !!! incbin "NoteTables/famistudio_vrc7_note_table_lsb.bin"                                                                   !!! #}
{# !!! amistudio_exp_note_table_msb:                                                                                            !!! #}
{# !!! amistudio_vrc7_note_table_msb:                                                                                           !!! #}
{# !!! incbin "NoteTables/famistudio_vrc7_note_table_msb.bin"                                                                   !!! #}
    {% endif 120 %}

    {% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
        {% if FAMISTUDIO_EXP_EPSM_FM_CHN_CNT > 0                                                                                       %}
{# !!! amistudio_epsm_note_table_lsb:                                                                                           !!! #}
{# !!! incbin "NoteTables/famistudio_epsm_note_table_lsb.bin"                                                                   !!! #}
{# !!! amistudio_epsm_note_table_msb:                                                                                           !!! #}
{# !!! incbin "NoteTables/famistudio_epsm_note_table_msb.bin"                                                                   !!! #}
        {% endif 120 %}
{# !!! amistudio_exp_note_table_lsb:                                                                                            !!! #}
{# !!! amistudio_epsm_s_note_table_lsb:                                                                                         !!! #}
{# !!! incbin "NoteTables/famistudio_epsm_s_note_table_lsb.bin"                                                                 !!! #}
{# !!! amistudio_exp_note_table_msb:                                                                                            !!! #}
{# !!! amistudio_epsm_s_note_table_msb:                                                                                         !!! #}
{# !!! incbin "NoteTables/famistudio_epsm_s_note_table_msb.bin"                                                                 !!! #}
    {% endif 120 %}

    {% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! amistudio_exp_note_table_lsb:                                                                                            !!! #}
{# !!! amistudio_fds_note_table_lsb:                                                                                            !!! #}
        {% if FAMISTUDIO_CFG_PAL_SUPPORT                                                                                               %}
{# !!! incbin "NoteTables/famistudio_fds_note_table_pal_lsb.bin"                                                                !!! #}
        {% endif 120 %}
        {% if FAMISTUDIO_CFG_NTSC_SUPPORT                                                                                              %}
{# !!! incbin "NoteTables/famistudio_fds_note_table_lsb.bin"                                                                    !!! #}
        {% endif 120 %}
{# !!! amistudio_exp_note_table_msb:                                                                                            !!! #}
{# !!! amistudio_fds_note_table_msb:                                                                                            !!! #}
        {% if FAMISTUDIO_CFG_PAL_SUPPORT                                                                                               %}
{# !!! incbin "NoteTables/famistudio_fds_note_table_pal_msb.bin"                                                                !!! #}
        {% endif 120 %}
        {% if FAMISTUDIO_CFG_NTSC_SUPPORT                                                                                              %}
{# !!! incbin "NoteTables/famistudio_fds_note_table_msb.bin"                                                                    !!! #}
        {% endif 120 %}
    {% endif 120 %}

    {% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! amistudio_exp_note_table_lsb:                                                                                            !!! #}
{# !!! amistudio_n163_note_table_lsb:                                                                                           !!! #}
        {% if FAMISTUDIO_CFG_PAL_SUPPORT                                                                                               %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 1                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_pal_1ch_lsb.bin"                                                           !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 2                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_pal_2ch_lsb.bin"                                                           !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 3                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_pal_3ch_lsb.bin"                                                           !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 4                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_pal_4ch_lsb.bin"                                                           !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 5                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_pal_5ch_lsb.bin"                                                           !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 6                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_pal_6ch_lsb.bin"                                                           !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 7                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_pal_7ch_lsb.bin"                                                           !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 8                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_pal_8ch_lsb.bin"                                                           !!! #}
            {% endif 120 %}
        {% endif 120 %}
        {% if FAMISTUDIO_CFG_NTSC_SUPPORT                                                                                              %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 1                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_1ch_lsb.bin"                                                               !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 2                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_2ch_lsb.bin"                                                               !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 3                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_3ch_lsb.bin"                                                               !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 4                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_4ch_lsb.bin"                                                               !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 5                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_5ch_lsb.bin"                                                               !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 6                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_6ch_lsb.bin"                                                               !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 7                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_7ch_lsb.bin"                                                               !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 8                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_8ch_lsb.bin"                                                               !!! #}
            {% endif 120 %}
        {% endif 120 %}
{# !!! amistudio_exp_note_table_msb:                                                                                            !!! #}
{# !!! amistudio_n163_note_table_msb:                                                                                           !!! #}
        {% if FAMISTUDIO_CFG_PAL_SUPPORT                                                                                               %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 1                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_pal_1ch_msb.bin"                                                           !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 2                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_pal_2ch_msb.bin"                                                           !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 3                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_pal_3ch_msb.bin"                                                           !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 4                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_pal_4ch_msb.bin"                                                           !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 5                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_pal_5ch_msb.bin"                                                           !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 6                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_pal_6ch_msb.bin"                                                           !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 7                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_pal_7ch_msb.bin"                                                           !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 8                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_pal_8ch_msb.bin"                                                           !!! #}
            {% endif 120 %}
        {% endif 120 %}
        {% if FAMISTUDIO_CFG_NTSC_SUPPORT                                                                                              %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 1                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_1ch_msb.bin"                                                               !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 2                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_2ch_msb.bin"                                                               !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 3                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_3ch_msb.bin"                                                               !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 4                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_4ch_msb.bin"                                                               !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 5                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_5ch_msb.bin"                                                               !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 6                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_6ch_msb.bin"                                                               !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 7                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_7ch_msb.bin"                                                               !!! #}
            {% endif 120 %}
            {% if FAMISTUDIO_EXP_N163_CHN_CNT = 8                                                                                          %}
{# !!! incbin "NoteTables/famistudio_n163_note_table_8ch_msb.bin"                                                               !!! #}
            {% endif 120 %}
        {% endif 120 %}
    {% endif 120 %}

{#  For a given channel, returns the index of the volume envelope.                                                          #}
{# !!! amistudio_channel_env:                                                                                                   !!! #}
{# !!! amistudio_channel_to_volume_env:                                                                                         !!! #}
{# !!! byte FAMISTUDIO_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                       !!! #}
{# !!! byte FAMISTUDIO_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                       !!! #}
{# !!! byte FAMISTUDIO_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                       !!! #}
{# !!! byte FAMISTUDIO_CH3_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                       !!! #}
{# !!! byte $ff                                                                                                                 !!! #}
{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! byte FAMISTUDIO_VRC6_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{# !!! byte FAMISTUDIO_VRC6_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{# !!! byte FAMISTUDIO_VRC6_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_VRC7                                                                                                      %}
{# !!! byte FAMISTUDIO_VRC7_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH3_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH4_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH5_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! byte FAMISTUDIO_FDS_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_MMC5                                                                                                      %}
{# !!! byte FAMISTUDIO_MMC5_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{# !!! byte FAMISTUDIO_MMC5_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! byte FAMISTUDIO_N163_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_CH3_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_CH4_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_CH5_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_CH6_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{# !!! byte FAMISTUDIO_N163_CH7_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_S5B                                                                                                       %}
{# !!! byte FAMISTUDIO_S5B_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                   !!! #}
{# !!! byte FAMISTUDIO_S5B_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                   !!! #}
{# !!! byte FAMISTUDIO_S5B_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 0                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH0_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 1                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH1_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 2                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH2_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 3                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH3_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 4                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH4_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 5                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH5_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 6                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH6_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 7                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH7_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 8                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH8_ENVS+FAMISTUDIO_ENV_VOLUME_OFF                                                                  !!! #}
{% endif 120 %}
{% endif 120 %}

{% if FAMISTUDIO_USE_ARPEGGIO                                                                                                  %}
{#  For a given channel, returns the index of the arpeggio envelope.                                                        #}
{# !!! amistudio_channel_to_arpeggio_env:                                                                                       !!! #}
{# !!! byte FAMISTUDIO_CH0_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                         !!! #}
{# !!! byte FAMISTUDIO_CH1_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                         !!! #}
{# !!! byte FAMISTUDIO_CH2_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                         !!! #}
{# !!! byte FAMISTUDIO_CH3_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                         !!! #}
{# !!! byte $ff                                                                                                                 !!! #}
{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! byte FAMISTUDIO_VRC6_CH0_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{# !!! byte FAMISTUDIO_VRC6_CH1_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{# !!! byte FAMISTUDIO_VRC6_CH2_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_VRC7                                                                                                      %}
{# !!! byte FAMISTUDIO_VRC7_CH0_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH1_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH2_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH3_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH4_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH5_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! byte FAMISTUDIO_FDS_CH0_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                     !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_MMC5                                                                                                      %}
{# !!! byte FAMISTUDIO_MMC5_CH0_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{# !!! byte FAMISTUDIO_MMC5_CH1_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! byte FAMISTUDIO_N163_CH0_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{# !!! byte FAMISTUDIO_N163_CH1_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{# !!! byte FAMISTUDIO_N163_CH2_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{# !!! byte FAMISTUDIO_N163_CH3_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{# !!! byte FAMISTUDIO_N163_CH4_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{# !!! byte FAMISTUDIO_N163_CH5_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{# !!! byte FAMISTUDIO_N163_CH6_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{# !!! byte FAMISTUDIO_N163_CH7_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_S5B                                                                                                       %}
{# !!! byte FAMISTUDIO_S5B_CH0_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                     !!! #}
{# !!! byte FAMISTUDIO_S5B_CH1_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                     !!! #}
{# !!! byte FAMISTUDIO_S5B_CH2_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                     !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 0                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH0_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 1                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH1_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 2                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH2_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 3                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH3_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 4                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH4_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 5                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH5_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 6                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH6_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 7                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH7_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 8                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH8_ENVS+FAMISTUDIO_ENV_NOTE_OFF                                                                    !!! #}
{% endif 120 %} {#  FAMISTUDIO_EXP_EPSM_ENV_CNT > 8 #}
{% endif 120 %} {#  FAMISTUDIO_EXP_EPSM #}
{% endif 120 %} {#  FAMISTUDIO_USE_ARPEGGIO #}

{% if FAMISTUDIO_USE_SLIDE_NOTES                                                                                               %}
{# !!! amistudio_channel_to_slide:                                                                                              !!! #}
{#  This table will only be defined if we use noise slides, otherwise identical to "famistudio_channel_to_pitch_env".       #}
{% if FAMISTUDIO_USE_NOISE_SLIDE_NOTES                                                                                         %}
{# !!! byte $00                                                                                                                 !!! #}
{# !!! byte $01                                                                                                                 !!! #}
{# !!! byte $02                                                                                                                 !!! #}
{# !!! byte FAMISTUDIO_NOISE_SLIDE_INDEX ; Keep the noise slide at the end so the pitch envelopes/slides are in sync.           !!! #}
{# !!! byte $ff ; no slide for DPCM                                                                                             !!! #}
{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! byte FAMISTUDIO_VRC6_CH0_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_VRC6_CH1_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_VRC6_CH2_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_VRC7                                                                                                      %}
{# !!! byte FAMISTUDIO_VRC7_CH0_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH1_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH2_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH3_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH4_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH5_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! byte FAMISTUDIO_FDS_CH0_PITCH_ENV_IDX                                                                                    !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_MMC5                                                                                                      %}
{# !!! byte FAMISTUDIO_MMC5_CH0_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_MMC5_CH1_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! byte FAMISTUDIO_N163_CH0_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_CH1_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_CH2_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_CH3_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_CH4_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_CH5_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_CH6_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_CH7_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_S5B                                                                                                       %}
{# !!! byte FAMISTUDIO_S5B_CH0_PITCH_ENV_IDX                                                                                    !!! #}
{# !!! byte FAMISTUDIO_S5B_CH1_PITCH_ENV_IDX                                                                                    !!! #}
{# !!! byte FAMISTUDIO_S5B_CH2_PITCH_ENV_IDX                                                                                    !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 0                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH0_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 1                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH1_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 2                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH2_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 3                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH3_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 4                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH4_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 5                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH5_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 6                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH6_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 7                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH7_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 8                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH8_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %} {#  FAMISTUDIO_EXP_EPSM_ENV_CNT > 8 #}
{% endif 120 %} {#  FAMISTUDIO_EXP_EPSM #}
{% endif 120 %} {#  FAMISTUDIO_USE_NOISE_SLIDE_NOTES #}

{% endif 120 %} {#  FAMISTUDIO_USE_SLIDE_NOTES #}

{#  For a given channel, returns the index of the pitch envelope.                                                           #}
{# !!! amistudio_channel_to_pitch_env:                                                                                          !!! #}
{# !!! byte $00                                                                                                                 !!! #}
{# !!! byte $01                                                                                                                 !!! #}
{# !!! byte $02                                                                                                                 !!! #}
{# !!! byte $ff ; no pitch envelopes for noise                                                                                  !!! #}
{# !!! byte $ff ; no pitch envelopes slide for DPCM                                                                             !!! #}
{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! byte FAMISTUDIO_VRC6_CH0_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_VRC6_CH1_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_VRC6_CH2_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_VRC7                                                                                                      %}
{# !!! byte FAMISTUDIO_VRC7_CH0_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH1_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH2_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH3_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH4_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_VRC7_CH5_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! byte FAMISTUDIO_FDS_CH0_PITCH_ENV_IDX                                                                                    !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_MMC5                                                                                                      %}
{# !!! byte FAMISTUDIO_MMC5_CH0_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_MMC5_CH1_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! byte FAMISTUDIO_N163_CH0_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_CH1_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_CH2_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_CH3_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_CH4_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_CH5_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_CH6_PITCH_ENV_IDX                                                                                   !!! #}
{# !!! byte FAMISTUDIO_N163_CH7_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_S5B                                                                                                       %}
{# !!! byte FAMISTUDIO_S5B_CH0_PITCH_ENV_IDX                                                                                    !!! #}
{# !!! byte FAMISTUDIO_S5B_CH1_PITCH_ENV_IDX                                                                                    !!! #}
{# !!! byte FAMISTUDIO_S5B_CH2_PITCH_ENV_IDX                                                                                    !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 0                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH0_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 1                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH1_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 2                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH2_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 3                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH3_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 4                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH4_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 5                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH5_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 6                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH6_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 7                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH7_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_ENV_CNT > 8                                                                                          %}
{# !!! byte FAMISTUDIO_EPSM_CH8_PITCH_ENV_IDX                                                                                   !!! #}
{% endif 120 %} {#  FAMISTUDIO_EXP_EPSM_ENV_CNT > 8 #}
{% endif 120 %} {#  FAMISTUDIO_EXP_EPSM #}

{% if FAMISTUDIO_USE_DUTYCYCLE_EFFECT                                                                                          %}
{#  For a given channel, returns the index of the duty cycle in the "famistudio_duty_cycle" array.                          #}
{# !!! amistudio_channel_to_dutycycle:                                                                                          !!! #}
{# !!! byte $00                                                                                                                 !!! #}
{# !!! byte $01                                                                                                                 !!! #}
{# !!! byte $ff                                                                                                                 !!! #}
{# !!! byte $02                                                                                                                 !!! #}
{# !!! byte $ff                                                                                                                 !!! #}
{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! byte FAMISTUDIO_VRC6_CH0_DUTY_IDX                                                                                        !!! #}
{# !!! byte FAMISTUDIO_VRC6_CH1_DUTY_IDX                                                                                        !!! #}
{# !!! byte FAMISTUDIO_VRC6_CH2_DUTY_IDX                                                                                        !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_MMC5                                                                                                      %}
{# !!! byte FAMISTUDIO_MMC5_CH0_DUTY_IDX                                                                                        !!! #}
{# !!! byte FAMISTUDIO_MMC5_CH1_DUTY_IDX                                                                                        !!! #}
{% endif 120 %}

{#  For a given channel, returns the index of the duty cycle envelope.                                                      #}
{# !!! amistudio_channel_to_duty_env:                                                                                           !!! #}
{# !!! byte FAMISTUDIO_CH0_ENVS+FAMISTUDIO_ENV_DUTY_OFF                                                                         !!! #}
{# !!! byte FAMISTUDIO_CH1_ENVS+FAMISTUDIO_ENV_DUTY_OFF                                                                         !!! #}
{# !!! byte $ff                                                                                                                 !!! #}
{# !!! byte FAMISTUDIO_CH3_ENVS+FAMISTUDIO_ENV_DUTY_OFF                                                                         !!! #}
{# !!! byte $ff                                                                                                                 !!! #}
{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! byte FAMISTUDIO_VRC6_CH0_ENVS+FAMISTUDIO_ENV_DUTY_OFF                                                                    !!! #}
{# !!! byte FAMISTUDIO_VRC6_CH1_ENVS+FAMISTUDIO_ENV_DUTY_OFF                                                                    !!! #}
{# !!! byte FAMISTUDIO_VRC6_CH2_ENVS+FAMISTUDIO_ENV_DUTY_OFF                                                                    !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_MMC5                                                                                                      %}
{# !!! byte FAMISTUDIO_MMC5_CH0_ENVS+FAMISTUDIO_ENV_DUTY_OFF                                                                    !!! #}
{# !!! byte FAMISTUDIO_MMC5_CH1_ENVS+FAMISTUDIO_ENV_DUTY_OFF                                                                    !!! #}
{% endif 120 %}
{% endif 120 %}

{#  Duty lookup table.                                                                                                      #}
{# !!! amistudio_duty_lookup:                                                                                                   !!! #}
{# !!! byte $30                                                                                                                 !!! #}
{# !!! byte $70                                                                                                                 !!! #}
{# !!! byte $b0                                                                                                                 !!! #}
{# !!! byte $f0                                                                                                                 !!! #}

{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{#  Duty lookup table for VRC6.                                                                                             #}
{# !!! amistudio_vrc6_duty_lookup:                                                                                              !!! #}
{# !!! byte $00                                                                                                                 !!! #}
{# !!! byte $10                                                                                                                 !!! #}
{# !!! byte $20                                                                                                                 !!! #}
{# !!! byte $30                                                                                                                 !!! #}
{# !!! byte $40                                                                                                                 !!! #}
{# !!! byte $50                                                                                                                 !!! #}
{# !!! byte $60                                                                                                                 !!! #}
{# !!! byte $70                                                                                                                 !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_PHASE_RESET                                                                                               %}
{#  For a given channel, returns the bit mask to set in the phase reset byte                                                #}
{# !!! amistudio_channel_to_phase_reset_mask:                                                                                   !!! #}
{# !!! byte $01                                                                                                                 !!! #}
{# !!! byte $02                                                                                                                 !!! #}
{% if !FAMISTUDIO_EXP_NONE                                                                                                     %}
{# !!! byte $ff                                                                                                                 !!! #}
{# !!! byte $ff                                                                                                                 !!! #}
{# !!! byte $ff                                                                                                                 !!! #}
{% if FAMISTUDIO_EXP_VRC6                                                                                                      %}
{# !!! byte $04                                                                                                                 !!! #}
{# !!! byte $08                                                                                                                 !!! #}
{# !!! byte $10                                                                                                                 !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_FDS                                                                                                       %}
{# !!! byte $80                                                                                                                 !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_MMC5                                                                                                      %}
{# !!! byte $20                                                                                                                 !!! #}
{# !!! byte $40                                                                                                                 !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_N163                                                                                                      %}
{# !!! byte $01                                                                                                                 !!! #}
{# !!! byte $02                                                                                                                 !!! #}
{# !!! byte $04                                                                                                                 !!! #}
{# !!! byte $08                                                                                                                 !!! #}
{# !!! byte $10                                                                                                                 !!! #}
{# !!! byte $20                                                                                                                 !!! #}
{# !!! byte $40                                                                                                                 !!! #}
{# !!! byte $80                                                                                                                 !!! #}
{% endif 120 %}
{% endif 120 %}
{% endif 120 %}

{% if !FAMISTUDIO_USE_FAMITRACKER_TEMPO                                                                                        %}
{# !!! amistudio_tempo_frame_lookup:                                                                                            !!! #}
{# !!! byte $01, $02 ; NTSC -> NTSC, NTSC -> PAL                                                                                !!! #}
{# !!! byte $00, $01 ; PAL  -> NTSC, PAL  -> PAL                                                                                !!! #}
{% endif 120 %}

{% if FAMISTUDIO_CFG_SMOOTH_VIBRATO                                                                                            %}
{#  lookup table for the 2 registers we need to set for smooth vibrato.                                                     #}
{#  Index 0 decrement the hi-period, index 2 increments. Index 1 is unused.                                                 #}
{# !!! amistudio_smooth_vibrato_period_lo_lookup:                                                                               !!! #}
{# !!! byte $00, $00, $ff                                                                                                       !!! #}
{# !!! amistudio_smooth_vibrato_sweep_lookup:                                                                                   !!! #}
{# !!! byte $8f, $00, $87                                                                                                       !!! #}
{% endif 120 %}

{% if FAMISTUDIO_USE_VOLUME_TRACK                                                                                              %}

{#  Precomputed volume multiplication table (rounded but never to zero unless one of the value is zero).                    #}
{#  Load the 2 volumes in the lo/hi nibble and fetch.                                                                       #}

{# !!! amistudio_volume_table:                                                                                                  !!! #}
{# !!! byte $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00, $00                                      !!! #}
{# !!! byte $00, $01, $01, $01, $01, $01, $01, $01, $01, $01, $01, $01, $01, $01, $01, $01                                      !!! #}
{# !!! byte $00, $01, $01, $01, $01, $01, $01, $01, $01, $01, $01, $01, $02, $02, $02, $02                                      !!! #}
{# !!! byte $00, $01, $01, $01, $01, $01, $01, $01, $02, $02, $02, $02, $02, $03, $03, $03                                      !!! #}
{# !!! byte $00, $01, $01, $01, $01, $01, $02, $02, $02, $02, $03, $03, $03, $03, $04, $04                                      !!! #}
{# !!! byte $00, $01, $01, $01, $01, $02, $02, $02, $03, $03, $03, $04, $04, $04, $05, $05                                      !!! #}
{# !!! byte $00, $01, $01, $01, $02, $02, $02, $03, $03, $04, $04, $04, $05, $05, $06, $06                                      !!! #}
{# !!! byte $00, $01, $01, $01, $02, $02, $03, $03, $04, $04, $05, $05, $06, $06, $07, $07                                      !!! #}
{# !!! byte $00, $01, $01, $02, $02, $03, $03, $04, $04, $05, $05, $06, $06, $07, $07, $08                                      !!! #}
{# !!! byte $00, $01, $01, $02, $02, $03, $04, $04, $05, $05, $06, $07, $07, $08, $08, $09                                      !!! #}
{# !!! byte $00, $01, $01, $02, $03, $03, $04, $05, $05, $06, $07, $07, $08, $09, $09, $0a                                      !!! #}
{# !!! byte $00, $01, $01, $02, $03, $04, $04, $05, $06, $07, $07, $08, $09, $0a, $0a, $0b                                      !!! #}
{# !!! byte $00, $01, $02, $02, $03, $04, $05, $06, $06, $07, $08, $09, $0a, $0a, $0b, $0c                                      !!! #}
{# !!! byte $00, $01, $02, $03, $03, $04, $05, $06, $07, $08, $09, $0a, $0a, $0b, $0c, $0d                                      !!! #}
{# !!! byte $00, $01, $02, $03, $04, $05, $06, $07, $07, $08, $09, $0a, $0b, $0c, $0d, $0e                                      !!! #}
{# !!! byte $00, $01, $02, $03, $04, $05, $06, $07, $08, $09, $0a, $0b, $0c, $0d, $0e, $0f                                      !!! #}

{% endif 120 %}


{% if FAMISTUDIO_EXP_EPSM                                                                                                      %}
{#  Mapping for the channel id of the rhythm channel, to the RAM offset for it                                              #}
{#  If the user disables various channels, then we want to save on the ram for them                                         #}
{#  by just not reserving it, so this maps from channel ID to the new RAM offset for the channel                            #}
{#  The end result should be a table that looks like this if you have channel 2, 3, and 5 enabled                           #}
{#  .byte $ff, $00, $01, $ff, $02, $ff                                                                                      #}
{# !!! PSM_CHANNEL1_RHYTHM_OFFSET = -1 + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN1_ENABLE                                                 !!! #}
{# !!! PSM_CHANNEL2_RHYTHM_OFFSET = EPSM_CHANNEL1_RHYTHM_OFFSET + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN2_ENABLE                        !!! #}
{# !!! PSM_CHANNEL3_RHYTHM_OFFSET = EPSM_CHANNEL2_RHYTHM_OFFSET + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN3_ENABLE                        !!! #}
{# !!! PSM_CHANNEL4_RHYTHM_OFFSET = EPSM_CHANNEL3_RHYTHM_OFFSET + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN4_ENABLE                        !!! #}
{# !!! PSM_CHANNEL5_RHYTHM_OFFSET = EPSM_CHANNEL4_RHYTHM_OFFSET + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN5_ENABLE                        !!! #}
{# !!! PSM_CHANNEL6_RHYTHM_OFFSET = EPSM_CHANNEL5_RHYTHM_OFFSET + FAMISTUDIO_EXP_EPSM_RHYTHM_CHN6_ENABLE                        !!! #}

{# !!! amistudio_rhythm_lut:                                                                                                    !!! #}
{% if FAMISTUDIO_EXP_EPSM_RHYTHM_CHN1_ENABLE                                                                                   %}
{# !!! byte <(EPSM_CHANNEL1_RHYTHM_OFFSET)                                                                                      !!! #}
{% else 120 %}
{# !!! byte $ff                                                                                                                 !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_RHYTHM_CHN2_ENABLE                                                                                   %}
{# !!! byte <(EPSM_CHANNEL2_RHYTHM_OFFSET)                                                                                      !!! #}
{% else 120 %}
{# !!! byte $ff                                                                                                                 !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_RHYTHM_CHN3_ENABLE                                                                                   %}
{# !!! byte <(EPSM_CHANNEL3_RHYTHM_OFFSET)                                                                                      !!! #}
{% else 120 %}
{# !!! byte $ff                                                                                                                 !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_RHYTHM_CHN4_ENABLE                                                                                   %}
{# !!! byte <(EPSM_CHANNEL4_RHYTHM_OFFSET)                                                                                      !!! #}
{% else 120 %}
{# !!! byte $ff                                                                                                                 !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_RHYTHM_CHN5_ENABLE                                                                                   %}
{# !!! byte <(EPSM_CHANNEL5_RHYTHM_OFFSET)                                                                                      !!! #}
{% else 120 %}
{# !!! byte $ff                                                                                                                 !!! #}
{% endif 120 %}
{% if FAMISTUDIO_EXP_EPSM_RHYTHM_CHN6_ENABLE                                                                                   %}
{# !!! byte <(EPSM_CHANNEL6_RHYTHM_OFFSET)                                                                                      !!! #}
{% else 120 %}
{# !!! byte $ff                                                                                                                 !!! #}
{% endif 120 %}
{% endif 120 %}
